<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<title>VideoQuiz ‚Äì Part 4 (Library + Student Modes)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html, body { height:100%; margin:0; background:#0f172a; }
  body { overflow:hidden; }
</style>
</head>

<body class="h-full text-white">
<div id="app" class="h-full flex flex-col">

  <!-- TOP BAR -->
  <header class="bg-slate-900 border-b border-slate-800 px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-3 h-3 rounded-full bg-emerald-400"></div>
      <div class="font-black text-lg">VideoQuiz</div>
      <div id="top-sub" class="text-slate-400 text-sm hidden md:block">–ª–æ–∫–∞–ª–Ω–∞ –≤–µ—Ä—Å–∏—è (–±–µ–∑ –æ–±–ª–∞–∫)</div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-home" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm font-bold" onclick="go('welcome')">–ù–∞—á–∞–ª–æ</button>
      <button id="btn-help" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-bold" onclick="openHelp()">–ü–æ–º–æ—â</button>
    </div>
  </header>

  <!-- SCREENS -->
  <main class="flex-1 overflow-hidden">

    <!-- WELCOME -->
    <section id="screen-welcome" class="h-full overflow-auto p-4 md:p-8">
      <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-6">
          <h2 class="text-2xl font-black mb-2">–£—á–µ–Ω–∏—Ü–∏</h2>
          <p class="text-slate-300 mb-4">–í—ä–≤–µ–¥–∏ –∏–º–µ + –∫–æ–¥ –∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–π —É—Ä–æ–∫–∞.</p>

          <div class="space-y-3">
            <input id="stuName" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold"
                   placeholder="–ò–º–µ (–Ω–∞–ø—Ä. –ú–∞—Ä–∏—è)">

            <textarea id="stuCode" class="w-full h-28 bg-slate-800 border border-slate-700 rounded-xl p-3 font-mono text-xs"
                      placeholder="–ü–æ—Å—Ç–∞–≤–∏ –∫–æ–¥–∞ –æ—Ç —É—á–∏—Ç–µ–ª—è —Ç—É–∫..."></textarea>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <label class="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center gap-2 cursor-pointer">
                <input id="modeHome" type="radio" name="mode" checked>
                <div>
                  <div class="font-black">–î–æ–º–∞—à–Ω–æ</div>
                  <div class="text-xs text-slate-400">–∑–∞–ø–∞–∑–≤–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç (–ª–æ–∫–∞–ª–Ω–æ)</div>
                </div>
              </label>

              <label class="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center gap-2 cursor-pointer">
                <input id="modeSOP" type="radio" name="mode">
                <div>
                  <div class="font-black">–°–û–ü üîä</div>
                  <div class="text-xs text-slate-400">–µ–¥—ä—Ä —à—Ä–∏—Ñ—Ç + —á–µ—Ç–µ—Ü</div>
                </div>
              </label>

              <label class="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center gap-2 cursor-pointer">
                <input id="modeDiscuss" type="radio" name="mode">
                <div>
                  <div class="font-black">–û–±—Å—ä–∂–¥–∞–Ω–µ</div>
                  <div class="text-xs text-slate-400">–Ω–µ –ø–∞–∑–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç</div>
                </div>
              </label>
            </div>

            <button class="w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-3 font-black"
                    onclick="startStudentFromCode()">–°—Ç–∞—Ä—Ç</button>

            <div class="text-xs text-slate-400">
              –ê–∫–æ –∫–æ–¥—ä—Ç –µ –º–Ω–æ–≥–æ –¥—ä–ª—ä–≥: –∫–æ–ø–∏—Ä–∞–π/–ø–æ—Å—Ç–∞–≤–∏ –≤–Ω–∏–º–∞—Ç–µ–ª–Ω–æ (–Ω–∞–π-–¥–æ–±—Ä–µ –æ—Ç ‚Äú–ï–∫—Å–ø–æ—Ä—Ç‚Äù –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è).
            </div>
          </div>
        </div>

        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-6">
          <h2 class="text-2xl font-black mb-2">–£—á–∏—Ç–µ–ª</h2>
          <p class="text-slate-300 mb-4">–°—ä–∑–¥–∞–π —É—Ä–æ–∫, –∑–∞–ø–∞–∑–∏ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–π –∫–æ–¥ –∑–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.</p>

          <div class="space-y-3">
            <button class="w-full bg-indigo-600 hover:bg-indigo-500 rounded-xl py-3 font-black"
                    onclick="go('teacher')">–í—Ö–æ–¥ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>

            <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4 text-sm text-slate-300">
              ‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –µ –ª–æ–∫–∞–ª–Ω–∞ (–≤ –±—Ä–∞—É–∑—ä—Ä–∞). –ü–æ-–∫—ä—Å–Ω–æ —â–µ —è –≤—ä—Ä–∂–µ–º –∫—ä–º Firebase.
            </div>

            <button class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl py-3 font-bold"
                    onclick="clearLocal()">
              –ù—É–ª–∏—Ä–∞–π –ª–æ–∫–∞–ª–Ω–∏ –¥–∞–Ω–Ω–∏ (–∞–∫–æ —Å–µ –æ–±—ä—Ä–∫–∞)
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- TEACHER LIBRARY -->
    <section id="screen-teacher" class="hidden h-full overflow-hidden">
      <div class="h-full grid grid-cols-1 lg:grid-cols-[420px_1fr] gap-0">
        <!-- left: library -->
        <div class="h-full bg-slate-950/40 border-r border-slate-800 overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-800 flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–£—á–∏—Ç–µ–ª—Å–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
              <div class="text-lg font-black">–£—Ä–æ—Ü–∏</div>
            </div>
            <button class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-lg font-black text-sm"
                    onclick="newLesson()">+ –ù–æ–≤ —É—Ä–æ–∫</button>
          </div>

          <div class="p-4 border-b border-slate-800">
            <input id="libSearch" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold"
                   placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ..." oninput="renderLibrary()">
          </div>

          <div id="libList" class="flex-1 overflow-auto p-4 space-y-3"></div>

          <div class="p-4 border-t border-slate-800 text-xs text-slate-400">
            –£—Ä–æ—Ü–∏—Ç–µ —Å–µ –ø–∞–∑—è—Ç –ª–æ–∫–∞–ª–Ω–æ –≤ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä.
          </div>
        </div>

        <!-- right: editor + preview -->
        <div class="h-full overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-800 flex flex-wrap items-center gap-2 justify-between bg-slate-900/40">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">–†–µ–¥–∞–∫—Ç–æ—Ä</span>
              <span id="editBadge" class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm font-black">–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —É—Ä–æ–∫</span>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-lg font-bold text-sm"
                      onclick="openExportModal()">–ï–∫—Å–ø–æ—Ä—Ç</button>
              <button class="bg-sky-600 hover:bg-sky-500 px-3 py-2 rounded-lg font-bold text-sm"
                      onclick="openImportModal()">–ò–º–ø–æ—Ä—Ç</button>
              <button class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded-lg font-bold text-sm"
                      onclick="openShareCode()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∫–æ–¥</button>
              <button class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-lg font-black text-sm"
                      onclick="saveLesson()">–ó–∞–ø–∞–∑–∏</button>
            </div>
          </div>

          <div class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-4 p-4">
            <!-- video -->
            <div class="bg-black rounded-2xl overflow-hidden relative">
              <div id="tPlayer" class="w-full h-full"></div>
              <div id="tHint" class="absolute top-3 left-3 bg-black/50 backdrop-blur px-3 py-2 rounded-xl text-xs text-slate-200">
                –ó–∞—Ä–µ–¥–∏ –≤–∏–¥–µ–æ (YouTube ID) –∏ –Ω–∞—Ç–∏—Å–Ω–∏ Play.
              </div>
            </div>

            <!-- questions -->
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden flex flex-col">
              <div class="p-4 border-b border-slate-800 space-y-2">
                <input id="tTitle" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 font-black"
                       placeholder="–ò–º–µ –Ω–∞ —É—Ä–æ–∫ (–Ω–∞–ø—Ä. –ë—ä–ª–≥–∞—Ä—Å–∫–æ –≤—ä–∑—Ä–∞–∂–¥–∞–Ω–µ)">
                <div class="flex gap-2">
                  <input id="tVid" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold"
                         placeholder="YouTube ID (11 –∑–Ω–∞–∫–∞)">
                  <button class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded-xl font-black"
                          onclick="bootTeacherPlayer()">–í–∏–¥–µ–æ</button>
                </div>

                <div class="flex items-center justify-between">
                  <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í—ä–ø—Ä–æ—Å–∏</div>
                  <div class="font-mono text-xs bg-slate-800 border border-slate-700 px-3 py-1 rounded" id="tClock">0:00</div>
                </div>

                <button class="w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-2 font-black"
                        onclick="openQForm()">+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å (–Ω–∞ —Ç–µ–∫—É—â–∞—Ç–∞ —Å–µ–∫—É–Ω–¥–∞)</button>
              </div>

              <div id="tQList" class="flex-1 overflow-auto p-4 space-y-3"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- STUDENT PLAYER -->
    <section id="screen-student" class="hidden h-full overflow-hidden">
      <div class="h-full grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-4 p-4">
        <div class="bg-black rounded-2xl overflow-hidden relative">
          <div id="sPlayer" class="w-full h-full"></div>
          <div id="sMini" class="absolute top-3 left-3 bg-black/50 backdrop-blur px-3 py-2 rounded-xl text-xs text-slate-200">
            –°—Ç–∞—Ä—Ç–∏—Ä–∞–π —É—Ä–æ–∫–∞.
          </div>
        </div>

        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-800">
            <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–£—á–µ–Ω–∏–∫</div>
            <div class="text-xl font-black" id="sName">‚Äî</div>
            <div class="text-sm text-slate-300 mt-1" id="sLesson">‚Äî</div>
            <div class="mt-3 flex items-center justify-between">
              <div class="font-mono text-xs bg-slate-800 border border-slate-700 px-3 py-1 rounded" id="sClock">0:00</div>
              <div class="text-sm font-black">–¢–æ—á–∫–∏: <span id="sScore" class="text-emerald-300">0</span></div>
            </div>
            <div class="mt-2 text-xs text-slate-400" id="sModeLabel">–†–µ–∂–∏–º: ‚Äî</div>
          </div>

          <div class="flex-1 overflow-auto p-4">
            <div class="text-slate-300 text-sm">
              –í–∏–¥–µ–æ + –≤—ä–ø—Ä–æ—Å–∏ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ê–∫–æ –±—Ä–∞—É–∑—ä—Ä—ä—Ç –±–ª–æ–∫–∏—Ä–∞ autoplay ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ Play.
            </div>
          </div>

          <div class="p-4 border-t border-slate-800">
            <button class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl py-3 font-bold"
                    onclick="go('welcome')">–ò–∑—Ö–æ–¥</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FINISH -->
    <section id="screen-finish" class="hidden h-full overflow-auto p-6">
      <div class="max-w-xl mx-auto bg-slate-900/70 border border-slate-800 rounded-3xl p-8 text-center">
        <div class="text-5xl font-black mb-2">–ö–†–ê–ô</div>
        <div class="text-slate-300 mb-6" id="finInfo">‚Äî</div>

        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 mb-6">
          <div class="text-slate-400 text-sm font-bold uppercase tracking-wider">–†–µ–∑—É–ª—Ç–∞—Ç</div>
          <div class="text-6xl font-black mt-2"><span id="finScore">0</span> / <span id="finMax">0</span></div>
        </div>

        <div id="finSaved" class="text-sm text-slate-300 mb-6"></div>

        <button class="w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-3 font-black"
                onclick="go('welcome')">–ù–∞—á–∞–ª–æ</button>
      </div>
    </section>

  </main>
</div>

<!-- MODALS -->
<div id="modalHelp" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg">–ü–æ–º–æ—â (–º–Ω–æ–≥–æ –∫—Ä–∞—Ç–∫–æ)</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeHelp()">‚úï</button>
    </div>
    <div class="p-4 space-y-3 text-slate-200 text-sm">
      <div class="font-bold">–£—á–∏—Ç–µ–ª:</div>
      <ul class="list-disc pl-5 space-y-1">
        <li>–í ‚Äû–£—á–∏—Ç–µ–ª‚Äú ‚Üí ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú ‚Üí –≤—ä–≤–µ–¥–∏ –∏–º–µ + YouTube ID ‚Üí ‚Äû–í–∏–¥–µ–æ‚Äú.</li>
        <li>–ü—É—Å–Ω–∏ –≤–∏–¥–µ–æ—Ç–æ, –∏–∑—á–∞–∫–∞–π —Ç–æ—á–Ω–∞—Ç–∞ —Å–µ–∫—É–Ω–¥–∞ ‚Üí ‚Äû+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å‚Äú.</li>
        <li>‚Äû–ó–∞–ø–∞–∑–∏‚Äú ‚Üí —É—Ä–æ–∫—ä—Ç –æ—Å—Ç–∞–≤–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ (–ª–æ–∫–∞–ª–Ω–æ).</li>
        <li>‚Äû–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∫–æ–¥‚Äú ‚Üí –∫–æ–ø–∏—Ä–∞–π –∏ –¥–∞–π –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.</li>
      </ul>
      <div class="font-bold mt-3">–£—á–µ–Ω–∏—Ü–∏:</div>
      <ul class="list-disc pl-5 space-y-1">
        <li>–í ‚Äû–£—á–µ–Ω–∏—Ü–∏‚Äú ‚Üí –∏–º–µ + –∫–æ–¥ ‚Üí —Ä–µ–∂–∏–º ‚Üí ‚Äû–°—Ç–∞—Ä—Ç‚Äú.</li>
        <li>–í–∏–¥–µ–æ —Å–ø–∏—Ä–∞ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏. –°–ª–µ–¥ –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞—Ç–∏—Å–∫–∞—à ‚Äû–ü—Ä–æ–¥—ä–ª–∂–∏‚Äú.</li>
      </ul>
      <div class="text-slate-400 text-xs mt-2">
        –¢–æ–≤–∞ –µ –ª–æ–∫–∞–ª–Ω–∞ –≤–µ—Ä—Å–∏—è. –°–ª–µ–¥–≤–∞—â–∞—Ç–∞ —Å—Ç—ä–ø–∫–∞ –µ –æ–±–ª–∞–∫ (Firebase) + —Ä–µ–∞–ª–µ–Ω —É—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
      </div>
    </div>
  </div>
</div>

<!-- Q FORM -->
<div id="modalQ" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg" id="qFormTitle">–í—ä–ø—Ä–æ—Å</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeQForm()">‚úï</button>
    </div>
    <div class="p-4 space-y-3">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="qTime" type="number" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–°–µ–∫—É–Ω–¥–∞">
        <select id="qCorrect" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold">
          <option value="0">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 1</option>
          <option value="1">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 2</option>
          <option value="2">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 3</option>
          <option value="3">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 4</option>
        </select>
      </div>

      <input id="qText" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-black" placeholder="–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞">

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="qO0" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 1">
        <input id="qO1" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 2">
        <input id="qO2" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 3">
        <input id="qO3" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 4">
      </div>

      <div id="qErr" class="text-rose-300 font-bold text-sm"></div>

      <div class="flex gap-2 flex-wrap">
        <button class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl font-black" onclick="saveQForm()">–ó–∞–ø–∞–∑–∏</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-xl font-bold" onclick="closeQForm()">–û—Ç–∫–∞–∑</button>
      </div>
    </div>
  </div>
</div>

<!-- SHARE CODE -->
<div id="modalShare" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg">–ö–æ–¥ –∑–∞ —É—á–µ–Ω–∏—Ü–∏</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeShare()">‚úï</button>
    </div>
    <div class="p-4 space-y-3">
      <div class="text-slate-300 text-sm">
        –ö–æ–ø–∏—Ä–∞–π –∏ –∏–∑–ø—Ä–∞—Ç–∏ —Ç–æ–∑–∏ –∫–æ–¥ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ (–≤—ä–≤ Viber/Teams/–∏–º–µ–π–ª).
      </div>
      <textarea id="shareText" class="w-full h-48 bg-slate-800 border border-slate-700 rounded-xl p-3 font-mono text-xs"></textarea>
      <div id="shareInfo" class="text-slate-400 text-xs"></div>
      <div class="flex gap-2 flex-wrap">
        <button class="bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded-xl font-black" onclick="copyShare()">–ö–æ–ø–∏—Ä–∞–π</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-xl font-bold" onclick="closeShare()">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT/EXPORT -->
<div id="modalIE" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg" id="ieTitle">–ï–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeIE()">‚úï</button>
    </div>
    <div class="p-4 space-y-3">
      <textarea id="ieText" class="w-full h-56 bg-slate-800 border border-slate-700 rounded-xl p-3 font-mono text-xs"
                placeholder="–ü–æ—Å—Ç–∞–≤–∏ JSON —Ç—É–∫..."></textarea>
      <div id="ieErr" class="text-rose-300 font-bold text-sm"></div>
      <div class="flex gap-2 flex-wrap">
        <button class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-xl font-black" onclick="doIEImport()">–ò–º–ø–æ—Ä—Ç</button>
        <button class="bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded-xl font-black" onclick="copyIE()">–ö–æ–ø–∏—Ä–∞–π</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-xl font-bold" onclick="closeIE()">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- STUDENT QUESTION MODAL -->
<div id="modalSQ" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div>
        <div id="sqMeta" class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í—ä–ø—Ä–æ—Å</div>
        <div id="sqText" class="text-xl font-black">‚Äî</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnSpeak" class="hidden px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 font-black text-sm" onclick="speakSQ()">üîä</button>
        <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeSQ()">‚úï</button>
      </div>
    </div>
    <div id="sqOpts" class="p-4 space-y-2"></div>
    <div class="p-4 border-t border-slate-800 flex items-center justify-between gap-3">
      <div id="sqFeed" class="font-bold text-slate-200"></div>
      <button id="btnSQContinue" class="hidden bg-emerald-600 hover:bg-emerald-500 px-5 py-3 rounded-xl font-black" onclick="continueStudent()">–ü—Ä–æ–¥—ä–ª–∂–∏</button>
    </div>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* =========================
   Local storage keys
========================= */
const LS_LIB = "videoquiz_library_v1";
const LS_RESULTS = "videoquiz_results_v1";

/* =========================
   Global state
========================= */
let ytReady = false;

// Teacher
let tPlayer = null;
let tTick = null;
let currentLessonId = null;   // selected in library
let workingLesson = null;     // {id,title,videoId,questions:[{time,text,options[4],correctIndex}]}
let editingQIndex = null;

// Student
let sPlayer = null;
let sTick = null;
let sAsked = new Set();
let sActiveQ = null;
let sScore = 0;
let sMax = 0;
let sMode = "home"; // home | sop | discuss
let sStudentName = "";
let sLessonTitle = "";

/* =========================
   YouTube API
========================= */
function onYouTubeIframeAPIReady(){ ytReady = true; }

/* =========================
   Screen nav
========================= */
function go(name){
  document.querySelectorAll("section[id^='screen-']").forEach(s=>s.classList.add("hidden"));
  document.getElementById("screen-"+name).classList.remove("hidden");
  // cleanup student/teacher tick
  if(name !== "student") stopStudentTick();
  if(name !== "teacher") stopTeacherTick();
  if(name === "teacher") renderLibrary();
}

function openHelp(){ document.getElementById("modalHelp").classList.remove("hidden"); }
function closeHelp(){ document.getElementById("modalHelp").classList.add("hidden"); }

/* =========================
   Utils
========================= */
function fmt(sec){
  sec = Math.max(0, Math.floor(sec || 0));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,"0")}`;
}
function toast(msg){
  // minimal: use alert-like but nicer
  // for simplicity and stability:
  alert(msg);
}
function b64EncodeUnicode(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function b64DecodeUnicode(str){
  return decodeURIComponent(escape(atob(str)));
}

/* =========================
   Library CRUD (LocalStorage)
========================= */
function loadLibrary(){
  try { return JSON.parse(localStorage.getItem(LS_LIB) || "[]"); }
  catch { return []; }
}
function saveLibrary(list){
  localStorage.setItem(LS_LIB, JSON.stringify(list));
}
function upsertLesson(lesson){
  const list = loadLibrary();
  const idx = list.findIndex(x=>x.id===lesson.id);
  if(idx>=0) list[idx] = lesson;
  else list.push(lesson);
  saveLibrary(list);
}
function deleteLesson(id){
  const list = loadLibrary().filter(x=>x.id!==id);
  saveLibrary(list);
}

function clearLocal(){
  if(!confirm("–°–∏–≥—É—Ä–Ω–∞ –ª–∏ —Å–∏? –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –ª–æ–∫–∞–ª–Ω–∞—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏ –ª–æ–∫–∞–ª–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.")) return;
  localStorage.removeItem(LS_LIB);
  localStorage.removeItem(LS_RESULTS);
  toast("–ù—É–ª–∏—Ä–∞–Ω–æ.");
}

/* =========================
   Teacher ‚Äì Library UI
========================= */
function renderLibrary(){
  const list = loadLibrary();
  const q = (document.getElementById("libSearch").value || "").toLowerCase().trim();
  const filtered = q ? list.filter(x => (x.title||"").toLowerCase().includes(q)) : list;

  const box = document.getElementById("libList");
  if(filtered.length === 0){
    box.innerHTML = `<div class="text-slate-400 text-sm">–ù—è–º–∞ —É—Ä–æ—Ü–∏. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú.</div>`;
    return;
  }

  box.innerHTML = filtered
    .sort((a,b)=>(a.title||"").localeCompare(b.title||""))
    .map(l => `
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
        <div class="font-black text-lg">${escapeHtml(l.title || "–ë–µ–∑ –∏–º–µ")}</div>
        <div class="text-xs text-slate-400">–í–∏–¥–µ–æ: <span class="font-mono">${escapeHtml(l.videoId||"‚Äî")}</span> ‚Ä¢ –í—ä–ø—Ä–æ—Å–∏: <b>${(l.questions||[]).length}</b></div>

        <div class="flex gap-2 flex-wrap">
          <button class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="selectLesson('${l.id}')">–†–µ–¥–∞–∫—Ü–∏—è</button>
          <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-xl font-bold text-sm" onclick="previewLesson('${l.id}')">–ü—Ä–µ–≥–ª–µ–¥</button>
          <button class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded-xl font-black text-sm" onclick="shareLesson('${l.id}')">–ö–æ–¥</button>
          <button class="bg-rose-600 hover:bg-rose-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="removeLesson('${l.id}')">–ò–∑—Ç—Ä–∏–π</button>
        </div>
      </div>
    `).join("");
}

function newLesson(){
  const id = "L" + Date.now();
  workingLesson = { id, title: "–ù–æ–≤ —É—Ä–æ–∫", videoId: "dQw4w9WgXcQ", questions: [] };
  currentLessonId = id;
  applyLessonToEditor();
  document.getElementById("editBadge").innerText = "–†–µ–¥–∞–∫—Ü–∏—è: –ù–æ–≤ —É—Ä–æ–∫";
  // stop old teacher player, so we recreate clean
  stopTeacherTick();
  document.getElementById("tPlayer").innerHTML = "";
  document.getElementById("tHint").innerText = "–í—ä–≤–µ–¥–∏ YouTube ID –∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–í–∏–¥–µ–æ‚Äú.";
  renderTeacherQuestions();
}

function selectLesson(id){
  const lesson = loadLibrary().find(x=>x.id===id);
  if(!lesson) return;
  workingLesson = JSON.parse(JSON.stringify(lesson));
  currentLessonId = id;
  applyLessonToEditor();
  document.getElementById("editBadge").innerText = "–†–µ–¥–∞–∫—Ü–∏—è: " + (workingLesson.title || "–ë–µ–∑ –∏–º–µ");
  stopTeacherTick();
  document.getElementById("tPlayer").innerHTML = "";
  document.getElementById("tHint").innerText = "–ù–∞—Ç–∏—Å–Ω–∏ ‚Äû–í–∏–¥–µ–æ‚Äú –∑–∞ –¥–∞ –∑–∞—Ä–µ–¥–∏—à –ø–ª–µ—ä—Ä–∞.";
  renderTeacherQuestions();
}

function previewLesson(id){
  const lesson = loadLibrary().find(x=>x.id===id);
  if(!lesson) return;
  // Start student in "discuss" mode for preview, without saving
  startStudent(lesson, "discuss", "–£—á–∏—Ç–µ–ª (–ø—Ä–µ–≥–ª–µ–¥)");
}

function shareLesson(id){
  const lesson = loadLibrary().find(x=>x.id===id);
  if(!lesson) return;
  shareLessonNow(lesson);
}

function removeLesson(id){
  if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞?")) return;
  deleteLesson(id);
  if(currentLessonId === id){
    currentLessonId = null;
    workingLesson = null;
    document.getElementById("editBadge").innerText = "–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —É—Ä–æ–∫";
    document.getElementById("tTitle").value = "";
    document.getElementById("tVid").value = "";
    document.getElementById("tQList").innerHTML = `<div class="text-slate-400 text-sm">–ò–∑–±–µ—Ä–∏ —É—Ä–æ–∫ –∏–ª–∏ —Å—ä–∑–¥–∞–π –Ω–æ–≤.</div>`;
    stopTeacherTick();
    document.getElementById("tPlayer").innerHTML = "";
  }
  renderLibrary();
}

function applyLessonToEditor(){
  document.getElementById("tTitle").value = workingLesson.title || "";
  document.getElementById("tVid").value = workingLesson.videoId || "";
}

function saveLesson(){
  if(!workingLesson){
    toast("–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —É—Ä–æ–∫. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú.");
    return;
  }
  // pull from UI
  workingLesson.title = (document.getElementById("tTitle").value || "").trim() || "–ë–µ–∑ –∏–º–µ";
  workingLesson.videoId = (document.getElementById("tVid").value || "").trim();
  workingLesson.questions = (workingLesson.questions || []).sort((a,b)=>a.time-b.time);

  if(!workingLesson.videoId || workingLesson.videoId.length !== 11){
    toast("YouTube ID —Ç—Ä—è–±–≤–∞ –¥–∞ –µ 11 –∑–Ω–∞–∫–∞.");
    return;
  }

  upsertLesson(workingLesson);
  renderLibrary();
  document.getElementById("editBadge").innerText = "–†–µ–¥–∞–∫—Ü–∏—è: " + workingLesson.title;
  toast("–ó–∞–ø–∞–∑–µ–Ω–æ –ª–æ–∫–∞–ª–Ω–æ ‚úÖ");
}

/* =========================
   Teacher ‚Äì Player & Questions
========================= */
function bootTeacherPlayer(){
  if(!ytReady){ toast("YouTube API –æ—â–µ –∑–∞—Ä–µ–∂–¥–∞. –ò–∑—á–∞–∫–∞–π 1-2 —Å–µ–∫."); return; }
  if(!workingLesson){
    toast("–ò–∑–±–µ—Ä–∏ —É—Ä–æ–∫ –∏–ª–∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú.");
    return;
  }
  // sync
  workingLesson.title = (document.getElementById("tTitle").value || "").trim() || "–ë–µ–∑ –∏–º–µ";
  workingLesson.videoId = (document.getElementById("tVid").value || "").trim();

  if(!workingLesson.videoId || workingLesson.videoId.length !== 11){
    toast("–í—ä–≤–µ–¥–∏ YouTube ID (11 –∑–Ω–∞–∫–∞).");
    return;
  }

  stopTeacherTick();
  document.getElementById("tPlayer").innerHTML = "";

  tPlayer = new YT.Player("tPlayer",{
    videoId: workingLesson.videoId,
    width:"100%", height:"100%",
    playerVars:{ rel:0, modestbranding:1 },
    events:{
      onReady: e => {
        document.getElementById("tHint").innerText = "–ü—É—Å–Ω–∏ –≤–∏–¥–µ–æ—Ç–æ. –ù–∞ —Ç–æ—á–Ω–∞—Ç–∞ —Å–µ–∫—É–Ω–¥–∞ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å‚Äú.";
        startTeacherTick();
      }
    }
  });
}

function startTeacherTick(){
  stopTeacherTick();
  tTick = setInterval(()=>{
    if(!tPlayer || typeof tPlayer.getCurrentTime !== "function") return;
    document.getElementById("tClock").innerText = fmt(tPlayer.getCurrentTime());
  }, 300);
}
function stopTeacherTick(){
  if(tTick) clearInterval(tTick);
  tTick = null;
}

function renderTeacherQuestions(){
  const box = document.getElementById("tQList");
  if(!workingLesson){
    box.innerHTML = `<div class="text-slate-400 text-sm">–ò–∑–±–µ—Ä–∏ —É—Ä–æ–∫ –∏–ª–∏ —Å—ä–∑–¥–∞–π –Ω–æ–≤.</div>`;
    return;
  }
  const qs = (workingLesson.questions || []).slice().sort((a,b)=>a.time-b.time);
  if(qs.length === 0){
    box.innerHTML = `<div class="text-slate-400 text-sm">–ù—è–º–∞ –≤—ä–ø—Ä–æ—Å–∏. –î–æ–±–∞–≤–∏ —Å –±—É—Ç–æ–Ω–∞ ‚Äû+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å‚Äú.</div>`;
    return;
  }
  box.innerHTML = qs.map((q, idx)=>`
    <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="font-black">${fmt(q.time)} ‚Äî ${escapeHtml(q.text)}</div>
        <button class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold" onclick="seekTeacher(${q.time})">–°–∫–æ–∫</button>
      </div>
      <div class="text-xs text-slate-400">–í–µ—Ä–µ–Ω: <b>${Number(q.correctIndex)+1}</b></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        ${q.options.map((o,i)=>`<div class="bg-slate-800 border border-slate-700 rounded-xl p-2 ${i===q.correctIndex?'text-emerald-300':''}">
          ${i+1}) ${escapeHtml(o)}
        </div>`).join("")}
      </div>
      <div class="flex gap-2 flex-wrap pt-2">
        <button class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="editTeacherQ(${idx})">–†–µ–¥–∞–∫—Ü–∏—è</button>
        <button class="bg-rose-600 hover:bg-rose-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="delTeacherQ(${idx})">–ò–∑—Ç—Ä–∏–π</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-xl font-bold text-sm" onclick="nudgeTeacherQ(${idx}, -1)">-1s</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-xl font-bold text-sm" onclick="nudgeTeacherQ(${idx}, +1)">+1s</button>
      </div>
    </div>
  `).join("");
}

function seekTeacher(sec){
  if(!tPlayer) return;
  tPlayer.seekTo(sec, true);
  tPlayer.playVideo();
}

function openQForm(){
  if(!workingLesson){
    toast("–ü—ä—Ä–≤–æ –∏–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫.");
    return;
  }
  editingQIndex = null;
  const t = tPlayer && typeof tPlayer.getCurrentTime==="function" ? Math.floor(tPlayer.getCurrentTime()) : 0;
  document.getElementById("qFormTitle").innerText = "–ù–æ–≤ –≤—ä–ø—Ä–æ—Å";
  document.getElementById("qTime").value = t;
  document.getElementById("qText").value = "";
  document.getElementById("qO0").value = "";
  document.getElementById("qO1").value = "";
  document.getElementById("qO2").value = "";
  document.getElementById("qO3").value = "";
  document.getElementById("qCorrect").value = "0";
  document.getElementById("qErr").innerText = "";
  document.getElementById("modalQ").classList.remove("hidden");
  if(tPlayer) tPlayer.pauseVideo();
}
function closeQForm(){
  document.getElementById("modalQ").classList.add("hidden");
}
function saveQForm(){
  const err = document.getElementById("qErr");
  err.innerText = "";

  const time = Number(document.getElementById("qTime").value);
  const text = (document.getElementById("qText").value || "").trim();
  const options = [
    (document.getElementById("qO0").value || "").trim(),
    (document.getElementById("qO1").value || "").trim(),
    (document.getElementById("qO2").value || "").trim(),
    (document.getElementById("qO3").value || "").trim(),
  ];
  const correctIndex = Number(document.getElementById("qCorrect").value);

  if(!Number.isFinite(time) || time < 0){ err.innerText = "–ù–µ–≤–∞–ª–∏–¥–Ω–∞ —Å–µ–∫—É–Ω–¥–∞."; return; }
  if(!text){ err.innerText = "–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞."; return; }
  if(options.some(o=>!o)){ err.innerText = "–ü–æ–ø—ä–ª–Ω–∏ –∏ 4-—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∞."; return; }
  if(!(correctIndex>=0 && correctIndex<=3)){ err.innerText = "–ò–∑–±–µ—Ä–∏ –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä."; return; }

  const q = { time, text, options, correctIndex };

  if(editingQIndex === null){
    workingLesson.questions.push(q);
  }else{
    workingLesson.questions[editingQIndex] = q;
  }
  workingLesson.questions.sort((a,b)=>a.time-b.time);
  renderTeacherQuestions();
  closeQForm();
}

function editTeacherQ(index){
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  const q = qs[index];
  if(!q) return;

  // Map back to actual index in workingLesson.questions (since we sorted view)
  const realIdx = workingLesson.questions.findIndex(x => x.time===q.time && x.text===q.text);
  editingQIndex = realIdx >= 0 ? realIdx : index;

  document.getElementById("qFormTitle").innerText = "–†–µ–¥–∞–∫—Ü–∏—è –Ω–∞ –≤—ä–ø—Ä–æ—Å";
  document.getElementById("qTime").value = q.time;
  document.getElementById("qText").value = q.text;
  document.getElementById("qO0").value = q.options[0] || "";
  document.getElementById("qO1").value = q.options[1] || "";
  document.getElementById("qO2").value = q.options[2] || "";
  document.getElementById("qO3").value = q.options[3] || "";
  document.getElementById("qCorrect").value = String(q.correctIndex || 0);
  document.getElementById("qErr").innerText = "";
  document.getElementById("modalQ").classList.remove("hidden");
  if(tPlayer) tPlayer.pauseVideo();
}

function delTeacherQ(index){
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  const q = qs[index];
  if(!q) return;
  if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞?")) return;
  // remove by match
  const realIdx = workingLesson.questions.findIndex(x => x.time===q.time && x.text===q.text);
  if(realIdx>=0) workingLesson.questions.splice(realIdx,1);
  else workingLesson.questions.splice(index,1);
  renderTeacherQuestions();
}

function nudgeTeacherQ(index, delta){
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  const q = qs[index];
  if(!q) return;
  const realIdx = workingLesson.questions.findIndex(x => x.time===q.time && x.text===q.text);
  const idx = realIdx>=0 ? realIdx : index;
  workingLesson.questions[idx].time = Math.max(0, (workingLesson.questions[idx].time||0) + delta);
  workingLesson.questions.sort((a,b)=>a.time-b.time);
  renderTeacherQuestions();
}

/* =========================
   Share code (Student code)
========================= */
function openShareCode(){
  if(!workingLesson){
    toast("–ò–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ –ó–∞–ø–∞–∑–∏.");
    return;
  }
  // ensure latest UI saved to object
  workingLesson.title = (document.getElementById("tTitle").value || "").trim() || "–ë–µ–∑ –∏–º–µ";
  workingLesson.videoId = (document.getElementById("tVid").value || "").trim();
  workingLesson.questions = (workingLesson.questions||[]).sort((a,b)=>a.time-b.time);

  if(!workingLesson.videoId || workingLesson.videoId.length !== 11){
    toast("–ü—ä—Ä–≤–æ –≤—ä–≤–µ–¥–∏ YouTube ID (11 –∑–Ω–∞–∫–∞).");
    return;
  }

  shareLessonNow(workingLesson);
}

function shareLessonNow(lesson){
  const payload = {
    v: lesson.videoId,
    title: lesson.title || "–ë–µ–∑ –∏–º–µ",
    q: (lesson.questions||[]).sort((a,b)=>a.time-b.time)
  };
  const code = b64EncodeUnicode(JSON.stringify(payload));

  document.getElementById("shareText").value = code;
  document.getElementById("shareInfo").innerText = `–£—Ä–æ–∫: "${lesson.title}" ‚Ä¢ –í—ä–ø—Ä–æ—Å–∏: ${(lesson.questions||[]).length}`;
  document.getElementById("modalShare").classList.remove("hidden");
}

function closeShare(){ document.getElementById("modalShare").classList.add("hidden"); }
function copyShare(){
  const ta = document.getElementById("shareText");
  ta.select();
  document.execCommand("copy");
  document.getElementById("shareInfo").innerText = "‚úÖ –ö–æ–ø–∏—Ä–∞–Ω–æ! –ò–∑–ø—Ä–∞—Ç–∏ –≥–æ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.";
}

/* =========================
   Import/Export (JSON) for teacher
========================= */
function openExportModal(){
  if(!workingLesson){ toast("–ò–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫."); return; }
  const clean = JSON.stringify({
    id: workingLesson.id,
    title: (document.getElementById("tTitle").value || "").trim() || workingLesson.title || "–ë–µ–∑ –∏–º–µ",
    videoId: (document.getElementById("tVid").value || "").trim() || workingLesson.videoId,
    questions: (workingLesson.questions||[]).sort((a,b)=>a.time-b.time)
  });
  document.getElementById("ieTitle").innerText = "–ï–∫—Å–ø–æ—Ä—Ç (JSON)";
  document.getElementById("ieText").value = clean;
  document.getElementById("ieErr").innerText = "";
  document.getElementById("modalIE").classList.remove("hidden");
}
function openImportModal(){
  document.getElementById("ieTitle").innerText = "–ò–º–ø–æ—Ä—Ç (JSON)";
  document.getElementById("ieText").value = "";
  document.getElementById("ieErr").innerText = "";
  document.getElementById("modalIE").classList.remove("hidden");
}
function closeIE(){ document.getElementById("modalIE").classList.add("hidden"); }
function copyIE(){
  const ta = document.getElementById("ieText");
  ta.select();
  document.execCommand("copy");
  document.getElementById("ieErr").innerText = "‚úÖ –ö–æ–ø–∏—Ä–∞–Ω–æ!";
}
function doIEImport(){
  const raw = (document.getElementById("ieText").value || "").trim();
  const err = document.getElementById("ieErr");
  err.innerText = "";
  if(!raw){ err.innerText = "–ü–æ—Å—Ç–∞–≤–∏ JSON."; return; }
  try{
    const obj = JSON.parse(raw);
    if(!obj.videoId || String(obj.videoId).length !== 11) throw new Error("–õ–∏–ø—Å–≤–∞/–≥—Ä–µ—à–µ–Ω videoId.");
    if(!Array.isArray(obj.questions)) throw new Error("–õ–∏–ø—Å–≤–∞ questions (–º–∞—Å–∏–≤).");

    const lesson = {
      id: obj.id || ("L"+Date.now()),
      title: obj.title || "–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω —É—Ä–æ–∫",
      videoId: obj.videoId,
      questions: obj.questions.map(q=>({
        time: Number(q.time||0),
        text: String(q.text||""),
        options: Array.isArray(q.options) ? q.options.slice(0,4) : ["","","",""],
        correctIndex: Number(q.correctIndex||0)
      }))
    };

    upsertLesson(lesson);
    selectLesson(lesson.id);
    renderLibrary();
    err.innerText = "‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!";
  }catch(e){
    err.innerText = "‚ùå " + (e.message || e);
  }
}

/* =========================
   Student mode ‚Äì start from code
========================= */
function startStudentFromCode(){
  const name = (document.getElementById("stuName").value || "").trim() || "–ê–Ω–æ–Ω–∏–º–µ–Ω";
  const code = (document.getElementById("stuCode").value || "").trim();
  if(!code){ toast("–ü–æ—Å—Ç–∞–≤–∏ –∫–æ–¥."); return; }

  let obj = null;
  try{
    obj = JSON.parse(b64DecodeUnicode(code));
  }catch{
    toast("–ö–æ–¥—ä—Ç –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω (–Ω–µ –º–æ–∂–µ –¥–∞ —Å–µ —Ä–∞–∑—á–µ—Ç–µ).");
    return;
  }
  if(!obj || !obj.v || String(obj.v).length !== 11 || !Array.isArray(obj.q)){
    toast("–ö–æ–¥—ä—Ç –µ –ø–æ–≤—Ä–µ–¥–µ–Ω (–ª–∏–ø—Å–≤–∞—Ç –¥–∞–Ω–Ω–∏).");
    return;
  }

  // mode
  const mode = document.getElementById("modeSOP").checked ? "sop"
            : document.getElementById("modeDiscuss").checked ? "discuss"
            : "home";

  const lesson = {
    title: obj.title || "–£—Ä–æ–∫",
    videoId: obj.v,
    questions: obj.q
  };

  startStudent(lesson, mode, name);
}

function startStudent(lesson, mode, name){
  if(!ytReady){ toast("YouTube API –æ—â–µ –∑–∞—Ä–µ–∂–¥–∞. –ò–∑—á–∞–∫–∞–π 1-2 —Å–µ–∫."); return; }

  sMode = mode;
  sStudentName = name;
  sLessonTitle = lesson.title || "–£—Ä–æ–∫";

  // score calc
  sScore = 0;
  sAsked = new Set();
  sActiveQ = null;

  // max points (–ø–æ 1 –Ω–∞ –≤—ä–ø—Ä–æ—Å –∑–∞—Å–µ–≥–∞)
  sMax = (lesson.questions||[]).length;

  // UI
  document.getElementById("sName").innerText = sStudentName;
  document.getElementById("sLesson").innerText = sLessonTitle;
  document.getElementById("sScore").innerText = "0";
  document.getElementById("sModeLabel").innerText =
    "–†–µ–∂–∏–º: " + (mode==="home" ? "–î–æ–º–∞—à–Ω–æ" : mode==="sop" ? "–°–û–ü" : "–û–±—Å—ä–∂–¥–∞–Ω–µ");

  // SOP big text mode (question modal)
  const btnSpeak = document.getElementById("btnSpeak");
  btnSpeak.classList.toggle("hidden", mode!=="sop");

  // create player
  stopStudentTick();
  document.getElementById("sPlayer").innerHTML = "";
  go("student");

  sPlayer = new YT.Player("sPlayer", {
    videoId: lesson.videoId,
    width:"100%", height:"100%",
    playerVars:{ rel:0, modestbranding:1 },
    events:{
      onReady: e => {
        document.getElementById("sMini").innerText = "–ü—É—Å–Ω–∏ Play (–∞–∫–æ –Ω–µ —Ç—Ä—ä–≥–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ).";
        startStudentTick(lesson);
      },
      onStateChange: e => {
        // when ended
        if(e.data === 0){
          finishStudent();
        }
      }
    }
  });
}

function startStudentTick(lesson){
  stopStudentTick();
  sTick = setInterval(()=>{
    if(!sPlayer || typeof sPlayer.getCurrentTime !== "function") return;
    const t = sPlayer.getCurrentTime();
    document.getElementById("sClock").innerText = fmt(t);

    const qs = (lesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
    const next = qs.find(q => !sAsked.has(q.time) && t >= q.time);
    if(next){
      sAsked.add(next.time);
      showStudentQuestion(next);
    }
  }, 300);
}
function stopStudentTick(){
  if(sTick) clearInterval(sTick);
  sTick = null;
}

function showStudentQuestion(q){
  sActiveQ = q;
  if(sPlayer) sPlayer.pauseVideo();

  document.getElementById("sqMeta").innerText = `–í—ä–ø—Ä–æ—Å @ ${fmt(q.time)}`;
  document.getElementById("sqText").innerText = q.text;
  document.getElementById("sqFeed").innerText = "–ò–∑–±–µ—Ä–∏ –æ—Ç–≥–æ–≤–æ—Ä.";
  document.getElementById("btnSQContinue").classList.add("hidden");

  // SOP style: larger question
  const sqText = document.getElementById("sqText");
  sqText.className = (sMode==="sop")
    ? "text-3xl font-black leading-snug"
    : "text-xl font-black";

  const box = document.getElementById("sqOpts");
  box.innerHTML = "";
  q.options.forEach((opt, idx)=>{
    const b = document.createElement("button");
    b.className = (sMode==="sop")
      ? "w-full text-left bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-2xl p-5 font-black text-xl transition"
      : "w-full text-left bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl p-4 font-bold transition";
    b.innerText = opt;
    b.onclick = ()=>answerStudent(idx);
    box.appendChild(b);
  });

  document.getElementById("modalSQ").classList.remove("hidden");

  // auto read in SOP
  if(sMode==="sop"){
    speakSQ();
  }else{
    if(window.speechSynthesis) window.speechSynthesis.cancel();
  }
}

function answerStudent(idx){
  if(!sActiveQ) return;
  const correct = Number(sActiveQ.correctIndex) === idx;

  // lock
  document.querySelectorAll("#sqOpts button").forEach((b,i)=>{
    b.disabled = true;
    b.classList.remove("hover:bg-slate-700");
    if(i === Number(sActiveQ.correctIndex)) b.classList.add("border-emerald-500");
    if(i === idx && !correct) b.classList.add("border-rose-500");
    b.classList.add("opacity-95");
  });

  if(correct){
    sScore += 1;
    document.getElementById("sScore").innerText = String(sScore);
    document.getElementById("sqFeed").innerText = "‚úÖ –í—è—Ä–Ω–æ!";
  }else{
    document.getElementById("sqFeed").innerText = "‚ùå –ì—Ä–µ—à–Ω–æ.";
  }
  document.getElementById("btnSQContinue").classList.remove("hidden");
}

function continueStudent(){
  closeSQ();
  if(sPlayer) sPlayer.playVideo();
}
function closeSQ(){
  document.getElementById("modalSQ").classList.add("hidden");
  sActiveQ = null;
  if(window.speechSynthesis) window.speechSynthesis.cancel();
}

function speakSQ(){
  if(!("speechSynthesis" in window)) return;
  const txt = document.getElementById("sqText").innerText;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = "bg-BG";
  u.rate = 0.9;
  window.speechSynthesis.speak(u);
}

function finishStudent(){
  stopStudentTick();
  // save locally only for home mode
  const saved = (sMode === "home");
  if(saved){
    const arr = loadResults();
    arr.unshift({
      student: sStudentName,
      lesson: sLessonTitle,
      score: sScore,
      max: sMax,
      at: new Date().toISOString()
    });
    localStorage.setItem(LS_RESULTS, JSON.stringify(arr.slice(0,200)));
  }

  document.getElementById("finInfo").innerText =
    `${sStudentName} ‚Ä¢ ${sLessonTitle} ‚Ä¢ —Ä–µ–∂–∏–º: ${sMode==="home"?"–î–æ–º–∞—à–Ω–æ":sMode==="sop"?"–°–û–ü":"–û–±—Å—ä–∂–¥–∞–Ω–µ"}`;
  document.getElementById("finScore").innerText = String(sScore);
  document.getElementById("finMax").innerText = String(sMax);
  document.getElementById("finSaved").innerText =
    saved ? "‚úÖ –†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω –ª–æ–∫–∞–ª–Ω–æ." : "‚ÑπÔ∏è –†–µ–∂–∏–º –æ–±—Å—ä–∂–¥–∞–Ω–µ ‚Äì —Ä–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –ù–ï —Å–µ –∑–∞–ø–∏—Å–≤–∞.";

  go("finish");
}

/* =========================
   Results (local)
========================= */
function loadResults(){
  try { return JSON.parse(localStorage.getItem(LS_RESULTS) || "[]"); }
  catch { return []; }
}

/* =========================
   Small helpers
========================= */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   Boot
========================= */
go("welcome");
</script>
</body>
</html>
