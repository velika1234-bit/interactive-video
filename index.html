<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>VideoQuiz Ultimate</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (—Ñ–∏–∫—Å–∏—Ä–∞–Ω–∞ –≤–µ—Ä—Å–∏—è + –ø—Ä–µ–¥–ø–∞–∑–∏—Ç–µ–ª) -->
  <script defer src="https://unpkg.com/lucide@0.454.0/dist/umd/lucide.min.js"></script>
  <script>
    window.lucide = window.lucide || { createIcons(){} };
  </script>

  <!-- YouTube API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <script>
    try {
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Nunito', 'sans-serif'] },
            colors: {
              brand: { 50:'#eef2ff',100:'#e0e7ff',500:'#6366f1',600:'#4f46e5',700:'#4338ca',900:'#312e81' }
            }
          }
        }
      }
    } catch {}
  </script>

  <style>
    body { font-family: 'Nunito', system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: pop .35s cubic-bezier(.16,1,.3,1) forwards; }
    .sop-text { font-size: 1.5rem !important; line-height: 1.3 !important; }
    .sop-btn { font-size: 1.25rem !important; padding: 1.5rem !important; }
    #ind-overlay { z-index: 2147483647 !important; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-brand-100 selection:text-brand-700">

  <div id="app" class="h-full flex flex-col relative">

    <!-- Loader -->
    <div id="auth-loader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center flex-col gap-6">
      <div class="relative">
        <div class="w-20 h-20 border-4 border-slate-100 rounded-full"></div>
        <div class="w-20 h-20 border-4 border-brand-600 rounded-full animate-spin absolute top-0 left-0 border-t-transparent"></div>
        <div class="absolute top-0 left-0 w-20 h-20 flex items-center justify-center text-2xl">üéì</div>
      </div>
      <p class="font-black text-brand-900 text-lg tracking-widest animate-pulse">–ó–ê–†–ï–ñ–î–ê–ù–ï...</p>
    </div>

    <!-- Toasts -->
    <div id="msg-container" class="fixed top-6 right-6 z-[10000] flex flex-col items-end pointer-events-none gap-2"></div>

    <!-- SCREEN: WELCOME -->
    <div id="screen-welcome" class="flex h-full w-full bg-slate-50 relative z-10 overflow-hidden flex-col md:flex-row">

      <!-- Student side -->
      <div id="welcome-student-side" class="flex-1 relative flex flex-col justify-center items-center p-4 md:p-12 bg-white overflow-y-auto w-full h-full md:h-auto">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 via-purple-500 to-pink-500"></div>

        <div class="w-full max-w-lg space-y-6 pb-20 md:pb-0">
          <div class="text-center space-y-1">
            <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tight">VideoQuiz</h1>
            <p class="text-slate-500 font-bold text-sm md:text-lg">–£—á–∏ –∏ —Å–µ –∑–∞–±–∞–≤–ª—è–≤–∞–π!</p>
          </div>

          <div class="flex border-b border-slate-200 mb-4 md:hidden">
            <button onclick="window.switchTab('solo')" id="tab-solo" class="flex-1 pb-2 text-sm font-bold text-brand-600 border-b-2 border-brand-600 transition-all">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</button>
            <button onclick="window.switchTab('class')" id="tab-class" class="flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all">–í –ö–ª–∞—Å</button>
          </div>

          <!-- SOLO -->
          <div id="panel-solo" class="bg-white p-1 rounded-2xl border border-slate-200 shadow-lg shadow-slate-100/50">
            <div class="bg-slate-50 rounded-xl p-5 border border-slate-100">
              <div class="flex items-center gap-2 mb-3 text-brand-700">
                <i data-lucide="play-circle" class="w-5 h-5"></i>
                <h3 class="font-black text-base">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</h3>
              </div>

              <form onsubmit="event.preventDefault(); window.startIndividual();" class="space-y-3">
                <input type="text" id="ind-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ..." class="w-full p-3 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 text-sm focus:border-brand-500 outline-none transition-all" autocomplete="off">
                <input type="text" id="ind-quiz-code" placeholder="–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫..." class="w-full p-3 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 text-sm focus:border-brand-500 outline-none transition-all" autocomplete="off">

                <div class="flex gap-2">
                  <label class="flex-1 flex items-center justify-center gap-1 cursor-pointer bg-white p-2 rounded-lg border border-slate-200 text-[10px] font-bold text-slate-600">
                    <input type="checkbox" id="ind-sop-mode" class="accent-brand-600 mr-1"> –°–û–ü üîä
                  </label>
                  <label class="flex-1 flex items-center justify-center gap-1 cursor-pointer bg-white p-2 rounded-lg border border-slate-200 text-[10px] font-bold text-slate-600">
                    <input type="checkbox" id="ind-discussion-mode" class="accent-amber-500 mr-1"> –û–±—Å—ä–∂–¥–∞–Ω–µ
                  </label>
                </div>

                <button type="submit" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-black uppercase text-xs tracking-wider shadow-md active:scale-[0.98] transition-all">–°—Ç–∞—Ä—Ç</button>
              </form>
            </div>
          </div>

          <!-- CLASS JOIN -->
          <div id="panel-class" class="hidden md:block relative group">
            <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-2xl opacity-30 blur"></div>
            <div class="relative bg-white p-5 rounded-2xl border border-slate-100 shadow-xl">
              <div class="flex items-center gap-2 mb-3 text-emerald-700">
                <i data-lucide="users" class="w-5 h-5"></i>
                <h3 class="font-black text-base">–í –ö–ª–∞—Å (–ù–∞ –∂–∏–≤–æ)</h3>
              </div>
              <form onsubmit="event.preventDefault(); window.joinLiveSession();" class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                  <input type="text" id="live-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="w-full p-3 bg-slate-50 rounded-xl border-2 border-transparent focus:bg-white focus:border-emerald-500 font-bold text-center text-sm outline-none transition-all" autocomplete="off">
                  <input type="number" id="live-pin" placeholder="–ü–ò–ù" class="w-full p-3 bg-slate-50 rounded-xl border-2 border-transparent focus:bg-white focus:border-emerald-500 font-black text-center text-lg tracking-widest outline-none transition-all" inputmode="numeric" autocomplete="off">
                </div>
                <button type="submit" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-black uppercase text-xs tracking-wider shadow-md active:scale-[0.98] transition-all">–í–ª–µ–∑</button>
              </form>
            </div>
          </div>

          <div class="md:hidden text-center pt-4">
            <button onclick="window.toggleMobileView('teacher')" class="text-xs font-bold text-slate-400 hover:text-brand-600 underline">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥ ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- Teacher side -->
      <div id="welcome-teacher-side" class="hidden md:flex w-full md:w-[420px] bg-slate-900 text-white p-8 flex-col justify-center relative overflow-hidden shrink-0 h-full">
        <button onclick="window.toggleMobileView('student')" class="md:hidden absolute top-6 left-6 text-slate-400 hover:text-white flex items-center gap-2 font-bold text-sm">
          <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
        </button>

        <div class="relative z-10 w-full max-w-sm mx-auto space-y-6">
          <div>
            <h2 class="text-3xl font-black mb-1">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥</h2>
            <p class="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ—Ü–∏.</p>
          </div>

          <form onsubmit="event.preventDefault(); window.handleAuthSubmit();" class="space-y-4">
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1">–ò–º–µ–π–ª</label>
              <input type="email" id="auth-email" placeholder="name@school.bg" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-600 focus:bg-white/10 focus:border-brand-500 outline-none transition-all font-bold text-sm" autocomplete="username">
            </div>

            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1">–ü–∞—Ä–æ–ª–∞</label>
              <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-600 focus:bg-white/10 focus:border-brand-500 outline-none transition-all font-bold text-sm" autocomplete="current-password">
            </div>

            <div id="auth-teacher-code-container" class="hidden space-y-1">
              <label class="text-[10px] font-bold text-amber-500 uppercase tracking-wider pl-1">–ö–æ–¥</label>
              <input type="password" id="auth-teacher-code" placeholder="vilidaf76" class="w-full p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl text-amber-200 placeholder-amber-500/50 outline-none font-bold text-center tracking-widest text-sm">
            </div>

            <button type="submit" id="auth-submit-btn" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-black uppercase tracking-wider shadow-lg active:scale-[0.98] transition-all">–í–ª–µ–∑</button>
          </form>

          <div class="text-center pt-4 border-t border-white/5">
            <button onclick="window.toggleAuthMode()" class="text-sm text-slate-400 hover:text-white font-bold transition-colors">
              –ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? <span class="text-brand-400">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            </button>
          </div>
        </div>
      </div>
    </div>
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>VideoQuiz Ultimate</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (—Ñ–∏–∫—Å–∏—Ä–∞–Ω–∞ –≤–µ—Ä—Å–∏—è + –ø—Ä–µ–¥–ø–∞–∑–∏—Ç–µ–ª) -->
  <script defer src="https://unpkg.com/lucide@0.454.0/dist/umd/lucide.min.js"></script>
  <script>
    window.lucide = window.lucide || { createIcons(){} };
  </script>

  <!-- YouTube API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <script>
    try {
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Nunito', 'sans-serif'] },
            colors: {
              brand: { 50:'#eef2ff',100:'#e0e7ff',500:'#6366f1',600:'#4f46e5',700:'#4338ca',900:'#312e81' }
            }
          }
        }
      }
    } catch {}
  </script>

  <style>
    body { font-family: 'Nunito', system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: pop .35s cubic-bezier(.16,1,.3,1) forwards; }
    .sop-text { font-size: 1.5rem !important; line-height: 1.3 !important; }
    .sop-btn { font-size: 1.25rem !important; padding: 1.5rem !important; }
    #ind-overlay { z-index: 2147483647 !important; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-brand-100 selection:text-brand-700">

  <div id="app" class="h-full flex flex-col relative">

    <!-- Loader -->
    <div id="auth-loader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center flex-col gap-6">
      <div class="relative">
        <div class="w-20 h-20 border-4 border-slate-100 rounded-full"></div>
        <div class="w-20 h-20 border-4 border-brand-600 rounded-full animate-spin absolute top-0 left-0 border-t-transparent"></div>
        <div class="absolute top-0 left-0 w-20 h-20 flex items-center justify-center text-2xl">üéì</div>
      </div>
      <p class="font-black text-brand-900 text-lg tracking-widest animate-pulse">–ó–ê–†–ï–ñ–î–ê–ù–ï...</p>
    </div>

    <!-- Toasts -->
    <div id="msg-container" class="fixed top-6 right-6 z-[10000] flex flex-col items-end pointer-events-none gap-2"></div>

    <!-- SCREEN: WELCOME -->
    <div id="screen-welcome" class="flex h-full w-full bg-slate-50 relative z-10 overflow-hidden flex-col md:flex-row">

      <!-- Student side -->
      <div id="welcome-student-side" class="flex-1 relative flex flex-col justify-center items-center p-4 md:p-12 bg-white overflow-y-auto w-full h-full md:h-auto">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 via-purple-500 to-pink-500"></div>

        <div class="w-full max-w-lg space-y-6 pb-20 md:pb-0">
          <div class="text-center space-y-1">
            <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tight">VideoQuiz</h1>
            <p class="text-slate-500 font-bold text-sm md:text-lg">–£—á–∏ –∏ —Å–µ –∑–∞–±–∞–≤–ª—è–≤–∞–π!</p>
          </div>

          <div class="flex border-b border-slate-200 mb-4 md:hidden">
            <button onclick="window.switchTab('solo')" id="tab-solo" class="flex-1 pb-2 text-sm font-bold text-brand-600 border-b-2 border-brand-600 transition-all">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</button>
            <button onclick="window.switchTab('class')" id="tab-class" class="flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all">–í –ö–ª–∞—Å</button>
          </div>

          <!-- SOLO -->
          <div id="panel-solo" class="bg-white p-1 rounded-2xl border border-slate-200 shadow-lg shadow-slate-100/50">
            <div class="bg-slate-50 rounded-xl p-5 border border-slate-100">
              <div class="flex items-center gap-2 mb-3 text-brand-700">
                <i data-lucide="play-circle" class="w-5 h-5"></i>
                <h3 class="font-black text-base">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</h3>
              </div>

              <form onsubmit="event.preventDefault(); window.startIndividual();" class="space-y-3">
                <input type="text" id="ind-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ..." class="w-full p-3 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 text-sm focus:border-brand-500 outline-none transition-all" autocomplete="off">
                <input type="text" id="ind-quiz-code" placeholder="–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫..." class="w-full p-3 bg-white rounded-xl border border-slate-200 font-bold text-slate-700 text-sm focus:border-brand-500 outline-none transition-all" autocomplete="off">

                <div class="flex gap-2">
                  <label class="flex-1 flex items-center justify-center gap-1 cursor-pointer bg-white p-2 rounded-lg border border-slate-200 text-[10px] font-bold text-slate-600">
                    <input type="checkbox" id="ind-sop-mode" class="accent-brand-600 mr-1"> –°–û–ü üîä
                  </label>
                  <label class="flex-1 flex items-center justify-center gap-1 cursor-pointer bg-white p-2 rounded-lg border border-slate-200 text-[10px] font-bold text-slate-600">
                    <input type="checkbox" id="ind-discussion-mode" class="accent-amber-500 mr-1"> –û–±—Å—ä–∂–¥–∞–Ω–µ
                  </label>
                </div>

                <button type="submit" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-black uppercase text-xs tracking-wider shadow-md active:scale-[0.98] transition-all">–°—Ç–∞—Ä—Ç</button>
              </form>
            </div>
          </div>

          <!-- CLASS JOIN -->
          <div id="panel-class" class="hidden md:block relative group">
            <div class="absolute -inset-0.5 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-2xl opacity-30 blur"></div>
            <div class="relative bg-white p-5 rounded-2xl border border-slate-100 shadow-xl">
              <div class="flex items-center gap-2 mb-3 text-emerald-700">
                <i data-lucide="users" class="w-5 h-5"></i>
                <h3 class="font-black text-base">–í –ö–ª–∞—Å (–ù–∞ –∂–∏–≤–æ)</h3>
              </div>
              <form onsubmit="event.preventDefault(); window.joinLiveSession();" class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                  <input type="text" id="live-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="w-full p-3 bg-slate-50 rounded-xl border-2 border-transparent focus:bg-white focus:border-emerald-500 font-bold text-center text-sm outline-none transition-all" autocomplete="off">
                  <input type="number" id="live-pin" placeholder="–ü–ò–ù" class="w-full p-3 bg-slate-50 rounded-xl border-2 border-transparent focus:bg-white focus:border-emerald-500 font-black text-center text-lg tracking-widest outline-none transition-all" inputmode="numeric" autocomplete="off">
                </div>
                <button type="submit" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-black uppercase text-xs tracking-wider shadow-md active:scale-[0.98] transition-all">–í–ª–µ–∑</button>
              </form>
            </div>
          </div>

          <div class="md:hidden text-center pt-4">
            <button onclick="window.toggleMobileView('teacher')" class="text-xs font-bold text-slate-400 hover:text-brand-600 underline">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥ ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- Teacher side -->
      <div id="welcome-teacher-side" class="hidden md:flex w-full md:w-[420px] bg-slate-900 text-white p-8 flex-col justify-center relative overflow-hidden shrink-0 h-full">
        <button onclick="window.toggleMobileView('student')" class="md:hidden absolute top-6 left-6 text-slate-400 hover:text-white flex items-center gap-2 font-bold text-sm">
          <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
        </button>

        <div class="relative z-10 w-full max-w-sm mx-auto space-y-6">
          <div>
            <h2 class="text-3xl font-black mb-1">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥</h2>
            <p class="text-slate-400 text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ—Ü–∏.</p>
          </div>

          <form onsubmit="event.preventDefault(); window.handleAuthSubmit();" class="space-y-4">
            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1">–ò–º–µ–π–ª</label>
              <input type="email" id="auth-email" placeholder="name@school.bg" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-600 focus:bg-white/10 focus:border-brand-500 outline-none transition-all font-bold text-sm" autocomplete="username">
            </div>

            <div class="space-y-1">
              <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-1">–ü–∞—Ä–æ–ª–∞</label>
              <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-600 focus:bg-white/10 focus:border-brand-500 outline-none transition-all font-bold text-sm" autocomplete="current-password">
            </div>

            <div id="auth-teacher-code-container" class="hidden space-y-1">
              <label class="text-[10px] font-bold text-amber-500 uppercase tracking-wider pl-1">–ö–æ–¥</label>
              <input type="password" id="auth-teacher-code" placeholder="vilidaf76" class="w-full p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl text-amber-200 placeholder-amber-500/50 outline-none font-bold text-center tracking-widest text-sm">
            </div>

            <button type="submit" id="auth-submit-btn" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-black uppercase tracking-wider shadow-lg active:scale-[0.98] transition-all">–í–ª–µ–∑</button>
          </form>

          <div class="text-center pt-4 border-t border-white/5">
            <button onclick="window.toggleAuthMode()" class="text-sm text-slate-400 hover:text-white font-bold transition-colors">
              –ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? <span class="text-brand-400">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- SCREEN: TEACHER DASHBOARD -->
    <div id="screen-teacher-dashboard" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-20">
      <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center sticky top-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-200">
            <i data-lucide="library" class="w-5 h-5"></i>
          </div>
          <div class="hidden sm:block">
            <h1 class="font-black text-slate-800 text-lg leading-tight">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
            <p id="user-email-display" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">...</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="window.openImportModal()" class="p-2 text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all" title="–ò–º–ø–æ—Ä—Ç">
            <i data-lucide="download" class="w-5 h-5"></i>
          </button>
          <button onclick="window.createNewQuiz()" class="px-5 py-2.5 bg-brand-600 text-white rounded-xl font-bold text-xs hover:bg-brand-700 transition-all shadow-md flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">–ù–æ–≤ –£—Ä–æ–∫</span>
          </button>
          <button onclick="window.handleLogout()" class="p-2 text-slate-400 hover:text-rose-500 transition-colors ml-2" title="–ò–∑—Ö–æ–¥">
            <i data-lucide="log-out" class="w-5 h-5"></i>
          </button>
        </div>
      </header>

      <main class="flex-1 overflow-y-auto p-4 md:p-6 max-w-7xl mx-auto w-full space-y-6">
        <section>
          <h2 class="text-lg md:text-xl font-black text-slate-800 mb-4">–í–∞—à–∏—Ç–µ –£—Ä–æ—Ü–∏</h2>
          <div id="my-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
        </section>

        <section class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-50/50 gap-4">
            <div class="flex items-center gap-4 bg-white p-1 rounded-xl border border-slate-200">
              <button onclick="window.switchHistoryTab('solo')" id="hist-tab-solo" class="px-4 py-2 rounded-lg font-bold text-xs transition-all bg-brand-600 text-white shadow-sm">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏</button>
              <button onclick="window.switchHistoryTab('class')" id="hist-tab-class" class="px-4 py-2 rounded-lg font-bold text-xs transition-all text-slate-500 hover:text-slate-800 hover:bg-slate-50">–í –ö–ª–∞—Å</button>
            </div>
          </div>

          <div id="hist-view-solo" class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase tracking-wider border-b border-slate-100">
                <tr><th class="p-4 pl-6">–£—á–µ–Ω–∏–∫</th><th class="p-4">–£—Ä–æ–∫</th><th class="p-4">–î–∞—Ç–∞</th><th class="p-4 text-right">–†–µ–∑—É–ª—Ç–∞—Ç</th><th class="p-4 text-center">–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
              </thead>
              <tbody id="solo-results-body" class="divide-y divide-slate-50"></tbody>
            </table>
          </div>

          <div id="hist-view-class" class="hidden overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase tracking-wider border-b border-slate-100">
                <tr><th class="p-4 pl-6">–î–∞—Ç–∞</th><th class="p-4">–£—Ä–æ–∫</th><th class="p-4">–ü–ò–ù</th><th class="p-4 text-center">–ò–Ω—Ñ–æ</th><th class="p-4 text-center">–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
              </thead>
              <tbody id="class-results-body" class="divide-y divide-slate-50"></tbody>
            </table>
            <div id="class-history-empty" class="hidden p-8 text-center text-slate-400 text-sm font-bold">–ù—è–º–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –∫–ª–∞—Å–Ω–∏ —Å–µ—Å–∏–∏.</div>
          </div>
        </section>
      </main>
    </div>

    <!-- SCREEN: EDITOR -->
    <div id="screen-create" class="hidden h-full flex flex-col bg-slate-100 absolute inset-0 z-30">
      <header class="bg-white border-b px-6 py-3 flex justify-between items-center sticky top-0 z-30 shadow-sm">
        <div class="flex items-center gap-4">
          <button onclick="window.switchScreen('teacher-dashboard')" class="p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-all">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </button>
          <h2 class="font-black text-slate-800 text-lg">–†–µ–¥–∞–∫—Ç–æ—Ä</h2>
        </div>
        <button onclick="window.saveQuizToLibrary()" class="px-6 py-2.5 bg-brand-600 text-white rounded-xl font-bold text-sm shadow-md hover:bg-brand-700 transition-all flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i> –ó–∞–ø–∞–∑–∏
        </button>
      </header>

      <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <div class="flex-1 bg-black relative flex flex-col justify-center">
          <div id="editor-player-container" class="aspect-video w-full max-h-full mx-auto relative z-10"></div>

          <div id="editor-video-input" class="absolute inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-8 gap-4">
            <div class="w-full max-w-md space-y-4 text-center">
              <h3 class="text-white font-black text-2xl">–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –í–∏–¥–µ–æ</h3>
              <input type="text" id="yt-url" placeholder="YouTube –ª–∏–Ω–∫..." class="w-full pl-4 pr-4 py-3 rounded-xl border-none shadow-xl bg-white text-slate-800 font-bold text-sm outline-none">
              <button onclick="window.loadEditorVideo()" class="w-full px-6 py-3 bg-brand-600 text-white rounded-xl font-bold text-sm shadow-xl hover:bg-brand-700 transition-all">–ó–ê–†–ï–î–ò</button>
              <p class="text-slate-500 text-xs">–ö–æ–ø–∏—Ä–∞–π—Ç–µ –ª–∏–Ω–∫ –æ—Ç YouTube –∏ –≥–æ –ø–æ—Å—Ç–∞–≤–µ—Ç–µ —Ç—É–∫.</p>
            </div>
          </div>
        </div>

        <div class="w-full lg:w-96 bg-white border-l border-slate-200 flex flex-col z-20 shadow-xl h-1/2 lg:h-full">
          <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
            <span class="text-xs font-black text-slate-400 uppercase">–í—ä–ø—Ä–æ—Å–∏</span>
            <div class="flex items-center gap-3">
              <div class="bg-brand-100 text-brand-700 px-3 py-1 rounded-lg font-mono font-bold text-xs" id="timer">00:00</div>
              <button onclick="window.openQuestionModal()" class="w-8 h-8 bg-brand-600 text-white rounded-full flex items-center justify-center hover:scale-110 shadow-lg" title="–î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å">
                <i data-lucide="plus" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
          <div id="q-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
        </div>
      </div>
    </div>

    <!-- SCREEN: LIVE HOST -->
    <div id="screen-live-host" class="hidden h-full flex flex-col bg-slate-900 absolute inset-0 z-40">
      <div class="bg-slate-800 text-white px-6 py-3 shadow-lg flex justify-between items-center shrink-0 z-20 border-b border-slate-700 h-16">
        <div class="flex items-center gap-4">
          <div class="bg-brand-600 px-4 py-1.5 rounded-lg shadow-lg">
            <span class="text-[9px] uppercase font-bold text-brand-200 block">–ö–û–î</span>
            <h1 id="host-pin" class="text-2xl font-black leading-none text-white">...</h1>
          </div>
          <div class="text-slate-300 text-xs font-bold flex items-center gap-2">
            <i data-lucide="users" class="w-4 h-4"></i> <span id="host-participant-count">0</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="window.finishLiveSession()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-xs">–ó–ê–ü–ê–ó–ò & –ö–†–ê–ô</button>
          <button onclick="window.quitHostSession()" class="px-4 py-2 bg-slate-700 text-slate-200 rounded-lg font-bold text-xs border border-slate-600">–ö–†–ê–ô (–±–µ–∑ –∑–∞–ø–∏—Å)</button>
        </div>
      </div>

      <div class="flex-1 flex flex-col lg:flex-row overflow-hidden p-3 gap-3">
        <div class="flex-1 bg-black rounded-2xl shadow-xl overflow-hidden relative border-4 border-white/20 min-h-[300px]">
          <div id="host-video-container" class="w-full h-full"></div>

          <div id="host-setup-area" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 backdrop-blur-sm gap-6">
            <button onclick="window.initHostPlayer()" class="px-10 py-5 bg-brand-600 text-white rounded-2xl font-black text-2xl hover:bg-brand-500 shadow-2xl flex items-center gap-3 transform hover:scale-105 transition-all">
              <i data-lucide="play" class="w-8 h-8"></i> –°–¢–ê–†–¢
            </button>
            <p class="text-slate-400 font-bold">–ò–∑—á–∞–∫–∞–π—Ç–µ –≤—Å–∏—á–∫–∏ –¥–∞ —Å–µ –ø—Ä–∏—Å—ä–µ–¥–∏–Ω—è—Ç.</p>
          </div>

          <div id="host-resume-overlay" class="hidden absolute inset-0 flex-col items-center justify-center bg-black/80 z-30 backdrop-blur-sm gap-6">
            <div class="text-white text-3xl font-black mb-4">–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∞–∫—Ç–∏–≤–µ–Ω!</div>
            <button onclick="window.resumeHostSession()" class="px-10 py-5 bg-emerald-500 text-white rounded-2xl font-black text-2xl hover:bg-emerald-600 shadow-2xl flex items-center gap-3 transform hover:scale-105 transition-all">
              <i data-lucide="play-circle" class="w-8 h-8"></i> –ü–†–û–î–™–õ–ñ–ò –í–ò–î–ï–û–¢–û
            </button>
          </div>
        </div>

        <div class="w-full lg:w-80 flex flex-col shrink-0 bg-white border-l border-slate-200 z-30 shadow-2xl h-1/3 lg:h-full">
          <div class="p-3 border-b border-slate-100 bg-slate-50">
            <h3 class="font-black text-slate-800 uppercase text-xs flex items-center gap-2">
              <i data-lucide="trophy" class="w-4 h-4 text-amber-500"></i> –ö–ª–∞—Å–∏—Ä–∞–Ω–µ
            </h3>
          </div>
          <div class="flex-1 overflow-y-auto p-2 scrollbar-hide bg-slate-50">
            <table class="w-full text-left border-separate border-spacing-y-2">
              <tbody id="host-results-body"></tbody>
            </table>
          </div>
          <div id="host-qr-container" class="p-6 border-t border-slate-200 bg-white flex flex-col items-center justify-center shrink-0"></div>
        </div>
      </div>
    </div>

    <!-- SCREEN: LIVE CLIENT -->
    <div id="screen-live-client" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-50 overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-2 bg-brand-500 z-20"></div>

      <div id="client-waiting" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-8">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-5xl shadow-xl animate-bounce border-4 border-slate-100" id="client-status-emoji">üëÄ</div>
        <div>
          <h2 class="text-2xl font-black text-slate-800 mb-2" id="client-status-title">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞!</h2>
          <p class="text-slate-500 font-bold">–û—á–∞–∫–≤–∞–π –≤—ä–ø—Ä–æ—Å...</p>
        </div>
        <div class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-3">
          <span id="my-avatar-display" class="text-2xl">üòé</span>
          <p class="font-black text-slate-800 text-lg leading-none" id="client-player-name">...</p>
        </div>
      </div>

      <div id="client-question" class="hidden flex-1 flex flex-col p-6 pb-32 overflow-y-auto">
        <div class="bg-white p-6 rounded-3xl shadow-lg border-b-8 border-slate-100 mb-6 text-center">
          <p id="live-q-text-client" class="text-xl font-black text-slate-800 leading-snug">...</p>
        </div>
        <div id="live-options-client" class="space-y-4 max-w-md mx-auto w-full"></div>
        <button id="live-confirm-btn" onclick="window.confirmLiveAnswer()" class="hidden fixed bottom-6 left-6 right-6 py-4 bg-brand-600 text-white rounded-2xl font-black text-lg shadow-xl hover:bg-brand-700 transition-all z-50">–ü–û–¢–í–™–†–î–ò</button>
      </div>

      <div id="client-finished" class="hidden flex-1 flex flex-col items-center justify-center p-8 bg-brand-600 text-white text-center absolute inset-0 z-50">
        <h1 class="text-5xl font-black mb-2 animate-pop">–ö–†–ê–ô!</h1>
        <p class="font-bold opacity-80 mb-10 text-xl">–¢–≤–æ—è—Ç —Ä–µ–∑—É–ª—Ç–∞—Ç:</p>
        <div class="bg-white text-brand-600 w-40 h-40 rounded-full flex items-center justify-center font-black text-6xl shadow-2xl mb-10 border-8 border-brand-400" id="final-score-display">0</div>
        <button onclick="location.reload()" class="px-10 py-4 bg-brand-800 hover:bg-brand-900 rounded-2xl font-bold text-lg shadow-lg">–ù–æ–≤–∞ –∏–≥—Ä–∞</button>
      </div>
    </div>

    <!-- SCREEN: SOLO SOLVE -->
    <div id="screen-solve" class="hidden h-full flex flex-col bg-black absolute inset-0 z-50">
      <div class="flex-1 relative flex items-center justify-center">
        <div id="solve-player-container" class="w-full h-full absolute inset-0"></div>

        <div id="ind-overlay" class="absolute inset-0 bg-slate-900/95 hidden flex-col items-center justify-center p-6 sm:p-10 overflow-y-auto">
          <div class="w-full max-w-2xl space-y-10 text-center relative">
            <button onclick="window.speakQuestion()" id="ind-speak-btn" class="hidden absolute -top-12 right-0 p-3 bg-brand-600 text-white rounded-full shadow-lg hover:bg-brand-500" title="–ü—Ä–æ—á–µ—Ç–∏ –≤—ä–ø—Ä–æ—Å–∞">
              <i data-lucide="volume-2" class="w-6 h-6"></i>
            </button>
            <h2 id="ind-overlay-q-text" class="font-black text-white leading-tight drop-shadow-lg text-3xl">–í—ä–ø—Ä–æ—Å?</h2>
            <div id="ind-overlay-options" class="grid gap-4 w-full"></div>
            <button id="ind-confirm-btn" onclick="window.confirmSoloAnswer()" class="hidden w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg shadow-lg hover:bg-indigo-700 transition-all mt-4">–ü–û–¢–í–™–†–î–ò</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN: FINISH -->
    <div id="screen-finish" class="hidden h-full flex flex-col items-center justify-center bg-slate-50 p-8 text-center absolute inset-0 z-50">
      <div class="bg-white p-12 rounded-[3rem] shadow-2xl border-b-8 border-indigo-100 max-w-md w-full space-y-8 animate-pop">
        <div class="w-24 h-24 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto text-5xl mb-2">üèÜ</div>
        <div>
          <h2 class="text-3xl font-black text-slate-800 mb-2">–†–µ–∑—É–ª—Ç–∞—Ç</h2>
          <div id="res-score" class="text-6xl font-black text-indigo-600 py-2">0 / 0</div>
        </div>
        <button onclick="window.switchScreen('welcome')" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold uppercase tracking-wider hover:bg-slate-900 transition-all shadow-lg">–ù–∞—á–∞–ª–æ</button>
      </div>
    </div>

    <!-- MODAL: QUESTION -->
    <div id="modal-q" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-md">
      <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-pop border border-slate-200">
        <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
          <h3 class="font-black text-xl text-slate-800">–í—ä–ø—Ä–æ—Å</h3>
          <button onclick="window.closeModal('modal-q')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 text-slate-500 hover:bg-rose-100 hover:text-rose-500">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="p-8 overflow-y-auto space-y-6">
          <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">–¢–µ–∫—Å—Ç</label>
            <textarea id="m-text" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-slate-800 outline-none focus:border-brand-500 h-28 resize-none text-lg"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">–¢–∏–ø</label>
              <select id="m-type" onchange="window.updateModalFields()" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-sm outline-none appearance-none focus:border-brand-500">
                <option value="single">–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω</option>
                <option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω–∏</option>
                <option value="boolean">–í—è—Ä–Ω–æ / –ì—Ä–µ—à–Ω–æ</option>
                <option value="numeric_slider">–ü–ª—ä–∑–≥–∞—á (–ß–∏—Å–ª–æ)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">–¢–æ—á–∫–∏</label>
              <input type="number" id="m-points" value="1" min="0" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-brand-500">
            </div>
          </div>

          <div id="m-opts-container" class="pt-2 border-t border-slate-100"></div>
        </div>

        <div class="p-6 border-t bg-slate-50">
          <button onclick="window.saveQuestion()" class="w-full py-4 bg-brand-600 text-white rounded-2xl font-black uppercase tracking-wider hover:bg-brand-700 shadow-lg">–ó–∞–ø–∞–∑–∏</button>
        </div>
      </div>
    </div>

    <!-- MODAL: SHARE -->
    <div id="modal-share" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white rounded-3xl p-10 max-w-md w-full text-center space-y-8 animate-pop shadow-2xl">
        <div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-2">
          <i data-lucide="share-2" class="w-10 h-10"></i>
        </div>
        <div>
          <h3 class="text-2xl font-black text-slate-800">–°–ø–æ–¥–µ–ª–∏ –£—Ä–æ–∫–∞</h3>
          <p class="text-slate-500 font-bold mt-2">–ö–æ–¥ –∑–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–∞ —Ä–∞–±–æ—Ç–∞:</p>
        </div>
        <div class="relative group">
          <input type="text" id="share-code-display" readonly class="w-full p-5 bg-slate-50 border-2 border-slate-200 rounded-2xl font-mono text-sm text-slate-600 break-all pr-14 outline-none">
          <button onclick="window.copyShareCode()" class="absolute right-3 top-3 p-2 bg-white border border-slate-200 rounded-xl hover:bg-brand-50 hover:text-brand-600">
            <i data-lucide="copy" class="w-5 h-5"></i>
          </button>
        </div>
        <button onclick="window.closeModal('modal-share')" class="text-sm font-bold text-slate-400 hover:text-slate-800 transition-colors">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
    </div>

    <!-- MODAL: IMPORT -->
    <div id="modal-import" class="hidden fixed inset-0 bg-black/60 z-[100] items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white rounded-3xl p-8 max-w-lg w-full space-y-6 animate-pop shadow-2xl">
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-black text-slate-800">–ò–º–ø–æ—Ä—Ç</h3>
          <button onclick="window.closeModal('modal-import')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <textarea id="import-code-input" placeholder="–ö–æ–¥..." class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-mono text-xs h-40 resize-none outline-none focus:border-brand-500 transition-all"></textarea>
        <button onclick="window.submitImport()" class="w-full py-4 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 shadow-lg">–ò–ú–ü–û–†–¢–ò–†–ê–ô</button>
      </div>
    </div>

  </div> <!-- /#app -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
    updateDoc, deleteDoc, addDoc, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged, signOut,
    createUserWithEmailAndPassword, signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ---------- SAFE HELPERS ----------
  function safeLucide(){ try{ window.lucide?.createIcons?.(); }catch{} }
  function $(id){ return document.getElementById(id); }
  function showModal(id){ const m=$(id); m.classList.remove('hidden'); m.classList.add('flex'); safeLucide(); }
  function closeModal(id){ const m=$(id); m.classList.add('hidden'); m.classList.remove('flex'); }
  window.closeModal = closeModal;

  window.showMessage = (t,type='info')=>{
    const c=$('msg-container'); if(!c) return;
    const m=document.createElement('div');
    const bg = type==='error'?'bg-rose-500':type==='success'?'bg-emerald-600':'bg-brand-600';
    m.className=`p-4 rounded-xl text-white shadow-lg mb-2 animate-pop flex items-center gap-3 ${bg}`;
    m.innerText=t;
    c.appendChild(m);
    setTimeout(()=>m.remove(),3200);
  };

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
    authDomain: "videoquiz-ultimate.firebaseapp.com",
    projectId: "videoquiz-ultimate",
    storageBucket: "videoquiz-ultimate.firebasestorage.app",
    messagingSenderId: "793138692820",
    appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
  };

  const finalAppId = "videoquiz-ultimate-live";
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------- PATHS ----------
  const profileDoc = (uid)=>doc(db,'artifacts',finalAppId,'users',uid,'settings','profile');
  const myQuizzesCol = (uid)=>collection(db,'artifacts',finalAppId,'users',uid,'my_quizzes');
  const soloResultsCol = (uid)=>collection(db,'artifacts',finalAppId,'users',uid,'solo_results');
  const classHistoryCol = (uid)=>collection(db,'artifacts',finalAppId,'users',uid,'class_history');

  const sessionRef = (id)=>doc(db,'artifacts',finalAppId,'public','data','sessions',id);
  const participantsCol = (sid)=>collection(db,'artifacts',finalAppId,'public','data','sessions',sid,'participants');
  const participantRef = (sid,pid)=>doc(db,'artifacts',finalAppId,'public','data','sessions',sid,'participants',pid);

  // ---------- STATE ----------
  let user=null, isTeacher=false;
  let myQuizzes=[], soloResults=[], classHistory=[];
  let editingQuizId=null, questions=[], currentVideoId="";
  let player=null, solvePlayer=null, hostPlayer=null;
  let currentQuiz=null, currentQuizOwnerId=null;

  let scoreCount=0, soloGameFinished=false, currentQIndex=-1, lastAnsweredIndex=-1;
  let sopModeEnabled=false, isDiscussionMode=false, studentNameValue="", tempSelectedAnswer=null;

  let sessionID="", sessionDocId="", liveActiveQIdx=-1, liveScore=0;
  let lastFetchedParticipants=[], activeIntervals=[];
  let authMode='login';
  let activeHistoryTab='solo';

  const AVATARS=['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ'];

  // ---------- UTILS ----------
  function clearIntervals(){ activeIntervals.forEach(clearInterval); activeIntervals=[]; }
  function formatTime(s){ const m=Math.floor(s/60),sc=Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
  function formatDate(ts){ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString('bg-BG'); }
  function getTimestampMs(ts){ return ts?(ts.toMillis?ts.toMillis():ts.seconds*1000):0; }

  function encodeQuizCode(obj){ const json=JSON.stringify(obj); return btoa(unescape(encodeURIComponent(json))); }
  function decodeQuizCode(code){
    try{
      const cleaned=(code||'').trim().replace(/\s/g,'');
      const json=decodeURIComponent(escape(atob(cleaned)));
      return JSON.parse(json);
    }catch{ return null; }
  }

  // ---------- NAV / UI ----------
  window.toggleMobileView=(view)=>{
    $('welcome-student-side').classList.toggle('hidden',view!=='student');
    $('welcome-teacher-side').classList.toggle('hidden',view!=='teacher');
    $('welcome-teacher-side').classList.toggle('flex',view==='teacher');
  };

  window.switchTab=(tab)=>{
    $('panel-solo').classList.toggle('hidden',tab!=='solo');
    $('panel-class').classList.toggle('hidden',tab!=='class');
    $('tab-solo').className = tab==='solo'
      ? "flex-1 pb-2 text-sm font-bold text-brand-600 border-b-2 border-brand-600 transition-all"
      : "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all";
    $('tab-class').className = tab==='class'
      ? "flex-1 pb-2 text-sm font-bold text-emerald-600 border-b-2 border-emerald-600 transition-all"
      : "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all";
  };

  window.switchHistoryTab=(tab)=>{
    activeHistoryTab=tab;
    $('hist-tab-solo').className = tab==='solo'
      ? "px-4 py-2 rounded-lg font-bold text-xs transition-all bg-brand-600 text-white shadow-sm"
      : "px-4 py-2 rounded-lg font-bold text-xs transition-all text-slate-500 hover:text-slate-800 hover:bg-slate-50";
    $('hist-tab-class').className = tab==='class'
      ? "px-4 py-2 rounded-lg font-bold text-xs transition-all bg-brand-600 text-white shadow-sm"
      : "px-4 py-2 rounded-lg font-bold text-xs transition-all text-slate-500 hover:text-slate-800 hover:bg-slate-50";
    $('hist-view-solo').classList.toggle('hidden', tab!=='solo');
    $('hist-view-class').classList.toggle('hidden', tab!=='class');
    safeLucide();
  };

  window.switchScreen=(name)=>{
    // —Å–∫—Ä–∏–π –≤—Å–∏—á–∫–∏ –µ–∫—Ä–∞–Ω–∏ –≤—ä—Ç—Ä–µ –≤ app (—Å–∞–º–æ —Ç–µ–∑–∏ –∫–æ–∏—Ç–æ –ø–æ—á–≤–∞—Ç —Å—ä—Å screen-)
    document.querySelectorAll('[id^="screen-"]').forEach(el=>el.classList.add('hidden'));
    const t=$('screen-'+name);
    if(t) t.classList.remove('hidden');

    if(name==='teacher-dashboard'){
      window.loadMyQuizzes();
      window.loadSoloResults();
      window.loadClassHistory();
    }
    safeLucide();
    window.scrollTo(0,0);
  };

  // ---------- AUTH ----------
  window.toggleAuthMode=()=>{
    authMode = authMode==='login'?'register':'login';
    $('auth-teacher-code-container').classList.toggle('hidden',authMode!=='register');
    $('auth-submit-btn').innerText = authMode==='register'?'–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ':'–í–ª–µ–∑';
  };

  window.handleAuthSubmit=async()=>{
    const em=$('auth-email').value.trim();
    const ps=$('auth-password').value;
    try{
      if(authMode==='register'){
        if($('auth-teacher-code').value!=="vilidaf76") return window.showMessage("–ì—Ä–µ—à–µ–Ω –∫–æ–¥!","error");
        const cred=await createUserWithEmailAndPassword(auth, em, ps);
        await setDoc(profileDoc(cred.user.uid), { role:'teacher', email:em, emailNormalized: em.toLowerCase(), createdAt: serverTimestamp() });
      }else{
        await signInWithEmailAndPassword(auth, em, ps);
      }
    }catch(e){
      return window.showMessage("–ì—Ä–µ—à–∫–∞: "+(e?.message||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'),"error");
    }
  };

  window.handleLogout=async()=>{ await signOut(auth); location.reload(); };

  // ---------- TEACHER: LOAD / RENDER ----------
  window.loadMyQuizzes=()=>{
    if(!user) return;
    onSnapshot(myQuizzesCol(user.uid),(s)=>{
      myQuizzes=s.docs.map(d=>({ ...d.data(), id:d.id }));
      window.renderMyQuizzes();
    });
  };

  window.loadSoloResults=()=>{
    if(!user) return;
    onSnapshot(soloResultsCol(user.uid),(s)=>{
      soloResults=s.docs.map(d=>({ ...d.data(), id:d.id }));
      window.renderSoloResults();
    });
  };

  window.loadClassHistory=()=>{
    if(!user) return;
    onSnapshot(classHistoryCol(user.uid),(s)=>{
      classHistory=s.docs.map(d=>({ ...d.data(), id:d.id }));
      window.renderClassHistory();
    });
  };

  window.renderMyQuizzes=()=>{
    const c=$('my-quizzes-list'); if(!c) return;
    c.innerHTML = myQuizzes.map(q=>`
      <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-lg transition-all flex flex-col justify-between">
        <div class="mb-4">
          <h4 class="font-black text-slate-800 text-lg line-clamp-2">${q.title||'–ë–µ–∑ –∏–º–µ'}</h4>
          <p class="text-[10px] text-slate-400 font-black uppercase mt-2">${q.questions?.length||0} –≤—ä–ø—Ä–æ—Å–∞</p>
        </div>
        <div class="flex items-center gap-2 pt-4 border-t border-slate-50">
          <button onclick="window.startHostFromLibrary('${q.id}')" class="flex-1 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all shadow-sm">
            <i data-lucide="play" class="w-3.5 h-3.5"></i> –°—Ç–∞—Ä—Ç
          </button>
          <button onclick="window.showShareCode('${q.id}')" class="p-2.5 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-xl transition-all">
            <i data-lucide="share-2" class="w-4 h-4"></i>
          </button>
          <button onclick="window.editQuiz('${q.id}')" class="p-2.5 bg-slate-50 text-slate-500 hover:bg-slate-100 rounded-xl transition-all">
            <i data-lucide="pencil" class="w-4 h-4"></i>
          </button>
          <button onclick="window.deleteQuiz('${q.id}')" class="p-2.5 bg-rose-50 text-rose-500 hover:bg-rose-100 rounded-xl transition-all">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    `).join('');
    safeLucide();
  };

  window.renderSoloResults=()=>{
    const b=$('solo-results-body'); if(!b) return;
    const s=[...soloResults].sort((a,b)=>getTimestampMs(b.timestamp)-getTimestampMs(a.timestamp));
    b.innerHTML = s.map(r=>`
      <tr class="border-b border-slate-50 text-xs hover:bg-brand-50/30 transition-colors">
        <td class="p-4 font-bold text-slate-700">${r.studentName||'-'}</td>
        <td class="p-4 text-slate-500 truncate max-w-[120px]">${r.quizTitle||'-'}</td>
        <td class="p-4 text-slate-400 font-mono">${formatDate(r.timestamp)}</td>
        <td class="p-4 text-right"><span class="bg-brand-100 text-brand-700 px-2.5 py-1 rounded-lg font-black">${r.score||'-'}</span></td>
        <td class="p-4 text-center"><button onclick="window.deleteSoloResult('${r.id}')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
      </tr>
    `).join('');
    safeLucide();
  };

  window.renderClassHistory=()=>{
    const b=$('class-results-body'); const empty=$('class-history-empty');
    if(!b) return;
    if(classHistory.length===0){ b.innerHTML=''; empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    const s=[...classHistory].sort((a,b)=>getTimestampMs(b.timestamp)-getTimestampMs(a.timestamp));
    b.innerHTML = s.map(r=>`
      <tr class="border-b border-slate-50 text-xs hover:bg-slate-50 transition-colors">
        <td class="p-4 text-slate-400 font-mono">${formatDate(r.timestamp)}</td>
        <td class="p-4 font-bold text-slate-700">${r.quizTitle||'–ë–µ–∑ –∏–º–µ'}</td>
        <td class="p-4 text-slate-500 font-mono">${r.pin||'-'}</td>
        <td class="p-4 text-center"><button onclick="window.deleteClassSession('${r.id}','${r.sessionId}')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
      </tr>
    `).join('');
    safeLucide();
  };

  window.deleteSoloResult=async(id)=>{
    if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞?")) return;
    await deleteDoc(doc(soloResultsCol(user.uid), id));
  };

  window.deleteClassSession=async(historyId,sid)=>{
    if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∏ –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ —Å–µ—Å–∏—è—Ç–∞. –ü—Ä–æ–¥—ä–ª–∂–∏?")) return;
    await deleteDoc(doc(classHistoryCol(user.uid), historyId));
    try{
      await deleteDoc(sessionRef(sid));
      const snap=await getDocs(participantsCol(sid));
      await Promise.all(snap.docs.map(d=>deleteDoc(d.ref)));
    }catch{}
    window.showMessage("–ò–∑—Ç—Ä–∏—Ç–æ.","success");
  };

  // ---------- SHARE / IMPORT ----------
  window.showShareCode=(id)=>{
    const q=myQuizzes.find(x=>x.id===id); if(!q) return;
    const payload={ ownerId:user.uid, title:q.title||'–ë–µ–∑ –∏–º–µ', v:q.v, q:q.questions||[] };
    $('share-code-display').value = encodeQuizCode(payload);
    showModal('modal-share');
  };

  window.copyShareCode=()=>{
    $('share-code-display').select();
    document.execCommand('copy');
    window.showMessage("–ö–æ–ø–∏—Ä–∞–Ω–æ!","success");
  };

  window.openImportModal=()=>showModal('modal-import');

  window.submitImport=async()=>{
    const d=decodeQuizCode($('import-code-input').value);
    if(!d || !d.v || !Array.isArray(d.q)) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥","error");
    await addDoc(myQuizzesCol(user.uid), { title:d.title||'Import', v:d.v, questions:d.q, createdAt: serverTimestamp() });
    closeModal('modal-import');
    window.showMessage("–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!","success");
  };

  // ---------- EDITOR ----------
  function startEditorTimer(){
    clearIntervals();
    const tEl=$('timer');
    const i=setInterval(()=>{ try{ tEl.innerText=formatTime(Math.floor(player.getCurrentTime())); }catch{} },250);
    activeIntervals.push(i);
  }

  window.createNewQuiz=()=>{
    editingQuizId=null; questions=[]; currentVideoId="";
    $('yt-url').value="";
    $('editor-video-input').classList.remove('hidden');
    $('editor-player-container').innerHTML="";
    window.renderEditorList();
    window.switchScreen('create');
  };

  window.editQuiz=(id)=>{
    const q=myQuizzes.find(x=>x.id===id); if(!q) return;
    editingQuizId=id;
    questions=(q.questions||[]).slice();
    currentVideoId=q.v;
    $('yt-url').value=`https://youtu.be/${q.v}`;
    window.switchScreen('create');
    window.renderEditorList();
    $('editor-video-input').classList.add('hidden');
    $('editor-player-container').innerHTML='<div id="player"></div>';
    player=new YT.Player('player',{ videoId:currentVideoId, playerVars:{autoplay:0,controls:1}, events:{ onReady:startEditorTimer } });
  };

  window.loadEditorVideo=()=>{
    const url=$('yt-url').value.trim();
    const id=url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/)?.[1];
    if(!id) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω YouTube –ª–∏–Ω–∫","error");
    currentVideoId=id;
    $('editor-video-input').classList.add('hidden');
    $('editor-player-container').innerHTML='<div id="player"></div>';
    player=new YT.Player('player',{ videoId:id, playerVars:{autoplay:1,controls:1}, events:{ onReady:startEditorTimer } });
  };

  window.openQuestionModal=()=>{
    try{ player?.pauseVideo?.(); }catch{}
    $('m-text').value='';
    $('m-type').value='single';
    $('m-points').value=1;
    window.updateModalFields();
    showModal('modal-q');
  };

  window.updateModalFields=()=>{
    const type=$('m-type').value;
    const c=$('m-opts-container'); c.innerHTML='';
    if(type==='single' || type==='multiple'){
      c.innerHTML = `
        <div class="space-y-3">
          ${[1,2,3,4].map(n=>`
            <div class="opt-row flex items-center gap-3">
              <input type="text" placeholder="–û—Ç–≥–æ–≤–æ—Ä ${n}" class="flex-1 p-4 bg-slate-50 rounded-xl border-2 border-slate-200 text-sm font-bold focus:border-brand-500 outline-none">
              ${type==='single'
                ? `<label class="text-xs font-bold text-slate-500"><input type="radio" name="single-correct" value="${n-1}" class="mr-2 accent-brand-600">–í–µ—Ä–µ–Ω</label>`
                : `<label class="text-xs font-bold text-slate-500"><input type="checkbox" data-multi-correct="${n-1}" class="mr-2 accent-emerald-600">–í–µ—Ä–µ–Ω</label>`
              }
            </div>
          `).join('')}
        </div>`;
      setTimeout(()=>{ const r=document.querySelector('input[name="single-correct"][value="0"]'); if(r) r.checked=true; },0);
    }
    else if(type==='boolean'){
      c.innerHTML = `
        <div class="flex gap-4">
          <label class="flex-1 p-4 bg-emerald-50 rounded-xl border-2 border-emerald-200 cursor-pointer flex items-center justify-center gap-2 font-black text-emerald-700">
            <input type="radio" name="bool-val" value="true" checked> –î–ê
          </label>
          <label class="flex-1 p-4 bg-rose-50 rounded-xl border-2 border-rose-200 cursor-pointer flex items-center justify-center gap-2 font-black text-rose-700">
            <input type="radio" name="bool-val" value="false"> –ù–ï
          </label>
        </div>`;
    }
    else if(type==='numeric_slider'){
      c.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
          <input type="number" id="m-min" placeholder="–ú–∏–Ω" class="p-3 border rounded-xl" value="0">
          <input type="number" id="m-max" placeholder="–ú–∞–∫—Å" class="p-3 border rounded-xl" value="100">
          <input type="number" id="m-step" placeholder="–°—Ç—ä–ø–∫–∞" class="p-3 border rounded-xl" value="1">
          <input type="number" id="m-tolerance" placeholder="–¢–æ–ª–µ—Ä–∞–Ω—Å" class="p-3 border rounded-xl" value="0">
        </div>
        <input type="number" id="m-correct-num" placeholder="–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä" class="w-full p-3 border rounded-xl mt-4 font-bold" value="0">`;
    }
  };

  window.saveQuestion=()=>{
    const txt=$('m-text').value.trim();
    if(!txt) return window.showMessage("–í—ä–≤–µ–¥–µ—Ç–µ —Ç–µ–∫—Å—Ç!","error");
    const type=$('m-type').value;
    const pts=Number($('m-points').value)||0;
    const t = player?.getCurrentTime ? Math.floor(player.getCurrentTime()) : 0;

    const q={ time:t, text:txt, type, points:pts };

    if(type==='single'){
      const opts=[...document.querySelectorAll('.opt-row input[type="text"]')].map(x=>x.value.trim()).filter(Boolean);
      if(opts.length<2) return window.showMessage("–ü–æ–Ω–µ 2 –æ—Ç–≥–æ–≤–æ—Ä–∞.","error");
      q.options=opts;
      q.correct=Number(document.querySelector('input[name="single-correct"]:checked')?.value ?? 0);
    }
    if(type==='multiple'){
      const opts=[...document.querySelectorAll('.opt-row input[type="text"]')].map(x=>x.value.trim()).filter(Boolean);
      if(opts.length<2) return window.showMessage("–ü–æ–Ω–µ 2 –æ—Ç–≥–æ–≤–æ—Ä–∞.","error");
      q.options=opts;
      q.correct=[...document.querySelectorAll('input[type="checkbox"][data-multi-correct]')].filter(x=>x.checked).map(x=>Number(x.getAttribute('data-multi-correct')));
      if(!q.correct.length) return window.showMessage("–ú–∞—Ä–∫–∏—Ä–∞–π –ø–æ–Ω–µ 1 –≤–µ—Ä–µ–Ω.","error");
    }
    if(type==='boolean'){
      q.options=['–î–ê','–ù–ï'];
      q.correct=(document.querySelector('input[name="bool-val"]:checked')?.value==='true');
    }
    if(type==='numeric_slider'){
      q.min=Number(document.getElementById('m-min').value||0);
      q.max=Number(document.getElementById('m-max').value||100);
      q.step=Number(document.getElementById('m-step').value||1);
      q.tolerance=Number(document.getElementById('m-tolerance').value||0);
      q.correct=Number(document.getElementById('m-correct-num').value||0);
      q.options=[];
    }

    questions.push(q);
    questions.sort((a,b)=>a.time-b.time);
    window.renderEditorList();
    closeModal('modal-q');
  };

  window.renderEditorList=()=>{
    const el=$('q-list');
    el.innerHTML = questions.map((q,i)=>`
      <div class="p-4 bg-white border border-slate-200 shadow-sm rounded-xl mb-3 flex justify-between items-center hover:border-brand-300 transition-all">
        <div class="flex items-center gap-3">
          <span class="font-mono font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded-lg text-xs">${formatTime(q.time)}</span>
          <span class="truncate w-40 font-bold text-slate-700 text-sm">${q.text}</span>
          <span class="text-[10px] font-black text-slate-400 uppercase">(${q.type})</span>
        </div>
        <button onclick="questions.splice(${i},1);window.renderEditorList()" class="text-slate-300 hover:text-rose-500 transition-colors p-2 rounded-lg hover:bg-rose-50">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      </div>
    `).join('');
    safeLucide();
  };

  window.saveQuizToLibrary=async()=>{
    if(!currentVideoId) return window.showMessage("–ü—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–∏ –≤–∏–¥–µ–æ.","error");
    if(!questions.length) return window.showMessage("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ 1 –≤—ä–ø—Ä–æ—Å.","error");
    const existing = editingQuizId ? myQuizzes.find(x=>x.id===editingQuizId) : null;
    const title = prompt("–ò–º–µ –Ω–∞ —É—Ä–æ–∫–∞:", existing?.title || "");
    if(title===null) return;

    const data={ title:(title.trim()||'–ë–µ–∑ –∏–º–µ'), v:currentVideoId, questions, updatedAt: serverTimestamp() };

    try{
      if(editingQuizId) await updateDoc(doc(myQuizzesCol(user.uid), editingQuizId), data);
      else { data.createdAt=serverTimestamp(); await addDoc(myQuizzesCol(user.uid), data); }
      window.showMessage("–ó–∞–ø–∞–∑–µ–Ω–æ!","success");
      window.switchScreen('teacher-dashboard');
    }catch(e){
      window.showMessage("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: "+(e?.message||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'),"error");
    }
  };

  window.deleteQuiz=async(id)=>{
    if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞?")) return;
    await deleteDoc(doc(myQuizzesCol(user.uid), id));
  };

  // ---------- SOLO ----------
  window.speakQuestion=(text)=>{
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text||$('ind-overlay-q-text').innerText);
    u.lang='bg-BG'; u.rate=0.9;
    window.speechSynthesis.speak(u);
  };

  function scoreMultiplePartial(selected, correct, points){
    const P=points||1;
    const corr=Array.isArray(correct)?correct:[];
    const C=Math.max(1,corr.length);
    const setC=new Set(corr);
    let s=0;
    for(const idx of selected) s += setC.has(idx) ? (P/C) : -(P/C);
    return Math.max(0, Math.min(P, s));
  }

  window.startIndividual=async()=>{
    const code=$('ind-quiz-code').value.trim().replace(/\s/g,'');
    const nameInput=$('ind-student-name').value.trim();
    if(!code) return window.showMessage("–í—ä–≤–µ–¥–∏ –∫–æ–¥!","error");

    const dec=decodeQuizCode(code);
    if(!dec || !dec.v || !Array.isArray(dec.q)) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥","error");

    currentQuiz=dec;
    currentQuizOwnerId=dec.ownerId||null;
    sopModeEnabled=$('ind-sop-mode').checked;
    isDiscussionMode=$('ind-discussion-mode').checked;
    studentNameValue=nameInput||"–ê–Ω–æ–Ω–∏–º–µ–Ω";

    scoreCount=0; soloGameFinished=false; currentQIndex=-1; lastAnsweredIndex=-1;

    if(!auth.currentUser) await signInAnonymously(auth);

    window.switchScreen('solve');
    setTimeout(()=>{
      $('solve-player-container').innerHTML='<div id="solve-player"></div>';
      solvePlayer=new YT.Player('solve-player',{
        videoId: currentQuiz.v,
        width:'100%', height:'100%',
        playerVars:{autoplay:1,controls:1},
        events:{
          onStateChange:(e)=>{
            if(e.data===1){
              clearIntervals();
              const i=setInterval(()=>{
                const t=Math.floor(solvePlayer.getCurrentTime());
                const qIdx=currentQuiz.q.findIndex((qq,idx)=>idx>lastAnsweredIndex && t>= (qq.time||0));
                if(qIdx!==-1){ window.triggerSoloQuestion(currentQuiz.q[qIdx], qIdx); lastAnsweredIndex=qIdx; }
                if(solvePlayer.getDuration()>0 && t>=solvePlayer.getDuration()-1) window.finishSoloGame();
              },350);
              activeIntervals.push(i);
            } else if(e.data===0) window.finishSoloGame();
          }
        }
      });
    },400);
  };

  window.triggerSoloQuestion=(q,idx)=>{
    currentQIndex=idx;
    solvePlayer.pauseVideo();

    $('ind-overlay').classList.remove('hidden');
    $('ind-overlay').classList.add('flex');

    $('ind-overlay-q-text').innerText=q.text;

    if(sopModeEnabled){
      $('ind-overlay-q-text').classList.add('sop-text');
      $('ind-speak-btn').classList.remove('hidden');
      window.speakQuestion(q.text);
    }else{
      $('ind-overlay-q-text').classList.remove('sop-text');
      $('ind-speak-btn').classList.add('hidden');
      window.speechSynthesis?.cancel();
    }

    const c=$('ind-overlay-options');
    c.innerHTML='';
    tempSelectedAnswer=null;
    $('ind-confirm-btn').classList.add('hidden');

    const btnClass = sopModeEnabled
      ? "option-btn sop-btn w-full bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl text-white font-bold text-left backdrop-blur-md transition-all shadow-lg mb-2"
      : "option-btn w-full p-5 bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl text-white font-bold text-xl text-left backdrop-blur-md transition-all hover:scale-[1.01] active:scale-95 shadow-lg";

    if(q.type==='single' || q.type==='boolean'){
      const opts=q.type==='boolean'?['–î–ê','–ù–ï']:(q.options||[]);
      c.innerHTML = opts.map((o,i)=>`<button onclick="window.selectOptionSolo(this, ${q.type==='boolean'?(i===0):i})" class="${btnClass}">${o}</button>`).join('');
    }
    else if(q.type==='multiple'){
      const opts=q.options||[];
      c.innerHTML = opts.map((o,i)=>`
        <label class="${btnClass} flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="mt-2 w-5 h-5 accent-emerald-400" data-multi-idx="${i}">
          <span>${o}</span>
        </label>
      `).join('');
      $('ind-confirm-btn').classList.remove('hidden');
    }
    else if(q.type==='numeric_slider'){
      c.innerHTML = `
        <div class="w-full bg-white/20 p-6 rounded-2xl">
          <input type="range" id="solo-range" min="${q.min}" max="${q.max}" step="${q.step}" class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            oninput="document.getElementById('solo-range-val').innerText=this.value">
          <div class="text-white text-4xl font-black mt-4" id="solo-range-val">${Math.round((q.min+q.max)/2)}</div>
        </div>`;
      $('ind-confirm-btn').classList.remove('hidden');
    }else{
      c.innerHTML = `<div class="text-white/80 font-bold">–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ç–∏–ø (–≤ —Ç–æ–∑–∏ –±–∞–∑–æ–≤ —Ñ–∞–π–ª).</div>`;
      $('ind-confirm-btn').classList.remove('hidden');
    }
    safeLucide();
  };

  window.selectOptionSolo=(el,val)=>{
    document.querySelectorAll('#ind-overlay-options .option-btn').forEach(b=>b.classList.remove('border-indigo-500','bg-indigo-600/50'));
    el.classList.add('border-indigo-500','bg-indigo-600/50');
    tempSelectedAnswer=val;
    $('ind-confirm-btn').classList.remove('hidden');
  };

  window.confirmSoloAnswer=async()=>{
    if(!currentQuiz || !currentQuiz.q || currentQIndex<0) return;
    const q=currentQuiz.q[currentQIndex];
    let earned=0;

    if(q.type==='single' || q.type==='boolean'){
      const isCor=(tempSelectedAnswer===q.correct);
      earned=isCor ? (q.points||1) : 0;
    }else if(q.type==='numeric_slider'){
      const val=Number(document.getElementById('solo-range').value);
      const isCor=Math.abs(val-q.correct) <= (q.tolerance||0);
      earned=isCor ? (q.points||1) : 0;
    }else if(q.type==='multiple'){
      const selected=[...document.querySelectorAll('#ind-overlay-options input[type="checkbox"][data-multi-idx]')].filter(x=>x.checked).map(x=>Number(x.getAttribute('data-multi-idx')));
      earned = scoreMultiplePartial(selected, q.correct, q.points||1);
    }

    scoreCount += earned;
    window.showMessage(earned>0 ? `+${earned.toFixed(2)} —Ç.` : "0 —Ç.", earned>0 ? "success" : "error");

    $('ind-overlay').classList.add('hidden');
    $('ind-overlay').classList.remove('flex');
    window.speechSynthesis?.cancel();

    setTimeout(()=>solvePlayer.playVideo(),700);
  };

  window.finishSoloGame=async()=>{
    if(soloGameFinished) return;
    soloGameFinished=true;

    window.switchScreen('finish');
    const max=currentQuiz.q.reduce((a,b)=>a+(b.points||1),0);
    $('res-score').innerText=`${scoreCount.toFixed(2)} / ${max}`;

    if(isDiscussionMode) return;

    if(auth.currentUser && currentQuizOwnerId){
      try{
        await setDoc(doc(soloResultsCol(currentQuizOwnerId), `${auth.currentUser.uid}_${Date.now()}`), {
          studentName: studentNameValue,
          quizTitle: (currentQuiz.title||'') + (sopModeEnabled ? " (–°–û–ü)" : ""),
          score: `${scoreCount.toFixed(2)}/${max}`,
          timestamp: serverTimestamp(),
          userId: auth.currentUser.uid
        });
      }catch(e){
        // –∞–∫–æ rules –Ω–µ –ø–æ–∑–≤–æ–ª—è–≤–∞—Ç
      }
    }
  };

  // ---------- LIVE ----------
  window.joinLiveSession=async()=>{
    const pin=$('live-pin').value.trim();
    const name=$('live-student-name').value.trim();
    if(!pin || !name) return window.showMessage("–ü–æ–ø—ä–ª–Ω–∏ –∏–º–µ –∏ –ü–ò–ù!","error");

    if(!auth.currentUser) await signInAnonymously(auth);

    const snap=await getDoc(sessionRef(pin));
    if(!snap.exists()) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ü–ò–ù","error");

    sessionID=pin; sessionDocId=pin;
    liveScore=0; liveActiveQIdx=-1; lastAnsweredIndex=-1;
    studentNameValue=name;

    window.switchScreen('live-client');

    const ava=AVATARS[Math.floor(Math.random()*AVATARS.length)];
    $('my-avatar-display').innerText=ava;
    $('client-player-name').innerText=name;

    await setDoc(participantRef(pin, auth.currentUser.uid), { name, avatar:ava, score:0, joinedAt: serverTimestamp() }, { merge:true });

    onSnapshot(sessionRef(pin),(s)=>{
      const d=s.data(); if(!d) return;
      if(d.status==='finished'){
        $('client-question').classList.add('hidden');
        $('client-waiting').classList.add('hidden');
        $('client-finished').classList.remove('hidden');
        $('final-score-display').innerText = liveScore.toFixed(2);
        return;
      }
      if(d.status==='active' && d.activeQ!==liveActiveQIdx){
        liveActiveQIdx=d.activeQ;
        window.currentLiveQ=d.qData;
        $('client-question').classList.remove('hidden');
        $('client-waiting').classList.add('hidden');
        $('live-q-text-client').innerText=d.qData.text;
        window.renderLiveQuestionUI(d.qData);
        return;
      }
      $('client-question').classList.add('hidden');
      $('client-waiting').classList.remove('hidden');
    });
  };

  window.renderLiveQuestionUI=(q)=>{
    const c=$('live-options-client');
    c.innerHTML='';
    tempSelectedAnswer=null;
    $('live-confirm-btn').classList.add('hidden');

    if(q.type==='single' || q.type==='boolean'){
      const opts=q.type==='boolean'?['–î–ê','–ù–ï']:(q.options||[]);
      c.innerHTML = opts.map((o,i)=>`
        <button onclick="window.selectOptionLive(this, ${q.type==='boolean'?(i===0):i})"
          class="option-btn w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-lg text-slate-700 shadow-sm mb-3 text-left hover:border-brand-500 hover:bg-brand-50 transition-all active:scale-[0.98]">${o}</button>
      `).join('');
    } else if(q.type==='multiple'){
      const opts=q.options||[];
      c.innerHTML = opts.map((o,i)=>`
        <label class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-lg text-slate-700 shadow-sm mb-3 text-left hover:border-brand-500 hover:bg-brand-50 transition-all flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="mt-1 w-5 h-5 accent-emerald-600" data-live-multi-idx="${i}">
          <span>${o}</span>
        </label>
      `).join('');
      $('live-confirm-btn').classList.remove('hidden');
    } else if(q.type==='numeric_slider'){
      c.innerHTML = `
        <div class="w-full bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
          <input type="range" id="live-range" min="${q.min}" max="${q.max}" step="${q.step}" class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            oninput="document.getElementById('live-range-val').innerText=this.value">
          <div class="text-brand-600 text-6xl font-black mt-6 text-center" id="live-range-val">${Math.round((q.min+q.max)/2)}</div>
        </div>`;
      $('live-confirm-btn').classList.remove('hidden');
    }
  };

  window.selectOptionLive=(el,val)=>{
    document.querySelectorAll('#live-options-client .option-btn').forEach(b=>b.classList.remove('border-brand-600','bg-brand-50'));
    el.classList.add('border-brand-600','bg-brand-50');
    tempSelectedAnswer=val;
    $('live-confirm-btn').classList.remove('hidden');
  };

  window.confirmLiveAnswer=async()=>{
    if(lastAnsweredIndex===liveActiveQIdx) return;
    lastAnsweredIndex=liveActiveQIdx;

    const q=window.currentLiveQ;
    let earned=0;

    if(q.type==='numeric_slider'){
      const val=Number(document.getElementById('live-range').value);
      const isCor=Math.abs(val-q.correct) <= (q.tolerance||0);
      earned=isCor?(q.points||1):0;
    } else if(q.type==='multiple'){
      const selected=[...document.querySelectorAll('#live-options-client input[type="checkbox"][data-live-multi-idx]')].filter(x=>x.checked).map(x=>Number(x.getAttribute('data-live-multi-idx')));
      earned = scoreMultiplePartial(selected, q.correct, q.points||1);
    } else {
      const isCor=(tempSelectedAnswer===q.correct);
      earned=isCor?(q.points||1):0;
    }

    liveScore += earned;

    $('client-question').classList.add('hidden');
    $('client-waiting').classList.remove('hidden');

    const up={ score: liveScore };
    await updateDoc(participantRef(sessionID, auth.currentUser.uid), up);
  };

  // HOST
  window.startHostFromLibrary=async(id)=>{
    const q=myQuizzes.find(x=>x.id===id); if(!q) return;
    currentQuiz={ title:q.title, v:q.v, q:q.questions||[] };
    currentQuizOwnerId=user.uid;
    await window.openLiveHost();
  };

  window.openLiveHost=async()=>{
    sessionID=Math.floor(1000+Math.random()*9000).toString();
    sessionDocId=sessionID;
    liveActiveQIdx=-1;

    window.switchScreen('live-host');
    $('host-pin').innerText=sessionID;

    const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(location.origin+location.pathname+'?pin='+sessionID)}`;
    $('host-qr-container').innerHTML = `<div class="text-[10px] uppercase font-black text-slate-400 mb-2 tracking-widest">QR –í—Ö–æ–¥</div><img src="${qrUrl}" class="w-32 h-32 rounded-xl border-4 border-white shadow-md"><div class="text-[9px] text-slate-500 mt-2 font-mono">–°–∫–∞–Ω–∏—Ä–∞–π</div>`;

    await setDoc(sessionRef(sessionDocId), {
      activeQ:-1,
      status:'waiting',
      hostId: currentQuizOwnerId,
      pin: sessionID,
      quizTitle: currentQuiz.title,
      createdAt: serverTimestamp()
    });

    onSnapshot(participantsCol(sessionDocId),(s)=>{
      lastFetchedParticipants=s.docs.map(d=>({ ...d.data(), id:d.id }));
      window.renderHostDashboard();
    });
  };

  window.renderHostDashboard=()=>{
    $('host-participant-count').innerText=String(lastFetchedParticipants.length);
    const b=$('host-results-body');
    const sorted=[...lastFetchedParticipants].sort((a,b)=>(b.score||0)-(a.score||0));
    b.innerHTML = sorted.map((p,i)=>`
      <tr>
        <td class="p-3 font-black text-slate-400 text-xs w-10">#${i+1}</td>
        <td class="p-3 font-bold text-slate-800 flex items-center gap-2"><span class="text-xl">${p.avatar||'üòé'}</span> ${p.name}</td>
        <td class="p-3 text-right font-black text-brand-600">${(p.score??0).toFixed?.(2) ?? (p.score??0)}</td>
      </tr>
    `).join('');
  };

  window.initHostPlayer=()=>{
    $('host-setup-area').classList.add('hidden');
    $('host-video-container').innerHTML = `<div id="host-video" class="w-full h-full"></div>`;

    hostPlayer=new YT.Player('host-video',{
      videoId: currentQuiz.v,
      width:'100%', height:'100%',
      playerVars:{autoplay:1,controls:1},
      events:{
        onReady:(e)=>e.target.playVideo(),
        onStateChange:(e)=>{
          if(e.data===1){
            clearIntervals();
            const i=setInterval(async ()=>{
              const t=Math.floor(hostPlayer.getCurrentTime());
              const qIdx=currentQuiz.q.findIndex(q=>Math.abs((q.time||0)-t)<=1);
              if(qIdx!==-1 && qIdx!==liveActiveQIdx){
                liveActiveQIdx=qIdx;
                hostPlayer.pauseVideo();
                $('host-resume-overlay').classList.remove('hidden');
                $('host-resume-overlay').classList.add('flex');
                await updateDoc(sessionRef(sessionDocId), { activeQ:qIdx, qData: currentQuiz.q[qIdx], status:'active' });
              }
            },900);
            activeIntervals.push(i);
          }
        }
      }
    });
  };

  window.resumeHostSession=async()=>{
    $('host-resume-overlay').classList.add('hidden');
    $('host-resume-overlay').classList.remove('flex');
    hostPlayer.playVideo();
    await updateDoc(sessionRef(sessionDocId), { status:'playing' });
  };

  window.finishLiveSession=async()=>{
    await updateDoc(sessionRef(sessionDocId), { status:'finished' });
    // –ó–∞–ø–∏—Å –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è
    try{
      await addDoc(classHistoryCol(user.uid), { sessionId: sessionDocId, pin: sessionID, quizTitle: currentQuiz.title, timestamp: serverTimestamp() });
    }catch{}
    window.switchScreen('teacher-dashboard');
  };

  window.quitHostSession=async()=>{
    if(!confirm("–ö—Ä–∞–π –±–µ–∑ –∑–∞–ø–∏—Å?")) return;
    // –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–∫–ª—é—á–≤–∞–º–µ –ª–æ–∫–∞–ª–Ω–æ
    window.switchScreen('teacher-dashboard');
  };

  // ---------- AUTH STATE ----------
  onAuthStateChanged(auth, async (u)=>{
    user=u||null;
    if(!u){
      isTeacher=false;
      window.switchScreen('welcome');
      safeLucide();
      setTimeout(()=>$('auth-loader')?.classList.add('hidden'), 700);
      return;
    }

    // –∞–∫–æ –µ —É—á–∏—Ç–µ–ª
    try{
      const snap=await getDoc(profileDoc(u.uid));
      if(snap.exists() && snap.data().role==='teacher'){
        isTeacher=true;
        $('user-email-display').innerText = snap.data().email || u.email || '';
        window.switchScreen('teacher-dashboard');
      } else {
        isTeacher=false;
        window.switchScreen('welcome');
      }
    }catch{
      window.switchScreen('welcome');
    }

    safeLucide();
    setTimeout(()=>$('auth-loader')?.classList.add('hidden'), 700);
  });

  // ---------- URL pin preload ----------
  window.addEventListener('DOMContentLoaded', ()=>{
    const p=new URLSearchParams(location.search).get('pin');
    if(p){
      window.switchTab('class');
      $('live-pin').value=p;
      window.showMessage("–ü–ò–ù –∑–∞—Ä–µ–¥–µ–Ω!","success");
    }
    safeLucide();
    setTimeout(()=>$('auth-loader')?.classList.add('hidden'), 1200);
  });

</script>

</body>
</html>
