<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<title>VideoQuiz Ultimate ‚Äì Local + Live Class (Firebase)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<style>
  html, body { height:100%; margin:0; background:#0b1220; }
  body { overflow:hidden; }
  .scrollbar::-webkit-scrollbar{ width:10px; height:10px; }
  .scrollbar::-webkit-scrollbar-thumb{ background:#334155; border-radius:999px; }
  .scrollbar::-webkit-scrollbar-track{ background:transparent; }
</style>
</head>

<body class="h-full text-white">
<div id="app" class="h-full flex flex-col">

  <!-- TOP BAR -->
  <header class="bg-slate-950 border-b border-slate-800 px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-3 h-3 rounded-full bg-emerald-400"></div>
      <div class="font-black text-lg">VideoQuiz</div>
      <div class="text-slate-400 text-sm hidden md:block">–ª–æ–∫–∞–ª–Ω–æ + ‚Äû–í –∫–ª–∞—Å‚Äú (Firebase)</div>
    </div>
    <div class="flex items-center gap-2">
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm font-bold" onclick="go('welcome')">–ù–∞—á–∞–ª–æ</button>
      <button class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-bold" onclick="openHelp()">–ü–æ–º–æ—â</button>
    </div>
  </header>

  <!-- TOASTS -->
  <div id="toasts" class="fixed top-4 right-4 z-[9999] space-y-2 pointer-events-none"></div>

  <!-- MAIN -->
  <main class="flex-1 overflow-hidden">

    <!-- WELCOME -->
    <section id="screen-welcome" class="h-full overflow-auto p-4 md:p-8 scrollbar">
      <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Students -->
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-6 space-y-4">
          <div>
            <h2 class="text-2xl font-black">–£—á–µ–Ω–∏—Ü–∏</h2>
            <p class="text-slate-300">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ –∏–ª–∏ –í –∫–ª–∞—Å.</p>
          </div>

          <div class="bg-slate-950/40 border border-slate-800 rounded-2xl p-4 space-y-3">
            <div class="font-black text-lg">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</div>
            <input id="stuName" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold"
              placeholder="–ò–º–µ (–Ω–∞–ø—Ä. –ú–∞—Ä–∏—è)">
            <textarea id="stuCode" class="w-full h-24 bg-slate-800 border border-slate-700 rounded-xl p-3 font-mono text-xs"
              placeholder="–ü–æ—Å—Ç–∞–≤–∏ –∫–æ–¥–∞ –æ—Ç —É—á–∏—Ç–µ–ª—è —Ç—É–∫..."></textarea>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <label class="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center gap-2 cursor-pointer">
                <input id="modeHome" type="radio" name="mode" checked>
                <div>
                  <div class="font-black">–î–æ–º–∞—à–Ω–æ</div>
                  <div class="text-xs text-slate-400">–ø–∞–∑–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç</div>
                </div>
              </label>

              <label class="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center gap-2 cursor-pointer">
                <input id="modeSOP" type="radio" name="mode">
                <div>
                  <div class="font-black">–°–û–ü üîä</div>
                  <div class="text-xs text-slate-400">–µ–¥—ä—Ä —à—Ä–∏—Ñ—Ç</div>
                </div>
              </label>

              <label class="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center gap-2 cursor-pointer">
                <input id="modeDiscuss" type="radio" name="mode">
                <div>
                  <div class="font-black">–û–±—Å—ä–∂–¥–∞–Ω–µ</div>
                  <div class="text-xs text-slate-400">–±–µ–∑ –∑–∞–ø–∏—Å</div>
                </div>
              </label>
            </div>

            <button class="w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-3 font-black"
              onclick="startStudentFromCode()">–°—Ç–∞—Ä—Ç</button>
          </div>

          <div class="bg-slate-950/40 border border-slate-800 rounded-2xl p-4 space-y-3">
            <div class="font-black text-lg">–í –∫–ª–∞—Å (–Ω–∞ –∂–∏–≤–æ)</div>
            <div class="grid grid-cols-2 gap-2">
              <input id="liveName" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold"
                placeholder="–ò–º–µ">
              <input id="livePin" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-black tracking-widest text-center"
                placeholder="PIN" inputmode="numeric">
            </div>
            <button class="w-full bg-teal-600 hover:bg-teal-500 rounded-xl py-3 font-black"
              onclick="joinLive()">–í–ª–µ–∑ –≤ –∫–ª–∞—Å</button>
            <div class="text-xs text-slate-400">PIN –≥–æ –¥–∞–≤–∞ —É—á–∏—Ç–µ–ª—è—Ç (–ø–æ–∫–∞–∑–∞–Ω –Ω–∞ –µ–∫—Ä–∞–Ω–∞ + QR).</div>
          </div>
        </div>

        <!-- Teacher -->
        <div class="bg-slate-900/70 border border-slate-800 rounded-2xl p-6 space-y-4">
          <div>
            <h2 class="text-2xl font-black">–£—á–∏—Ç–µ–ª</h2>
            <p class="text-slate-300">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ + —Ä–µ–¥–∞–∫—Ç–æ—Ä + —Å—Ç–∞—Ä—Ç –Ω–∞ –∂–∏–≤–∞ —Å–µ—Å–∏—è.</p>
          </div>

          <button class="w-full bg-indigo-600 hover:bg-indigo-500 rounded-xl py-3 font-black"
            onclick="go('teacher')">–í—Ö–æ–¥ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>

          <div class="bg-slate-950/40 border border-slate-800 rounded-2xl p-4 text-sm text-slate-300 space-y-2">
            <div class="font-bold">‚úÖ –ö–∞–∫–≤–æ –µ –Ω–æ–≤–æ—Ç–æ:</div>
            <div>‚Äû–í –∫–ª–∞—Å (–Ω–∞ –∂–∏–≤–æ)‚Äú —Ä–∞–±–æ—Ç–∏ –ø—Ä–µ–∑ Firebase/Firestore, –∑–∞ –¥–∞ –≤–ª–∏–∑–∞—Ç –º–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∏ –µ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</div>
          </div>

          <button class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl py-3 font-bold"
            onclick="clearLocal()">–ù—É–ª–∏—Ä–∞–π –ª–æ–∫–∞–ª–Ω–∏ –¥–∞–Ω–Ω–∏</button>
        </div>
      </div>
    </section>

    <!-- TEACHER -->
    <section id="screen-teacher" class="hidden h-full overflow-hidden">
      <div class="h-full grid grid-cols-1 lg:grid-cols-[440px_1fr]">

        <!-- left -->
        <div class="h-full bg-slate-950/40 border-r border-slate-800 overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-800 flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–£—á–∏—Ç–µ–ª—Å–∫–∏ –ø–∞–Ω–µ–ª</div>
              <div class="text-lg font-black">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
            </div>
            <button class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-lg font-black text-sm"
              onclick="newLesson()">+ –ù–æ–≤ —É—Ä–æ–∫</button>
          </div>

          <div class="p-4 border-b border-slate-800 space-y-3">
            <input id="libSearch" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold"
              placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ..." oninput="renderLibrary()">

            <div class="flex gap-2">
              <button id="tabLessons" class="flex-1 bg-indigo-600 rounded-xl py-2 font-black text-sm" onclick="setTeacherTab('lessons')">–£—Ä–æ—Ü–∏</button>
              <button id="tabResults" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl py-2 font-black text-sm" onclick="setTeacherTab('results')">–î–æ–º–∞—à–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</button>
            </div>
          </div>

          <div id="teacherTabLessons" class="flex-1 overflow-auto p-4 space-y-3 scrollbar"></div>

          <div id="teacherTabResults" class="hidden flex-1 overflow-auto p-4 space-y-3 scrollbar">
            <div class="flex items-center justify-between">
              <div class="font-black">–î–æ–º–∞—à–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</div>
              <button class="bg-rose-600 hover:bg-rose-500 px-3 py-2 rounded-xl font-bold text-sm"
                onclick="clearResults()">–ò–∑—á–∏—Å—Ç–∏</button>
            </div>
            <div class="text-xs text-slate-400">–ü–æ–∫–∞–∑–≤–∞ —Å–∞–º–æ —Ä–µ–∂–∏–º ‚Äú–î–æ–º–∞—à–Ω–æ‚Äù. (–õ–æ–∫–∞–ª–Ω–æ)</div>

            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden">
              <table class="w-full text-left text-sm">
                <thead class="bg-slate-900 border-b border-slate-800 text-slate-300">
                <tr>
                  <th class="p-3">–£—á–µ–Ω–∏–∫</th>
                  <th class="p-3">–£—Ä–æ–∫</th>
                  <th class="p-3 text-right">–†–µ–∑—É–ª—Ç–∞—Ç</th>
                  <th class="p-3">–î–∞—Ç–∞</th>
                </tr>
                </thead>
                <tbody id="resultsBody" class="divide-y divide-slate-800"></tbody>
              </table>
            </div>
          </div>

          <div class="p-4 border-t border-slate-800 text-xs text-slate-400">
            –£—Ä–æ—Ü–∏/–¥–æ–º–∞—à–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ —Å–µ –ø–∞–∑—è—Ç –ª–æ–∫–∞–ª–Ω–æ –≤ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä.
          </div>
        </div>

        <!-- right -->
        <div class="h-full overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-800 flex flex-wrap items-center gap-2 justify-between bg-slate-900/40">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">–†–µ–¥–∞–∫—Ç–æ—Ä</span>
              <span id="editBadge" class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm font-black">–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —É—Ä–æ–∫</span>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <button class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-lg font-black text-sm"
                onclick="startLiveHostFromEditor()">–í –∫–ª–∞—Å (–Ω–∞ –∂–∏–≤–æ)</button>

              <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-lg font-bold text-sm"
                onclick="openExportModal()">–ï–∫—Å–ø–æ—Ä—Ç</button>

              <button class="bg-sky-600 hover:bg-sky-500 px-3 py-2 rounded-lg font-bold text-sm"
                onclick="openImportModal()">–ò–º–ø–æ—Ä—Ç</button>

              <button class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded-lg font-black text-sm"
                onclick="openShareCode()">–ö–æ–¥ (—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ)</button>

              <button class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-lg font-black text-sm"
                onclick="saveLesson()">–ó–∞–ø–∞–∑–∏</button>
            </div>
          </div>

          <div class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-[1fr_440px] gap-4 p-4">
            <!-- video -->
            <div class="bg-black rounded-2xl overflow-hidden relative">
              <div id="tPlayer" class="w-full h-full"></div>
              <div id="tHint" class="absolute top-3 left-3 bg-black/50 backdrop-blur px-3 py-2 rounded-xl text-xs text-slate-200">
                –ó–∞—Ä–µ–¥–∏ –≤–∏–¥–µ–æ (YouTube ID) –∏ –Ω–∞—Ç–∏—Å–Ω–∏ Play.
              </div>
            </div>

            <!-- questions -->
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden flex flex-col">
              <div class="p-4 border-b border-slate-800 space-y-2">
                <input id="tTitle" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 font-black"
                  placeholder="–ò–º–µ –Ω–∞ —É—Ä–æ–∫ (–Ω–∞–ø—Ä. –ë—ä–ª–≥–∞—Ä—Å–∫–æ –≤—ä–∑—Ä–∞–∂–¥–∞–Ω–µ)">
                <div class="flex gap-2">
                  <input id="tVid" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold"
                    placeholder="YouTube ID (11 –∑–Ω–∞–∫–∞)">
                  <button class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded-xl font-black"
                    onclick="bootTeacherPlayer()">–í–∏–¥–µ–æ</button>
                </div>

                <div class="flex items-center justify-between">
                  <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í—ä–ø—Ä–æ—Å–∏</div>
                  <div class="font-mono text-xs bg-slate-800 border border-slate-700 px-3 py-1 rounded" id="tClock">0:00</div>
                </div>

                <button class="w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-2 font-black"
                  onclick="openQForm()">+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å (–Ω–∞ —Ç–µ–∫—É—â–∞—Ç–∞ —Å–µ–∫—É–Ω–¥–∞)</button>

                <div class="text-xs text-slate-400">
                  –ê–≤—Ç–æ—Å–µ–π–≤: <span id="autosaveState" class="font-bold text-slate-300">‚Äî</span>
                </div>
              </div>

              <div id="tQList" class="flex-1 overflow-auto p-4 space-y-3 scrollbar"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- STUDENT SOLO -->
    <section id="screen-student" class="hidden h-full overflow-hidden">
      <div class="h-full grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-4 p-4">
        <div class="bg-black rounded-2xl overflow-hidden relative">
          <div id="sPlayer" class="w-full h-full"></div>
          <div id="sMini" class="absolute top-3 left-3 bg-black/50 backdrop-blur px-3 py-2 rounded-xl text-xs text-slate-200">
            –°—Ç–∞—Ä—Ç–∏—Ä–∞–π —É—Ä–æ–∫–∞.
          </div>
        </div>

        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-800">
            <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–£—á–µ–Ω–∏–∫</div>
            <div class="text-xl font-black" id="sName">‚Äî</div>
            <div class="text-sm text-slate-300 mt-1" id="sLesson">‚Äî</div>
            <div class="mt-3 flex items-center justify-between">
              <div class="font-mono text-xs bg-slate-800 border border-slate-700 px-3 py-1 rounded" id="sClock">0:00</div>
              <div class="text-sm font-black">–¢–æ—á–∫–∏: <span id="sScore" class="text-emerald-300">0</span></div>
            </div>
            <div class="mt-2 text-xs text-slate-400" id="sModeLabel">–†–µ–∂–∏–º: ‚Äî</div>
          </div>

          <div class="flex-1 overflow-auto p-4 scrollbar">
            <div class="text-slate-300 text-sm">
              –í–∏–¥–µ–æ + –≤—ä–ø—Ä–æ—Å–∏ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ê–∫–æ –±—Ä–∞—É–∑—ä—Ä—ä—Ç –±–ª–æ–∫–∏—Ä–∞ autoplay ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ Play.
            </div>
          </div>

          <div class="p-4 border-t border-slate-800">
            <button class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl py-3 font-bold"
              onclick="resetStudentPlayerUI(); go('welcome')">–ò–∑—Ö–æ–¥</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FINISH SOLO -->
    <section id="screen-finish" class="hidden h-full overflow-auto p-6 scrollbar">
      <div class="max-w-xl mx-auto bg-slate-900/70 border border-slate-800 rounded-3xl p-8 text-center">
        <div class="text-5xl font-black mb-2">–ö–†–ê–ô</div>
        <div class="text-slate-300 mb-6" id="finInfo">‚Äî</div>

        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 mb-6">
          <div class="text-slate-400 text-sm font-bold uppercase tracking-wider">–†–µ–∑—É–ª—Ç–∞—Ç</div>
          <div class="text-6xl font-black mt-2"><span id="finScore">0</span> / <span id="finMax">0</span></div>
        </div>

        <div id="finSaved" class="text-sm text-slate-300 mb-6"></div>

        <button class="w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-3 font-black"
          onclick="resetStudentPlayerUI(); go('welcome')">–ù–∞—á–∞–ª–æ</button>
      </div>
    </section>

    <!-- LIVE HOST -->
    <section id="screen-live-host" class="hidden h-full overflow-hidden bg-slate-950">
      <div class="h-full flex flex-col">
        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-950">
          <div class="flex items-center gap-4">
            <div class="bg-amber-600 px-4 py-2 rounded-xl shadow">
              <div class="text-[10px] uppercase font-black text-amber-100 tracking-widest">PIN</div>
              <div id="hostPin" class="text-2xl font-black tracking-widest">----</div>
            </div>
            <div class="text-slate-300 text-sm">
              <div class="font-black" id="hostLessonTitle">‚Äî</div>
              <div class="text-xs text-slate-400">–£—á–µ–Ω–∏—Ü–∏: <span id="hostCount" class="font-black">0</span></div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnHostStart" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl font-black"
              onclick="hostStartVideo()">–°–¢–ê–†–¢</button>
            <button id="btnHostResume" class="hidden bg-teal-600 hover:bg-teal-500 px-4 py-2 rounded-xl font-black"
              onclick="hostResume()">–ü–†–û–î–™–õ–ñ–ò</button>
            <button id="btnHostEnd" class="bg-rose-600 hover:bg-rose-500 px-4 py-2 rounded-xl font-black"
              onclick="hostEndSession()">–ö–†–ê–ô</button>
          </div>
        </div>

        <div class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-4 p-4">
          <div class="bg-black rounded-2xl overflow-hidden relative">
            <div id="hostPlayer" class="w-full h-full"></div>
            <div id="hostOverlay" class="absolute inset-0 bg-black/70 backdrop-blur flex items-center justify-center">
              <div class="text-center space-y-3">
                <div class="text-3xl font-black">–°–µ—Å–∏—è—Ç–∞ –µ –≥–æ—Ç–æ–≤–∞</div>
                <div class="text-slate-300">–ò–∑—á–∞–∫–∞–π —É—á–µ–Ω–∏—Ü–∏—Ç–µ –¥–∞ –≤–ª—è–∑–∞—Ç –∏ –Ω–∞—Ç–∏—Å–Ω–∏ <b>–°–¢–ê–†–¢</b>.</div>
              </div>
            </div>
          </div>

          <div class="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden flex flex-col">
            <div class="p-4 border-b border-slate-800">
              <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–ü—Ä–æ–≥—Ä–µ—Å</div>
              <div class="mt-2 bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div id="hostProgressBar" class="h-3 bg-emerald-500" style="width:0%"></div>
              </div>
              <div class="mt-2 text-xs text-slate-400">
                –û—Ç–≥–æ–≤–æ—Ä–∏–ª–∏ –Ω–∞ —Ç–µ–∫—É—â–∏—è –≤—ä–ø—Ä–æ—Å: <span id="hostAnswered" class="font-black text-slate-200">0</span>/<span id="hostTotal" class="font-black text-slate-200">0</span>
              </div>
            </div>

            <div class="p-4 border-b border-slate-800 flex items-center justify-between">
              <div class="font-black">–ö–ª–∞—Å–∞—Ü–∏—è</div>
              <div class="text-xs text-slate-400">–°–æ—Ä—Ç–∏—Ä–∞–Ω–æ –ø–æ —Ç–æ—á–∫–∏</div>
            </div>

            <div class="flex-1 overflow-auto p-4 scrollbar">
              <table class="w-full text-sm">
                <tbody id="hostLeaderboard" class="space-y-2"></tbody>
              </table>
            </div>

            <div class="p-4 border-t border-slate-800 bg-slate-950/40">
              <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">QR</div>
              <div class="flex items-center gap-3">
                <img id="hostQR" class="w-28 h-28 rounded-xl bg-white" alt="QR">
                <div class="text-xs text-slate-300">
                  –£—á–µ–Ω–∏—Ü–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–∞—Ç QR –∏–ª–∏ –≤—ä–≤–µ–∂–¥–∞—Ç PIN –≤ –Ω–∞—á–∞–ª–Ω–∏—è –µ–∫—Ä–∞–Ω.
                  <div class="mt-2 text-slate-400">QR —Å—ä–¥—ä—Ä–∂–∞ —Å–∞–º–æ PIN (–ø–æ-–ª–µ—Å–Ω–æ –∏ –Ω–∞–¥–µ–∂–¥–Ω–æ).</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- LIVE CLIENT -->
    <section id="screen-live-client" class="hidden h-full overflow-hidden bg-slate-950">
      <div class="h-full flex flex-col">
        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-950">
          <div>
            <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í –∫–ª–∞—Å</div>
            <div class="font-black text-lg" id="clientName">‚Äî</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">–¢–æ—á–∫–∏</div>
            <div class="text-2xl font-black text-emerald-300" id="clientScore">0</div>
          </div>
        </div>

        <!-- waiting -->
        <div id="clientWaiting" class="flex-1 flex items-center justify-center p-6">
          <div class="text-center space-y-4">
            <div id="clientEmoji" class="text-6xl">üëÄ</div>
            <div class="text-2xl font-black">–ò–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å–∏—Ç–µ</div>
            <div class="text-slate-300">–ö–æ–≥–∞—Ç–æ —É—á–∏—Ç–µ–ª—è—Ç –ø—É—Å–Ω–µ –≤—ä–ø—Ä–æ—Å, —â–µ —Å–µ –ø–æ—è–≤–∏ —Ç—É–∫.</div>
          </div>
        </div>

        <!-- question -->
        <div id="clientQuestion" class="hidden flex-1 overflow-auto p-6 scrollbar">
          <div class="max-w-xl mx-auto space-y-4">
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5">
              <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í—ä–ø—Ä–æ—Å</div>
              <div id="clientQText" class="text-xl font-black mt-2">‚Äî</div>
            </div>
            <div id="clientOpts" class="space-y-2"></div>
            <button id="clientConfirm" class="hidden w-full bg-emerald-600 hover:bg-emerald-500 rounded-xl py-3 font-black"
              onclick="clientConfirmAnswer()">–ü–û–¢–í–™–†–î–ò</button>
          </div>
        </div>

        <!-- finished -->
        <div id="clientFinished" class="hidden flex-1 flex items-center justify-center p-6">
          <div class="text-center space-y-4">
            <div class="text-6xl">üèÅ</div>
            <div class="text-3xl font-black">–ö—Ä–∞–π –Ω–∞ —Å–µ—Å–∏—è—Ç–∞</div>
            <div class="text-slate-300">–¢–≤–æ—è—Ç —Ä–µ–∑—É–ª—Ç–∞—Ç:</div>
            <div class="text-6xl font-black text-emerald-300" id="clientFinalScore">0</div>
            <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-3 rounded-xl font-bold"
              onclick="liveClientCleanup(); go('welcome')">–ò–∑—Ö–æ–¥</button>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- HELP MODAL -->
<div id="modalHelp" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg">–ü–æ–º–æ—â (–∫—Ä–∞—Ç–∫–æ)</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeHelp()">‚úï</button>
    </div>
    <div class="p-4 space-y-3 text-slate-200 text-sm">
      <div class="font-bold">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ:</div>
      <ul class="list-disc pl-5 space-y-1">
        <li>–£—á–∏—Ç–µ–ª: ‚Äû–ö–æ–¥ (—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ)‚Äú ‚Üí –∫–æ–ø–∏—Ä–∞.</li>
        <li>–£—á–µ–Ω–∏–∫: –ø–æ—Å—Ç–∞–≤—è –∫–æ–¥–∞ ‚Üí –°—Ç–∞—Ä—Ç.</li>
      </ul>
      <div class="font-bold mt-3">–í –∫–ª–∞—Å (–Ω–∞ –∂–∏–≤–æ):</div>
      <ul class="list-disc pl-5 space-y-1">
        <li>–£—á–∏—Ç–µ–ª: ‚Äû–í –∫–ª–∞—Å (–Ω–∞ –∂–∏–≤–æ)‚Äú ‚Üí PIN + QR.</li>
        <li>–£—á–µ–Ω–∏—Ü–∏: –≤—ä–≤–µ–∂–¥–∞—Ç –∏–º–µ + PIN –æ—Ç –Ω–∞—á–∞–ª–Ω–∏—è –µ–∫—Ä–∞–Ω.</li>
        <li>–£—á–∏—Ç–µ–ª: –°–¢–ê–†–¢ ‚Üí –ø—Ä–∏ –≤—ä–ø—Ä–æ—Å –≤–∏–¥–µ–æ—Ç–æ —Å–ø–∏—Ä–∞, —É—á–µ–Ω–∏—Ü–∏—Ç–µ –æ—Ç–≥–æ–≤–∞—Ä—è—Ç, —É—á–∏—Ç–µ–ª –Ω–∞—Ç–∏—Å–∫–∞ –ü–†–û–î–™–õ–ñ–ò.</li>
        <li>–ö–†–ê–ô ‚Üí —É—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–∏–∂–¥–∞—Ç —Ñ–∏–Ω–∞–ª–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç.</li>
      </ul>
    </div>
  </div>
</div>

<!-- QUESTION FORM MODAL -->
<div id="modalQ" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg" id="qFormTitle">–í—ä–ø—Ä–æ—Å</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeQForm()">‚úï</button>
    </div>
    <div class="p-4 space-y-3">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="qTime" type="number" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–°–µ–∫—É–Ω–¥–∞">
        <select id="qCorrect" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold">
          <option value="0">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 1</option>
          <option value="1">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 2</option>
          <option value="2">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 3</option>
          <option value="3">–í–µ—Ä–Ω–∏—è—Ç –µ –û—Ç–≥–æ–≤–æ—Ä 4</option>
        </select>
      </div>

      <input id="qText" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-black" placeholder="–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞">

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input id="qO0" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 1">
        <input id="qO1" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 2">
        <input id="qO2" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 3">
        <input id="qO3" class="bg-slate-800 border border-slate-700 rounded-xl p-3 font-bold" placeholder="–û—Ç–≥–æ–≤–æ—Ä 4">
      </div>

      <div id="qErr" class="text-rose-300 font-bold text-sm"></div>

      <div class="flex gap-2 flex-wrap">
        <button class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl font-black" onclick="saveQForm()">–ó–∞–ø–∞–∑–∏</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-xl font-bold" onclick="closeQForm()">–û—Ç–∫–∞–∑</button>
      </div>
    </div>
  </div>
</div>

<!-- SHARE SOLO CODE MODAL -->
<div id="modalShare" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg">–ö–æ–¥ (—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ)</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeShare()">‚úï</button>
    </div>
    <div class="p-4 space-y-3">
      <textarea id="shareText" class="w-full h-48 bg-slate-800 border border-slate-700 rounded-xl p-3 font-mono text-xs"></textarea>
      <div id="shareInfo" class="text-slate-400 text-xs"></div>
      <div class="flex gap-2 flex-wrap">
        <button class="bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded-xl font-black" onclick="copyShare()">–ö–æ–ø–∏—Ä–∞–π</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-xl font-bold" onclick="closeShare()">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT/EXPORT MODAL -->
<div id="modalIE" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div class="font-black text-lg" id="ieTitle">–ï–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç</div>
      <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeIE()">‚úï</button>
    </div>
    <div class="p-4 space-y-3">
      <textarea id="ieText" class="w-full h-56 bg-slate-800 border border-slate-700 rounded-xl p-3 font-mono text-xs"
        placeholder="–ü–æ—Å—Ç–∞–≤–∏ JSON —Ç—É–∫..."></textarea>
      <div id="ieErr" class="text-rose-300 font-bold text-sm"></div>
      <div class="flex gap-2 flex-wrap">
        <button class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-xl font-black" onclick="doIEImport()">–ò–º–ø–æ—Ä—Ç</button>
        <button class="bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded-xl font-black" onclick="copyIE()">–ö–æ–ø–∏—Ä–∞–π</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-xl font-bold" onclick="closeIE()">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- STUDENT SOLO QUESTION MODAL -->
<div id="modalSQ" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl w-full max-w-2xl overflow-hidden">
    <div class="p-4 border-b border-slate-800 flex items-center justify-between">
      <div>
        <div id="sqMeta" class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í—ä–ø—Ä–æ—Å</div>
        <div id="sqText" class="text-xl font-black">‚Äî</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnSpeak" class="hidden px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 font-black text-sm" onclick="speakSQ()">üîä</button>
        <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" onclick="closeSQ()">‚úï</button>
      </div>
    </div>
    <div id="sqOpts" class="p-4 space-y-2"></div>
    <div class="p-4 border-t border-slate-800 flex items-center justify-between gap-3">
      <div id="sqFeed" class="font-bold text-slate-200"></div>
      <button id="btnSQContinue" class="hidden bg-emerald-600 hover:bg-emerald-500 px-5 py-3 rounded-xl font-black" onclick="continueStudent()">–ü—Ä–æ–¥—ä–ª–∂–∏</button>
    </div>
  </div>
</div>

<script type="module">
/* =========================
   FIREBASE (LIVE CLASS)
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp,
  collection, onSnapshot, query, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// ‚úÖ –¢–≤–æ—è—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const firebaseConfig = {
  apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
  authDomain: "videoquiz-ultimate.firebaseapp.com",
  projectId: "videoquiz-ultimate",
  storageBucket: "videoquiz-ultimate.firebasestorage.app",
  messagingSenderId: "793138692820",
  appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
};

// Namespace –∑–∞ Firestore (–∫–∞–∫—Ç–æ —Å—Ç–∞—Ä–∏—è —Ç–∏ –ø—Ä–æ–µ–∫—Ç)
const FINAL_APP_ID = "videoquiz-ultimate-live";

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);

let fbUser = null;
onAuthStateChanged(auth, (u)=>{ fbUser = u || null; });

/* =========================
   LIVE CLASS PATHS
========================= */
const sessionRef = (pin) => doc(db, "artifacts", FINAL_APP_ID, "public", "data", "sessions", pin);
const participantsCol = (pin) => collection(db, "artifacts", FINAL_APP_ID, "public", "data", "sessions", pin, "participants");
const participantRef = (pin, uid) => doc(db, "artifacts", FINAL_APP_ID, "public", "data", "sessions", pin, "participants", uid);

/* =========================
   LOCAL STORAGE KEYS
========================= */
const LS_LIB = "videoquiz_library_v2";
const LS_RESULTS = "videoquiz_results_v2";

/* =========================
   YT API READY
========================= */
let ytReady = false;
window.onYouTubeIframeAPIReady = () => { ytReady = true; };

/* =========================
   STATE: TEACHER (LOCAL)
========================= */
let tPlayer = null;
let tTick = null;
let currentLessonId = null;
let workingLesson = null;
let editingQIndex = null;
let teacherTab = "lessons";

/* =========================
   STATE: SOLO (LOCAL)
========================= */
let sPlayer = null;
let sTick = null;
let sAsked = new Set();
let sActiveQ = null;
let sScore = 0;
let sMax = 0;
let sMode = "home";
let sStudentName = "";
let sLessonTitle = "";

/* =========================
   STATE: LIVE CLASS (FIREBASE)
========================= */
// host
let hostPin = null;
let hostLesson = null;
let hostPlayer = null;
let hostTick = null;
let hostActiveQ = -1;
let hostUnsubs = [];
let hostParticipants = [];
// client
let clientPin = null;
let clientLesson = null;
let clientActiveQ = -1;
let clientScore = 0;
let clientSelected = null;
let clientConfirmedForQ = -1;
let clientUnsub = null;

/* =========================
   UI helpers
========================= */
function toast(msg, type="info"){
  const box = document.getElementById("toasts");
  const el = document.createElement("div");
  const color =
    type==="success" ? "bg-emerald-600" :
    type==="error" ? "bg-rose-600" :
    type==="warn" ? "bg-amber-600" :
    "bg-indigo-600";
  el.className = `pointer-events-none ${color} shadow-xl rounded-xl px-4 py-3 text-sm font-bold border border-white/10`;
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transition="opacity .3s"; }, 2600);
  setTimeout(()=>{ el.remove(); }, 3000);
}
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function fmt(sec){
  sec = Math.max(0, Math.floor(sec || 0));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,"0")}`;
}
function b64EncodeUnicode(str){ return btoa(unescape(encodeURIComponent(str))); }
function b64DecodeUnicode(str){ return decodeURIComponent(escape(atob(str))); }

/* =========================
   Screen nav
========================= */
window.go = (name) => {
  document.querySelectorAll("section[id^='screen-']").forEach(s=>s.classList.add("hidden"));
  document.getElementById("screen-"+name).classList.remove("hidden");

  // stop SOLO ticks if leaving
  if(name !== "student") stopStudentTick();
  if(name !== "teacher") stopTeacherTick();

  if(name === "teacher"){
    setTeacherTab(teacherTab);
    renderLibrary();
    renderResults();
  }
};
window.openHelp = ()=> document.getElementById("modalHelp").classList.remove("hidden");
window.closeHelp = ()=> document.getElementById("modalHelp").classList.add("hidden");

/* =========================
   Local storage (library/results)
========================= */
function loadLibrary(){ try{ return JSON.parse(localStorage.getItem(LS_LIB)||"[]"); }catch{return [];} }
function saveLibrary(list){ localStorage.setItem(LS_LIB, JSON.stringify(list)); }
function upsertLesson(lesson){
  const list = loadLibrary();
  const idx = list.findIndex(x=>x.id===lesson.id);
  if(idx>=0) list[idx]=lesson; else list.push(lesson);
  saveLibrary(list);
}
function deleteLesson(id){ saveLibrary(loadLibrary().filter(x=>x.id!==id)); }

function loadResults(){ try{ return JSON.parse(localStorage.getItem(LS_RESULTS)||"[]"); }catch{return [];} }
function saveResults(arr){ localStorage.setItem(LS_RESULTS, JSON.stringify(arr)); }

window.clearLocal = ()=>{
  if(!confirm("–°–∏–≥—É—Ä–Ω–∞ –ª–∏ —Å–∏? –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –ª–æ–∫–∞–ª–Ω–∞—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏ –ª–æ–∫–∞–ª–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.")) return;

  resetStudentPlayerUI();
  stopTeacherTick();
  destroyYT(tPlayer); tPlayer=null; document.getElementById("tPlayer").innerHTML=""; document.getElementById("tClock").innerText="0:00";

  localStorage.removeItem(LS_LIB);
  localStorage.removeItem(LS_RESULTS);
  toast("–ù—É–ª–∏—Ä–∞–Ω–æ.", "success");
  renderLibrary(); renderResults();
};
window.clearResults = ()=>{
  if(!confirm("–ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –¥–æ–º–∞—à–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏?")) return;
  localStorage.removeItem(LS_RESULTS);
  renderResults();
  toast("–†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —Å–∞ –∏–∑—á–∏—Å—Ç–µ–Ω–∏.", "success");
};

/* =========================
   Tabs
========================= */
window.setTeacherTab = (tab)=>{
  teacherTab = tab;
  document.getElementById("teacherTabLessons").classList.toggle("hidden", tab!=="lessons");
  document.getElementById("teacherTabResults").classList.toggle("hidden", tab!=="results");
  document.getElementById("tabLessons").className = (tab==="lessons")
    ? "flex-1 bg-indigo-600 rounded-xl py-2 font-black text-sm"
    : "flex-1 bg-slate-800 border border-slate-700 rounded-xl py-2 font-black text-sm";
  document.getElementById("tabResults").className = (tab==="results")
    ? "flex-1 bg-indigo-600 rounded-xl py-2 font-black text-sm"
    : "flex-1 bg-slate-800 border border-slate-700 rounded-xl py-2 font-black text-sm";
};

/* =========================
   Render Results (local)
========================= */
function renderResults(){
  const body = document.getElementById("resultsBody");
  if(!body) return;
  const arr = loadResults();
  if(arr.length===0){
    body.innerHTML = `<tr><td colspan="4" class="p-4 text-slate-400 text-sm">–ù—è–º–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ –¥–æ–º–∞—à–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</td></tr>`;
    return;
  }
  body.innerHTML = arr.slice(0,200).map(r=>{
    const d = new Date(r.at);
    const when = isNaN(d.getTime()) ? "" : d.toLocaleString("bg-BG");
    return `<tr class="text-slate-200">
      <td class="p-3 font-bold">${escapeHtml(r.student||"")}</td>
      <td class="p-3">${escapeHtml(r.lesson||"")}</td>
      <td class="p-3 text-right font-black text-emerald-300">${r.score} / ${r.max}</td>
      <td class="p-3 text-slate-300 text-xs">${escapeHtml(when)}</td>
    </tr>`;
  }).join("");
}

/* =========================
   Teacher Library UI
========================= */
function renderLibrary(){
  const list = loadLibrary();
  const q = (document.getElementById("libSearch")?.value || "").toLowerCase().trim();
  const filtered = q ? list.filter(x => (x.title||"").toLowerCase().includes(q)) : list;

  const box = document.getElementById("teacherTabLessons");
  if(!box) return;

  if(filtered.length===0){
    box.innerHTML = `<div class="text-slate-400 text-sm">–ù—è–º–∞ —É—Ä–æ—Ü–∏. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú.</div>`;
    return;
  }
  box.innerHTML = filtered
    .sort((a,b)=>(a.title||"").localeCompare(b.title||""))
    .map(l=>`
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
        <div class="font-black text-lg">${escapeHtml(l.title||"–ë–µ–∑ –∏–º–µ")}</div>
        <div class="text-xs text-slate-400">–í–∏–¥–µ–æ: <span class="font-mono">${escapeHtml(l.videoId||"‚Äî")}</span> ‚Ä¢ –í—ä–ø—Ä–æ—Å–∏: <b>${(l.questions||[]).length}</b></div>

        <div class="flex gap-2 flex-wrap">
          <button class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="selectLesson('${l.id}')">–†–µ–¥–∞–∫—Ü–∏—è</button>
          <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-xl font-bold text-sm" onclick="previewLesson('${l.id}')">–ü—Ä–µ–≥–ª–µ–¥</button>
          <button class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-xl font-black text-sm" onclick="startLiveHostFromLibrary('${l.id}')">–í –∫–ª–∞—Å</button>
          <button class="bg-amber-600 hover:bg-amber-500 px-3 py-2 rounded-xl font-black text-sm" onclick="shareLesson('${l.id}')">–ö–æ–¥</button>
          <button class="bg-rose-600 hover:bg-rose-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="removeLesson('${l.id}')">–ò–∑—Ç—Ä–∏–π</button>
        </div>
      </div>
    `).join("");
}

window.newLesson = ()=>{
  const id = "L"+Date.now();
  workingLesson = { id, title:"–ù–æ–≤ —É—Ä–æ–∫", videoId:"dQw4w9WgXcQ", questions:[] };
  currentLessonId = id;
  applyLessonToEditor();
  document.getElementById("editBadge").innerText = "–†–µ–¥–∞–∫—Ü–∏—è: –ù–æ–≤ —É—Ä–æ–∫";
  stopTeacherTick();
  destroyYT(tPlayer); tPlayer=null; document.getElementById("tPlayer").innerHTML=""; document.getElementById("tClock").innerText="0:00";
  document.getElementById("tHint").innerText = "–í—ä–≤–µ–¥–∏ YouTube ID –∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–í–∏–¥–µ–æ‚Äú.";
  renderTeacherQuestions();
  markAutosave("‚Äî");
  toast("–°—ä–∑–¥–∞–¥–µ–Ω –Ω–æ–≤ —É—Ä–æ–∫.", "success");
};

window.selectLesson = (id)=>{
  const lesson = loadLibrary().find(x=>x.id===id);
  if(!lesson) return;
  workingLesson = JSON.parse(JSON.stringify(lesson));
  currentLessonId = id;
  applyLessonToEditor();
  document.getElementById("editBadge").innerText = "–†–µ–¥–∞–∫—Ü–∏—è: " + (workingLesson.title||"–ë–µ–∑ –∏–º–µ");
  stopTeacherTick();
  destroyYT(tPlayer); tPlayer=null; document.getElementById("tPlayer").innerHTML=""; document.getElementById("tClock").innerText="0:00";
  document.getElementById("tHint").innerText = "–ù–∞—Ç–∏—Å–Ω–∏ ‚Äû–í–∏–¥–µ–æ‚Äú –∑–∞ –¥–∞ –∑–∞—Ä–µ–¥–∏—à –ø–ª–µ—ä—Ä–∞.";
  renderTeacherQuestions();
  markAutosave("‚Äî");
};

window.previewLesson = (id)=>{
  const lesson = loadLibrary().find(x=>x.id===id);
  if(!lesson) return;
  startStudent(lesson, "discuss", "–£—á–∏—Ç–µ–ª (–ø—Ä–µ–≥–ª–µ–¥)");
};

window.shareLesson = (id)=>{
  const lesson = loadLibrary().find(x=>x.id===id);
  if(!lesson) return;
  shareLessonNow(lesson);
};

window.removeLesson = (id)=>{
  if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞?")) return;
  deleteLesson(id);
  if(currentLessonId===id){
    currentLessonId=null; workingLesson=null;
    document.getElementById("editBadge").innerText="–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —É—Ä–æ–∫";
    document.getElementById("tTitle").value="";
    document.getElementById("tVid").value="";
    document.getElementById("tQList").innerHTML=`<div class="text-slate-400 text-sm">–ò–∑–±–µ—Ä–∏ —É—Ä–æ–∫ –∏–ª–∏ —Å—ä–∑–¥–∞–π –Ω–æ–≤.</div>`;
    stopTeacherTick();
    destroyYT(tPlayer); tPlayer=null; document.getElementById("tPlayer").innerHTML=""; document.getElementById("tClock").innerText="0:00";
    markAutosave("‚Äî");
  }
  renderLibrary();
  toast("–£—Ä–æ–∫—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç.", "success");
};

function applyLessonToEditor(){
  document.getElementById("tTitle").value = workingLesson.title || "";
  document.getElementById("tVid").value = workingLesson.videoId || "";
}
function markAutosave(text){
  const el = document.getElementById("autosaveState");
  if(el) el.textContent = text;
}

window.saveLesson = ()=>{
  if(!workingLesson){ toast("–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —É—Ä–æ–∫. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú.", "warn"); return; }
  workingLesson.title = (document.getElementById("tTitle").value||"").trim() || "–ë–µ–∑ –∏–º–µ";
  workingLesson.videoId = (document.getElementById("tVid").value||"").trim();
  workingLesson.questions = (workingLesson.questions||[]).sort((a,b)=>a.time-b.time);
  if(!workingLesson.videoId || workingLesson.videoId.length!==11){ toast("YouTube ID —Ç—Ä—è–±–≤–∞ –¥–∞ –µ 11 –∑–Ω–∞–∫–∞.", "error"); return; }
  upsertLesson(workingLesson);
  renderLibrary();
  document.getElementById("editBadge").innerText = "–†–µ–¥–∞–∫—Ü–∏—è: "+workingLesson.title;
  const now = new Date().toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  markAutosave("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ "+now);
  toast("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ","success");
};

/* =========================
   Teacher Player + Questions
========================= */
function destroyYT(p){
  try{ if(p && typeof p.destroy==="function") p.destroy(); }catch(e){}
}
window.bootTeacherPlayer = ()=>{
  const ok = await window.ensureYouTube(videoId);
  if (!ok) return;
  if(!ytReady){ toast("YouTube API –æ—â–µ –∑–∞—Ä–µ–∂–¥–∞. –ò–∑—á–∞–∫–∞–π 1-2 —Å–µ–∫.", "warn"); return; }
  if(!workingLesson){ toast("–ò–∑–±–µ—Ä–∏ —É—Ä–æ–∫ –∏–ª–∏ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû–ù–æ–≤ —É—Ä–æ–∫‚Äú.", "warn"); return; }
  workingLesson.title = (document.getElementById("tTitle").value||"").trim() || "–ë–µ–∑ –∏–º–µ";
  workingLesson.videoId = (document.getElementById("tVid").value||"").trim();
  if(!workingLesson.videoId || workingLesson.videoId.length!==11){ toast("–í—ä–≤–µ–¥–∏ YouTube ID (11 –∑–Ω–∞–∫–∞).", "error"); return; }

  stopTeacherTick();
  destroyYT(tPlayer);
  tPlayer=null;
  document.getElementById("tPlayer").innerHTML="";
  document.getElementById("tClock").innerText="0:00";

  tPlayer = new YT.Player("tPlayer",{
    videoId: workingLesson.videoId,
    width:"100%", height:"100%",
    playerVars:{ rel:0, modestbranding:1 },
    events:{
      onReady: e=>{
        try{ e.target.seekTo(0,true); }catch(_){}
        document.getElementById("tHint").innerText = "–ü—É—Å–Ω–∏ –≤–∏–¥–µ–æ—Ç–æ. –ù–∞ —Ç–æ—á–Ω–∞—Ç–∞ —Å–µ–∫—É–Ω–¥–∞ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äû+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å‚Äú.";
        startTeacherTick();
      }
    }
  });
};
function startTeacherTick(){
  stopTeacherTick();
  tTick = setInterval(()=>{
    if(!tPlayer || typeof tPlayer.getCurrentTime!=="function") return;
    document.getElementById("tClock").innerText = fmt(tPlayer.getCurrentTime());
  }, 300);
}
function stopTeacherTick(){
  if(tTick) clearInterval(tTick);
  tTick=null;
}

function renderTeacherQuestions(){
  const box = document.getElementById("tQList");
  if(!box) return;
  if(!workingLesson){
    box.innerHTML = `<div class="text-slate-400 text-sm">–ò–∑–±–µ—Ä–∏ —É—Ä–æ–∫ –∏–ª–∏ —Å—ä–∑–¥–∞–π –Ω–æ–≤.</div>`;
    return;
  }
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  if(qs.length===0){
    box.innerHTML = `<div class="text-slate-400 text-sm">–ù—è–º–∞ –≤—ä–ø—Ä–æ—Å–∏. –î–æ–±–∞–≤–∏ —Å –±—É—Ç–æ–Ω–∞ ‚Äû+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å‚Äú.</div>`;
    return;
  }
  box.innerHTML = qs.map((q, idx)=>`
    <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="font-black">${fmt(q.time)} ‚Äî ${escapeHtml(q.text)}</div>
        <button class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-bold" onclick="seekTeacher(${q.time})">–°–∫–æ–∫</button>
      </div>
      <div class="text-xs text-slate-400">–í–µ—Ä–µ–Ω: <b>${Number(q.correctIndex)+1}</b></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        ${(q.options||[]).map((o,i)=>`<div class="bg-slate-800 border border-slate-700 rounded-xl p-2 ${i===q.correctIndex?'text-emerald-300':''}">
          ${i+1}) ${escapeHtml(o)}
        </div>`).join("")}
      </div>
      <div class="flex gap-2 flex-wrap pt-2">
        <button class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="editTeacherQ(${idx})">–†–µ–¥–∞–∫—Ü–∏—è</button>
        <button class="bg-rose-600 hover:bg-rose-500 px-3 py-2 rounded-xl font-bold text-sm" onclick="delTeacherQ(${idx})">–ò–∑—Ç—Ä–∏–π</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-xl font-bold text-sm" onclick="nudgeTeacherQ(${idx}, -1)">-1s</button>
        <button class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-xl font-bold text-sm" onclick="nudgeTeacherQ(${idx}, +1)">+1s</button>
      </div>
    </div>
  `).join("");
}
window.seekTeacher = (sec)=>{
  if(!tPlayer) return;
  tPlayer.seekTo(sec,true);
  tPlayer.playVideo();
};

window.openQForm = ()=>{
  if(!workingLesson){ toast("–ü—ä—Ä–≤–æ –∏–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫.", "warn"); return; }
  editingQIndex = null;
  const t = (tPlayer && typeof tPlayer.getCurrentTime==="function") ? Math.floor(tPlayer.getCurrentTime()) : 0;
  document.getElementById("qFormTitle").innerText="–ù–æ–≤ –≤—ä–ø—Ä–æ—Å";
  document.getElementById("qTime").value=t;
  document.getElementById("qText").value="";
  document.getElementById("qO0").value="";
  document.getElementById("qO1").value="";
  document.getElementById("qO2").value="";
  document.getElementById("qO3").value="";
  document.getElementById("qCorrect").value="0";
  document.getElementById("qErr").innerText="";
  document.getElementById("modalQ").classList.remove("hidden");
  if(tPlayer) tPlayer.pauseVideo();
};
window.closeQForm = ()=> document.getElementById("modalQ").classList.add("hidden");

window.saveQForm = ()=>{
  const err = document.getElementById("qErr");
  err.innerText="";
  const time = Number(document.getElementById("qTime").value);
  const text = (document.getElementById("qText").value||"").trim();
  const options = [
    (document.getElementById("qO0").value||"").trim(),
    (document.getElementById("qO1").value||"").trim(),
    (document.getElementById("qO2").value||"").trim(),
    (document.getElementById("qO3").value||"").trim()
  ];
  const correctIndex = Number(document.getElementById("qCorrect").value);
  if(!Number.isFinite(time) || time<0){ err.innerText="–ù–µ–≤–∞–ª–∏–¥–Ω–∞ —Å–µ–∫—É–Ω–¥–∞."; return; }
  if(!text){ err.innerText="–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞."; return; }
  if(options.some(o=>!o)){ err.innerText="–ü–æ–ø—ä–ª–Ω–∏ –∏ 4-—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∞."; return; }
  if(!(correctIndex>=0 && correctIndex<=3)){ err.innerText="–ò–∑–±–µ—Ä–∏ –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä."; return; }
  const q = { time, text, options, correctIndex };
  if(editingQIndex===null) workingLesson.questions.push(q);
  else workingLesson.questions[editingQIndex]=q;
  workingLesson.questions.sort((a,b)=>a.time-b.time);
  renderTeacherQuestions();
  window.closeQForm();

  upsertLesson(workingLesson);
  renderLibrary();
  markAutosave("–ê–≤—Ç–æ—Å–µ–π–≤ ‚úÖ");
  toast("–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω (–∞–≤—Ç–æ—Å–µ–π–≤).", "success");
};

window.editTeacherQ = (index)=>{
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  const q = qs[index]; if(!q) return;
  const realIdx = workingLesson.questions.findIndex(x=>x.time===q.time && x.text===q.text);
  editingQIndex = realIdx>=0 ? realIdx : index;
  document.getElementById("qFormTitle").innerText="–†–µ–¥–∞–∫—Ü–∏—è –Ω–∞ –≤—ä–ø—Ä–æ—Å";
  document.getElementById("qTime").value=q.time;
  document.getElementById("qText").value=q.text;
  document.getElementById("qO0").value=q.options[0]||"";
  document.getElementById("qO1").value=q.options[1]||"";
  document.getElementById("qO2").value=q.options[2]||"";
  document.getElementById("qO3").value=q.options[3]||"";
  document.getElementById("qCorrect").value=String(q.correctIndex||0);
  document.getElementById("qErr").innerText="";
  document.getElementById("modalQ").classList.remove("hidden");
  if(tPlayer) tPlayer.pauseVideo();
};

window.delTeacherQ = (index)=>{
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  const q = qs[index]; if(!q) return;
  if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞?")) return;
  const realIdx = workingLesson.questions.findIndex(x=>x.time===q.time && x.text===q.text);
  if(realIdx>=0) workingLesson.questions.splice(realIdx,1);
  else workingLesson.questions.splice(index,1);
  renderTeacherQuestions();
  upsertLesson(workingLesson);
  renderLibrary();
  markAutosave("–ê–≤—Ç–æ—Å–µ–π–≤ ‚úÖ");
  toast("–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç (–∞–≤—Ç–æ—Å–µ–π–≤).","success");
};

window.nudgeTeacherQ = (index, delta)=>{
  const qs = (workingLesson.questions||[]).slice().sort((a,b)=>a.time-b.time);
  const q = qs[index]; if(!q) return;
  const realIdx = workingLesson.questions.findIndex(x=>x.time===q.time && x.text===q.text);
  const idx = realIdx>=0 ? realIdx : index;
  workingLesson.questions[idx].time = Math.max(0, (workingLesson.questions[idx].time||0)+delta);
  workingLesson.questions.sort((a,b)=>a.time-b.time);
  renderTeacherQuestions();
  upsertLesson(workingLesson);
  renderLibrary();
  markAutosave("–ê–≤—Ç–æ—Å–µ–π–≤ ‚úÖ");
  toast("–í—Ä–µ–º–µ—Ç–æ –µ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–æ (–∞–≤—Ç–æ—Å–µ–π–≤).","success");
};

/* =========================
   Share SOLO code
========================= */
window.openShareCode = ()=>{
  if(!workingLesson){ toast("–ò–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ –ó–∞–ø–∞–∑–∏.", "warn"); return; }
  workingLesson.title = (document.getElementById("tTitle").value||"").trim() || "–ë–µ–∑ –∏–º–µ";
  workingLesson.videoId = (document.getElementById("tVid").value||"").trim();
  workingLesson.questions = (workingLesson.questions||[]).sort((a,b)=>a.time-b.time);
  if(!workingLesson.videoId || workingLesson.videoId.length!==11){ toast("–ü—ä—Ä–≤–æ –≤—ä–≤–µ–¥–∏ YouTube ID (11 –∑–Ω–∞–∫–∞).", "error"); return; }
  shareLessonNow(workingLesson);
};
function shareLessonNow(lesson){
  const payload = { v: lesson.videoId, title: lesson.title||"–ë–µ–∑ –∏–º–µ", q: (lesson.questions||[]).sort((a,b)=>a.time-b.time) };
  const code = b64EncodeUnicode(JSON.stringify(payload));
  document.getElementById("shareText").value = code;
  document.getElementById("shareInfo").innerText = `–£—Ä–æ–∫: "${lesson.title}" ‚Ä¢ –í—ä–ø—Ä–æ—Å–∏: ${(lesson.questions||[]).length}`;
  document.getElementById("modalShare").classList.remove("hidden");
}
window.closeShare = ()=> document.getElementById("modalShare").classList.add("hidden");
window.copyShare = ()=>{
  const ta=document.getElementById("shareText"); ta.select(); document.execCommand("copy");
  toast("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω ‚úÖ","success");
};

/* =========================
   Import / Export JSON
========================= */
window.openExportModal = ()=>{
  if(!workingLesson){ toast("–ò–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫.", "warn"); return; }
  const clean = JSON.stringify({
    id: workingLesson.id,
    title: (document.getElementById("tTitle").value||"").trim() || workingLesson.title || "–ë–µ–∑ –∏–º–µ",
    videoId: (document.getElementById("tVid").value||"").trim() || workingLesson.videoId,
    questions: (workingLesson.questions||[]).sort((a,b)=>a.time-b.time)
  }, null, 2);
  document.getElementById("ieTitle").innerText="–ï–∫—Å–ø–æ—Ä—Ç (JSON)";
  document.getElementById("ieText").value=clean;
  document.getElementById("ieErr").innerText="";
  document.getElementById("modalIE").classList.remove("hidden");
};
window.openImportModal = ()=>{
  document.getElementById("ieTitle").innerText="–ò–º–ø–æ—Ä—Ç (JSON)";
  document.getElementById("ieText").value="";
  document.getElementById("ieErr").innerText="";
  document.getElementById("modalIE").classList.remove("hidden");
};
window.closeIE = ()=> document.getElementById("modalIE").classList.add("hidden");
window.copyIE = ()=>{
  const ta=document.getElementById("ieText"); ta.select(); document.execCommand("copy");
  document.getElementById("ieErr").innerText="‚úÖ –ö–æ–ø–∏—Ä–∞–Ω–æ!";
};
window.doIEImport = ()=>{
  const raw=(document.getElementById("ieText").value||"").trim();
  const err=document.getElementById("ieErr"); err.innerText="";
  if(!raw){ err.innerText="–ü–æ—Å—Ç–∞–≤–∏ JSON."; return; }
  try{
    const obj=JSON.parse(raw);
    if(!obj.videoId || String(obj.videoId).length!==11) throw new Error("–õ–∏–ø—Å–≤–∞/–≥—Ä–µ—à–µ–Ω videoId.");
    if(!Array.isArray(obj.questions)) throw new Error("–õ–∏–ø—Å–≤–∞ questions (–º–∞—Å–∏–≤).");
    const lesson={
      id: obj.id || ("L"+Date.now()),
      title: obj.title || "–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω —É—Ä–æ–∫",
      videoId: obj.videoId,
      questions: obj.questions.map(q=>({
        time: Number(q.time||0),
        text: String(q.text||""),
        options: Array.isArray(q.options) ? q.options.slice(0,4) : ["","","",""],
        correctIndex: Number(q.correctIndex||0)
      })).sort((a,b)=>a.time-b.time)
    };
    upsertLesson(lesson);
    window.selectLesson(lesson.id);
    renderLibrary();
    err.innerText="‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!";
    toast("–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ ‚úÖ","success");
  }catch(e){
    err.innerText="‚ùå "+(e.message||e);
  }
};

/* =========================
   SOLO: player reset + run
========================= */
function resetStudentPlayerUI(){
  stopStudentTick();
  destroyYT(sPlayer); sPlayer=null;
  const clock=document.getElementById("sClock");
  const mini=document.getElementById("sMini");
  const box=document.getElementById("sPlayer");
  if(clock) clock.innerText="0:00";
  if(mini) mini.innerText="–°—Ç–∞—Ä—Ç–∏—Ä–∞–π —É—Ä–æ–∫–∞.";
  if(box) box.innerHTML="";
}
function stopStudentTick(){ if(sTick) clearInterval(sTick); sTick=null; }

window.startStudentFromCode = ()=>{
  const name=(document.getElementById("stuName").value||"").trim() || "–ê–Ω–æ–Ω–∏–º–µ–Ω";
  const code=(document.getElementById("stuCode").value||"").trim();
  if(!code){ toast("–ü–æ—Å—Ç–∞–≤–∏ –∫–æ–¥.","warn"); return; }
  let obj=null;
  try{ obj = JSON.parse(b64DecodeUnicode(code)); }
  catch{ toast("–ö–æ–¥—ä—Ç –Ω–µ –µ –≤–∞–ª–∏–¥–µ–Ω.","error"); return; }
  if(!obj || !obj.v || String(obj.v).length!==11 || !Array.isArray(obj.q)){
    toast("–ö–æ–¥—ä—Ç –µ –ø–æ–≤—Ä–µ–¥–µ–Ω.","error"); return;
  }
  const mode = document.getElementById("modeSOP").checked ? "sop"
            : document.getElementById("modeDiscuss").checked ? "discuss"
            : "home";
  const lesson = { title: obj.title||"–£—Ä–æ–∫", videoId: obj.v, questions: obj.q };
  startStudent(lesson, mode, name);
};

function startStudent(lesson, mode, name){
  if(!ytReady){ toast("YouTube API –æ—â–µ –∑–∞—Ä–µ–∂–¥–∞. –ò–∑—á–∞–∫–∞–π 1-2 —Å–µ–∫.","warn"); return; }

  lesson.questions = (lesson.questions||[])
    .map(q=>({ ...q, time:Number(q.time), correctIndex:Number(q.correctIndex), options:Array.isArray(q.options)?q.options.slice(0,4):["","","",""] }))
    .filter(q=>Number.isFinite(q.time))
    .sort((a,b)=>a.time-b.time);

  sMode = mode;
  sStudentName = name;
  sLessonTitle = lesson.title || "–£—Ä–æ–∫";
  sScore = 0;
  sAsked = new Set();
  sActiveQ = null;
  sMax = (lesson.questions||[]).length;

  document.getElementById("sName").innerText=sStudentName;
  document.getElementById("sLesson").innerText=sLessonTitle;
  document.getElementById("sScore").innerText="0";
  document.getElementById("sModeLabel").innerText = "–†–µ–∂–∏–º: " + (mode==="home"?"–î–æ–º–∞—à–Ω–æ":mode==="sop"?"–°–û–ü":"–û–±—Å—ä–∂–¥–∞–Ω–µ");
  document.getElementById("btnSpeak").classList.toggle("hidden", mode!=="sop");

  resetStudentPlayerUI();
  go("student");

  sPlayer = new YT.Player("sPlayer",{
    videoId: lesson.videoId,
    width:"100%", height:"100%",
    playerVars:{ rel:0, modestbranding:1 },
    events:{
      onReady: e=>{
        try{ e.target.seekTo(0,true); }catch(_){}
        document.getElementById("sClock").innerText="0:00";
        document.getElementById("sMini").innerText=`–¢–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω ‚Ä¢ –í—ä–ø—Ä–æ—Å–∏: ${lesson.questions.length} ‚Ä¢ –ù–∞—Ç–∏—Å–Ω–∏ Play –∞–∫–æ –Ω–µ —Ç—Ä—ä–≥–Ω–µ.`;
        startStudentTick(lesson);
      },
      onStateChange: e=>{
        if(e.data===1) startStudentTick(lesson);
        if(e.data===0) finishStudent();
      }
    }
  });
}

function startStudentTick(lesson){
  stopStudentTick();
  sTick = setInterval(()=>{
    if(!sPlayer || typeof sPlayer.getCurrentTime!=="function") return;
    const t = sPlayer.getCurrentTime();
    document.getElementById("sClock").innerText = fmt(t);

    const qs = lesson.questions||[];
    for(let i=0;i<qs.length;i++){
      if(sAsked.has(i)) continue;
      if(t >= qs[i].time){
        sAsked.add(i);
        showStudentQuestion(qs[i]);
        break;
      }
    }
  }, 300);
}

function showStudentQuestion(q){
  sActiveQ = q;
  if(sPlayer) sPlayer.pauseVideo();

  document.getElementById("sqMeta").innerText = `–í—ä–ø—Ä–æ—Å @ ${fmt(q.time)}`;
  document.getElementById("sqText").innerText = q.text;
  document.getElementById("sqFeed").innerText = "–ò–∑–±–µ—Ä–∏ –æ—Ç–≥–æ–≤–æ—Ä.";
  document.getElementById("btnSQContinue").classList.add("hidden");

  const sqTextEl = document.getElementById("sqText");
  sqTextEl.className = (sMode==="sop") ? "text-3xl font-black leading-snug" : "text-xl font-black";

  const box=document.getElementById("sqOpts");
  box.innerHTML="";
  q.options.forEach((opt, idx)=>{
    const b=document.createElement("button");
    b.className = (sMode==="sop")
      ? "w-full text-left bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-2xl p-5 font-black text-xl transition"
      : "w-full text-left bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl p-4 font-bold transition";
    b.innerText = opt;
    b.onclick = ()=>answerStudent(idx);
    box.appendChild(b);
  });

  document.getElementById("modalSQ").classList.remove("hidden");
  if(sMode==="sop") speakSQ();
  else if(window.speechSynthesis) window.speechSynthesis.cancel();
}

function answerStudent(idx){
  if(!sActiveQ) return;
  const correct = Number(sActiveQ.correctIndex)===idx;

  document.querySelectorAll("#sqOpts button").forEach((b,i)=>{
    b.disabled=true;
    b.classList.remove("hover:bg-slate-700");
    if(i===Number(sActiveQ.correctIndex)) b.classList.add("border-emerald-500");
    if(i===idx && !correct) b.classList.add("border-rose-500");
    b.classList.add("opacity-95");
  });

  if(correct){
    sScore += 1;
    document.getElementById("sScore").innerText = String(sScore);
    document.getElementById("sqFeed").innerText = "‚úÖ –í—è—Ä–Ω–æ!";
  }else{
    document.getElementById("sqFeed").innerText = "‚ùå –ì—Ä–µ—à–Ω–æ.";
  }
  document.getElementById("btnSQContinue").classList.remove("hidden");
}

window.continueStudent = ()=>{
  closeSQ();
  if(sPlayer) sPlayer.playVideo();
};
window.closeSQ = ()=>{
  document.getElementById("modalSQ").classList.add("hidden");
  sActiveQ=null;
  if(window.speechSynthesis) window.speechSynthesis.cancel();
};
window.speakSQ = ()=>{
  if(!("speechSynthesis" in window)) return;
  const txt=document.getElementById("sqText").innerText;
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(txt);
  u.lang="bg-BG"; u.rate=0.9;
  window.speechSynthesis.speak(u);
};

function finishStudent(){
  stopStudentTick();

  const saved = (sMode==="home");
  if(saved){
    const arr = loadResults();
    arr.unshift({ student:sStudentName, lesson:sLessonTitle, score:sScore, max:sMax, at:new Date().toISOString() });
    saveResults(arr.slice(0,200));
  }

  document.getElementById("finInfo").innerText = `${sStudentName} ‚Ä¢ ${sLessonTitle} ‚Ä¢ —Ä–µ–∂–∏–º: ${sMode==="home"?"–î–æ–º–∞—à–Ω–æ":sMode==="sop"?"–°–û–ü":"–û–±—Å—ä–∂–¥–∞–Ω–µ"}`;
  document.getElementById("finScore").innerText = String(sScore);
  document.getElementById("finMax").innerText = String(sMax);
  document.getElementById("finSaved").innerText = saved ? "‚úÖ –†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω –ª–æ–∫–∞–ª–Ω–æ." : "‚ÑπÔ∏è –†–µ–∂–∏–º –æ–±—Å—ä–∂–¥–∞–Ω–µ ‚Äì —Ä–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –ù–ï —Å–µ –∑–∞–ø–∏—Å–≤–∞.";
  go("finish");
  renderResults();
}

/* =========================
   LIVE CLASS ‚Äì HOST
========================= */
function makePin(){
  return String(Math.floor(1000 + Math.random()*9000));
}
async function ensureAuth(){
  if(!fbUser){
    await signInAnonymously(auth);
  }
  return auth.currentUser;
}

window.startLiveHostFromLibrary = async (lessonId)=>{
  const lesson = loadLibrary().find(x=>x.id===lessonId);
  if(!lesson){ toast("–ù—è–º–∞ —Ç–∞–∫—ä–≤ —É—Ä–æ–∫.","error"); return; }
  await startLiveHost(lesson);
};

window.startLiveHostFromEditor = async ()=>{
  if(!workingLesson){ toast("–ò–∑–±–µ—Ä–∏/—Å—ä–∑–¥–∞–π —É—Ä–æ–∫.","warn"); return; }
  // –ø–æ–ª–∑–≤–∞–π —Ç–µ–∫—É—â–æ—Ç–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const lesson = {
    title: (document.getElementById("tTitle").value||"").trim() || workingLesson.title || "–ë–µ–∑ –∏–º–µ",
    videoId: (document.getElementById("tVid").value||"").trim() || workingLesson.videoId,
    questions: (workingLesson.questions||[]).sort((a,b)=>a.time-b.time)
  };
  if(!lesson.videoId || lesson.videoId.length!==11){ toast("YouTube ID —Ç—Ä—è–±–≤–∞ –¥–∞ –µ 11 –∑–Ω–∞–∫–∞.","error"); return; }
  if((lesson.questions||[]).length===0){ toast("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ 1 –≤—ä–ø—Ä–æ—Å.","warn"); return; }
  await startLiveHost(lesson);
};

async function startLiveHost(lesson){
  if(!ytReady){ toast("YouTube API –æ—â–µ –∑–∞—Ä–µ–∂–¥–∞.","warn"); return; }
  await ensureAuth();

  // cleanup previous host session if any
  hostCleanup();

  hostLesson = normalizeLessonForLive(lesson);

  // create unique pin
  let pin = null;
  for(let tries=0; tries<7; tries++){
    const candidate = makePin();
    const snap = await getDoc(sessionRef(candidate));
    if(!snap.exists()){ pin = candidate; break; }
  }
  if(!pin){ toast("–ù–µ —É—Å–ø—è—Ö –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–º PIN. –û–ø–∏—Ç–∞–π –ø–∞–∫.","error"); return; }

  hostPin = pin;
  hostActiveQ = -1;
  document.getElementById("hostPin").innerText = hostPin;
  document.getElementById("hostLessonTitle").innerText = hostLesson.title;
  document.getElementById("hostCount").innerText = "0";
  document.getElementById("hostAnswered").innerText = "0";
  document.getElementById("hostTotal").innerText = "0";
  document.getElementById("hostProgressBar").style.width = "0%";
  document.getElementById("btnHostResume").classList.add("hidden");
  document.getElementById("btnHostStart").classList.remove("hidden");
  document.getElementById("hostOverlay").classList.remove("hidden");

  // QR with only pin (safer)
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(hostPin)}`;
  document.getElementById("hostQR").src = qrUrl;

  // create session doc
  await setDoc(sessionRef(hostPin), {
    pin: hostPin,
    status: "waiting",          // waiting | playing | active | finished
    activeQ: -1,
    lesson: hostLesson,         // snapshot
    hostUid: auth.currentUser.uid,
    createdAt: serverTimestamp(),
    endedAt: null
  });

  // subscribe to participants
  const unsubParts = onSnapshot(participantsCol(hostPin), (snap)=>{
    hostParticipants = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderHostLeaderboard();
    updateHostProgress();
  });
  hostUnsubs.push(unsubParts);

  // build host player
  destroyYT(hostPlayer); hostPlayer=null;
  document.getElementById("hostPlayer").innerHTML = "";
  hostPlayer = new YT.Player("hostPlayer",{
    videoId: hostLesson.videoId,
    width:"100%", height:"100%",
    playerVars:{ rel:0, modestbranding:1 },
    events:{
      onReady: e=>{
        try{ e.target.seekTo(0,true); }catch(_){}
      },
      onStateChange: e=>{
        // when playing, ensure tick is running
        if(e.data===1) hostStartTick();
      }
    }
  });

  go("live-host");
  toast("–°–µ—Å–∏—è—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞ ‚úÖ","success");
}

function normalizeLessonForLive(lesson){
  const qs = (lesson.questions||[])
    .map(q=>({
      time: Number(q.time),
      text: String(q.text||""),
      options: Array.isArray(q.options) ? q.options.slice(0,4) : ["","","",""],
      correctIndex: Number(q.correctIndex||0)
    }))
    .filter(q=>Number.isFinite(q.time))
    .sort((a,b)=>a.time-b.time);

  return {
    title: lesson.title || "–£—Ä–æ–∫",
    videoId: lesson.videoId,
    questions: qs,
    maxScore: qs.length
  };
}

window.hostStartVideo = async ()=>{
  if(!hostPlayer || !hostPin) return;
  document.getElementById("hostOverlay").classList.add("hidden");
  document.getElementById("btnHostStart").classList.add("hidden");
  await updateDoc(sessionRef(hostPin), { status: "playing" });
  hostPlayer.playVideo();
};

function hostStartTick(){
  hostStopTick();
  hostTick = setInterval(async ()=>{
    if(!hostPlayer || typeof hostPlayer.getCurrentTime!=="function") return;
    if(!hostLesson) return;

    // if already in active question state, don't auto-trigger new ones
    // (host resumes manually)
    const t = Math.floor(hostPlayer.getCurrentTime());
    const nextIdx = hostLesson.questions.findIndex((q, idx)=> idx>hostActiveQ && Math.abs(q.time - t) <= 1);

    if(nextIdx !== -1){
      hostActiveQ = nextIdx;
      hostPlayer.pauseVideo();
      document.getElementById("btnHostResume").classList.remove("hidden");
      await updateDoc(sessionRef(hostPin), {
        status: "active",
        activeQ: nextIdx,
        qData: hostLesson.questions[nextIdx]
      });
      updateHostProgress();
      toast("–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∞–∫—Ç–∏–≤–µ–Ω.","warn");
    }
  }, 800);
}
function hostStopTick(){ if(hostTick) clearInterval(hostTick); hostTick=null; }

window.hostResume = async ()=>{
  if(!hostPin || !hostPlayer) return;
  document.getElementById("btnHostResume").classList.add("hidden");
  await updateDoc(sessionRef(hostPin), { status:"playing" });
  hostPlayer.playVideo();
};

window.hostEndSession = async ()=>{
  if(!hostPin) { go("teacher"); return; }
  if(!confirm("–ö—Ä–∞–π –Ω–∞ —Å–µ—Å–∏—è—Ç–∞?")) return;

  hostStopTick();
  try{ await updateDoc(sessionRef(hostPin), { status:"finished", endedAt: serverTimestamp() }); }catch(e){}
  // show end to clients
  toast("–°–µ—Å–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏.","success");
  go("teacher");
  hostCleanup();
};

function renderHostLeaderboard(){
  const tb = document.getElementById("hostLeaderboard");
  if(!tb) return;
  const sorted = [...hostParticipants].sort((a,b)=>(b.score||0)-(a.score||0));
  document.getElementById("hostCount").innerText = String(sorted.length);

  tb.innerHTML = sorted.map((p,i)=>`
    <tr>
      <td class="py-2 pr-2 text-slate-400 font-black w-10">#${i+1}</td>
      <td class="py-2 font-bold">${escapeHtml(p.name||"")}</td>
      <td class="py-2 text-right font-black text-emerald-300">${p.score||0}</td>
    </tr>
  `).join("");
}

function updateHostProgress(){
  const total = hostParticipants.length;
  document.getElementById("hostTotal").innerText = String(total);

  if(hostActiveQ < 0 || total === 0){
    document.getElementById("hostAnswered").innerText = "0";
    document.getElementById("hostProgressBar").style.width = "0%";
    return;
  }
  const answered = hostParticipants.filter(p => p.answers && p.answers[String(hostActiveQ)]).length;
  document.getElementById("hostAnswered").innerText = String(answered);
  const pct = Math.round((answered / total) * 100);
  document.getElementById("hostProgressBar").style.width = `${pct}%`;
}

function hostCleanup(){
  hostStopTick();
  hostUnsubs.forEach(fn=>{ try{ fn(); }catch(e){} });
  hostUnsubs = [];
  hostParticipants = [];
  hostActiveQ = -1;
  hostLesson = null;
  hostPin = null;
  destroyYT(hostPlayer); hostPlayer=null;
  document.getElementById("hostPlayer").innerHTML="";
}

/* =========================
   LIVE CLASS ‚Äì CLIENT
========================= */
const AVATARS = ["üòé","ü§ì","ü¶ä","üêº","üêØ","ü¶Å","üê∏","üêµ","üê∂","üê±","üêß","ü¶Ñ","üê≤","ü¶ã","üêù"];

window.joinLive = async ()=>{
  const name=(document.getElementById("liveName").value||"").trim();
  const pin=(document.getElementById("livePin").value||"").trim();
  if(!name || !pin){ toast("–í—ä–≤–µ–¥–∏ –∏–º–µ –∏ PIN.","warn"); return; }

  await ensureAuth();

  const snap = await getDoc(sessionRef(pin));
  if(!snap.exists()){ toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω PIN.","error"); return; }
  const sess = snap.data();
  if(sess.status === "finished"){ toast("–¢–∞–∑–∏ —Å–µ—Å–∏—è –≤–µ—á–µ –µ –ø—Ä–∏–∫–ª—é—á–∏–ª–∞.","warn"); return; }

  liveClientCleanup();

  clientPin = pin;
  clientLesson = sess.lesson;
  clientActiveQ = -1;
  clientScore = 0;
  clientSelected = null;
  clientConfirmedForQ = -1;

  document.getElementById("clientName").innerText = name;
  document.getElementById("clientScore").innerText = "0";
  document.getElementById("clientFinished").classList.add("hidden");
  document.getElementById("clientQuestion").classList.add("hidden");
  document.getElementById("clientWaiting").classList.remove("hidden");

  const avatar = AVATARS[Math.floor(Math.random()*AVATARS.length)];
  document.getElementById("clientEmoji").innerText = avatar;

  // create participant
  await setDoc(participantRef(pin, auth.currentUser.uid), {
    uid: auth.currentUser.uid,
    name,
    avatar,
    score: 0,
    joinedAt: serverTimestamp(),
    answers: {}
  }, { merge:true });

  // listen session changes
  clientUnsub = onSnapshot(sessionRef(pin), (s)=>{
    const d=s.data(); if(!d) return;

    if(d.status === "finished"){
      document.getElementById("clientWaiting").classList.add("hidden");
      document.getElementById("clientQuestion").classList.add("hidden");
      document.getElementById("clientFinished").classList.remove("hidden");
      document.getElementById("clientFinalScore").innerText = String(clientScore);
      return;
    }

    if(d.status === "active" && typeof d.activeQ === "number" && d.activeQ !== clientActiveQ){
      clientActiveQ = d.activeQ;
      clientSelected = null;
      document.getElementById("clientConfirm").classList.add("hidden");
      document.getElementById("clientWaiting").classList.add("hidden");
      document.getElementById("clientFinished").classList.add("hidden");
      document.getElementById("clientQuestion").classList.remove("hidden");
      renderClientQuestion(d.qData);
    }

    if(d.status !== "active"){
      // back to waiting (unless finished)
      document.getElementById("clientQuestion").classList.add("hidden");
      document.getElementById("clientFinished").classList.add("hidden");
      document.getElementById("clientWaiting").classList.remove("hidden");
    }
  });

  go("live-client");
  toast("–°–≤—ä—Ä–∑–∞–Ω/–∞ ‚úÖ","success");
};

function renderClientQuestion(q){
  document.getElementById("clientQText").innerText = q?.text || "‚Äî";
  const box=document.getElementById("clientOpts");
  box.innerHTML="";
  const opts = (q?.options || []).slice(0,4);

  opts.forEach((opt, idx)=>{
    const b=document.createElement("button");
    b.className = "w-full text-left bg-slate-900/60 border border-slate-800 hover:border-emerald-500 rounded-xl p-4 font-bold transition";
    b.innerText = opt;
    b.onclick = ()=>{
      clientSelected = idx;
      document.querySelectorAll("#clientOpts button").forEach(x=>x.classList.remove("border-emerald-500","bg-emerald-500/10"));
      b.classList.add("border-emerald-500","bg-emerald-500/10");
      document.getElementById("clientConfirm").classList.remove("hidden");
    };
    box.appendChild(b);
  });
}

window.clientConfirmAnswer = async ()=>{
  if(clientPin==null || clientActiveQ<0) return;
  if(clientSelected==null){ toast("–ò–∑–±–µ—Ä–∏ –æ—Ç–≥–æ–≤–æ—Ä.","warn"); return; }
  if(clientConfirmedForQ === clientActiveQ) return;

  const sessSnap = await getDoc(sessionRef(clientPin));
  if(!sessSnap.exists()) return;
  const sess = sessSnap.data();
  const q = sess.qData;
  const correct = (Number(q.correctIndex) === Number(clientSelected));

  if(correct) clientScore += 1;
  document.getElementById("clientScore").innerText = String(clientScore);

  // write answer into participant doc
  const upd = {
    score: clientScore
  };
  upd[`answers.${clientActiveQ}`] = { selected: clientSelected, correct, at: Date.now() };

  await updateDoc(participantRef(clientPin, auth.currentUser.uid), upd);
  clientConfirmedForQ = clientActiveQ;

  // UI feedback
  document.getElementById("clientConfirm").classList.add("hidden");
  document.getElementById("clientWaiting").classList.remove("hidden");
  document.getElementById("clientQuestion").classList.add("hidden");
  toast(correct ? "–í—è—Ä–Ω–æ ‚úÖ" : "–ì—Ä–µ—à–Ω–æ ‚ùå", correct ? "success" : "error");
};

function liveClientCleanup(){
  try{ if(clientUnsub) clientUnsub(); }catch(e){}
  clientUnsub = null;
  clientPin = null;
  clientLesson = null;
  clientActiveQ = -1;
  clientScore = 0;
  clientSelected = null;
  clientConfirmedForQ = -1;
}
window.liveClientCleanup = liveClientCleanup;

/* =========================
   INIT
========================= */
go("welcome");
renderLibrary();
renderResults();

/* =========================
   FIRESTORE RULES (–∫–æ–ø–∏—Ä–∞–π –≤ Firebase Console)
========================= */
/*
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // allow anonymous auth (students/teacher host)
    function isAuthed() { return request.auth != null; }

    match /artifacts/videoquiz-ultimate-live/public/data/sessions/{pin} {

      // Everyone can read session (needed for students)
      allow read: if true;

      // Create session: any authed user (teacher/host)
      allow create: if isAuthed();

      // Update session: only hostUid can update (protect control)
      allow update: if isAuthed() && request.auth.uid == resource.data.hostUid;

      // Participants subcollection
      match /participants/{uid} {
        allow read: if true;
        allow create: if isAuthed() && request.auth.uid == uid;
        allow update: if isAuthed() && request.auth.uid == uid;
        allow delete: if false;
      }
    }
  }
}
*/
  <script>
  window.__ytReady = false;

  function loadYouTubeAPI() {
    return new Promise((resolve, reject) => {
      if (window.YT && window.YT.Player) {
        window.__ytReady = true;
        return resolve(true);
      }
      if (document.getElementById("yt-iframe-api")) {
        const start = Date.now();
        const t = setInterval(() => {
          if (window.YT && window.YT.Player) {
            clearInterval(t);
            window.__ytReady = true;
            resolve(true);
          } else if (Date.now() - start > 5000) {
            clearInterval(t);
            reject(new Error("YouTube API timeout (blocked?)"));
          }
        }, 100);
        return;
      }

      const s = document.createElement("script");
      s.id = "yt-iframe-api";
      s.src = "https://www.youtube.com/iframe_api";
      s.async = true;
      s.onerror = () => reject(new Error("YouTube API script blocked"));
      document.head.appendChild(s);

      window.onYouTubeIframeAPIReady = () => {
        window.__ytReady = true;
        resolve(true);
      };

      setTimeout(() => {
        if (!(window.YT && window.YT.Player)) reject(new Error("YouTube API timeout (blocked?)"));
      }, 5000);
    });
  }

  function showYouTubeFallback(videoId) {
    const box = document.createElement("div");
    box.style.cssText =
      "position:fixed;top:16px;right:16px;z-index:99999;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;max-width:320px;font:14px/1.3 system-ui;box-shadow:0 10px 30px rgba(0,0,0,.35)";
    box.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">YouTube API –µ –±–ª–æ–∫–∏—Ä–∞–Ω–æ</div>
      <div style="opacity:.9;margin-bottom:10px">
        –ë–ª–æ–∫–∏—Ä–∞–Ω–æ –µ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ iframe_api (–æ–±–∏–∫–Ω–æ–≤–µ–Ω–æ –æ—Ç AdBlock/Shield/–º—Ä–µ–∂–∞).
      </div>
      <a target="_blank" rel="noopener"
         href="https://www.youtube.com/watch?v=${encodeURIComponent(videoId||"")}"
         style="display:inline-block;background:#2563eb;color:#fff;padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:700">
         –û—Ç–≤–æ—Ä–∏ –≤–∏–¥–µ–æ—Ç–æ –≤ YouTube
      </a>
    `;
    document.body.appendChild(box);
  }

  window.ensureYouTube = async function(videoIdForFallback) {
    try { await loadYouTubeAPI(); return true; }
    catch (e) { console.warn(e); showYouTubeFallback(videoIdForFallback); return false; }
  };
</script>

</body>
</html>
