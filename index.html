<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VideoQuiz Ultimate</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { height: 100%; }
    body { margin: 0; }
    .glass { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }
    .btn { @apply px-4 py-2 rounded-xl font-bold; }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <!-- Top bar -->
  <header class="sticky top-0 z-50 border-b border-white/10 bg-slate-950/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2 font-black">
        <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
        <span>VideoQuiz</span>
        <span class="text-slate-400 font-semibold">Ultimate</span>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <span id="ytBadge" class="hidden text-xs px-3 py-1 rounded-full bg-amber-500/20 border border-amber-400/20 text-amber-200">
          YouTube API още зарежда… Изчакай 1–2 сек.
        </span>

        <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-sm"
                onclick="UI.show('screenHome')">Начало</button>

        <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-sm"
                onclick="UI.show('screenTeacher')">Учител</button>

        <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-sm"
                onclick="UI.show('screenSolo')">Самостоятелно</button>

        <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-sm"
                onclick="UI.show('screenLiveJoin')">В клас</button>
      </div>
    </div>
  </header>

  <!-- Toasts -->
  <div id="toasts" class="fixed top-16 right-4 z-[9999] space-y-2"></div>

  <!-- Screens wrapper -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- HOME -->
    <section id="screenHome" class="space-y-4">
      <div class="glass rounded-2xl p-6">
        <h1 class="text-3xl font-black">VideoQuiz</h1>
        <p class="text-slate-300 mt-2">
          Урок с YouTube + въпроси по секунди. Режими: Учител / Самостоятелно / В клас (QR).
        </p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black"
                  onclick="UI.show('screenTeacher')">Учителски панел</button>
          <button class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-black"
                  onclick="UI.show('screenSolo')">Самостоятелно</button>
          <button class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 font-black"
                  onclick="UI.show('screenLiveJoin')">В клас (ученик)</button>
        </div>
      </div>
    </section>

    <!-- TEACHER -->
    <section id="screenTeacher" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        <!-- Library -->
        <aside class="lg:col-span-4 glass rounded-2xl p-4">
          <div class="flex items-center gap-2">
            <div>
              <div class="text-xs text-slate-400 font-bold uppercase">Учителски панел</div>
              <div class="text-xl font-black">Библиотека</div>
            </div>
            <div class="ml-auto">
              <button class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black text-sm"
                      onclick="Teacher.newLesson()">+ Нов урок</button>
            </div>
          </div>

          <div class="mt-3">
            <input id="libSearch" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                   placeholder="Търси по име…" oninput="Teacher.renderLibrary()" />
          </div>

          <div class="mt-3 flex gap-2">
            <button id="tabLessons" class="flex-1 px-3 py-2 rounded-xl bg-indigo-600 font-black"
                    onclick="Teacher.setTab('lessons')">Уроци</button>
            <button id="tabResults" class="flex-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10 font-black"
                    onclick="Teacher.setTab('results')">Домашни резултати</button>
          </div>

          <div id="libList" class="mt-3 space-y-2 text-sm text-slate-200"></div>

          <div class="mt-4 text-xs text-slate-400">
            Уроците/резултатите се пазят локално в този браузър.
          </div>
        </aside>

        <!-- Editor center -->
        <section class="lg:col-span-8 space-y-4">
          <div class="glass rounded-2xl p-4">
            <div class="flex flex-wrap items-center gap-2">
              <div>
                <div class="text-xs text-slate-400 font-bold uppercase">Редактор</div>
                <div id="currentLessonName" class="text-lg font-black">Няма избран урок</div>
              </div>
              <div class="ml-auto flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black text-sm"
                        onclick="Live.hostStart()">В клас (на живо)</button>
                <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-black text-sm"
                        onclick="Teacher.exportLesson()">Експорт</button>
                <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-black text-sm"
                        onclick="Teacher.importLesson()">Импорт</button>
                <button class="px-3 py-2 rounded-xl bg-amber-600 hover:bg-amber-500 font-black text-sm"
                        onclick="Teacher.copySoloCode()">Код (самостоятелно)</button>
                <button class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-black text-sm"
                        onclick="Teacher.saveLesson()">Запази</button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
              <!-- video -->
              <div class="glass rounded-2xl p-3">
                <div class="flex items-center gap-2">
                  <div class="text-sm font-black">Видео</div>
                  <div class="ml-auto text-xs text-slate-300">
                    Време: <span id="tClock" class="font-black">0:00</span>
                  </div>
                </div>
                <div class="mt-2 rounded-2xl overflow-hidden bg-black aspect-video">
                  <div id="tPlayer" class="w-full h-full"></div>
                </div>
                <div id="tHint" class="mt-2 text-xs text-slate-300">
                  Зареди видео (YouTube ID) и натисни „Видео“.
                </div>
              </div>

              <!-- form + questions -->
              <div class="glass rounded-2xl p-3">
                <div class="space-y-3">
                  <input id="tTitle" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                         placeholder="Име на урок (напр. Българско възраждане)" />
                  <div class="flex gap-2">
                    <input id="tYtId" class="flex-1 px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                           placeholder="YouTube ID (11 знака)" />
                    <button class="px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-black"
                            onclick="Teacher.bootTeacherPlayer()">Видео</button>
                  </div>

                  <div class="flex items-center gap-2">
                    <div class="text-xs text-slate-400 font-black uppercase">Въпроси</div>
                    <div class="ml-auto text-xs text-slate-300">
                      Текуща секунда: <span id="tSec" class="font-black">0</span>
                    </div>
                  </div>

                  <button class="w-full px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black"
                          onclick="Teacher.addQuestionAtCurrentSecond()">
                    + Добави въпрос (на текущата секунда)
                  </button>

                  <div id="tQuestions" class="mt-2 space-y-2 max-h-[280px] overflow-auto pr-1"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Live host panel -->
          <div id="liveHostCard" class="hidden glass rounded-2xl p-4">
            <div class="flex items-center gap-2">
              <div class="text-lg font-black">Сесия „В клас“</div>
              <div class="ml-auto flex gap-2">
                <button class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black text-sm"
                        onclick="Live.start()">СТАРТ</button>
                <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-black text-sm"
                        onclick="Live.end()">КРАЙ</button>
              </div>
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="glass rounded-2xl p-3">
                <div class="text-xs text-slate-400 font-black uppercase">ПИН</div>
                <div id="livePin" class="text-4xl font-black tracking-wider">—</div>
                <div class="text-xs text-slate-300 mt-1">Ученикът влиза с ПИН или QR</div>
              </div>

              <div class="glass rounded-2xl p-3">
                <div class="text-xs text-slate-400 font-black uppercase">QR</div>
                <div id="liveQr" class="mt-2"></div>
              </div>

              <div class="glass rounded-2xl p-3">
                <div class="text-xs text-slate-400 font-black uppercase">Участници</div>
                <div class="mt-2">
                  <div class="text-sm">Влезли: <span id="liveCount" class="font-black">0</span></div>
                  <div class="text-xs text-slate-300 mt-1">* локална демо сесия (без Firebase)</div>
                </div>
              </div>
            </div>
          </div>

        </section>
      </div>
    </section>

    <!-- SOLO (student) -->
    <section id="screenSolo" class="hidden">
      <div class="glass rounded-2xl p-4">
        <div class="text-2xl font-black">Самостоятелно</div>
        <p class="text-slate-300 text-sm mt-1">Въведи име + код на урок. Въпросите ще се появяват по време на видеото.</p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="sName" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                 placeholder="Твоето име…" />
          <input id="sCode" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                 placeholder="Код на урок…" />
          <button class="px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-black"
                  onclick="Solo.start()">СТАРТ</button>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-3">
            <div class="flex items-center">
              <div class="font-black">Видео</div>
              <div class="ml-auto text-xs text-slate-300">Време: <span id="sClock" class="font-black">0:00</span></div>
            </div>
            <div class="mt-2 rounded-2xl overflow-hidden bg-black aspect-video">
              <div id="sPlayer" class="w-full h-full"></div>
            </div>
          </div>

          <div class="glass rounded-2xl p-3">
            <div class="font-black">Въпрос</div>
            <div id="sQuestionBox" class="mt-2 text-slate-200">
              <div class="text-slate-400 text-sm">Когато стигнеш секунда с въпрос – ще се покаже тук.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LIVE JOIN (student) -->
    <section id="screenLiveJoin" class="hidden">
      <div class="glass rounded-2xl p-4">
        <div class="text-2xl font-black">В клас (ученик)</div>
        <p class="text-slate-300 text-sm mt-1">Демо режим (локално). За Firebase „наистина“, ще го включим след това.</p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <input id="jName" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                 placeholder="Твоето име…" />
          <input id="jPin" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                 placeholder="ПИН…" />
          <button class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black"
                  onclick="Live.join()">ВЛЕЗ</button>
        </div>

        <div class="mt-4 glass rounded-2xl p-4">
          <div class="text-sm text-slate-300">
            След „ВЛЕЗ“ чакаш учителят да натисне СТАРТ.
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal for question editor -->
  <div id="qModal" class="hidden fixed inset-0 z-[9998] bg-black/70">
    <div class="min-h-full flex items-center justify-center p-4">
      <div class="glass rounded-2xl p-4 w-full max-w-xl">
        <div class="flex items-center gap-2">
          <div class="text-lg font-black">Въпрос на секунда <span id="qmSec" class="text-emerald-300">0</span></div>
          <button class="ml-auto px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-black text-sm"
                  onclick="Teacher.closeQuestionModal()">Затвори</button>
        </div>

        <div class="mt-3 space-y-3">
          <input id="qmText" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none"
                 placeholder="Текст на въпроса…" />

          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <input id="qmA" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none" placeholder="Отговор A" />
            <input id="qmB" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none" placeholder="Отговор B" />
            <input id="qmC" class="px-4 py-3 rounded-xl bg-white/5 border border-white/10 outline-none" placeholder="Отговор C" />
          </div>

          <div class="flex items-center gap-2">
            <span class="text-sm text-slate-300">Верният е:</span>
            <select id="qmCorrect" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 outline-none font-bold">
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>

            <button class="ml-auto px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black"
                    onclick="Teacher.saveQuestionModal()">Запази въпроса</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   1) SUPER STABLE YOUTUBE IFRAME API LOADER (FIX)
   ========================================================= */

const YouTubeAPI = (() => {
  let promise = null;
  let ready = false;

  function setBadge(on) {
    const b = document.getElementById("ytBadge");
    if (!b) return;
    b.classList.toggle("hidden", !on);
  }

  function loadOnce() {
    if (promise) return promise;

    promise = new Promise((resolve, reject) => {
      // Already available?
      if (window.YT && typeof window.YT.Player === "function") {
        ready = true;
        setBadge(false);
        resolve(window.YT);
        return;
      }

      setBadge(true);

      // Global callback (must be global, not inside module scope)
      window.onYouTubeIframeAPIReady = () => {
        ready = true;
        setBadge(false);
        resolve(window.YT);
        let ytReady = false;

        window.onYouTubeIframeAPIReady = () => {
        ytReady = true;
        console.log("YT API READY");
      };

      

      // If script already inserted, don't insert again
      const existing = document.querySelector('script[data-yt-iframe-api="1"]');
      if (!existing) {
        const s = document.createElement("script");
        s.src = "https://www.youtube.com/iframe_api";
        s.async = true;
        s.defer = true;
        s.dataset.ytIframeApi = "1";
        s.onerror = () => reject(new Error("YT iframe_api failed to load"));
        document.head.appendChild(s);
      }

      // Timeout safety (some browsers/adblock)
      setTimeout(() => {
        if (window.YT && typeof window.YT.Player === "function") {
          ready = true;
          setBadge(false);
          resolve(window.YT);
        } else if (!ready) {
          // Retry once with cache-buster
          const s2 = document.createElement("script");
          s2.src = "https://www.youtube.com/iframe_api?cb=" + Date.now();
          s2.async = true;
          s2.defer = true;
          s2.onerror = () => reject(new Error("YT iframe_api retry failed"));
          document.head.appendChild(s2);

          // second timeout
          setTimeout(() => {
            if (window.YT && typeof window.YT.Player === "function") {
              ready = true;
              setBadge(false);
              resolve(window.YT);
            } else {
              setBadge(true);
              reject(new Error("YouTube API still not ready (blocked?)"));
            }
          }, 6000);
        }
      }, 6000);
    });

    return promise;
  }

  return {
    ensure: loadOnce,
    isReady: () => ready || (window.YT && typeof window.YT.Player === "function")
  };
})();

/* =========================================================
   2) UTIL / UI
   ========================================================= */

const UI = {
  show(id){
    for (const el of document.querySelectorAll("main > section")) el.classList.add("hidden");
    document.getElementById(id)?.classList.remove("hidden");
  }
};

function toast(msg, type="info"){
  const wrap = document.getElementById("toasts");
  const el = document.createElement("div");
  const base = "px-4 py-3 rounded-2xl shadow-lg border text-sm font-bold";
  const cls = type==="error"
    ? "bg-rose-600/20 border-rose-400/20 text-rose-100"
    : type==="warn"
    ? "bg-amber-500/20 border-amber-400/20 text-amber-100"
    : "bg-emerald-600/20 border-emerald-400/20 text-emerald-100";

  el.className = base + " " + cls;
  el.textContent = msg;
  wrap.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 3200);
}

function mmss(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const m = Math.floor(sec/60);
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function safeJSONParse(str){
  try { return JSON.parse(str); } catch { return null; }
}

function uid(){
  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}

/* =========================================================
   3) LOCAL STORAGE DB
   ========================================================= */

const DB = {
  keyLessons: "vq_lessons_v1",
  keyResults: "vq_results_v1",

  getLessons(){
    return safeJSONParse(localStorage.getItem(this.keyLessons)) || [];
  },
  setLessons(list){
    localStorage.setItem(this.keyLessons, JSON.stringify(list));
  },
  upsertLesson(lesson){
    const list = this.getLessons();
    const i = list.findIndex(x => x.id === lesson.id);
    if (i>=0) list[i] = lesson; else list.unshift(lesson);
    this.setLessons(list);
  },
  deleteLesson(id){
    const list = this.getLessons().filter(x => x.id !== id);
    this.setLessons(list);
  }
};

/* =========================================================
   4) APP STATE
   ========================================================= */

let workingLesson = null;

// players
let tPlayer = null;        // teacher
let sPlayer = null;        // solo

// tickers
let teacherTicker = null;
let soloTicker = null;

// live demo
const LiveState = { pin: null, joined: 0, running: false };

/* =========================================================
   5) TEACHER
   ========================================================= */

const Teacher = {
  tab: "lessons",
  qmEditingSec: null,

  setTab(tab){
    this.tab = tab;
    document.getElementById("tabLessons").className = tab==="lessons"
      ? "flex-1 px-3 py-2 rounded-xl bg-indigo-600 font-black"
      : "flex-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10 font-black";
    document.getElementById("tabResults").className = tab==="results"
      ? "flex-1 px-3 py-2 rounded-xl bg-indigo-600 font-black"
      : "flex-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10 font-black";
    this.renderLibrary();
  },

  newLesson(){
    workingLesson = {
      id: uid(),
      title: "Нов урок",
      videoId: "",
      questions: [],  // {sec, text, A,B,C, correct}
      createdAt: Date.now(),
      updatedAt: Date.now(),
    };
    this.syncFormFromLesson();
    this.renderLibrary();
    toast("Създаден е нов урок. Въведи YouTube ID.", "info");
  },

  selectLesson(id){
    const l = DB.getLessons().find(x => x.id===id);
    if (!l) return;
    workingLesson = JSON.parse(JSON.stringify(l));
    this.syncFormFromLesson();
    this.renderLibrary();
  },

  deleteLesson(id){
    if (!confirm("Да изтрия ли урока?")) return;
    DB.deleteLesson(id);
    if (workingLesson && workingLesson.id===id) workingLesson = null;
    this.syncFormFromLesson();
    this.renderLibrary();
  },

  syncFormFromLesson(){
    document.getElementById("currentLessonName").textContent = workingLesson ? workingLesson.title : "Няма избран урок";
    document.getElementById("tTitle").value = workingLesson ? (workingLesson.title||"") : "";
    document.getElementById("tYtId").value  = workingLesson ? (workingLesson.videoId||"") : "";
    document.getElementById("tClock").textContent = "0:00";
    document.getElementById("tSec").textContent = "0";
    this.renderQuestions();
  },

  syncLessonFromForm(){
    if (!workingLesson) return;
    workingLesson.title = (document.getElementById("tTitle").value || "").trim() || "Без име";
    workingLesson.videoId = (document.getElementById("tYtId").value || "").trim();
    workingLesson.updatedAt = Date.now();
    document.getElementById("currentLessonName").textContent = workingLesson.title;
  },

  saveLesson(){
    if (!workingLesson) { toast("Няма избран урок.", "warn"); return; }
    this.syncLessonFromForm();
    if (!workingLesson.videoId || workingLesson.videoId.length !== 11){
      toast("YouTube ID трябва да е 11 знака.", "warn"); return;
    }
    DB.upsertLesson(workingLesson);
    this.renderLibrary();
    toast("Урокът е запазен.", "info");
  },

  renderLibrary(){
    const box = document.getElementById("libList");
    box.innerHTML = "";

    const q = (document.getElementById("libSearch").value || "").toLowerCase().trim();
    if (this.tab === "results"){
      box.innerHTML = `<div class="text-slate-400 text-sm">Резултатите ще ги включим във Firebase версията (следваща порция).</div>`;
      return;
    }

    const lessons = DB.getLessons().filter(l => !q || (l.title||"").toLowerCase().includes(q));
    if (lessons.length === 0){
      box.innerHTML = `<div class="text-slate-400 text-sm">Няма уроци. Натисни „+ Нов урок“.</div>`;
      return;
    }

    for (const l of lessons){
      const active = (workingLesson && workingLesson.id===l.id);
      const row = document.createElement("div");
      row.className = "glass rounded-2xl p-3 flex items-center gap-2 " + (active ? "border-emerald-400/30" : "");
      row.innerHTML = `
        <div class="min-w-0">
          <div class="font-black truncate">${escapeHTML(l.title||"Без име")}</div>
          <div class="text-xs text-slate-400">Въпроси: ${l.questions?.length||0} • Видео: ${escapeHTML(l.videoId||"—")}</div>
        </div>
        <div class="ml-auto flex gap-2">
          <button class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-black text-xs">Отвори</button>
          <button class="px-3 py-2 rounded-xl bg-rose-600/20 border border-rose-400/20 hover:bg-rose-600/30 text-rose-100 font-black text-xs">Изтрий</button>
        </div>
      `;
      const [btnOpen, btnDel] = row.querySelectorAll("button");
      btnOpen.onclick = () => this.selectLesson(l.id);
      btnDel.onclick = () => this.deleteLesson(l.id);
      box.appendChild(row);
    }
  },

  async bootTeacherPlayer(){
    if (!workingLesson) { toast("Избери урок или натисни „Нов урок“.", "warn"); return; }
    this.syncLessonFromForm();

    if (!workingLesson.videoId || workingLesson.videoId.length !== 11){
      toast("Въведи YouTube ID (11 знака).", "error"); return;
    }

    try{
      await YouTubeAPI.ensure();
    }catch(e){
      console.error(e);
      toast("YouTube API е блокирано (AdBlock/политики). Пробвай без AdBlock или друг браузър.", "error");
      return;
    }

    // Destroy old player safely
    try { if (tPlayer && typeof tPlayer.destroy === "function") tPlayer.destroy(); } catch {}
    tPlayer = null;

    document.getElementById("tPlayer").innerHTML = "";
    document.getElementById("tClock").textContent = "0:00";
    document.getElementById("tSec").textContent = "0";

    tPlayer = new YT.Player("tPlayer", {
      videoId: workingLesson.videoId,
      width: "100%",
      height: "100%",
      playerVars: { rel: 0, modestbranding: 1 },
      events: {
        onReady: (e) => {
          try { e.target.seekTo(0, true); } catch {}
          document.getElementById("tHint").textContent = "Пусни видеото. На точната секунда натисни „Добави въпрос“.";
          this.startTeacherTick();
          toast("Видеото е заредено.", "info");
        },
        onStateChange: (e) => {
          // If paused, we still tick (to keep UI updated), but OK either way
        }
      }
    });
  },

  startTeacherTick(){
    if (teacherTicker) clearInterval(teacherTicker);
    teacherTicker = setInterval(() => {
      if (!tPlayer || typeof tPlayer.getCurrentTime !== "function") return;
      const sec = Math.floor(tPlayer.getCurrentTime() || 0);
      document.getElementById("tSec").textContent = String(sec);
      document.getElementById("tClock").textContent = mmss(sec);
    }, 250);
  },

  addQuestionAtCurrentSecond(){
    if (!workingLesson) { toast("Няма избран урок.", "warn"); return; }
    const sec = (tPlayer && typeof tPlayer.getCurrentTime==="function") ? Math.floor(tPlayer.getCurrentTime()||0) : 0;
    this.openQuestionModal(sec);
  },

  openQuestionModal(sec){
    this.qmEditingSec = sec;
    document.getElementById("qmSec").textContent = String(sec);

    // if exists at sec, load it
    const ex = (workingLesson.questions||[]).find(q => q.sec===sec);
    document.getElementById("qmText").value = ex?.text || "";
    document.getElementById("qmA").value = ex?.A || "";
    document.getElementById("qmB").value = ex?.B || "";
    document.getElementById("qmC").value = ex?.C || "";
    document.getElementById("qmCorrect").value = ex?.correct || "A";

    document.getElementById("qModal").classList.remove("hidden");
  },

  closeQuestionModal(){
    document.getElementById("qModal").classList.add("hidden");
  },

  saveQuestionModal(){
    if (!workingLesson) return;
    const sec = this.qmEditingSec ?? 0;

    const q = {
      sec,
      text: (document.getElementById("qmText").value||"").trim(),
      A: (document.getElementById("qmA").value||"").trim(),
      B: (document.getElementById("qmB").value||"").trim(),
      C: (document.getElementById("qmC").value||"").trim(),
      correct: document.getElementById("qmCorrect").value
    };

    if (!q.text || !q.A || !q.B || !q.C){
      toast("Попълни текста и трите отговора.", "warn"); return;
    }

    workingLesson.questions = (workingLesson.questions||[]).filter(x => x.sec !== sec);
    workingLesson.questions.push(q);
    workingLesson.questions.sort((a,b)=>a.sec-b.sec);

    this.renderQuestions();
    this.closeQuestionModal();
    toast("Въпросът е запазен.", "info");
  },

  deleteQuestion(sec){
    if (!workingLesson) return;
    workingLesson.questions = (workingLesson.questions||[]).filter(x => x.sec !== sec);
    this.renderQuestions();
    toast("Въпросът е изтрит.", "info");
  },

  renderQuestions(){
    const box = document.getElementById("tQuestions");
    box.innerHTML = "";

    if (!workingLesson){
      box.innerHTML = `<div class="text-slate-400 text-sm">Избери или създай урок.</div>`;
      return;
    }

    const qs = workingLesson.questions || [];
    if (qs.length === 0){
      box.innerHTML = `<div class="text-slate-400 text-sm">Няма въпроси още. Пусни видеото и добави.</div>`;
      return;
    }

    for (const q of qs){
      const row = document.createElement("div");
      row.className = "glass rounded-2xl p-3";
      row.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 font-black text-xs">${mmss(q.sec)}</div>
          <div class="font-black truncate">${escapeHTML(q.text)}</div>
          <div class="ml-auto flex gap-2">
            <button class="px-3 py-1.5 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-black text-xs">Редакция</button>
            <button class="px-3 py-1.5 rounded-xl bg-rose-600/20 border border-rose-400/20 hover:bg-rose-600/30 text-rose-100 font-black text-xs">Изтрий</button>
          </div>
        </div>
        <div class="mt-2 text-xs text-slate-300">
          A) ${escapeHTML(q.A)} • B) ${escapeHTML(q.B)} • C) ${escapeHTML(q.C)} • Верен: <span class="font-black">${q.correct}</span>
        </div>
      `;
      const [btnEdit, btnDel] = row.querySelectorAll("button");
      btnEdit.onclick = () => this.openQuestionModal(q.sec);
      btnDel.onclick = () => this.deleteQuestion(q.sec);
      box.appendChild(row);
    }
  },

  exportLesson(){
    if (!workingLesson){ toast("Няма избран урок.", "warn"); return; }
    this.syncLessonFromForm();
    const data = JSON.stringify(workingLesson, null, 2);
    navigator.clipboard.writeText(data).then(()=>{
      toast("Експортът е копиран в clipboard (JSON).", "info");
    }).catch(()=>{
      // fallback
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (workingLesson.title||"lesson").replace(/[^\w\-]+/g,"_") + ".json";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Експортът е свален като файл.", "info");
    });
  },

  importLesson(){
    const txt = prompt("Постави JSON-а на урока тук (Import):");
    if (!txt) return;
    const obj = safeJSONParse(txt);
    if (!obj || !obj.videoId){
      toast("Невалиден JSON за урок.", "error"); return;
    }
    // normalize
    obj.id = obj.id || uid();
    obj.title = obj.title || "Импортиран урок";
    obj.questions = Array.isArray(obj.questions) ? obj.questions : [];
    obj.updatedAt = Date.now();

    workingLesson = obj;
    DB.upsertLesson(obj);
    this.syncFormFromLesson();
    this.renderLibrary();
    toast("Импортът е успешен.", "info");
  },

  copySoloCode(){
    if (!workingLesson){ toast("Няма избран урок.", "warn"); return; }
    this.syncLessonFromForm();
    const code = workingLesson.id;
    navigator.clipboard.writeText(code).then(()=>{
      toast("Кодът за самостоятелно е копиран.", "info");
    }).catch(()=>{
      toast("Кодът е: " + code, "info");
    });
  }
};

/* =========================================================
   6) SOLO (student)
   ========================================================= */

const Solo = {
  currentLesson: null,
  fired: new Set(),

  async start(){
    const name = (document.getElementById("sName").value||"").trim();
    const code = (document.getElementById("sCode").value||"").trim();

    if (!name){ toast("Въведи име.", "warn"); return; }
    if (!code){ toast("Въведи код на урок.", "warn"); return; }

    const lesson = DB.getLessons().find(x => x.id===code);
    if (!lesson){ toast("Няма такъв код в този браузър. (Трябва учителят да е създал урок тук.)", "error"); return; }

    this.currentLesson = lesson;
    this.fired = new Set();
    document.getElementById("sClock").textContent = "0:00";
    document.getElementById("sQuestionBox").innerHTML = `<div class="text-slate-400 text-sm">Пусни видеото. Въпросите ще излизат.</div>`;

    try{
      await YouTubeAPI.ensure();
    }catch(e){
      console.error(e);
      toast("YouTube API е блокирано (AdBlock/политики).", "error");
      return;
    }

    try { if (sPlayer && typeof sPlayer.destroy==="function") sPlayer.destroy(); } catch {}
    sPlayer = null;
    document.getElementById("sPlayer").innerHTML = "";

    sPlayer = new YT.Player("sPlayer", {
      videoId: lesson.videoId,
      width: "100%",
      height: "100%",
      playerVars: { rel: 0, modestbranding: 1 },
      events: {
        onReady: () => {
          toast("Видеото е заредено. Пусни Play.", "info");
          this.startTick();
        }
      }
    });
  },

  startTick(){
    if (soloTicker) clearInterval(soloTicker);

    soloTicker = setInterval(() => {
      if (!this.currentLesson || !sPlayer || typeof sPlayer.getCurrentTime!=="function") return;

      const sec = Math.floor(sPlayer.getCurrentTime()||0);
      document.getElementById("sClock").textContent = mmss(sec);

      const q = (this.currentLesson.questions||[]).find(x => x.sec===sec);
      if (q && !this.fired.has(sec)){
        this.fired.add(sec);
        try { sPlayer.pauseVideo(); } catch {}
        this.showQuestion(q);
      }
    }, 250);
  },

  showQuestion(q){
    const box = document.getElementById("sQuestionBox");
    box.innerHTML = `
      <div class="text-sm text-slate-300">Секунда: <span class="font-black">${mmss(q.sec)}</span></div>
      <div class="text-xl font-black mt-1">${escapeHTML(q.text)}</div>
      <div class="mt-3 space-y-2">
        <button class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-left" onclick="Solo.answer('${q.sec}','A')">
          A) ${escapeHTML(q.A)}
        </button>
        <button class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-left" onclick="Solo.answer('${q.sec}','B')">
          B) ${escapeHTML(q.B)}
        </button>
        <button class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 font-bold text-left" onclick="Solo.answer('${q.sec}','C')">
          C) ${escapeHTML(q.C)}
        </button>
      </div>
    `;
    toast("Въпрос!", "warn");
  },

  answer(sec, choice){
    const q = (this.currentLesson?.questions||[]).find(x => String(x.sec)===String(sec));
    if (!q) return;

    const ok = (choice === q.correct);
    toast(ok ? "✅ Вярно!" : "❌ Грешно.", ok ? "info" : "error");

    // continue
    document.getElementById("sQuestionBox").innerHTML = `<div class="text-slate-400 text-sm">Продължавай…</div>`;
    try { sPlayer.playVideo(); } catch {}
  }
};

/* =========================================================
   7) LIVE (demo локално)
   ========================================================= */

const Live = {
  hostStart(){
    if (!workingLesson){ toast("Избери урок в Учител.", "warn"); UI.show("screenTeacher"); return; }
    document.getElementById("liveHostCard").classList.remove("hidden");

    // simple random pin
    LiveState.pin = String(Math.floor(1000 + Math.random()*9000));
    LiveState.joined = 0;
    LiveState.running = false;

    document.getElementById("livePin").textContent = LiveState.pin;
    document.getElementById("liveCount").textContent = "0";

    // QR = link to join screen with pin prefilled
    const url = location.origin + location.pathname + "#join=" + LiveState.pin;
    document.getElementById("liveQr").innerHTML = `<img class="rounded-xl bg-white p-2" alt="QR" src="${qrDataUrl(url)}">`;
    toast("Сесията е подготвена. Дай ПИН/QR.", "info");
  },

  start(){
    if (!LiveState.pin){ toast("Няма ПИН.", "warn"); return; }
    LiveState.running = true;
    toast("Сесията започна (демо).", "info");
  },

  end(){
    LiveState.running = false;
    toast("Сесията приключи (демо).", "info");
  },

  join(){
    const name = (document.getElementById("jName").value||"").trim();
    const pin = (document.getElementById("jPin").value||"").trim();
    if (!name){ toast("Въведи име.", "warn"); return; }
    if (!pin){ toast("Въведи ПИН.", "warn"); return; }

    // demo: if pin matches current host pin in same browser session only
    if (!LiveState.pin || pin !== LiveState.pin){
      toast("ПИН не е активен в този браузър (демо). Firebase версията ще го реши.", "warn");
      return;
    }

    LiveState.joined++;
    document.getElementById("liveCount").textContent = String(LiveState.joined);
    toast("Влезе в клас (демо).", "info");
  }
};

/* =========================================================
   8) HELPERS
   ========================================================= */

function escapeHTML(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// Lightweight QR via Google Chart (works fine for demo)
function qrDataUrl(text){
  const u = "https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl=" + encodeURIComponent(text);
  return u;
}

/* =========================================================
   9) BOOT
   ========================================================= */

(function boot(){
  // Preload YouTube API ASAP
  YouTubeAPI.ensure().then(()=> {
    toast("YouTube API е готово.", "info");
  }).catch(()=> {
    // not fatal, user can still try
    toast("YouTube API може да е блокирано. Ако не тръгне – изключи AdBlock.", "warn");
  });

  Teacher.renderLibrary();

  // If opened with #join=PIN
  const h = location.hash || "";
  if (h.startsWith("#join=")){
    UI.show("screenLiveJoin");
    document.getElementById("jPin").value = h.replace("#join=","");
  } else {
    UI.show("screenHome");
  }
})();
</script>
</body>
</html>
