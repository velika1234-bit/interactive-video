<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<title>VideoQuiz – Part 3 Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>

<style>
html, body { height:100%; margin:0; background:#0f172a; }
body { overflow:hidden; }
</style>
</head>

<body class="h-full text-white flex flex-col">

<!-- HEADER -->
<div class="bg-slate-900 p-4 flex flex-wrap gap-3 items-center justify-between shadow">
  <h1 class="text-xl font-black">VideoQuiz — Редактор</h1>

  <div class="flex gap-2 flex-wrap">
    <input id="ytId" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm w-56"
           value="dQw4w9WgXcQ" placeholder="YouTube ID">

    <button onclick="bootPlayer()" class="bg-indigo-600 px-4 py-2 rounded-lg font-bold">
      Видео
    </button>

    <button onclick="openAddForm()" class="bg-emerald-600 px-4 py-2 rounded-lg font-bold">
      + Въпрос
    </button>

    <button onclick="exportJSON()" class="bg-amber-600 px-4 py-2 rounded-lg font-bold">
      Експорт
    </button>

    <button onclick="importJSON()" class="bg-sky-600 px-4 py-2 rounded-lg font-bold">
      Импорт
    </button>
  </div>
</div>

<!-- MAIN -->
<div class="flex-1 grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-4 p-4 overflow-hidden">

  <!-- VIDEO -->
  <div class="bg-black rounded-2xl overflow-hidden relative">
    <div id="player" class="w-full h-full"></div>
  </div>

  <!-- PANEL -->
  <div class="bg-slate-900 border border-slate-700 rounded-2xl flex flex-col overflow-hidden">
    <div class="p-4 border-b border-slate-700">
      <div class="flex justify-between">
        <h2 class="font-black text-lg">Въпроси</h2>
        <div id="clock" class="font-mono text-xs bg-slate-800 px-3 py-1 rounded">0:00</div>
      </div>
    </div>

    <div id="qList" class="flex-1 overflow-auto p-4 space-y-3"></div>
  </div>
</div>

<!-- QUESTION MODAL (PLAY MODE) -->
<div id="qModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-xl p-6 space-y-4">
    <h3 id="playQText" class="text-xl font-black"></h3>
    <div id="playOpts" class="space-y-2"></div>
    <div id="playFeedback" class="font-bold"></div>
    <button onclick="continueVideo()" class="bg-emerald-600 px-4 py-2 rounded-lg font-bold">
      Продължи
    </button>
  </div>
</div>

<!-- EDITOR MODAL -->
<div id="editModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-xl p-6 space-y-4">
    <h3 class="font-black text-xl">Нов въпрос</h3>

    <input id="fTime" type="number" placeholder="Секунда"
      class="w-full bg-slate-800 border border-slate-700 rounded p-2">

    <input id="fText" placeholder="Текст на въпрос"
      class="w-full bg-slate-800 border border-slate-700 rounded p-2">

    <div id="fOpts" class="space-y-2"></div>

    <select id="fCorrect" class="w-full bg-slate-800 border border-slate-700 rounded p-2">
      <option value="0">Верният е отговор 1</option>
      <option value="1">Верният е отговор 2</option>
      <option value="2">Верният е отговор 3</option>
      <option value="3">Верният е отговор 4</option>
    </select>

    <div class="flex gap-2">
      <button onclick="saveQuestion()" class="bg-emerald-600 px-4 py-2 rounded font-bold">Запази</button>
      <button onclick="closeEdit()" class="bg-slate-700 px-4 py-2 rounded">Отказ</button>
    </div>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let QUIZ = { videoId:"dQw4w9WgXcQ", questions:[] };
let player, ytReady=false, timer=null, asked=new Set(), editIndex=null;

function onYouTubeIframeAPIReady(){ ytReady=true; }

function bootPlayer(){
 if(!ytReady) return alert("YT още зарежда");
 QUIZ.videoId = ytId.value.trim();
 asked=new Set();
 if(timer) clearInterval(timer);
 document.getElementById("player").innerHTML="";
 player = new YT.Player("player",{
  videoId:QUIZ.videoId,
  events:{ onReady:e=>{ timer=setInterval(tick,300); } }
 });
}

function tick(){
 if(!player) return;
 const t = player.getCurrentTime();
 clock.innerText = fmt(t);
 const q = QUIZ.questions.find(q=>!asked.has(q.time)&&t>=q.time);
 if(q){ asked.add(q.time); ask(q); }
}

function fmt(s){ s=Math.floor(s||0); return Math.floor(s/60)+":"+(s%60).toString().padStart(2,"0"); }

function ask(q){
 player.pauseVideo();
 playQText.innerText=q.text;
 playOpts.innerHTML="";
 playFeedback.innerText="";
 q.options.forEach((o,i)=>{
  const b=document.createElement("button");
  b.className="w-full bg-slate-800 p-3 rounded";
  b.innerText=o;
  b.onclick=()=>answer(i,q.correctIndex);
  playOpts.appendChild(b);
 });
 qModal.classList.remove("hidden");
}

function answer(i,c){
 playFeedback.innerText = i===c ? "✅ Вярно" : "❌ Грешно";
}

function continueVideo(){
 qModal.classList.add("hidden");
 player.playVideo();
}

function renderList(){
 qList.innerHTML = QUIZ.questions
 .sort((a,b)=>a.time-b.time)
 .map((q,i)=>`
 <div class="bg-slate-800 p-3 rounded space-y-2">
   <div class="font-bold">${fmt(q.time)} — ${q.text}</div>
   <div class="flex gap-2">
     <button onclick="editQ(${i})" class="bg-indigo-600 px-2 py-1 rounded text-xs">Редакция</button>
     <button onclick="delQ(${i})" class="bg-rose-600 px-2 py-1 rounded text-xs">Изтрий</button>
   </div>
 </div>`).join("");
}

function openAddForm(){
 editIndex=null;
 fTime.value = player ? Math.floor(player.getCurrentTime()) : 0;
 fText.value="";
 fOpts.innerHTML="";
 for(let i=0;i<4;i++){
  fOpts.innerHTML += `<input id="opt${i}" placeholder="Отговор ${i+1}"
   class="w-full bg-slate-800 border border-slate-700 rounded p-2">`;
 }
 editModal.classList.remove("hidden");
}

function saveQuestion(){
 const q={
  time:Number(fTime.value),
  text:fText.value,
  options:[opt0.value,opt1.value,opt2.value,opt3.value],
  correctIndex:Number(fCorrect.value)
 };
 if(editIndex===null) QUIZ.questions.push(q);
 else QUIZ.questions[editIndex]=q;
 closeEdit();
 renderList();
}

function closeEdit(){ editModal.classList.add("hidden"); }

function editQ(i){
 editIndex=i;
 const q=QUIZ.questions[i];
 fTime.value=q.time;
 fText.value=q.text;
 fOpts.innerHTML="";
 q.options.forEach((o,i)=>{ fOpts.innerHTML += `<input id="opt${i}" value="${o}" class="w-full bg-slate-800 border p-2 rounded">`;});
 fCorrect.value=q.correctIndex;
 editModal.classList.remove("hidden");
}

function delQ(i){ QUIZ.questions.splice(i,1); renderList(); }

function exportJSON(){
 prompt("Копирай урока:", JSON.stringify(QUIZ));
}

function importJSON(){
 const t=prompt("Постави JSON:");
 if(!t) return;
 QUIZ = JSON.parse(t);
 renderList();
}
</script>

</body>
</html>
