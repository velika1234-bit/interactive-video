<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp,
    updateDoc, deleteDoc, addDoc, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged, signOut,
    createUserWithEmailAndPassword, signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // =========================
  // CONFIG
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
    authDomain: "videoquiz-ultimate.firebaseapp.com",
    projectId: "videoquiz-ultimate",
    storageBucket: "videoquiz-ultimate.firebasestorage.app",
    messagingSenderId: "793138692820",
    appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
  };

  const finalAppId = "videoquiz-ultimate-live";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // =========================
  // STATE
  // =========================
  let user = null;
  let isTeacher = false;

  let myQuizzes = [];
  let soloResults = [];
  let classHistory = [];

  let editingQuizId = null;
  let questions = [];
  let currentVideoId = "";

  let player = null;        // editor player
  let solvePlayer = null;   // solo player
  let hostPlayer = null;    // live host player
  let isYTReady = false;

  let currentQuiz = null; // { title, v, q, ownerId }
  let currentQuizOwnerId = null;

  // Solo runtime
  let scoreCount = 0;
  let soloGameFinished = false;
  let currentQIndex = -1;
  let lastAnsweredIndex = -1;
  let sopModeEnabled = false;
  let isDiscussionMode = false;
  let studentNameValue = "";
  let tempSelectedAnswer = null;

  // Live session state
  let sessionID = "";
  let sessionDocId = "";
  let liveActiveQIdx = -1;
  let liveScore = 0;
  let lastFetchedParticipants = [];
  let activeIntervals = [];

  let authMode = "login";
  let activeHistoryTab = "solo";

  const AVATARS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ'];

  // =========================
  // PATHS
  // =========================
  const profileDoc = (uid) => doc(db, "artifacts", finalAppId, "users", uid, "settings", "profile");
  const myQuizzesCol = (uid) => collection(db, "artifacts", finalAppId, "users", uid, "my_quizzes");
  const soloResultsCol = (uid) => collection(db, "artifacts", finalAppId, "users", uid, "solo_results");
  const classHistoryCol = (uid) => collection(db, "artifacts", finalAppId, "users", uid, "class_history");

  const sessionRef = (id) => doc(db, "artifacts", finalAppId, "public", "data", "sessions", id);
  const participantsCol = (sid) => collection(db, "artifacts", finalAppId, "public", "data", "sessions", sid, "participants");
  const participantRef = (sid, pid) => doc(db, "artifacts", finalAppId, "public", "data", "sessions", sid, "participants", pid);

  // =========================
  // HELPERS
  // =========================
  function formatTime(s) {
    const m = Math.floor(s / 60), sc = Math.floor(s % 60);
    return `${m}:${sc < 10 ? "0" : ""}${sc}`;
  }
  function formatDate(ts) {
    if (!ts) return "";
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("bg-BG");
  }
  function getTimestampMs(ts) {
    return ts ? (ts.toMillis ? ts.toMillis() : ts.seconds * 1000) : 0;
  }

  // Unicode-safe base64
  function encodeQuizCode(obj) {
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodeQuizCode(code) {
    try {
      if (!code) return null;
      const cleaned = code.trim().replace(/\s/g, "");
      const json = decodeURIComponent(escape(atob(cleaned)));
      return JSON.parse(json);
    } catch {
      return null;
    }
  }

  function clearIntervals() {
    activeIntervals.forEach(clearInterval);
    activeIntervals = [];
  }

  // =========================
  // UI
  // =========================
  window.showMessage = (text, type = "info") => {
    const c = document.getElementById("msg-container");
    if (!c) return;

    const m = document.createElement("div");
    const bg =
      type === "error" ? "bg-rose-500" :
      type === "success" ? "bg-emerald-600" :
      "bg-brand-600";
    m.className = `p-4 rounded-xl text-white shadow-lg mb-2 animate-pop flex items-center gap-3 ${bg}`;
    m.innerText = text;
    c.appendChild(m);
    setTimeout(() => m.remove(), 3200);
  };

  window.switchScreen = (n) => {
    document.querySelectorAll("#app > div").forEach(d => d.classList.add("hidden"));
    const t = document.getElementById("screen-" + n);
    if (t) t.classList.remove("hidden");

    if (n === "teacher-dashboard") {
      if (!user || !isTeacher) {
        window.showMessage("–ù—è–º–∞—Ç–µ —É—á–∏—Ç–µ–ª—Å–∫–∏ –¥–æ—Å—Ç—ä–ø.", "error");
        document.getElementById("screen-welcome")?.classList.remove("hidden");
        return;
      }
      window.loadMyQuizzes();
      window.loadSoloResults();
      window.loadClassHistory();
    }

    lucide?.createIcons();
    window.scrollTo(0, 0);
  };

  window.toggleAuthMode = () => {
    authMode = authMode === "login" ? "register" : "login";
    document.getElementById("auth-teacher-code-container").classList.toggle("hidden", authMode !== "register");
    document.getElementById("auth-submit-btn").innerText = authMode === "register" ? "–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ" : "–í–ª–µ–∑";
  };

  window.switchTab = (tab) => {
    document.getElementById("panel-solo").classList.toggle("hidden", tab !== "solo");
    document.getElementById("panel-class").classList.toggle("hidden", tab !== "class");

    document.getElementById("tab-solo").className =
      tab === "solo"
        ? "flex-1 pb-2 text-sm font-bold text-brand-600 border-b-2 border-brand-600 transition-all"
        : "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all";
    document.getElementById("tab-class").className =
      tab === "class"
        ? "flex-1 pb-2 text-sm font-bold text-emerald-600 border-b-2 border-emerald-600 transition-all"
        : "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent transition-all";
  };

  window.switchHistoryTab = (tab) => {
    activeHistoryTab = tab;

    document.getElementById("hist-tab-solo").className =
      tab === "solo"
        ? "px-4 py-2 rounded-lg font-bold text-xs transition-all bg-brand-600 text-white shadow-sm"
        : "px-4 py-2 rounded-lg font-bold text-xs transition-all text-slate-500 hover:text-slate-800 hover:bg-slate-50";
    document.getElementById("hist-tab-class").className =
      tab === "class"
        ? "px-4 py-2 rounded-lg font-bold text-xs transition-all bg-brand-600 text-white shadow-sm"
        : "px-4 py-2 rounded-lg font-bold text-xs transition-all text-slate-500 hover:text-slate-800 hover:bg-slate-50";

    document.getElementById("hist-view-solo").classList.toggle("hidden", tab !== "solo");
    document.getElementById("hist-view-class").classList.toggle("hidden", tab !== "class");
  };

  // =========================
  // AUTH
  // =========================
  window.handleAuthSubmit = async () => {
    const em = document.getElementById("auth-email").value.trim();
    const ps = document.getElementById("auth-password").value;

    try {
      if (authMode === "register") {
        const code = document.getElementById("auth-teacher-code").value;
        if (code !== "vilidaf76") return window.showMessage("–ì—Ä–µ—à–µ–Ω –∫–æ–¥!", "error");

        const cred = await createUserWithEmailAndPassword(auth, em, ps);
        await setDoc(profileDoc(cred.user.uid), {
          role: "teacher",
          email: em,
          emailNormalized: em.toLowerCase(),
          createdAt: serverTimestamp()
        });
      } else {
        await signInWithEmailAndPassword(auth, em, ps);
      }

      window.switchScreen("teacher-dashboard");
    } catch (e) {
      window.showMessage("–ì—Ä–µ—à–∫–∞: " + (e?.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"), "error");
    }
  };

  window.handleLogout = async () => {
    await signOut(auth);
    location.reload();
  };

  // =========================
  // TEACHER LOAD + RENDER
  // =========================
  window.loadMyQuizzes = () => {
    if (!user) return;
    onSnapshot(myQuizzesCol(user.uid), (s) => {
      myQuizzes = s.docs.map(d => ({ ...d.data(), id: d.id }));
      window.renderMyQuizzes();
    });
  };

  window.loadSoloResults = () => {
    if (!user) return;
    onSnapshot(soloResultsCol(user.uid), (s) => {
      soloResults = s.docs.map(d => ({ ...d.data(), id: d.id }));
      window.renderSoloResults();
    });
  };

  window.loadClassHistory = () => {
    if (!user) return;
    onSnapshot(classHistoryCol(user.uid), (s) => {
      classHistory = s.docs.map(d => ({ ...d.data(), id: d.id }));
      window.renderClassHistory();
    });
  };

  window.renderMyQuizzes = () => {
    const c = document.getElementById("my-quizzes-list");
    if (!c) return;

    c.innerHTML = myQuizzes.map(q => `
      <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-lg transition-all flex flex-col justify-between group">
        <div class="mb-4">
          <h4 class="font-black text-slate-800 text-lg line-clamp-2">${q.title || "–ë–µ–∑ –∏–º–µ"}</h4>
          <p class="text-[10px] text-slate-400 font-black uppercase mt-2">${q.questions?.length || 0} –≤—ä–ø—Ä–æ—Å–∞</p>
        </div>
        <div class="flex items-center gap-2 pt-4 border-t border-slate-50">
          <button onclick="window.startHostFromLibrary('${q.id}')" title="–°—Ç–∞—Ä—Ç –Ω–∞ –∂–∏–≤–æ"
            class="flex-1 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all shadow-sm">
            <i data-lucide="play" class="w-3.5 h-3.5"></i> –°—Ç–∞—Ä—Ç
          </button>
          <button onclick="window.showShareCode('${q.id}')" title="–ö–æ–¥"
            class="p-2.5 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-xl transition-all">
            <i data-lucide="share-2" class="w-4 h-4"></i>
          </button>
          <button onclick="window.editQuiz('${q.id}')" title="–†–µ–¥–∞–∫—Ü–∏—è"
            class="p-2.5 bg-slate-50 text-slate-500 hover:bg-slate-100 rounded-xl transition-all">
            <i data-lucide="pencil" class="w-4 h-4"></i>
          </button>
          <button onclick="window.deleteQuiz('${q.id}')" title="–ò–∑—Ç—Ä–∏–π"
            class="p-2.5 bg-rose-50 text-rose-500 hover:bg-rose-100 rounded-xl transition-all">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    `).join("");

    lucide?.createIcons();
  };

  window.renderSoloResults = () => {
    const b = document.getElementById("solo-results-body");
    if (!b) return;

    const sorted = [...soloResults].sort((a, b) => getTimestampMs(b.timestamp) - getTimestampMs(a.timestamp));
    b.innerHTML = sorted.map(r => `
      <tr class="border-b border-slate-50 text-xs hover:bg-brand-50/30 transition-colors">
        <td class="p-4 font-bold text-slate-700">${r.studentName || "-"}</td>
        <td class="p-4 text-slate-500 truncate max-w-[120px]">${r.quizTitle || "-"}</td>
        <td class="p-4 text-slate-400 font-mono">${formatDate(r.timestamp)}</td>
        <td class="p-4 text-right"><span class="bg-brand-100 text-brand-700 px-2.5 py-1 rounded-lg font-black">${r.score || "-"}</span></td>
        <td class="p-4 text-center">
          <button onclick="window.deleteSoloResult('${r.id}')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all" title="–ò–∑—Ç—Ä–∏–π">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </td>
      </tr>
    `).join("");

    lucide?.createIcons();
  };

  window.renderClassHistory = () => {
    const b = document.getElementById("class-results-body");
    const empty = document.getElementById("class-history-empty");
    if (!b) return;

    if (!classHistory.length) {
      b.innerHTML = "";
      empty?.classList.remove("hidden");
      return;
    }
    empty?.classList.add("hidden");

    const sorted = [...classHistory].sort((a, b) => getTimestampMs(b.timestamp) - getTimestampMs(a.timestamp));
    b.innerHTML = sorted.map(r => `
      <tr class="border-b border-slate-50 text-xs hover:bg-slate-50 transition-colors">
        <td class="p-4 text-slate-400 font-mono">${formatDate(r.timestamp)}</td>
        <td class="p-4 font-bold text-slate-700">${r.quizTitle || "–ë–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ"}</td>
        <td class="p-4 text-slate-500 font-mono">${r.pin || "-"}</td>
        <td class="p-4 text-center">
          <button onclick="window.viewClassSessionResults('${r.sessionId}', '${(r.quizTitle||"").replaceAll("'", "\\'")}')" class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg font-bold text-[10px] hover:bg-indigo-100 transition-all flex items-center justify-center gap-1 mx-auto">
            <i data-lucide="eye" class="w-3 h-3"></i> –í–∏–∂
          </button>
        </td>
        <td class="p-4 text-center">
          <button onclick="window.deleteClassSession('${r.id}', '${r.sessionId}')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all" title="–ò–∑—Ç—Ä–∏–π –°–µ—Å–∏—è">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </td>
      </tr>
    `).join("");

    lucide?.createIcons();
  };

  window.deleteSoloResult = async (id) => {
    if (!user) return;
    if (!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞?")) return;
    await deleteDoc(doc(soloResultsCol(user.uid), id));
  };

  window.deleteClassSession = async (historyId, sid) => {
    if (!user) return;
    if (!confirm("–¢–æ–≤–∞ –∏–∑—Ç—Ä–∏–≤–∞ –∏—Å—Ç–æ—Ä–∏—è + —Å–µ—Å–∏—è + —É—á–∞—Å—Ç–Ω–∏—Ü–∏. –ü—Ä–æ–¥—ä–ª–∂–∏?")) return;

    await deleteDoc(doc(classHistoryCol(user.uid), historyId));
    try {
      await deleteDoc(sessionRef(sid));
      const pSnap = await getDocs(participantsCol(sid));
      await Promise.all(pSnap.docs.map(d => deleteDoc(d.ref)));
    } catch (e) {
      console.warn("Cleanup error:", e);
    }
    window.showMessage("–°–µ—Å–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.", "success");
  };

  window.viewClassSessionResults = async (sid, title) => {
    document.getElementById("m-class-res-title").innerText = title;
    const b = document.getElementById("m-class-res-body");
    b.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-slate-400">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>`;
    document.getElementById("modal-class-results").classList.remove("hidden");

    try {
      const snap = await getDocs(participantsCol(sid));
      const parts = snap.docs.map(d => d.data()).sort((a, b) => (b.score || 0) - (a.score || 0));
      if (!parts.length) {
        b.innerHTML = `<tr><td colspan="2" class="p-8 text-center text-slate-400 italic">–ù—è–º–∞ —É—á–∞—Å—Ç–Ω–∏—Ü–∏.</td></tr>`;
      } else {
        b.innerHTML = parts.map(p => `
          <tr>
            <td class="p-4 font-bold text-slate-700 flex items-center gap-2"><span class="text-xl">${p.avatar || "üë§"}</span> ${p.name}</td>
            <td class="p-4 text-right font-black text-brand-600">${p.score || 0}</td>
          </tr>
        `).join("");
      }
    } catch {
      b.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-rose-500">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</td></tr>`;
    }
  };

  // =========================
  // SHARE CODE (teacher)
  // =========================
  window.showShareCode = (quizId) => {
    if (!user) return;
    const q = myQuizzes.find(x => x.id === quizId);
    if (!q) return;

    const payload = {
      ownerId: user.uid,
      title: q.title || "–ë–µ–∑ –∏–º–µ",
      v: q.v,
      q: q.questions || []
    };

    document.getElementById("share-code-display").value = encodeQuizCode(payload);

    const m = document.getElementById("modal-share");
    m.classList.remove("hidden");
    m.classList.add("flex");
  };

  window.copyShareCode = () => {
    const el = document.getElementById("share-code-display");
    el.select();
    document.execCommand("copy");
    window.showMessage("–ö–æ–ø–∏—Ä–∞–Ω–æ!", "success");
  };

  // =========================
  // EDITOR
  // =========================
  function startEditorTimer() {
    clearIntervals();
    const tEl = document.getElementById("timer");
    if (!tEl || !player) return;

    const i = setInterval(() => {
      try {
        tEl.innerText = formatTime(Math.floor(player.getCurrentTime()));
      } catch {}
    }, 250);

    activeIntervals.push(i);
  }

  window.createNewQuiz = () => {
    editingQuizId = null;
    questions = [];
    currentVideoId = "";
    document.getElementById("yt-url").value = "";
    document.getElementById("editor-video-input").classList.remove("hidden");
    document.getElementById("editor-player-container").innerHTML = "";
    window.renderEditorList();
    window.switchScreen("create");
  };

  window.editQuiz = (id) => {
    const q = myQuizzes.find(x => x.id === id);
    if (!q) return;

    editingQuizId = id;
    questions = (q.questions || []).slice();
    currentVideoId = q.v;

    document.getElementById("yt-url").value = `https://youtu.be/${q.v}`;
    window.switchScreen("create");
    window.renderEditorList();

    document.getElementById("editor-video-input").classList.add("hidden");
    document.getElementById("editor-player-container").innerHTML = `<div id="player"></div>`;

    player = new YT.Player("player", {
      videoId: currentVideoId,
      playerVars: { autoplay: 0, controls: 1 },
      events: { onReady: startEditorTimer }
    });
  };

  window.loadEditorVideo = () => {
    const url = document.getElementById("yt-url").value.trim();
    const id = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/)?.[1];
    if (!id) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω YouTube –ª–∏–Ω–∫", "error");

    currentVideoId = id;

    document.getElementById("editor-video-input").classList.add("hidden");
    document.getElementById("editor-player-container").innerHTML = `<div id="player"></div>`;

    player = new YT.Player("player", {
      videoId: id,
      playerVars: { autoplay: 1, controls: 1 },
      events: { onReady: startEditorTimer }
    });
  };

  // Modal fields with correct selection
  window.updateModalFields = () => {
    const type = document.getElementById("m-type").value;
    const c = document.getElementById("m-opts-container");
    c.innerHTML = "";

    const optRow = (n) => `
      <div class="opt-row flex items-center gap-3">
        <input type="text" placeholder="–û—Ç–≥–æ–≤–æ—Ä ${n}" class="flex-1 p-4 bg-slate-50 rounded-xl border-2 border-slate-200 text-sm font-bold focus:border-brand-500 outline-none transition-all">
        <div class="min-w-[120px] text-right">
          ${type === "single" ? `<label class="text-xs font-bold text-slate-500"><input type="radio" name="single-correct" value="${n-1}" class="mr-2 accent-brand-600">–í–µ—Ä–µ–Ω</label>` : ""}
          ${type === "multiple" ? `<label class="text-xs font-bold text-slate-500"><input type="checkbox" data-multi-correct="${n-1}" class="mr-2 accent-emerald-600">–í–µ—Ä–µ–Ω</label>` : ""}
        </div>
      </div>
    `;

    if (type === "single" || type === "multiple" || type === "ordering") {
      c.innerHTML = `
        <div class="space-y-3">
          ${[1,2,3,4].map(optRow).join("")}
        </div>
        ${type === "ordering" ? `<div class="mt-3 text-xs text-slate-500 font-bold">–ü–æ–¥—Ä–µ–∂–¥–∞–Ω–µ: –≤–µ—Ä–Ω–∏—è—Ç —Ä–µ–¥ –µ –∫–∞–∫—Ç–æ —Å–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏ –æ–ø—Ü–∏–∏—Ç–µ (TODO: drag & drop).</div>` : ``}
      `;
      // default single correct = 0
      if (type === "single") {
        setTimeout(() => {
          const r = document.querySelector('input[name="single-correct"][value="0"]');
          if (r) r.checked = true;
        }, 0);
      }
    } else if (type === "boolean") {
      c.innerHTML = `
        <div class="flex gap-4">
          <label class="flex-1 p-4 bg-emerald-50 rounded-xl border-2 border-emerald-200 cursor-pointer flex items-center justify-center gap-2 font-black text-emerald-700 hover:bg-emerald-100 transition-all">
            <input type="radio" name="bool-val" value="true" checked> –î–ê
          </label>
          <label class="flex-1 p-4 bg-rose-50 rounded-xl border-2 border-rose-200 cursor-pointer flex items-center justify-center gap-2 font-black text-rose-700 hover:bg-rose-100 transition-all">
            <input type="radio" name="bool-val" value="false"> –ù–ï
          </label>
        </div>
      `;
    } else if (type === "numeric_slider" || type === "timeline_slider") {
      c.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
          <input type="number" id="m-min" placeholder="–ú–∏–Ω" class="p-3 border rounded-xl" value="0">
          <input type="number" id="m-max" placeholder="–ú–∞–∫—Å" class="p-3 border rounded-xl" value="100">
          <input type="number" id="m-step" placeholder="–°—Ç—ä–ø–∫–∞" class="p-3 border rounded-xl" value="1">
          <input type="number" id="m-tolerance" placeholder="–¢–æ–ª–µ—Ä–∞–Ω—Å" class="p-3 border rounded-xl" value="0">
        </div>
        <input type="number" id="m-correct-num" placeholder="–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä" class="w-full p-3 border rounded-xl mt-4 font-bold" value="0">
      `;
    }
  };

  window.openQuestionModal = () => {
    if (player && typeof player.pauseVideo === "function") player.pauseVideo();

    document.getElementById("m-text").value = "";
    document.getElementById("m-type").value = "single";
    document.getElementById("m-points").value = 1;
    window.updateModalFields();

    const modal = document.getElementById("modal-q");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  };

  window.saveQuestion = () => {
    const txt = document.getElementById("m-text").value.trim();
    if (!txt) return window.showMessage("–í—ä–≤–µ–¥–µ—Ç–µ —Ç–µ–∫—Å—Ç!", "error");

    const type = document.getElementById("m-type").value;
    const pts = Number(document.getElementById("m-points").value) || 1;
    const t = player && typeof player.getCurrentTime === "function" ? Math.floor(player.getCurrentTime()) : 0;

    const optInputs = [...document.querySelectorAll(".opt-row input[type='text']")];
    const opts = optInputs.map(i => (i.value || "").trim()).filter(Boolean);

    let q = { time: t, text: txt, type, points: pts };

    if (type === "single") {
      if (opts.length < 2) return window.showMessage("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ 2 –æ–ø—Ü–∏–∏.", "error");
      const corr = Number(document.querySelector("input[name='single-correct']:checked")?.value ?? 0);
      q.options = opts;
      q.correct = corr;
    }

    if (type === "multiple") {
      if (opts.length < 2) return window.showMessage("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ 2 –æ–ø—Ü–∏–∏.", "error");
      const corr = [...document.querySelectorAll("input[type='checkbox'][data-multi-correct]")]
        .filter(x => x.checked)
        .map(x => Number(x.getAttribute("data-multi-correct")));
      if (!corr.length) return window.showMessage("–ú–∞—Ä–∫–∏—Ä–∞–π—Ç–µ –ø–æ–Ω–µ 1 –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä.", "error");
      q.options = opts;
      q.correct = corr;
    }

    if (type === "boolean") {
      q.options = ["–î–ê", "–ù–ï"];
      q.correct = (document.querySelector("input[name='bool-val']:checked")?.value === "true");
    }

    if (type === "numeric_slider" || type === "timeline_slider") {
      q.min = Number(document.getElementById("m-min").value || 0);
      q.max = Number(document.getElementById("m-max").value || 100);
      q.step = Number(document.getElementById("m-step").value || 1);
      q.tolerance = Number(document.getElementById("m-tolerance").value || 0);
      q.correct = Number(document.getElementById("m-correct-num").value || 0);
      q.options = [];
    }

    if (type === "ordering") {
      // TODO: –∑–∞ –º–æ–º–µ–Ω—Ç–∞ –≤–µ—Ä–Ω–∏—è—Ç —Ä–µ–¥ –µ –∫–∞–∫—Ç–æ —Å–∞ –≤—ä–≤–µ–¥–µ–Ω–∏
      if (opts.length < 2) return window.showMessage("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ 2 –æ–ø—Ü–∏–∏.", "error");
      q.options = opts;
      q.correct = opts.map((_, i) => i);
    }

    questions.push(q);
    questions.sort((a, b) => a.time - b.time);
    window.renderEditorList();

    const modal = document.getElementById("modal-q");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  };

  window.renderEditorList = () => {
    const el = document.getElementById("q-list");
    el.innerHTML = questions.map((q, i) => `
      <div class="p-4 bg-white border border-slate-200 shadow-sm rounded-xl mb-3 flex justify-between items-center group hover:border-brand-300 transition-all">
        <div class="flex items-center gap-3">
          <span class="font-mono font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded-lg text-xs">${formatTime(q.time)}</span>
          <span class="truncate w-40 font-bold text-slate-700 text-sm">${q.text}</span>
          <span class="text-[10px] font-black text-slate-400 uppercase">(${q.type})</span>
        </div>
        <button onclick="window.deleteEditorQuestion(${i})" class="text-slate-300 hover:text-rose-500 transition-colors p-2 rounded-lg hover:bg-rose-50">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      </div>
    `).join("");
    lucide?.createIcons();
  };

  window.deleteEditorQuestion = (idx) => {
    questions.splice(idx, 1);
    window.renderEditorList();
  };

  window.saveQuizToLibrary = async () => {
    if (!user || !isTeacher) return window.showMessage("–ù—è–º–∞—Ç–µ —É—á–∏—Ç–µ–ª—Å–∫–∏ –¥–æ—Å—Ç—ä–ø.", "error");
    if (!currentVideoId) return window.showMessage("–ü—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–µ—Ç–µ –≤–∏–¥–µ–æ.", "error");
    if (!questions.length) return window.showMessage("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –≤—ä–ø—Ä–æ—Å!", "error");

    const existing = editingQuizId ? myQuizzes.find(x => x.id === editingQuizId) : null;
    const title = prompt("–ò–º–µ –Ω–∞ —É—Ä–æ–∫–∞:", existing?.title || "");
    if (title === null) return;

    const data = {
      title: (title.trim() || "–ë–µ–∑ –∏–º–µ"),
      v: currentVideoId,
      questions,
      updatedAt: serverTimestamp()
    };

    try {
      if (editingQuizId) {
        await updateDoc(doc(myQuizzesCol(user.uid), editingQuizId), data);
        window.showMessage("–£—Ä–æ–∫—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω!", "success");
      } else {
        data.createdAt = serverTimestamp();
        await addDoc(myQuizzesCol(user.uid), data);
        window.showMessage("–£—Ä–æ–∫—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω!", "success");
      }
      window.switchScreen("teacher-dashboard");
    } catch (e) {
      window.showMessage("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å: " + (e?.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"), "error");
    }
  };

  window.deleteQuiz = async (id) => {
    if (!user) return;
    if (!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞?")) return;
    await deleteDoc(doc(myQuizzesCol(user.uid), id));
  };

  // =========================
  // SOLO MODE
  // =========================
  window.speakQuestion = (text) => {
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "bg-BG";
    u.rate = 0.9;
    window.speechSynthesis.speak(u);
  };

  window.startIndividual = async () => {
    const code = document.getElementById("ind-quiz-code").value.trim().replace(/\s/g, "");
    const nameInput = document.getElementById("ind-student-name").value.trim();
    if (!code) return window.showMessage("–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥!", "error");

    const dec = decodeQuizCode(code);
    if (!dec || !dec.v || !Array.isArray(dec.q)) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥", "error");

    currentQuiz = dec;
    currentQuizOwnerId = dec.ownerId || null;

    sopModeEnabled = document.getElementById("ind-sop-mode").checked;
    isDiscussionMode = document.getElementById("ind-discussion-mode").checked;
    studentNameValue = nameInput || "–ê–Ω–æ–Ω–∏–º–µ–Ω";

    scoreCount = 0;
    soloGameFinished = false;
    lastAnsweredIndex = -1;
    currentQIndex = -1;

    if (!auth.currentUser) await signInAnonymously(auth);

    window.switchScreen("solve");
    setTimeout(() => {
      document.getElementById("solve-player-container").innerHTML = '<div id="solve-player"></div>';

      solvePlayer = new YT.Player("solve-player", {
        videoId: currentQuiz.v,
        width: "100%",
        height: "100%",
        playerVars: { autoplay: 1, controls: 1 },
        events: {
          onStateChange: (e) => {
            if (e.data === 1) {
              clearIntervals();
              const i = setInterval(() => {
                const t = Math.floor(solvePlayer.getCurrentTime());
                const qIdx = currentQuiz.q.findIndex((q, idx) => idx > lastAnsweredIndex && t >= (q.time || 0));
                if (qIdx !== -1) {
                  window.triggerSoloQuestion(currentQuiz.q[qIdx], qIdx);
                  lastAnsweredIndex = qIdx;
                }
                if (solvePlayer.getDuration() > 0 && t >= solvePlayer.getDuration() - 1) window.finishSoloGame();
              }, 350);
              activeIntervals.push(i);
            } else if (e.data === 0) {
              window.finishSoloGame();
            }
          }
        }
      });
    }, 400);
  };

  window.triggerSoloQuestion = (q, idx) => {
    currentQIndex = idx;
    solvePlayer.pauseVideo();

    const ov = document.getElementById("ind-overlay");
    ov.classList.remove("hidden");
    ov.classList.add("flex");

    const txt = document.getElementById("ind-overlay-q-text");
    txt.innerText = q.text;

    if (sopModeEnabled) {
      txt.classList.add("sop-text");
      document.getElementById("ind-speak-btn").classList.remove("hidden");
      window.speakQuestion(q.text);
    } else {
      txt.classList.remove("sop-text");
      document.getElementById("ind-speak-btn").classList.add("hidden");
      window.speechSynthesis?.cancel();
    }

    const c = document.getElementById("ind-overlay-options");
    c.innerHTML = "";
    tempSelectedAnswer = null;
    document.getElementById("ind-confirm-btn").classList.add("hidden");

    const btnClass = sopModeEnabled
      ? "option-btn sop-btn w-full bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl text-white font-bold text-left backdrop-blur-md transition-all shadow-lg mb-2"
      : "option-btn w-full p-5 bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl text-white font-bold text-xl text-left backdrop-blur-md transition-all hover:scale-[1.01] active:scale-95 shadow-lg";

    if (q.type === "single" || q.type === "boolean") {
      const opts = q.type === "boolean" ? ["–î–ê", "–ù–ï"] : (q.options || []);
      c.innerHTML = opts.map((o, i) =>
        `<button onclick="window.selectOptionSolo(this, ${q.type === "boolean" ? (i === 0) : i})" class="${btnClass}">${o}</button>`
      ).join("");
    } else if (q.type === "multiple") {
      const opts = q.options || [];
      c.innerHTML = opts.map((o, i) => `
        <label class="${btnClass} flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="mt-2 w-5 h-5 accent-emerald-400" data-multi-idx="${i}">
          <span>${o}</span>
        </label>
      `).join("");
      document.getElementById("ind-confirm-btn").classList.remove("hidden");
    } else if (q.type === "numeric_slider") {
      c.innerHTML = `
        <div class="w-full bg-white/20 p-6 rounded-2xl">
          <input type="range" id="solo-range" min="${q.min}" max="${q.max}" step="${q.step}" class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            oninput="document.getElementById('solo-range-val').innerText=this.value">
          <div class="text-white text-4xl font-black mt-4" id="solo-range-val">${Math.round((q.min + q.max) / 2)}</div>
        </div>
      `;
      document.getElementById("ind-confirm-btn").classList.remove("hidden");
    } else {
      c.innerHTML = `<div class="text-white/80 font-bold">–¢–æ–∑–∏ —Ç–∏–ø –µ TODO –∑–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–∏—è —Ä–µ–∂–∏–º.</div>`;
      document.getElementById("ind-confirm-btn").classList.remove("hidden");
    }
  };

  window.selectOptionSolo = (el, val) => {
    document.querySelectorAll("#ind-overlay-options .option-btn").forEach(b => b.classList.remove("border-indigo-500", "bg-indigo-600/50"));
    el.classList.add("border-indigo-500", "bg-indigo-600/50");
    tempSelectedAnswer = val;
    document.getElementById("ind-confirm-btn").classList.remove("hidden");
  };

  // Multiple partial credit:
  // +P/C for true positive, -P/C for false positive, clamp [0..P]
  function scoreMultiplePartial(selected, correct, points) {
    const P = points || 1;
    const corr = Array.isArray(correct) ? correct : [];
    const C = Math.max(1, corr.length);
    const setC = new Set(corr);
    let s = 0;
    for (const idx of selected) {
      s += setC.has(idx) ? (P / C) : -(P / C);
    }
    return Math.max(0, Math.min(P, s));
  }

  window.confirmSoloAnswer = () => {
    if (!currentQuiz || !currentQuiz.q || currentQIndex < 0) return;
    const q = currentQuiz.q[currentQIndex];

    let earned = 0;

    if (q.type === "single" || q.type === "boolean") {
      const isCor = (tempSelectedAnswer === q.correct);
      earned = isCor ? (q.points || 1) : 0;
    } else if (q.type === "numeric_slider") {
      const val = Number(document.getElementById("solo-range").value);
      const isCor = Math.abs(val - q.correct) <= (q.tolerance || 0);
      earned = isCor ? (q.points || 1) : 0;
    } else if (q.type === "multiple") {
      const selected = [...document.querySelectorAll('#ind-overlay-options input[type="checkbox"][data-multi-idx]')]
        .filter(x => x.checked)
        .map(x => Number(x.getAttribute("data-multi-idx")));
      earned = scoreMultiplePartial(selected, q.correct, q.points || 1);
    } else {
      earned = 0;
    }

    scoreCount += earned;

    if (earned > 0) window.showMessage(`+${earned.toFixed(2)} —Ç.`, "success");
    else window.showMessage("0 —Ç.", "error");

    const ov = document.getElementById("ind-overlay");
    ov.classList.add("hidden");
    ov.classList.remove("flex");
    window.speechSynthesis?.cancel();

    setTimeout(() => solvePlayer.playVideo(), 700);
  };

  window.finishSoloGame = async () => {
    if (soloGameFinished) return;
    soloGameFinished = true;

    window.switchScreen("finish");

    const max = currentQuiz.q.reduce((a, b) => a + (b.points || 1), 0);
    document.getElementById("res-score").innerText = `${scoreCount.toFixed(2)} / ${max}`;

    if (isDiscussionMode) return; // ‚úÖ –æ–±—Å—ä–∂–¥–∞–Ω–µ = –Ω—è–º–∞ cloud save

    if (auth.currentUser && currentQuizOwnerId) {
      try {
        await setDoc(doc(soloResultsCol(currentQuizOwnerId), `${auth.currentUser.uid}_${Date.now()}`), {
          studentName: studentNameValue,
          quizTitle: currentQuiz.title + (sopModeEnabled ? " (–°–û–ü)" : ""),
          score: `${scoreCount.toFixed(2)}/${max}`,
          timestamp: serverTimestamp(),
          userId: auth.currentUser.uid
        });
        window.showMessage("–†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –µ –∑–∞–ø–∏—Å–∞–Ω!", "success");
      } catch (e) {
        window.showMessage("–ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞–ø–∏—à–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ (Rules?).", "error");
      }
    }
  };

  // =========================
  // LIVE CLIENT
  // =========================
  window.joinLiveSession = async () => {
    const pin = document.getElementById("live-pin").value.trim();
    const name = document.getElementById("live-student-name").value.trim();
    if (!pin || !name) return window.showMessage("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –¥–∞–Ω–Ω–∏—Ç–µ!", "error");

    if (!auth.currentUser) await signInAnonymously(auth);

    const snap = await getDoc(sessionRef(pin));
    if (!snap.exists()) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ü–ò–ù", "error");

    sessionID = pin;
    sessionDocId = pin;
    liveScore = 0;
    liveActiveQIdx = -1;
    lastAnsweredIndex = -1;

    studentNameValue = name;

    window.switchScreen("live-client");
    const ava = AVATARS[Math.floor(Math.random() * AVATARS.length)];
    document.getElementById("my-avatar-display").innerText = ava;
    document.getElementById("client-player-name").innerText = name;

    await setDoc(participantRef(pin, auth.currentUser.uid), {
      name, avatar: ava, score: 0, joinedAt: serverTimestamp()
    }, { merge: true });

    onSnapshot(sessionRef(pin), (s) => {
      const d = s.data();
      if (!d) return;

      if (d.status === "finished") {
        document.getElementById("client-question").classList.add("hidden");
        document.getElementById("client-waiting").classList.add("hidden");
        document.getElementById("client-finished").classList.remove("hidden");
        document.getElementById("final-score-display").innerText = liveScore.toFixed(2);
        return;
      }

      if (d.status === "active" && d.activeQ !== liveActiveQIdx) {
        liveActiveQIdx = d.activeQ;
        window.currentLiveQ = d.qData;

        document.getElementById("client-question").classList.remove("hidden");
        document.getElementById("client-waiting").classList.add("hidden");

        document.getElementById("live-q-text-client").innerText = d.qData.text;
        window.renderLiveQuestionUI(d.qData);
        return;
      }

      document.getElementById("client-question").classList.add("hidden");
      document.getElementById("client-waiting").classList.remove("hidden");
    });
  };

  window.renderLiveQuestionUI = (q) => {
    const c = document.getElementById("live-options-client");
    c.innerHTML = "";
    tempSelectedAnswer = null;
    document.getElementById("live-confirm-btn").classList.add("hidden");

    if (q.type === "single" || q.type === "boolean") {
      const opts = q.type === "boolean" ? ["–î–ê", "–ù–ï"] : (q.options || []);
      c.innerHTML = opts.map((o, i) => `
        <button onclick="window.selectOptionLive(this, ${q.type === "boolean" ? (i === 0) : i})"
          class="option-btn w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-lg text-slate-700 shadow-sm mb-3 text-left hover:border-brand-500 hover:bg-brand-50 transition-all active:scale-[0.98]">
          ${o}
        </button>
      `).join("");
    } else if (q.type === "multiple") {
      const opts = q.options || [];
      c.innerHTML = opts.map((o, i) => `
        <label class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-lg text-slate-700 shadow-sm mb-3 text-left hover:border-brand-500 hover:bg-brand-50 transition-all flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="mt-1 w-5 h-5 accent-emerald-600" data-live-multi-idx="${i}">
          <span>${o}</span>
        </label>
      `).join("");
      document.getElementById("live-confirm-btn").classList.remove("hidden");
    } else if (q.type === "numeric_slider") {
      c.innerHTML = `
        <div class="w-full bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
          <input type="range" id="live-range" min="${q.min}" max="${q.max}" step="${q.step}" class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            oninput="document.getElementById('live-range-val').innerText=this.value">
          <div class="text-brand-600 text-6xl font-black mt-6 text-center" id="live-range-val">${Math.round((q.min + q.max) / 2)}</div>
        </div>
      `;
      document.getElementById("live-confirm-btn").classList.remove("hidden");
    } else {
      c.innerHTML = `<p class="text-center font-bold text-slate-500 mt-10">–¢–æ–∑–∏ —Ç–∏–ø –µ TODO –∑–∞ live –∫–ª–∏–µ–Ω—Ç.</p>`;
    }
  };

  window.selectOptionLive = (el, val) => {
    document.querySelectorAll("#live-options-client .option-btn").forEach(b => b.classList.remove("border-brand-600", "bg-brand-50"));
    el.classList.add("border-brand-600", "bg-brand-50");
    tempSelectedAnswer = val;
    document.getElementById("live-confirm-btn").classList.remove("hidden");
  };

  window.confirmLiveAnswer = async () => {
    if (lastAnsweredIndex === liveActiveQIdx) return;
    lastAnsweredIndex = liveActiveQIdx;

    const q = window.currentLiveQ;
    let earned = 0;

    if (q.type === "numeric_slider") {
      const val = Number(document.getElementById("live-range").value);
      const isCor = Math.abs(val - q.correct) <= (q.tolerance || 0);
      earned = isCor ? (q.points || 1) : 0;
    } else if (q.type === "multiple") {
      const selected = [...document.querySelectorAll('#live-options-client input[type="checkbox"][data-live-multi-idx]')]
        .filter(x => x.checked)
        .map(x => Number(x.getAttribute("data-live-multi-idx")));
      earned = scoreMultiplePartial(selected, q.correct, q.points || 1);
    } else {
      const isCor = (tempSelectedAnswer === q.correct);
      earned = isCor ? (q.points || 1) : 0;
    }

    liveScore += earned;

    document.getElementById("client-question").classList.add("hidden");
    document.getElementById("client-waiting").classList.remove("hidden");

    const up = { score: liveScore };
    up[`answers.${liveActiveQIdx}`] = { earned, type: q.type };
    await updateDoc(participantRef(sessionID, auth.currentUser.uid), up);
  };

  // =========================
  // LIVE HOST
  // =========================
  window.startHostFromLibrary = async (quizId) => {
    if (!user || !isTeacher) return window.showMessage("–ù—è–º–∞—Ç–µ —É—á–∏—Ç–µ–ª—Å–∫–∏ –¥–æ—Å—Ç—ä–ø.", "error");

    const q = myQuizzes.find(x => x.id === quizId);
    if (!q) return;

    currentQuiz = { title: q.title, v: q.v, q: q.questions || [], ownerId: user.uid };
    currentQuizOwnerId = user.uid;

    await window.openLiveHost();
  };

  window.openLiveHost = async () => {
    sessionID = Math.floor(1000 + Math.random() * 9000).toString();
    sessionDocId = sessionID;
    liveActiveQIdx = -1;

    window.switchScreen("live-host");
    document.getElementById("host-pin").innerText = sessionID;

    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin + window.location.pathname + "?pin=" + sessionID)}`;
    document.getElementById("host-qr-container").innerHTML = `
      <div class="text-[10px] uppercase font-black text-slate-400 mb-2 tracking-widest">QR –í—Ö–æ–¥</div>
      <img src="${qrUrl}" class="w-32 h-32 rounded-xl border-4 border-white shadow-md">
      <div class="text-[9px] text-slate-300 mt-2 font-mono">–°–∫–∞–Ω–∏—Ä–∞–π—Ç–µ</div>
    `;

    await setDoc(sessionRef(sessionDocId), {
      activeQ: -1,
      status: "waiting",
      hostId: currentQuizOwnerId,
      pin: sessionID,
      quizTitle: currentQuiz.title,
      createdAt: serverTimestamp()
    });

    onSnapshot(participantsCol(sessionDocId), (s) => {
      lastFetchedParticipants = s.docs.map(d => ({ ...d.data(), id: d.id }));
      window.renderHostDashboard();
    });
  };

  window.renderHostDashboard = () => {
    document.getElementById("host-participant-count").innerText = String(lastFetchedParticipants.length);

    const b = document.getElementById("host-results-body");
    const sorted = [...lastFetchedParticipants].sort((a, b) => (b.score || 0) - (a.score || 0));
    b.innerHTML = sorted.map((p, i) => `
      <tr class="transition-all animate-fade-in">
        <td class="p-3 font-black text-slate-400 text-xs w-10">#${i + 1}</td>
        <td class="p-3 font-bold text-slate-800 flex items-center gap-2"><span class="text-xl">${p.avatar || "üòé"}</span> ${p.name}</td>
        <td class="p-3 text-right font-black text-brand-600">${(p.score ?? 0).toFixed?.(2) ?? (p.score ?? 0)}</td>
      </tr>
    `).join("");
  };

  window.initHostPlayer = () => {
    document.getElementById("host-setup-area").classList.add("hidden");

    // ‚úÖ FIX: inject actual host-video element
    document.getElementById("host-video-container").innerHTML = `<div id="host-video" class="w-full h-full"></div>`;

    hostPlayer = new YT.Player("host-video", {
      videoId: currentQuiz.v,
      width: "100%",
      height: "100%",
      playerVars: { autoplay: 1, controls: 1 },
      events: {
        onReady: (e) => e.target.playVideo(),
        onStateChange: (e) => {
          if (e.data !== 1) return; // playing only
          clearIntervals();

          const i = setInterval(async () => {
            const t = Math.floor(hostPlayer.getCurrentTime());
            const qIdx = currentQuiz.q.findIndex(q => Math.abs((q.time || 0) - t) <= 1);
            if (qIdx !== -1 && qIdx !== liveActiveQIdx) {
              liveActiveQIdx = qIdx;
              hostPlayer.pauseVideo();

              document.getElementById("host-resume-overlay").classList.remove("hidden");
              document.getElementById("host-resume-overlay").classList.add("flex");

              await updateDoc(sessionRef(sessionDocId), {
                activeQ: qIdx,
                qData: currentQuiz.q[qIdx],
                status: "active"
              });
            }

            // auto-finish near end
            if (hostPlayer.getDuration && hostPlayer.getDuration() > 0) {
              if (t >= hostPlayer.getDuration() - 1) {
                await window.finishLiveSession();
              }
            }
          }, 650);

          activeIntervals.push(i);
        }
      }
    });
  };

  window.resumeHostSession = async () => {
    document.getElementById("host-resume-overlay").classList.add("hidden");
    document.getElementById("host-resume-overlay").classList.remove("flex");

    await updateDoc(sessionRef(sessionDocId), { status: "playing" });
    hostPlayer?.playVideo();
  };

  window.finishLiveSession = async () => {
    try {
      await updateDoc(sessionRef(sessionDocId), { status: "finished", finishedAt: serverTimestamp() });
    } catch {}

    // save history
    if (user && isTeacher) {
      try {
        await addDoc(classHistoryCol(user.uid), {
          sessionId: sessionDocId,
          pin: sessionID,
          quizTitle: currentQuiz?.title || "",
          timestamp: serverTimestamp()
        });
      } catch {}
    }

    document.getElementById("export-buttons-container").classList.remove("hidden");
    document.getElementById("export-buttons-container").classList.add("flex");
  };

  window.quitHostSession = async () => {
    if (!confirm("–ö—Ä–∞–π –Ω–∞ —Å–µ—Å–∏—è—Ç–∞?")) return;
    await window.finishLiveSession();
    window.switchScreen("teacher-dashboard");
  };

  // =========================
  // IMPORT
  // =========================
  window.openImportModal = () => {
    const m = document.getElementById("modal-import");
    m.classList.remove("hidden");
    m.classList.add("flex");
  };

  window.submitImport = async () => {
    if (!user) return;
    const c = document.getElementById("import-code-input").value;
    const d = decodeQuizCode(c);
    if (!d || !d.v || !Array.isArray(d.q)) return window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥", "error");

    await addDoc(myQuizzesCol(user.uid), {
      title: d.title || "Import",
      v: d.v,
      questions: d.q,
      createdAt: serverTimestamp()
    });

    window.showMessage("–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!", "success");
    const m = document.getElementById("modal-import");
    m.classList.add("hidden");
    m.classList.remove("flex");
  };

  // =========================
  // BOOT
  // =========================
  onAuthStateChanged(auth, async (u) => {
    user = u || null;

    if (!user) {
      isTeacher = false;
      window.switchScreen("welcome");
      return;
    }

    try {
      const snap = await getDoc(profileDoc(user.uid));
      isTeacher = !!(snap.exists() && snap.data()?.role === "teacher");
      if (isTeacher) document.getElementById("user-email-display").innerText = snap.data()?.email || "";
    } catch {
      isTeacher = false;
    }

    const p = new URLSearchParams(window.location.search).get("pin");
    if (p) {
      window.switchScreen("welcome");
      window.switchTab("class");
      const el = document.getElementById("live-pin");
      if (el) el.value = p;
      return;
    }

    window.switchScreen(isTeacher ? "teacher-dashboard" : "welcome");
  });

  window.addEventListener("DOMContentLoaded", () => {
    const p = new URLSearchParams(window.location.search).get("pin");
    if (p) {
      setTimeout(() => {
        window.switchTab("class");
        const el = document.getElementById("live-pin");
        if (el) {
          el.value = p;
          window.showMessage("–ü–ò–ù –∑–∞—Ä–µ–¥–µ–Ω!", "success");
        }
      }, 500);
    }
    setTimeout(() => document.getElementById("auth-loader")?.classList.add("hidden"), 2500);
    lucide?.createIcons();
  });

  window.onYouTubeIframeAPIReady = () => {
    isYTReady = true;
    console.log("YT Ready");
  };
</script>
