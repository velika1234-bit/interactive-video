<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>VideoQuiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;900&display=swap" rel="stylesheet">
  <script>
    try{tailwind.config={theme:{extend:{fontFamily:{sans:['Nunito','sans-serif']}}}}}catch(e){}
  </script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">
<div id="toasts" class="toast"></div>

<!-- WELCOME -->
<section id="screen-welcome" class="h-full w-full overflow-auto">
  <div class="min-h-full grid lg:grid-cols-2">
    <div class="bg-white">
      <div class="max-w-xl mx-auto p-6 lg:p-10 space-y-6">
        <div class="text-center">
          <h1 class="text-5xl font-black tracking-tight">VideoQuiz</h1>
          <p class="font-bold text-slate-500">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ / –í –∫–ª–∞—Å</p>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-5 space-y-3 bg-slate-50">
            <div class="flex items-center gap-2 text-indigo-700">
              <i data-lucide="play-circle" class="w-5 h-5"></i>
              <div class="font-black">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</div>
            </div>
            <input id="ind-name" class="w-full p-3 rounded-xl border border-slate-200 font-bold" placeholder="–ò–º–µ">
            <textarea id="ind-code" class="w-full p-3 rounded-xl border border-slate-200 font-mono text-xs h-24" placeholder="–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫"></textarea>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 text-xs font-black text-slate-600 bg-white border border-slate-200 rounded-xl p-2">
                <input id="ind-sop" type="checkbox" class="accent-indigo-600"> –°–û–ü üîä
              </label>
              <label class="flex items-center gap-2 text-xs font-black text-slate-600 bg-white border border-slate-200 rounded-xl p-2">
                <input id="ind-disc" type="checkbox" class="accent-amber-500"> –û–±—Å—ä–∂–¥–∞–Ω–µ
              </label>
            </div>
            <button class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full" onclick="startSolo()">–°—Ç–∞—Ä—Ç</button>
          </div>

          <div class="card p-5 space-y-3 bg-emerald-50">
            <div class="flex items-center gap-2 text-emerald-700">
              <i data-lucide="users" class="w-5 h-5"></i>
              <div class="font-black">–í –∫–ª–∞—Å (–ü–ò–ù)</div>
            </div>
            <input id="live-name" class="w-full p-3 rounded-xl border border-emerald-200 font-bold text-center" placeholder="–ò–º–µ">
            <input id="live-pin" class="w-full p-3 rounded-xl border border-emerald-200 font-black text-center text-lg tracking-widest" placeholder="–ü–ò–ù" inputmode="numeric">
            <button class="btn bg-emerald-600 hover:bg-emerald-700 text-white w-full" onclick="joinLive()">–í–ª–µ–∑</button>
          </div>
        </div>

        <p class="text-xs font-bold text-slate-400 text-center">–£—á–∏—Ç–µ–ª—Å–∫–∏—è—Ç –≤—Ö–æ–¥ –µ –≤–¥—è—Å–Ω–æ.</p>
      </div>
    </div>

    <div class="bg-slate-900 text-white">
      <div class="max-w-sm mx-auto p-6 lg:p-10 space-y-5">
        <div>
          <div id="auth-title" class="text-3xl font-black">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥</div>
          <div class="text-slate-400 font-bold text-sm">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ—Ü–∏</div>
        </div>
        <div class="space-y-3">
          <input id="auth-email" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 font-bold" placeholder="email">
          <input id="auth-pass" type="password" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 font-bold" placeholder="–ø–∞—Ä–æ–ª–∞">
          <div id="auth-code-wrap" class="hidden">
            <input id="auth-code" type="password" class="w-full p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 font-black text-center tracking-widest" placeholder="–∫–æ–¥ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è">
            <div class="text-[11px] text-amber-300 font-bold">–°–∞–º–æ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
          </div>
          <button id="auth-btn" class="btn bg-indigo-600 hover:bg-indigo-500 w-full" onclick="authSubmit()">–í–ª–µ–∑</button>
          <button id="auth-toggle" class="text-sm font-bold text-slate-300 hover:text-white w-full" onclick="toggleAuth()">–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- TEACHER -->
<section id="screen-teacher" class="hidden h-full w-full overflow-hidden">
  <header class="bg-white border-b border-slate-200 p-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center">
        <i data-lucide="library" class="w-5 h-5"></i>
      </div>
      <div>
        <div class="font-black">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div id="teacherEmail" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">...</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-black text-xs" onclick="openEditor()">–ù–æ–≤ —É—Ä–æ–∫</button>
      <button class="p-2 rounded-xl hover:bg-rose-50 text-slate-500 hover:text-rose-600" onclick="logout()" title="–ò–∑—Ö–æ–¥">
        <i data-lucide="log-out" class="w-5 h-5"></i>
      </button>
    </div>
  </header>

  <main class="h-[calc(100%-64px)] overflow-auto p-4 max-w-6xl mx-auto space-y-6">
    <div>
      <div class="font-black text-xl mb-3">–í–∞—à–∏—Ç–µ —É—Ä–æ—Ü–∏</div>
      <div id="lessonGrid" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>

    <div class="card overflow-hidden">
      <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
        <div class="font-black">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</div>
        <button class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-black text-xs hover:bg-slate-50" onclick="exportSoloExcel()">Excel</button>
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-black">
            <tr><th class="p-3 text-left">–£—á–µ–Ω–∏–∫</th><th class="p-3 text-left">–£—Ä–æ–∫</th><th class="p-3 text-left">–î–∞—Ç–∞</th><th class="p-3 text-right">–†–µ–∑—É–ª—Ç–∞—Ç</th></tr>
          </thead>
          <tbody id="soloRows" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </div>
  </main>
</section>

<!-- EDITOR -->
<section id="screen-editor" class="hidden h-full w-full overflow-hidden bg-slate-100">
  <header class="bg-white border-b border-slate-200 p-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <button class="p-2 rounded-xl hover:bg-slate-100" onclick="goTeacher()"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
      <div>
        <div class="font-black">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
        <div id="edSub" class="text-[10px] font-black uppercase tracking-widest text-slate-400">–ù–æ–≤ —É—Ä–æ–∫</div>
      </div>
    </div>
    <button class="px-5 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-black" onclick="saveLesson()">–ó–∞–ø–∞–∑–∏</button>
  </header>

  <div class="h-[calc(100%-64px)] grid lg:grid-cols-[1fr,420px]">
    <div class="bg-black relative">
      <div id="edPlayer" class="absolute inset-0"></div>
      <div id="edPanel" id="edOverlay" class="absolute inset-0 bg-slate-900/90 flex items-center justify-center p-6">
        <div class="w-full max-w-md space-y-3 text-center">
          <div class="text-white text-2xl font-black">–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –≤–∏–¥–µ–æ</div>
          <input id="edUrl" class="w-full p-3 rounded-xl font-bold" placeholder="YouTube –ª–∏–Ω–∫">
          <button class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full" onclick="loadEditorVideo()">–ó–∞—Ä–µ–¥–∏</button>
          <div class="text-slate-300 text-xs font-bold">YouTube –ª–∏–Ω–∫ (youtube.com / youtu.be)</div>
        </div>
      </div>
    </div>
    <aside class="bg-white border-l border-slate-200 overflow-hidden flex flex-col">
      <div class="p-4 border-b bg-slate-50 flex items-center justify-between">
        <div class="font-black text-slate-700">–í—ä–ø—Ä–æ—Å–∏</div>
        <div class="flex items-center gap-2">
          <div id="edTime" class="px-3 py-1 rounded-lg bg-indigo-50 text-indigo-700 font-mono font-black text-xs">0:00</div>
          <button class="w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center" onclick="openQModal()">
            <i data-lucide="plus" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div id="edQList" class="flex-1 overflow-auto p-4 space-y-3 bg-slate-50"></div>
    </aside>
  </div>
</section>

<!-- SOLO -->
<section id="screen-solo" class="hidden h-full w-full bg-black relative">
  <div id="soloPlayer" class="absolute inset-0"></div>
  <div id="soloOverlay" class="hidden absolute inset-0 bg-slate-900/95 z-10 items-center justify-center p-6">
    <div class="w-full max-w-2xl space-y-5 text-center">
      <button id="soloSpeak" class="hidden ml-auto p-3 rounded-full bg-indigo-600 text-white" onclick="speakSolo()"><i data-lucide="volume-2" class="w-6 h-6"></i></button>
      <div id="soloQ" class="text-white text-3xl font-black"></div>
      <div id="soloOpts" class="grid gap-3"></div>
      <button id="soloConfirm" class="hidden btn bg-indigo-600 hover:bg-indigo-700 text-white w-full" onclick="confirmSolo()">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
    </div>
  </div>
</section>

<!-- FINISH -->
<section id="screen-finish" class="hidden h-full w-full flex items-center justify-center p-6">
  <div class="card p-10 text-center space-y-4 max-w-md w-full">
    <div class="text-5xl">üèÜ</div>
    <div class="text-2xl font-black">–†–µ–∑—É–ª—Ç–∞—Ç</div>
    <div id="finishScore" class="text-6xl font-black text-indigo-700">0/0</div>
    <button class="btn bg-slate-900 hover:bg-slate-950 text-white w-full" onclick="goWelcome()">–ù–∞—á–∞–ª–æ</button>
  </div>
</section>

<!-- HOST -->
<section id="screen-host" class="hidden h-full w-full bg-slate-900 text-white overflow-hidden">
  <header class="h-16 px-4 flex items-center justify-between bg-slate-800 border-b border-slate-700">
    <div class="flex items-center gap-4">
      <div class="px-4 py-1.5 rounded-xl bg-indigo-600">
        <div class="text-[9px] uppercase font-black text-indigo-200">–ü–ò–ù</div>
        <div id="hostPin" class="text-2xl font-black leading-none">----</div>
      </div>
      <div class="text-xs font-black text-slate-300 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i><span id="hostCount">0</span></div>
    </div>
    <div class="flex items-center gap-2">
      <button id="hostExportX" class="hidden px-3 py-2 rounded-xl bg-emerald-600 font-black text-xs" onclick="exportHostExcel()">Excel</button>
      <button id="hostExportP" class="hidden px-3 py-2 rounded-xl bg-indigo-600 font-black text-xs" onclick="exportHostPDF()">PDF</button>
      <button class="px-4 py-2 rounded-xl bg-slate-700 font-black text-xs" onclick="endHost()">–ö—Ä–∞–π</button>
    </div>
  </header>
  <div class="h-[calc(100%-64px)] grid lg:grid-cols-[1fr,320px] gap-3 p-3 overflow-hidden">
    <div class="bg-black rounded-2xl overflow-hidden relative">
      <div id="hostPlayer" class="absolute inset-0"></div>
      <div id="hostStart" class="absolute inset-0 bg-black/70 flex items-center justify-center">
        <button class="px-10 py-5 rounded-2xl bg-indigo-600 hover:bg-indigo-500 font-black text-2xl" onclick="startHostVideo()">
          ‚ñ∂ –°—Ç–∞—Ä—Ç
        </button>
      </div>
      <div id="hostQ" class="hidden absolute inset-0 bg-black/70 items-center justify-center flex-col gap-4">
        <div class="text-3xl font-black">–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∞–∫—Ç–∏–≤–µ–Ω!</div>
        <button class="px-10 py-5 rounded-2xl bg-emerald-600 font-black text-2xl" onclick="resumeHost()">–ü—Ä–æ–¥—ä–ª–∂–∏</button>
      </div>
    </div>
    <aside class="bg-white text-slate-800 rounded-2xl overflow-hidden border border-slate-200 flex flex-col">
      <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs uppercase">–ö–ª–∞—Å–∏—Ä–∞–Ω–µ</div>
      <div class="flex-1 overflow-auto p-2 bg-slate-50">
        <table class="w-full border-separate border-spacing-y-2"><tbody id="hostBoard"></tbody></table>
      </div>
    </aside>
  </div>
</section>

<!-- CLIENT -->
<section id="screen-client" class="hidden h-full w-full bg-slate-50 overflow-hidden relative">
  <div class="absolute top-0 left-0 w-full h-2 bg-indigo-500"></div>

  <div id="clientWait" class="h-full flex flex-col items-center justify-center p-8 text-center gap-6">
    <div class="text-6xl" id="cEmoji">üëÄ</div>
    <div>
      <div class="text-2xl font-black" id="cTitle">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞!</div>
      <div class="text-slate-500 font-bold">–û—á–∞–∫–≤–∞–π –≤—ä–ø—Ä–æ—Å‚Ä¶</div>
    </div>
    <div class="card px-6 py-3 flex items-center gap-3">
      <div class="text-2xl" id="cAvatar">üòé</div>
      <div class="text-lg font-black" id="cName">...</div>
    </div>
  </div>

  <div id="clientQWrap" class="hidden h-full p-6 pb-28 overflow-auto">
    <div class="card p-6 text-center">
      <div id="cQ" class="text-xl font-black"></div>
    </div>
    <div id="cOpts" class="mt-6 space-y-3 max-w-md mx-auto"></div>
    <button id="cConfirm" class="hidden fixed bottom-6 left-6 right-6 btn bg-indigo-600 hover:bg-indigo-700 text-white" onclick="confirmClient()">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
  </div>

  <div id="clientDone" class="hidden absolute inset-0 bg-indigo-600 text-white flex flex-col items-center justify-center gap-4">
    <div class="text-5xl font-black">–ö–†–ê–ô!</div>
    <div class="text-xl font-bold">–¢–≤–æ—è—Ç —Ä–µ–∑—É–ª—Ç–∞—Ç:</div>
    <div id="cFinal" class="w-40 h-40 rounded-full bg-white text-indigo-700 flex items-center justify-center text-6xl font-black">0</div>
    <button class="px-10 py-4 rounded-2xl bg-indigo-900 font-black text-lg" onclick="goWelcome()">–ò–∑—Ö–æ–¥</button>
  </div>
</section>

<!-- Q MODAL -->
<div id="qModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center p-4">
  <div class="card w-full max-w-2xl overflow-hidden">
    <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
      <div class="font-black text-lg">–ù–æ–≤ –≤—ä–ø—Ä–æ—Å</div>
      <button class="p-2 rounded-xl hover:bg-slate-100" onclick="closeQModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div class="p-4 space-y-4 max-h-[70vh] <div id="qModal" class="hidden" aria-hidden="true">
  <div class="vq-backdrop" onclick="closeQModal()"></div>
  <div class="vq-sheet" role="dialog" aria-modal="true">
    <div class="flex items-center justify-between gap-3 mb-3">
      <h3 id="mqTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ</h3>
      <div class="flex items-center gap-2">
        <div class="px-3 py-1 rounded-xl bg-slate-900 text-white font-black text-sm" id="mqBadge">0:00</div>
        <button type="button" class="p-2 rounded-xl hover:bg-slate-100" onclick="closeQModal()" aria-label="–ó–∞—Ç–≤–æ—Ä–∏">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    </div>

    <div class="vq-row mb-3">
      <div>
        <div class="text-xs font-black uppercase text-slate-500">–¢–∏–ø</div>
        <select id="mqType" class="mt-2" onchange="renderModal()">
          <option value="single">–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω</option>
          <option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω–∏</option>
          <option value="boolean">–í—è—Ä–Ω–æ / –ì—Ä–µ—à–Ω–æ</option>
          <option value="numeric">–ü–ª—ä–∑–≥–∞—á (—á–∏—Å–ª–æ)</option>
          <option value="text">–°–≤–æ–±–æ–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</option>
        </select>
      </div>
      <div>
        <div class="text-xs font-black uppercase text-slate-500">–¢–æ—á–∫–∏</div>
        <input id="mqPoints" type="number" min="1" value="1" class="mt-2">
      </div>
    </div>

    <div class="vq-row mb-3">
      <div>
        <div class="text-xs font-black uppercase text-slate-500">–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞</div>
        <textarea id="mqText" class="mt-2" placeholder="–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞"></textarea>
      </div>
      <div>
        <div class="text-xs font-black uppercase text-slate-500">–í—Ä–µ–º–µ (—Å–µ–∫.)</div>
        <input id="mqTime" type="number" step="0.1" min="0" value="0" class="mt-2">
        <div class="flex gap-2 mt-2">
          <button class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-black text-xs" type="button" onclick="setModalNow()">–¢–µ–∫—É—â–∞</button>
          <button class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-black text-xs" type="button" onclick="playFromModal()">–ü—É—Å–Ω–∏ ‚ñ∂</button>
        </div>
      </div>
    </div>

    <div id="mqBody" class="vq-answers"></div>

    <div class="vq-actions">
      <button class="vq-primary" type="button" onclick="saveModalQ()">–ó–ê–ü–ê–ó–ò</button>
      <button class="vq-cancel" type="button" onclick="closeQModal()">–û—Ç–∫–∞–∑</button>
    </div>
  </div>
</div>sejs/10.7.1/firebase-auth.js";

  // === YOUR FIREBASE CONFIG ===
  const firebaseConfig = {
    apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
    authDomain: "videoquiz-ultimate.firebaseapp.com",
    projectId: "videoquiz-ultimate",
    storageBucket: "videoquiz-ultimate.firebasestorage.app",
    messagingSenderId: "793138692820",
    appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
  };

  // Keep this fixed for your Firestore rules
  const FINAL_APP_ID = "videoquiz-ultimate-live";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // === PATHS (match your rules) ===
  const userRoot = (uid)=> collection(db,"artifacts",FINAL_APP_ID,"users",uid,"my_quizzes");
  const userProfile = (uid)=> doc(db,"artifacts",FINAL_APP_ID,"users",uid,"settings","profile");
  const soloResultsCol = (uid)=> collection(db,"artifacts",FINAL_APP_ID,"users",uid,"solo_results");
  const sessionRef = (pin)=> doc(db,"artifacts",FINAL_APP_ID,"public","data","sessions",pin);
  const participantsCol = (pin)=> collection(db,"artifacts",FINAL_APP_ID,"public","data","sessions",pin,"participants");
  const participantRef = (pin,pid)=> doc(db,"artifacts",FINAL_APP_ID,"public","data","sessions",pin,"participants",pid);

  // === UI helpers ===
  const $ = (id)=>document.getElementById(id);
  const fmt = (s)=>{const m=Math.floor(s/60),ss=Math.floor(s%60);return `${m}:${ss<10?'0':''}${ss}`};
  const toast=(t,kind="info")=>{
    const c=$("toasts");const d=document.createElement("div");
    d.className="titem "+(kind==="error"?"bg-rose-600":kind==="success"?"bg-emerald-600":"bg-indigo-600");
    d.textContent=t;c.appendChild(d);setTimeout(()=>d.remove(),2600);
  };
  const icons=()=>{try{window.lucide?.createIcons?.()}catch(e){}};

  const show=(name)=>{
    ["welcome","teacher","editor","solo","finish","host","client"].forEach(x=> $("screen-"+x).classList.add("hidden"));
    $("screen-"+name).classList.remove("hidden"); icons();
  };
  window.goWelcome=()=>show("welcome");
  window.goTeacher=()=>show("teacher");

  // === AUTH ===
  let authMode="login";
  window.toggleAuth=()=>{
    authMode = authMode==="login"?"register":"login";
    $("auth-title").textContent = authMode==="login"?"–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥":"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
    $("auth-btn").textContent = authMode==="login"?"–í–ª–µ–∑":"–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ";
    $("auth-code-wrap").classList.toggle("hidden", authMode!=="register");
    $("auth-toggle").textContent = authMode==="login"?"–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è":"–ò–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –í—Ö–æ–¥";
  };

  window.authSubmit=async ()=>{
    try{
      const email=($("auth-email").value||"").trim();
      const pass=($("auth-pass").value||"").trim();
      if(!email||!pass) return toast("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞.","error");
      if(authMode==="register"){
        if(($("auth-code").value||"").trim()!=="vilidaf76") return toast("–ì—Ä–µ—à–µ–Ω –∫–æ–¥ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.","error");
        const cred=await createUserWithEmailAndPassword(auth,email,pass);
        await setDoc(userProfile(cred.user.uid),{role:"teacher",email,createdAt:serverTimestamp()},{merge:true});
        toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞!","success");
      }else{
        await signInWithEmailAndPassword(auth,email,pass);
      }
    }catch(e){ toast("–ì—Ä–µ—à–∫–∞: "+(e?.message||e),"error"); }
  };

  window.logout=async ()=>{ await signOut(auth); location.reload(); };

  // === TEACHER DATA ===
  let user=null, myQuizzes=[], mySolo=[];
  let unsubQ=null, unsubS=null;

  const tsMs=(ts)=>ts?(ts.toMillis?ts.toMillis():(ts.seconds?ts.seconds*1000:0)):0;
  const toBG=(ts)=>{if(!ts)return"";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleString("bg-BG")};

  function renderTeacher(){
    $("lessonGrid").innerHTML = myQuizzes.map(q=>{
      const n=(q.questions||[]).length;
      return `
        <div class="card p-5 flex flex-col gap-3">
          <div class="font-black text-lg">${q.title||"–ë–µ–∑ –∏–º–µ"}</div>
          <div class="text-xs font-black text-slate-400 uppercase">${n} –≤—ä–ø—Ä–æ—Å–∞</div>
          <div class="flex gap-2 pt-2 border-t border-slate-100">
            <button class="flex-1 px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-black text-xs" onclick="startHost('${q.id}')">–°—Ç–∞—Ä—Ç</button>
            <button class="px-3 py-2 rounded-xl bg-slate-100 font-black text-xs" onclick="openEditor('${q.id}')">–†–µ–¥–∞–∫—Ü–∏—è</button>
            <button class="px-3 py-2 rounded-xl bg-rose-50 text-rose-600 font-black text-xs" onclick="delLesson('${q.id}')">–ò–∑—Ç—Ä–∏–π</button>
          </div>
          <button class="px-3 py-2 rounded-xl bg-amber-50 text-amber-700 font-black text-xs" onclick="shareLesson('${q.id}')">–ö–æ–¥ –∑–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</button>
        </div>`;
    }).join("");
    renderSoloRows();
    icons();
  }

  function renderSoloRows(){
    const rows=[...mySolo].sort((a,b)=>tsMs(b.timestamp)-tsMs(a.timestamp));
    $("soloRows").innerHTML = rows.map(r=>`
      <tr class="text-xs">
        <td class="p-3 font-bold">${r.studentName||""}</td>
        <td class="p-3">${r.quizTitle||""}</td>
        <td class="p-3 text-slate-400 font-mono">${toBG(r.timestamp)}</td>
        <td class="p-3 text-right font-black text-indigo-700">${r.score||""}</td>
      </tr>`).join("");
  }

  window.exportSoloExcel=()=>{
    const rows=[...mySolo].sort((a,b)=>tsMs(b.timestamp)-tsMs(a.timestamp))
      .map(r=>({Student:r.studentName||"",Lesson:r.quizTitle||"",Date:toBG(r.timestamp),Score:r.score||""}));
    const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Solo");XLSX.writeFile(wb,"VideoQuiz_Solo.xlsx");
  };

  window.delLesson=async (id)=>{ if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞?")) return; await deleteDoc(doc(db,"artifacts",FINAL_APP_ID,"users",user.uid,"my_quizzes",id)); };

  // === SHARE CODE ===
  const enc=(o)=>btoa(unescape(encodeURIComponent(JSON.stringify(o))));
  const dec=(s)=>{try{return JSON.parse(decodeURIComponent(escape(atob((s||"").trim().replace(/\s/g,"")))))}catch(e){return null;}};

  window.shareLesson=(id)=>{
    const q=myQuizzes.find(x=>x.id===id); if(!q) return;
    const payload={title:q.title||"–£—Ä–æ–∫",v:q.v, q:q.questions||[], ownerId:user.uid};
    navigator.clipboard?.writeText(enc(payload));
    toast("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞.","success");
  };

  // === EDITOR ===
  let edId=null, edTitle="–ë–µ–∑ –∏–º–µ", edVideo="", edQs=[], edPlayer=null, edTInt=null;

  const ytId=(u)=>{const m=(u||"").match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/);return m?m[1]:null;};
  const norm=(q)=>{
    if(typeof q.t!=="number") q.t=Number(q.t||q.time||0)||0;
    if(!Array.isArray(q.options)) q.options=[];
    if(!Array.isArray(q.correct)) q.correct = (typeof q.correct==="number")?[q.correct]:[];
    if(!q.type) q.type="single";
    q.points = Number(q.points||1)||1;
    return q;
  };

  function renderEdQs(){
    $("edQList").innerHTML = edQs.sort((a,b)=>a.t-b.t).map((q,i)=>`
      <div class="card p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-lg bg-indigo-50 text-indigo-700 font-mono font-black text-xs">${fmt(q.t||0)}</span>
              <span class="text-[10px] uppercase font-black text-slate-400">${q.type} ‚Ä¢ ${q.points}—Ç</span>
            </div>
            <div class="mt-2 font-black">${q.text||""}</div>
          </div>
          <div class="flex gap-1">
            <button class="p-2 rounded-xl hover:bg-slate-100" onclick="playQ(${q.t||0})"><i data-lucide="play" class="w-4 h-4"></i></button>
            <button class="p-2 rounded-xl hover:bg-rose-50 text-rose-600" onclick="delQ(${i})"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
          </div>
        </div>
      </div>`).join("");
    icons();
  }

  window.openEditor=(id=null)=>{
    edId=id; edQs=[]; edVideo=""; edTitle="–ë–µ–∑ –∏–º–µ";
    $("edSub").textContent = id?"–†–µ–¥–∞–∫—Ü–∏—è":"–ù–æ–≤ —É—Ä–æ–∫";
    $("edUrl").value=""; $("edPlayer").innerHTML=""; $("edOverlay").classList.remove("hidden");
    if(edTInt){clearInterval(edTInt);edTInt=null;}
    if(id){
      const q=myQuizzes.find(x=>x.id===id);
      if(q){ edTitle=q.title||"–ë–µ–∑ –∏–º–µ"; edVideo=q.v||""; edQs=(q.questions||[]).map(x=>norm(JSON.parse(JSON.stringify(x)))); }
      if(edVideo){ $("edOverlay").classList.add("hidden"); initEdPlayer(edVideo); $("edUrl").value="https://youtu.be/"+edVideo; }
    }
    renderEdQs(); show("editor");
  };

  function initEdPlayer(videoId){
    $("edPlayer").innerHTML='<div id="edYT" class="w-full h-full"></div>';
    edPlayer=new YT.Player("edYT",{videoId,width:"100%",height:"100%",playerVars:{autoplay:0,controls:1,rel:0},
      events:{onReady:()=>{edTInt=setInterval(()=>{try{$("edTime").textContent=fmt(edPlayer.getCurrentTime()||0)}catch(e){}},250);}}});
  }

  window.loadEditorVideo=()=>{
    const id=ytId($("edUrl").value);
    if(!id) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω YouTube –ª–∏–Ω–∫.","error");
    edVideo=id; $("edOverlay").classList.add("hidden"); initEdPlayer(id);
  };

  // Q Modal
  let modalBase=0;
  window.openQModal=()=>{
    if(!edPlayer||!edVideo) return toast("–ü—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–µ—Ç–µ –≤–∏–¥–µ–æ.","error");
    try{edPlayer.pauseVideo()}catch(e){}
    $("mqText").value=""; $("mqType").value="single"; $("mqPoints").value=1;
    modalBase=Math.round(Number(edPlayer.getCurrentTime()||0)*10)/10; $("mqTime").value=modalBase;
    renderModal();
    $("qModal").classList.remove("hidden"); $("qModal").classList.add("flex"); icons();
  };
  window.closeQModal=()=>{ $("qModal").classList.add("hidden"); $("qModal").classList.remove("flex"); };
  window.setModalNow=()=>{ modalBase=Math.round(Number(edPlayer.getCurrentTime()||0)*10)/10; $("mqTime").value=modalBase; };
  window.playFromModal=()=>{ const t=Number($("mqTime").value||0); try{edPlayer.seekTo(t,true);edPlayer.playVideo()}catch(e){} };

  window.renderModal=()=>{
    const type=$("mqType").value; const b=$("mqBody"); b.innerHTML="";
    if(type==="numeric"){
      b.innerHTML=`
        <div class="grid grid-cols-2 gap-3">
          <input id="mqMin" type="number" value="0" class="p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-black" placeholder="–ú–∏–Ω">
          <input id="mqMax" type="number" value="100" class="p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-black" placeholder="–ú–∞–∫—Å">
          <input id="mqStep" type="number" value="1" class="p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-black" placeholder="–°—Ç—ä–ø–∫–∞">
          <input id="mqTol" type="number" value="0" class="p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-black" placeholder="–¢–æ–ª–µ—Ä–∞–Ω—Å">
        </div>
        <input id="mqCorrectNum" type="number" value="0" class="w-full p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-black" placeholder="–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä">`;
      return;
    }
    if(type==="boolean"){
      b.innerHTML=`
        <div class="card p-4 bg-slate-50 space-y-2">
          <div class="font-black">–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</div>
          <label class="flex items-center gap-2 font-bold"><input type="radio" name="mqBool" value="true" checked> –í—è—Ä–Ω–æ</label>
          <label class="flex items-center gap-2 font-bold"><input type="radio" name="mqBool" value="false"> –ì—Ä–µ—à–Ω–æ</label>
        </div>`;
      return;
    }
    const isMulti=type==="multiple";
    b.innerHTML=`
      <div class="card p-4 bg-slate-50 space-y-3">
        <div class="font-black">–û—Ç–≥–æ–≤–æ—Ä–∏</div>
        <div id="mqOpts" class="space-y-2"></div>
        <div class="border-t border-slate-200 pt-3">
          <div class="font-black mb-2">–ú–∞—Ä–∫–∏—Ä–∞–π –≤–µ—Ä–µ–Ω(–∏)</div>
          <div id="mqCorrect" class="space-y-2"></div>
        </div>
      </div>`;
    const opts=["–û—Ç–≥–æ–≤–æ—Ä –ê","–û—Ç–≥–æ–≤–æ—Ä –ë","–û—Ç–≥–æ–≤–æ—Ä –í","–û—Ç–≥–æ–≤–æ—Ä –ì"];
    $("mqOpts").innerHTML=opts.map((v,i)=>`<input class="w-full p-3 rounded-xl border-2 border-slate-200 bg-white font-bold" data-i="${i}" value="${v}">`).join("");
    const rebuild=()=>{
      const os=[...document.querySelectorAll("#mqOpts input")].map(x=>x.value.trim()).filter(Boolean);
      const t=isMulti?"checkbox":"radio"; const name=isMulti?"":"name='mqSingle'";
      $("mqCorrect").innerHTML=os.map((o,i)=>`<label class="flex items-center gap-2 font-bold"><input type="${t}" ${name} data-i="${i}"> ${o}</label>`).join("");
    };
    document.querySelectorAll("#mqOpts input").forEach(i=>i.addEventListener("input",rebuild)); rebuild();
  };

  window.saveModalQ=()=>{
    const text=($("mqText").value||"").trim(); if(!text) return toast("–í—ä–≤–µ–¥–µ—Ç–µ —Ç–µ–∫—Å—Ç.","error");
    const type=$("mqType").value; const points=Number($("mqPoints").value||1)||1;
    const t=Math.max(0,Number($("mqTime").value||0));
    const q={t:Math.round(t*10)/10,text,type,points};
    if(type==="numeric"){
      q.min=Number($("mqMin").value||0); q.max=Number($("mqMax").value||100); q.step=Number($("mqStep").value||1);
      q.tol=Number($("mqTol").value||0); q.correctNum=Number($("mqCorrectNum").value||0);
      q.options=[]; q.correct=[];
    }else if(type==="boolean"){
      const val=document.querySelector("input[name='mqBool']:checked")?.value==="true";
      q.options=["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"]; q.correct=[val?0:1];
    }else{
      const os=[...document.querySelectorAll("#mqOpts input")].map(x=>x.value.trim()).filter(Boolean);
      if(os.length<2) return toast("–ü–æ–Ω–µ 2 –æ—Ç–≥–æ–≤–æ—Ä–∞.","error");
      q.options=os;
      if(type==="single"){
        const s=document.querySelector("#mqCorrect input[type='radio']:checked"); if(!s) return toast("–ú–∞—Ä–∫–∏—Ä–∞–π –≤–µ—Ä–µ–Ω.","error");
        q.correct=[Number(s.dataset.i)];
      }else{
        const s=[...document.querySelectorAll("#mqCorrect input[type='checkbox']:checked")].map(x=>Number(x.dataset.i));
        if(!s.length) return toast("–ú–∞—Ä–∫–∏—Ä–∞–π –ø–æ–Ω–µ –µ–¥–∏–Ω –≤–µ—Ä–µ–Ω.","error");
        q.correct=s.sort((a,b)=>a-b);
      }
    }
    edQs.push(norm(q)); renderEdQs(); closeQModal(); toast("–î–æ–±–∞–≤–µ–Ω –≤—ä–ø—Ä–æ—Å.","success");
  };

  window.playQ=(t)=>{ try{edPlayer.seekTo(t,true);edPlayer.playVideo()}catch(e){} };
  window.delQ=(i)=>{ if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) return; edQs.splice(i,1); renderEdQs(); };

  window.saveLesson=async ()=>{
    if(!edVideo) return toast("–ù—è–º–∞ –≤–∏–¥–µ–æ.","error");
    if(!edQs.length) return toast("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ 1 –≤—ä–ø—Ä–æ—Å.","error");
    const title=prompt("–ò–º–µ –Ω–∞ —É—Ä–æ–∫–∞:",edTitle); if(title===null) return;
    edTitle=(title||"").trim()||"–ë–µ–∑ –∏–º–µ";
    const payload={title:edTitle,v:edVideo,questions:edQs.map(norm),updatedAt:serverTimestamp()};
    if(edId){
      await updateDoc(doc(db,"artifacts",FINAL_APP_ID,"users",user.uid,"my_quizzes",edId),payload);
    }else{
      payload.createdAt=serverTimestamp();
      const ref=await addDoc(userRoot(user.uid),payload); edId=ref.id;
    }
    toast("–ó–∞–ø–∞–∑–µ–Ω–æ!","success"); show("teacher");
  };

  // === SOLO PLAY ===
  let soloPlayer=null, soloQuiz=null, soloIdx=-1, soloScore=0, soloMax=0, soloSel=null, sop=false, disc=false, soloName="–ê–Ω–æ–Ω–∏–º–µ–Ω", soloDone=false;
  const maxPts=(qs)=>qs.reduce((a,q)=>a+(Number(q.points||1)||1),0);
  const correct=(q,ans)=>{
    if(q.type==="numeric") return Math.abs(Number(ans)-Number(q.correctNum||0))<=Number(q.tol||0);
    if(q.type==="multiple"){const a=[...(ans||[])].sort((x,y)=>x-y),c=[...(q.correct||[])].sort((x,y)=>x-y);return JSON.stringify(a)===JSON.stringify(c);}
    return (q.correct||[])[0]===Number(ans);
  };

  window.startSolo=async ()=>{
    const d=dec($("ind-code").value||""); if(!d||!d.v) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥.","error");
    sop=$("ind-sop").checked; disc=$("ind-disc").checked; soloName=($("ind-name").value||"").trim()||"–ê–Ω–æ–Ω–∏–º–µ–Ω";
    soloQuiz={title:d.title||"–£—Ä–æ–∫",v:d.v,q:(d.q||[]).map(norm).sort((a,b)=>a.t-b.t),ownerId:d.ownerId||null};
    soloIdx=-1; soloScore=0; soloSel=null; soloDone=false; soloMax=maxPts(soloQuiz.q);
    if(!auth.currentUser) await signInAnonymously(auth);
    show("solo");
    $("soloPlayer").innerHTML='<div id="soloYT" class="w-full h-full"></div>';
    soloPlayer=new YT.Player("soloYT",{videoId:soloQuiz.v,width:"100%",height:"100%",playerVars:{autoplay:1,controls:1,rel:0},
      events:{onStateChange:(e)=>{ if(e.data===1) pollSolo(); if(e.data===0) finishSolo(); }}});
  };

  let soloPoll=null;
  function pollSolo(){
    clearInterval(soloPoll);
    soloPoll=setInterval(()=>{
      try{
        const t=Math.floor(soloPlayer.getCurrentTime());
        const next=soloQuiz.q.findIndex((qq,i)=>i>soloIdx && t>=Math.floor(qq.t));
        if(next!==-1){ soloIdx=next; openSoloQ(soloQuiz.q[next]); }
        const dur=soloPlayer.getDuration?.()||0; if(dur>0 && t>=dur-1) finishSolo();
      }catch(e){}
    },300);
  }

  function openSoloQ(q){
    try{soloPlayer.pauseVideo()}catch(e){}
    $("soloOverlay").classList.remove("hidden"); $("soloOverlay").classList.add("flex");
    $("soloQ").textContent=q.text;
    $("soloSpeak").classList.toggle("hidden",!sop);
    if(sop) speakSolo();
    soloSel=null; $("soloConfirm").classList.add("hidden");
    const o=$("soloOpts"); o.innerHTML="";
    if(q.type==="numeric"){
      const start=(q.min+q.max)/2;
      o.innerHTML=`<div class="card p-6 bg-white/10 border border-white/20">
        <input id="soloRange" type="range" min="${q.min}" max="${q.max}" step="${q.step||1}" value="${start}" class="w-full"
          oninput="document.getElementById('soloRangeVal').textContent=this.value">
        <div id="soloRangeVal" class="text-white text-5xl font-black mt-6">${start}</div></div>`;
      $("soloConfirm").classList.remove("hidden"); return;
    }
    if(q.type==="multiple"){
      o.innerHTML=q.options.map((x,i)=>`<label class="flex items-center gap-3 p-4 rounded-2xl bg-white/10 border border-white/15 text-white font-black">
        <input type="checkbox" data-i="${i}" class="accent-indigo-600 w-5 h-5"> ${x}</label>`).join("");
      o.querySelectorAll("input").forEach(cb=>cb.addEventListener("change",()=>{
        soloSel=[...o.querySelectorAll("input:checked")].map(x=>Number(x.dataset.i));
        $("soloConfirm").classList.toggle("hidden", !soloSel.length);
      }));
      return;
    }
    const list=(q.type==="boolean")?["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"]:q.options;
    o.innerHTML=list.map((x,i)=>`<button class="btn bg-white/10 border border-white/15 text-white text-left" onclick="pickSolo(${i})">${x}</button>`).join("");
  }

  window.pickSolo=(i)=>{ soloSel=i; $("soloConfirm").classList.remove("hidden"); };
  window.speakSolo=()=>{
    try{ if(!("speechSynthesis" in window)) return;
      speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance($("soloQ").textContent||""); u.lang="bg-BG"; u.rate=.9;
      speechSynthesis.speak(u);
    }catch(e){}
  };

  window.confirmSolo=async ()=>{
    const q=soloQuiz.q[soloIdx]; let ans=soloSel;
    if(q.type==="numeric") ans=Number(document.getElementById("soloRange").value);
    if(correct(q,ans)){ soloScore += (Number(q.points||1)||1); toast("–í—è—Ä–Ω–æ!","success"); } else toast("–ì—Ä–µ—à–Ω–æ‚Ä¶","error");
    $("soloOverlay").classList.add("hidden"); $("soloOverlay").classList.remove("flex");
    try{speechSynthesis.cancel()}catch(e){}
    setTimeout(()=>{try{soloPlayer.playVideo()}catch(e){}},600);
  };

  async function finishSolo(){
    if(soloDone) return; soloDone=true;
    show("finish"); $("finishScore").textContent=`${soloScore}/${soloMax}`;
    if(disc) return;
    if(auth.currentUser && soloQuiz?.ownerId){
      try{
        await addDoc(soloResultsCol(soloQuiz.ownerId),{
          studentName:soloName,
          quizTitle:soloQuiz.title+(sop?" (–°–û–ü)":""),
          score:`${soloScore}/${soloMax}`,
          timestamp:serverTimestamp(),
          userId:auth.currentUser.uid
        });
      }catch(e){}
    }
  }

  // === LIVE HOST ===
  let hostPlayer=null, hostPin="", hostLesson=null, hostIdx=-1, participants=[];
  const AVATARS=['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêô','ü¶Ñ','üêù','ü¶â','ü¶ã'];

  const randPin=()=>String(Math.floor(1000+Math.random()*9000));

  window.startHost=async (lessonId)=>{
    const q=myQuizzes.find(x=>x.id===lessonId); if(!q) return;
    hostLesson={title:q.title||"–£—Ä–æ–∫",v:q.v,q:(q.questions||[]).map(norm).sort((a,b)=>a.t-b.t)};
    hostPin=randPin(); hostIdx=-1; participants=[];
    show("host");
    $("hostPin").textContent=hostPin; $("hostCount").textContent="0"; $("hostBoard").innerHTML="";
    $("hostStart").classList.remove("hidden"); $("hostQ").classList.add("hidden"); $("hostQ").classList.remove("flex");
    $("hostExportX").classList.add("hidden"); $("hostExportP").classList.add("hidden");

    await setDoc(sessionRef(hostPin),{pin:hostPin,status:"waiting",activeQ:-1,quizTitle:hostLesson.title,hostId:user.uid,timestamp:serverTimestamp()},{merge:true});
    onSnapshot(participantsCol(hostPin),(snap)=>{participants=snap.docs.map(d=>({id:d.id,...d.data()})); renderBoard();});
  };

  function renderBoard(){
    $("hostCount").textContent=String(participants.length);
    const s=[...participants].sort((a,b)=>(b.score||0)-(a.score||0));
    $("hostBoard").innerHTML=s.map((p,i)=>`
      <tr class="bg-white rounded-2xl shadow-sm">
        <td class="p-3 text-xs font-black text-slate-400 w-10">#${i+1}</td>
        <td class="p-3 font-bold flex items-center gap-2"><span class="text-xl">${p.avatar||"üòé"}</span>${p.name||""}</td>
        <td class="p-3 text-right font-black text-indigo-700">${p.score||0}</td>
      </tr>`).join("");
  }

  window.startHostVideo=()=>{
    $("hostStart").classList.add("hidden");
    $("hostPlayer").innerHTML='<div id="hostYT" class="w-full h-full"></div>';
    hostPlayer=new YT.Player("hostYT",{videoId:hostLesson.v,width:"100%",height:"100%",playerVars:{autoplay:1,controls:1,rel:0},
      events:{onStateChange:(e)=>{ if(e.data===1) pollHost(); }}});
  };

  let hostPoll=null;
  function pollHost(){
    clearInterval(hostPoll);
    hostPoll=setInterval(async ()=>{
      try{
        const t=Math.floor(hostPlayer.getCurrentTime());
        const qIdx=hostLesson.q.findIndex((qq)=>Math.abs(Math.floor(qq.t)-t)<=1);
        if(qIdx!==-1 && qIdx!==hostIdx){
          hostIdx=qIdx;
          hostPlayer.pauseVideo();
          $("hostQ").classList.remove("hidden"); $("hostQ").classList.add("flex");
          await updateDoc(sessionRef(hostPin),{status:"active",activeQ:qIdx,qData:hostLesson.q[qIdx]});
        }
      }catch(e){}
    },750);
  }

  window.resumeHost=()=>{
    $("hostQ").classList.add("hidden"); $("hostQ").classList.remove("flex");
    try{hostPlayer.playVideo()}catch(e){}
    updateDoc(sessionRef(hostPin),{status:"playing"});
  };

  window.endHost=async ()=>{
    if(!confirm("–ö—Ä–∞–π –Ω–∞ —Å–µ—Å–∏—è—Ç–∞?")) return;
    await updateDoc(sessionRef(hostPin),{status:"finished"});
    $("hostExportX").classList.remove("hidden"); $("hostExportP").classList.remove("hidden");
  };

  window.exportHostExcel=()=>{
    const rows=participants.map(p=>({Name:p.name||"",Score:p.score||0}));
    const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Class");XLSX.writeFile(wb,`VideoQuiz_Class_${hostPin}.xlsx`);
  };
  window.exportHostPDF=()=>{
    const { jsPDF } = window.jspdf; const pdf=new jsPDF();
    pdf.text(`VideoQuiz - –†–µ–∑—É–ª—Ç–∞—Ç–∏ (–ü–ò–ù: ${hostPin})`,10,12);
    pdf.autoTable({head:[["–ò–º–µ","–¢–æ—á–∫–∏"]],body:participants.map(p=>[p.name||"",String(p.score||0)])});
    pdf.save(`VideoQuiz_Class_${hostPin}.pdf`);
  };

  // === LIVE CLIENT ===
  let cScore=0, cIdx=-1, cSel=null, cQ=null, cName="", cAvatar="üòé", lastAnswered=-1, lastPin="";
  const ok=(q,ans)=>correct(q,ans);

  window.joinLive=async ()=>{
    const pin=String(($("live-pin").value||"").trim());
    const name=String(($("live-name").value||"").trim());
    if(!pin||!name) return toast("–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –∏ –ü–ò–ù.","error");
    if(!auth.currentUser) await signInAnonymously(auth);
    const snap=await getDoc(sessionRef(pin));
    if(!snap.exists()) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ü–ò–ù.","error");

    lastPin=pin;
    cScore=0; cIdx=-1; cSel=null; cQ=null; lastAnswered=-1;
    cName=name; cAvatar=AVATARS[Math.floor(Math.random()*AVATARS.length)];
    $("cName").textContent=cName; $("cAvatar").textContent=cAvatar;
    show("client");

    await setDoc(participantRef(pin,auth.currentUser.uid),{name:cName,avatar:cAvatar,score:0,joinedAt:serverTimestamp()},{merge:true});

    onSnapshot(sessionRef(pin),(s)=>{
      const d=s.data(); if(!d) return;
      if(d.status==="finished"){
        $("clientWait").classList.add("hidden"); $("clientQWrap").classList.add("hidden");
        $("clientDone").classList.remove("hidden"); $("cFinal").textContent=String(cScore); return;
      }
      if(d.status==="active" && d.activeQ!==cIdx){
        cIdx=d.activeQ; cQ=norm(d.qData||{});
        openClientQ(cQ);
      }else if(d.status!=="active"){
        $("clientQWrap").classList.add("hidden"); $("clientWait").classList.remove("hidden");
      }
    });
  };

  function openClientQ(q){
    $("clientWait").classList.add("hidden"); $("clientQWrap").classList.remove("hidden");
    $("cQ").textContent=q.text; $("cConfirm").classList.add("hidden"); cSel=null;
    const o=$("cOpts"); o.innerHTML="";
    if(q.type==="numeric"){
      const start=(q.min+q.max)/2;
      o.innerHTML=`<div class="card p-6"><input id="cRange" type="range" min="${q.min}" max="${q.max}" step="${q.step||1}" value="${start}" class="w-full"
        oninput="document.getElementById('cRangeVal').textContent=this.value"><div id="cRangeVal" class="text-6xl font-black text-indigo-700 mt-6 text-center">${start}</div></div>`;
      $("cConfirm").classList.remove("hidden"); return;
    }
    if(q.type==="multiple"){
      o.innerHTML=q.options.map((x,i)=>`<label class="flex items-center gap-3 p-4 rounded-2xl bg-white border-2 border-slate-100 font-black">
        <input type="checkbox" data-i="${i}" class="accent-indigo-600 w-5 h-5"> ${x}</label>`).join("");
      o.querySelectorAll("input").forEach(cb=>cb.addEventListener("change",()=>{
        cSel=[...o.querySelectorAll("input:checked")].map(x=>Number(x.dataset.i));
        $("cConfirm").classList.toggle("hidden", !cSel.length);
      }));
      return;
    }
    const list=(q.type==="boolean")?["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"]:q.options;
    o.innerHTML=list.map((x,i)=>`<button class="btn bg-white border border-slate-200 w-full text-left" onclick="pickClient(${i},this)">${x}</button>`).join("");
  }

  window.pickClient=(i,el)=>{
    cSel=i; $("cConfirm").classList.remove("hidden");
    document.querySelectorAll("#cOpts button").forEach(b=>b.classList.remove("border-indigo-600","bg-indigo-50"));
    el.classList.add("border-indigo-600","bg-indigo-50");
  };

  window.confirmClient=async ()=>{
    if(!cQ) return;
    if(lastAnswered===cIdx) return; lastAnswered=cIdx;
    let ans=cSel; if(cQ.type==="numeric") ans=Number(document.getElementById("cRange").value);
    if(ok(cQ,ans)) cScore += (Number(cQ.points||1)||1);
    $("clientQWrap").classList.add("hidden"); $("clientWait").classList.remove("hidden");
    try{await updateDoc(participantRef(lastPin,auth.currentUser.uid),{score:cScore})}catch(e){}
  };

  // === AUTH STATE ===
  onAuthStateChanged(auth, async (u)=>{
    user=u||null;
    if(!user){ show("welcome"); icons(); return; }
    try{
      const prof=await getDoc(userProfile(user.uid));
      if(prof.exists() && prof.data()?.role==="teacher"){
        $("teacherEmail").textContent = prof.data()?.email || user.email || "";
        unsubQ?.(); unsubS?.();
        unsubQ=onSnapshot(userRoot(user.uid),(snap)=>{ myQuizzes=snap.docs.map(d=>({id:d.id,...d.data()})); renderTeacher(); });
        unsubS=onSnapshot(soloResultsCol(user.uid),(snap)=>{ mySolo=snap.docs.map(d=>({id:d.id,...d.data()})); renderTeacher(); });
        show("teacher"); icons(); return;
      }
    }catch(e){}
    show("welcome"); icons();
  });

  window.addEventListener("load", icons);
</script>
</body>
</htm
