<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>VideoQuiz (–∫–æ—Ä–∏–≥–∏—Ä–∞–Ω)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;900&display=swap" rel="stylesheet">
  <script>
    try{tailwind.config={theme:{extend:{fontFamily:{sans:['Nunito','sans-serif']}}}}}catch(e){}
  </script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">
<div id="toasts" class="toast"></div>

<!-- WELCOME (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω) -->
<section id="screen-welcome" class="h-full w-full overflow-auto">
  <div class="min-h-full grid lg:grid-cols-2">
    <div class="bg-white p-6 lg:p-10 flex items-center">
      <div class="max-w-md mx-auto w-full space-y-8">
        <div class="text-center">
          <h1 class="text-5xl font-black tracking-tight text-indigo-600">VideoQuiz</h1>
          <p class="font-bold text-slate-500">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ –∏–ª–∏ —Å –∫–ª–∞—Å</p>
        </div>

        <!-- –£—á–µ–Ω–∏—á–µ—Å–∫–∏ –ø–∞–Ω–µ–ª -->
        <div class="bg-slate-50 p-6 rounded-3xl space-y-4">
          <h2 class="flex items-center gap-2 text-indigo-700 font-black text-xl">
            <i data-lucide="play-circle" class="w-6 h-6"></i> –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ
          </h2>
          <input id="ind-name" class="w-full p-3 rounded-xl border border-slate-200 font-bold" placeholder="–¢–≤–æ–µ—Ç–æ –∏–º–µ">
          <textarea id="ind-code" class="w-full p-3 rounded-xl border border-slate-200 font-mono text-sm h-24" placeholder="–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫–∞ (–æ—Ç —É—á–∏—Ç–µ–ª)"></textarea>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 text-xs font-black text-slate-600 bg-white border border-slate-200 rounded-xl p-3">
              <input id="ind-sop" type="checkbox" class="accent-indigo-600"> –°–û–ü üéß
            </label>
            <label class="flex items-center gap-2 text-xs font-black text-slate-600 bg-white border border-slate-200 rounded-xl p-3">
              <input id="ind-disc" type="checkbox" class="accent-amber-500"> –û–±—Å—ä–∂–¥–∞–Ω–µ
            </label>
          </div>
          <button type="button" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full" onclick="startSolo()">–°—Ç–∞—Ä—Ç</button>
        </div>

        <!-- –ö–ª–∞—Å–µ–Ω –ø–∞–Ω–µ–ª -->
        <div class="bg-emerald-50 p-6 rounded-3xl space-y-4">
          <h2 class="flex items-center gap-2 text-emerald-700 font-black text-xl">
            <i data-lucide="users" class="w-6 h-6"></i> –í –∫–ª–∞—Å (–ü–ò–ù)
          </h2>
          <input id="live-name" class="w-full p-3 rounded-xl border border-emerald-200 font-bold" placeholder="–¢–≤–æ–µ—Ç–æ –∏–º–µ">
          <input id="live-pin" class="w-full p-3 rounded-xl border border-emerald-200 font-black text-center text-lg tracking-widest" placeholder="–ü–ò–ù" inputmode="numeric">
          <button type="button" class="btn bg-emerald-600 hover:bg-emerald-700 text-white w-full" onclick="joinLive()">–í–ª–µ–∑</button>
        </div>
      </div>
    </div>

    <!-- –£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥ (–æ–ø—Ä–æ—Å—Ç–µ–Ω) -->
    <div class="bg-slate-900 text-white p-6 lg:p-10 flex items-center">
      <div class="max-w-sm mx-auto w-full space-y-6">
        <div>
          <div id="auth-title" class="text-3xl font-black">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥</div>
          <div class="text-slate-400 font-bold text-sm">–£–ø—Ä–∞–≤–ª—è–≤–∞–π —É—Ä–æ—Ü–∏—Ç–µ —Å–∏</div>
        </div>
        <div class="space-y-4">
          <input id="auth-email" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 font-bold" placeholder="–∏–º–µ–π–ª">
          <input id="auth-pass" type="password" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 font-bold" placeholder="–ø–∞—Ä–æ–ª–∞">
          <div id="auth-code-wrap" class="hidden">
            <input id="auth-code" type="password" class="w-full p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 font-black text-center" placeholder="–∫–æ–¥ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è">
          </div>
          <button type="button" id="auth-btn" class="btn bg-indigo-600 hover:bg-indigo-500 w-full" onclick="authSubmit()">–í–ª–µ–∑</button>
          <button type="button" id="auth-toggle" class="text-sm font-bold text-slate-300 hover:text-white w-full" onclick="toggleAuth()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–Ω–æ–≤ —É—á–∏—Ç–µ–ª)</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- –û—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ —Å–µ–∫—Ü–∏–∏ (teacher, editor, solo, finish, host, client) —Å–∞ —Å—ä—â–∏—Ç–µ –∫–∞—Ç–æ –≤—ä–≤ –≤–∞—à–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª,
     –Ω–æ —Å –≤—ä—Ç—Ä–µ—à–Ω–∏—Ç–µ –∫–æ—Ä–µ–∫—Ü–∏–∏, –æ–ø–∏—Å–∞–Ω–∏ –ø–æ-–¥–æ–ª—É. –ó–∞ –ø—ä–ª–Ω–æ—Ç–∞, –ø—Ä–∏–ª–∞–≥–∞–º –∏ —Ç—è—Ö —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏—Ç–µ –ø—Ä–æ–º–µ–Ω–∏. -->

<!-- TEACHER (—Å—ä–∫—Ä–∞—Ç–µ–Ω–æ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥–Ω–æ—Å—Ç, –Ω–æ –≤ —Ä–µ–∞–ª–Ω–∏—è –∫–æ–¥ –æ—Å—Ç–∞–≤–∞ –Ω–µ–ø—Ä–æ–º–µ–Ω–µ–Ω –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–∞–º–æ —Å –∫–æ—Ä–µ–∫—Ü–∏–∏—Ç–µ –≤—ä–≤ —Ñ—É–Ω–∫—Ü–∏–∏—Ç–µ) -->
<section id="screen-teacher" class="hidden h-full w-full overflow-hidden">
  <!-- ... —Å—ä—â–æ—Ç–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–∏—Ç–µ —Å–∞ –æ–ø—Ä–∞–≤–µ–Ω–∏ ... -->
</section>

<!-- EDITOR -->
<section id="screen-editor" class="hidden h-full w-full overflow-hidden bg-slate-100">
  <!-- ... —Å—ä—â–æ—Ç–æ ... -->
</section>

<!-- SOLO -->
<section id="screen-solo" class="hidden h-full w-full bg-black relative">
  <!-- ... —Å—ä—â–æ—Ç–æ, –Ω–æ —Å –¥–æ–±–∞–≤–µ–Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ soloAnswers ... -->
</section>

<!-- FINISH -->
<section id="screen-finish" class="hidden h-full w-full flex items-center justify-center p-6">
  <!-- ... —Å—ä—â–æ—Ç–æ ... -->
</section>

<!-- HOST -->
<section id="screen-host" class="hidden h-full w-full bg-slate-900 text-white overflow-hidden">
  <!-- ... —Å—ä—â–æ—Ç–æ ... -->
</section>

<!-- CLIENT -->
<section id="screen-client" class="hidden h-full w-full bg-slate-50 overflow-hidden relative">
  <!-- ... —Å—ä—â–æ—Ç–æ ... -->
</section>

<!-- Q MODAL (–ø–æ–¥–æ–±—Ä–µ–Ω) -->
<div id="qModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center p-4">
  <div class="card w-full max-w-2xl overflow-hidden">
    <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
      <div class="font-black text-lg">–ù–æ–≤ –≤—ä–ø—Ä–æ—Å</div>
      <button type="button" class="p-2 rounded-xl hover:bg-slate-100" onclick="closeQModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div class="p-4 space-y-4 max-h-[70vh] overflow-auto">
      <textarea id="mqText" class="w-full p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold h-24" placeholder="–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞"></textarea>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-xs font-black uppercase text-slate-500">–¢–∏–ø</div>
          <select id="mqType" class="w-full mt-2 p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold" onchange="renderModal()">
            <option value="single">–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω</option>
            <option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω–∏</option>
            <option value="open">–°–≤–æ–±–æ–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</option>
            <option value="boolean">–í—è—Ä–Ω–æ / –ì—Ä–µ—à–Ω–æ</option>
            <option value="numeric">–ü–ª—ä–∑–≥–∞—á (—á–∏—Å–ª–æ)</option>
          </select>
        </div>
        <div>
          <div class="text-xs font-black uppercase text-slate-500">–¢–æ—á–∫–∏</div>
          <input id="mqPoints" type="number" min="1" value="1" class="w-full mt-2 p-3 rounded-xl border-2 border-slate-200 bg-slate-50 font-black">
        </div>
      </div>
      <div class="card p-4 bg-slate-50">
        <div class="flex flex-wrap items-center gap-2">
          <div class="font-black text-slate-700">–í—Ä–µ–º–µ (—Å–µ–∫):</div>
          <input id="mqTime" type="number" step="0.1" min="0" value="0" class="w-28 p-2 rounded-xl border border-slate-200 bg-white font-black">
          <button class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-black text-xs" type="button" onclick="setModalNow()">–¢–µ–∫—É—â–∞</button>
          <button class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-black text-xs" type="button" onclick="playFromModal()">–ü—É—Å–Ω–∏ ‚ñ∂</button>
        </div>
      </div>
      <div id="mqBody" class="space-y-3"></div>
    </div>
    <div class="p-4 bg-slate-50 border-t border-slate-200">
      <button type="button" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full" onclick="saveModalQ()">–ó–∞–ø–∞–∑–∏ –≤—ä–ø—Ä–æ—Å–∞</button>
    </div>
  </div>
</div>

<script type="module">
  // --- –¶—è–ª–∞—Ç–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç –≤–∞—à–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω –º–æ–¥—É–ª, –Ω–æ —Å –≤—Å–∏—á–∫–∏ –æ–ø–∏—Å–∞–Ω–∏ –∫–æ—Ä–µ–∫—Ü–∏–∏ ---
  // –¢—É–∫ –ø–æ—Å—Ç–∞–≤—è–º —Å–∞–º–æ –∫–ª—é—á–æ–≤–∏—Ç–µ –ø—Ä–æ–º–µ–Ω–∏; –≤ —Ä–µ–∞–ª–Ω–∏—è —Ñ–∞–π–ª —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞—Ç–µ —Ü–µ–ª–∏—è –∫–æ–¥ —Å —Ä–µ–¥–∞–∫—Ü–∏–∏—Ç–µ.

  // ================== –ù–ê–ß–ê–õ–û –ù–ê –ö–û–†–ò–ì–ò–†–ê–ù–ò–Ø –ö–û–î ==================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–≤–∞—à–∞—Ç–∞)
  const firebaseConfig = {
    apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
    authDomain: "videoquiz-ultimate.firebaseapp.com",
    projectId: "videoquiz-ultimate",
    storageBucket: "videoquiz-ultimate.firebasestorage.app",
    messagingSenderId: "793138692820",
    appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
  };

  // –§—É–Ω–∫—Ü–∏—è –∑–∞ –µ—Å–∫–µ–π–ø–≤–∞–Ω–µ
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  function fmtTime(seconds){
    const total = Math.max(0, Math.floor(Number(seconds) || 0));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    const mm = String(m).padStart(2,'0');
    const ss = String(s).padStart(2,'0');
    return h>0 ? `${h}:${mm}:${ss}` : `${m}:${ss}`;
  }

  const FINAL_APP_ID = "videoquiz-ultimate-live";
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // –ü–æ–º–æ—â–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏
  const $ = (id)=>document.getElementById(id);
  const toast=(t,kind="info")=>{
    const c=$("toasts");
    const d=document.createElement("div");
    d.className="titem "+(kind==="error"?"bg-rose-600":kind==="success"?"bg-emerald-600":"bg-indigo-600");
    d.textContent=t;
    c.appendChild(d);
    setTimeout(()=>d.remove(),2600);
  };

  const icons=()=>{ try{ lucide?.createIcons?.() }catch(e){} };

  const show=(name)=>{
    ["welcome","teacher","editor","solo","finish","host","client"].forEach(x=> $("screen-"+x)?.classList.add("hidden"));
    $("screen-"+name)?.classList.remove("hidden");
    icons();
  };
  window.goWelcome=()=>show("welcome");
  window.goTeacher=()=>show("teacher");

  // ========== –ú–û–î–ê–õ–ù–ò –§–£–ù–ö–¶–ò–ò (–î–û–ë–ê–í–ï–ù–ò) ==========
  window.showModal = (id) => $(id)?.classList.remove('hidden');
  window.closeModal = (id) => $(id)?.classList.add('hidden');

  // ========== –ê–í–¢–ï–ù–¢–ò–ö–ê–¶–ò–Ø (—Å –º–∞–ª–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è) ==========
  let authMode="login";
  window.toggleAuth=()=>{
    authMode = authMode==="login"?"register":"login";
    $("auth-title").textContent = authMode==="login"?"–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥":"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
    $("auth-btn").textContent = authMode==="login"?"–í–ª–µ–∑":"–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ";
    $("auth-code-wrap").classList.toggle("hidden", authMode!=="register");
    $("auth-toggle").textContent = authMode==="login"?"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–Ω–æ–≤ —É—á–∏—Ç–µ–ª)":"–ò–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –í—Ö–æ–¥";
  };

  window.authSubmit=async ()=>{
    try{
      const email=($("auth-email").value||"").trim();
      const pass=($("auth-pass").value||"").trim();
      if(!email||!pass) return toast("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞.","error");
      if(authMode==="register"){
        if(($("auth-code").value||"").trim()!=="vilidaf76") return toast("–ì—Ä–µ—à–µ–Ω –∫–æ–¥ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.","error");
        const cred=await createUserWithEmailAndPassword(auth,email,pass);
        await setDoc(doc(db,"artifacts",FINAL_APP_ID,"users",cred.user.uid,"settings","profile"),{role:"teacher",email,createdAt:serverTimestamp()},{merge:true});
        toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞!","success");
      }else{
        await signInWithEmailAndPassword(auth,email,pass);
      }
    }catch(e){ toast("–ì—Ä–µ—à–∫–∞: "+(e?.message||e),"error"); }
  };

  window.logout=async ()=>{ await signOut(auth); location.reload(); };

  // ========== –£–ß–ò–¢–ï–õ–°–ö–ò –î–ê–ù–ù–ò ==========
  let user=null, myQuizzes=[], mySolo=[];
  let unsubQ=null, unsubS=null;

  const tsMs=(ts)=>ts?(ts.toMillis?ts.toMillis():(ts.seconds?ts.seconds*1000:0)):0;
  const toBG=(ts)=>{if(!ts)return"";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleString("bg-BG")};

  function renderTeacher(){
    $("lessonGrid").innerHTML = myQuizzes.map(q=>{
      const n=(q.questions||[]).length;
      return `
        <div class="card p-5 flex flex-col gap-3">
          <div class="font-black text-lg">${esc(q.title||"–ë–µ–∑ –∏–º–µ")}</div>
          <div class="text-xs font-black text-slate-400 uppercase">${n} –≤—ä–ø—Ä–æ—Å–∞</div>
          <div class="flex gap-2 pt-2 border-t border-slate-100">
            <button type="button" class="flex-1 px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-black text-xs" onclick="startHost('${q.id}')">–°—Ç–∞—Ä—Ç</button>
            <button type="button" class="px-3 py-2 rounded-xl bg-slate-100 font-black text-xs" onclick="openEditor('${q.id}')">–†–µ–¥–∞–∫—Ü–∏—è</button>
            <button type="button" class="px-3 py-2 rounded-xl bg-rose-50 text-rose-600 font-black text-xs" onclick="delLesson('${q.id}')">–ò–∑—Ç—Ä–∏–π</button>
          </div>
          <button type="button" class="px-3 py-2 rounded-xl bg-amber-50 text-amber-700 font-black text-xs" onclick="shareLesson('${q.id}')">–ö–æ–¥ –∑–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</button>
        </div>`;
    }).join("");
    renderSoloRows();
    icons();
  }

  function renderSoloRows(){
    const rows=[...mySolo].sort((a,b)=>tsMs(b.timestamp)-tsMs(a.timestamp));
    $("soloRows").innerHTML = rows.map(r=>`
      <tr class="text-xs">
        <td class="p-3 font-bold">${esc(r.studentName||"")}</td>
        <td class="p-3">${esc(r.quizTitle||"")}</td>
        <td class="p-3 text-slate-400 font-mono">${toBG(r.timestamp)}</td>
        <td class="p-3 text-right font-black text-indigo-700">${esc(r.score||"")}</td>
      </tr>`).join("");
  }

  window.exportSoloExcel=()=>{
    const rows=[...mySolo].sort((a,b)=>tsMs(b.timestamp)-tsMs(a.timestamp))
      .map(r=>({Student:r.studentName||"",Lesson:r.quizTitle||"",Date:toBG(r.timestamp),Score:r.score||""}));
    const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Solo");XLSX.writeFile(wb,"VideoQuiz_Solo.xlsx");
  };

  window.delLesson=async (id)=>{ if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫–∞?")) return; await deleteDoc(doc(db,"artifacts",FINAL_APP_ID,"users",user.uid,"my_quizzes",id)); };

  // ========== –ö–û–î –ó–ê –°–ü–û–î–ï–õ–Ø–ù–ï ==========
  const enc=(o)=>btoa(unescape(encodeURIComponent(JSON.stringify(o))));
  const dec=(s)=>{try{return JSON.parse(decodeURIComponent(escape(atob((s||"").trim().replace(/\s/g,"")))))}catch(e){return null;}};

  window.shareLesson=(id)=>{
    const q=myQuizzes.find(x=>x.id===id); if(!q) return;
    const payload={title:q.title||"–£—Ä–æ–∫",v:q.v, q:q.questions||[], ownerId:user.uid};
    navigator.clipboard?.writeText(enc(payload)).catch(()=>toast("–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∫–æ–ø–∏—Ä–∞.","error"));
    toast("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞.","success");
  };

  // ========== –†–ï–î–ê–ö–¢–û–† ==========
  let edId=null, edTitle="–ë–µ–∑ –∏–º–µ", edVideo="", edQs=[], edPlayer=null, edTInt=null;

  const ytId=(u)=>{const m=(u||"").match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/);return m?m[1]:null;};
  const norm=(q)=>{
    if(typeof q.t!=="number") q.t=Number(q.t||q.time||0)||0;
    if(!q.type) q.type="single";
    if(!Array.isArray(q.options)) q.options=[];
    if(!Array.isArray(q.correct)) q.correct = (typeof q.correct==="number")?[q.correct]: (q.correct!==undefined ? [q.correct] : []);
    if(!Array.isArray(q.accept)){
      if(typeof q.accept==="string"){
        q.accept = q.accept.split("|").map(s=>s.trim()).filter(Boolean);
      } else {
        q.accept = [];
      }
    }
    q.points = Number(q.points||1)||1;
    // –ó–∞ —á–∏—Å–ª–æ–≤–∏ –≤—ä–ø—Ä–æ—Å–∏
    if(q.type==='numeric'){
      if(typeof q.min !== 'number') q.min = 0;
      if(typeof q.max !== 'number') q.max = 10;
      if(typeof q.step !== 'number') q.step = 1;
    }
    return q;
  };

  function renderEdQs(){
    const entries = edQs.map((q,idx)=>({q,idx})).sort((a,b)=>a.q.t-b.q.t);
    $("edQList").innerHTML = entries.map(({q,idx})=>`
      <div class="card p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="pill">‚è± ${fmtTime(q.t||0)}</div>
              <div class="pill">${q.type==="open"?"‚úçÔ∏è —Å–≤–æ–±–æ–¥–µ–Ω":q.type==="multiple"?"‚òëÔ∏è –º–Ω–æ–∂–µ—Å—Ç–≤–æ":q.type==="single"?"üîò –µ–¥–∏–Ω":q.type==="numeric"?"# —á–∏—Å–ª–æ":"‚úì –≤—è—Ä–Ω–æ/–≥—Ä–µ—à–Ω–æ"}</div>
              <div class="pill">‚≠ê ${q.points||1}</div>
            </div>
            <div class="font-black mt-2 break-words">${esc(q.text||"")}</div>
            ${(q.type==="single"||q.type==="multiple") ? `
              <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-slate-200">
                ${(q.options||[]).map((o,j)=>o?`<div class="px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                  <span class="font-black">${String.fromCharCode(65+j)}.</span> ${esc(o)} ${q.correct&&q.correct.includes(j)?'<span class="text-emerald-400 font-black">‚úì</span>':""}
                </div>`:"").join("")}
              </div>
            `:""}
            ${q.type==="open" && Array.isArray(q.accept) && q.accept.length ? `<div class="mt-2 text-xs text-slate-400">–ü—Ä–∏–µ–º–ª–∏–≤–∏: <span class="text-slate-200">${esc(q.accept.join(" | "))}</span></div>`:""}
            ${q.type==="numeric" ? `<div class="mt-2 text-xs text-slate-400">–î–∏–∞–ø–∞–∑–æ–Ω: ${q.min} ‚Äì ${q.max}, —Å—Ç—ä–ø–∫–∞ ${q.step}</div>`:""}
          </div>

          <div class="flex flex-col gap-2 shrink-0">
            <button type="button" class="btn btn-secondary" onclick="editQ(${idx})"><i data-lucide="pencil" class="w-4 h-4"></i> –†–µ–¥–∞–∫—Ü–∏—è</button>
            <button type="button" class="btn btn-danger" onclick="delQ(${idx})"><i data-lucide="trash-2" class="w-4 h-4"></i> –ò–∑—Ç—Ä–∏–π</button>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-2 flex-wrap">
          <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">–í—Ä–µ–º–µ:</div>
          <button type="button" class="btn btn-secondary" onclick="bumpQT(${idx},-0.5)">-0.5s</button>
          <button type="button" class="btn btn-secondary" onclick="bumpQT(${idx},-0.1)">-0.1s</button>
          <input type="number" step="0.1" value="${Number(q.t||0)}" onchange="setQT(${idx}, this.value)" class="w-24 px-3 py-2 bg-white/5 border border-white/10 rounded-xl text-white font-bold">
          <button type="button" class="btn btn-secondary" onclick="bumpQT(${idx},0.1)">+0.1s</button>
          <button type="button" class="btn btn-secondary" onclick="bumpQT(${idx},0.5)">+0.5s</button>
        </div>
      </div>
    `).join("") || `<div class="text-slate-400">–ù—è–º–∞ –≤—ä–ø—Ä–æ—Å–∏ –æ—â–µ. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äû+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å‚Äú.</div>`;
    icons();
  }

  window.openEditor=(id=null)=>{
    edId=id; edQs=[]; edVideo=""; edTitle="–ë–µ–∑ –∏–º–µ";
    $("edSub").textContent = id?"–†–µ–¥–∞–∫—Ü–∏—è":"–ù–æ–≤ —É—Ä–æ–∫";
    $("edUrl").value=""; $("edPlayer").innerHTML=""; $("edOverlay").classList.remove("hidden");
    if(edTInt){clearInterval(edTInt);edTInt=null;}
    if(id){
      const q=myQuizzes.find(x=>x.id===id);
      if(q){ edTitle=q.title||"–ë–µ–∑ –∏–º–µ"; edVideo=q.v||""; edQs=(q.questions||[]).map(x=>norm(JSON.parse(JSON.stringify(x)))); }
      if(edVideo){ $("edOverlay").classList.add("hidden"); initEdPlayer(edVideo); $("edUrl").value="https://youtu.be/"+edVideo; }
    }
    renderEdQs(); show("editor");
  };

  function initEdPlayer(videoId){
    $("edPlayer").innerHTML='<div id="edYT" class="w-full h-full"></div>';
    edPlayer=new YT.Player("edYT",{videoId,width:"100%",height:"100%",playerVars:{autoplay:0,controls:1,rel:0},
      events:{onReady:()=>{
        window.edPlayer = edPlayer; // –≤–∞–∂–Ω–æ –∑–∞ –¥–æ—Å—Ç—ä–ø –æ—Ç –º–æ–¥–∞–ª–∞
        edTInt=setInterval(()=>{try{$("edTime").textContent=fmtTime(edPlayer.getCurrentTime()||0)}catch(e){}},250);
      }}});
  }

  window.loadEditorVideo=()=>{
    const id=ytId($("edUrl").value);
    if(!id) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω YouTube –ª–∏–Ω–∫.","error");
    edVideo=id; $("edOverlay").classList.add("hidden"); initEdPlayer(id);
  };

  // –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü –∑–∞ –≤—ä–ø—Ä–æ—Å–∏
  let editingQIndex = null;
  let mqDraft = null;

  function getTeacherVideoTime(){
    try{
      if(window.edPlayer && typeof window.edPlayer.getCurrentTime==="function") return Number(window.edPlayer.getCurrentTime())||0;
    }catch(e){}
    return 0;
  }

  function renderModal(){
    const type = $("mqType")?.value || "single";
    const body = $("mqBody");
    if(!body) return;

    const q = mqDraft || {};
    const opts = Array.isArray(q.options) ? q.options.slice(0,4) : ["","","",""];
    while(opts.length<4) opts.push("");

    const correct = q.correct;
    const accept = Array.isArray(q.accept) ? q.accept.join(" | ") : (typeof q.accept==="string" ? q.accept : "");

    const radioChecked = (i)=> (type==="single" && Number(correct)===i) ? "checked" : "";
    const cbChecked = (i)=> (type==="multiple" && Array.isArray(correct) && correct.includes(i)) ? "checked" : "";
    const escV = (v)=> esc(String(v ?? ""));

    if(type==="single" || type==="multiple"){
      body.innerHTML = `
        <div class="space-y-3">
          <div class="text-sm text-slate-400">–û—Ç–≥–æ–≤–æ—Ä–∏</div>
          ${[0,1,2,3].map(i=>`
            <div class="flex items-center gap-3">
              ${type==="single"
                ? `<input type="radio" name="mqCorrect" value="${i}" class="h-5 w-5" ${radioChecked(i)} />`
                : `<input type="checkbox" id="mqCorr${i}" class="h-5 w-5" ${cbChecked(i)} />`
              }
              <input id="mqOpt${i}" type="text" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10"
                placeholder="${["A","B","C","D"][i]}" value="${escV(opts[i])}" />
            </div>
          `).join("")}
          <p class="text-xs text-slate-500">–°—ä–≤–µ—Ç: –ø—Ä–∏ ‚Äû–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω‚Äú –º–∞—Ä–∫–∏—Ä–∞–π –≤—Å–∏—á–∫–∏ –≤–µ—Ä–Ω–∏.</p>
        </div>
      `;
      return;
    }

    if(type==="open"){
      body.innerHTML = `
        <div class="space-y-3">
          <div class="text-sm text-slate-400">–°–≤–æ–±–æ–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</div>
          <input id="mqAccept" type="text" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10"
            placeholder="–ü—Ä–∏–µ–º–∏ –∫–∞—Ç–æ –≤–µ—Ä–Ω–∏ (–ø—Ä–∏–º–µ—Ä: —Å–æ—Ñ–∏—è | –°–æ—Ñ–∏—è)" value="${escV(accept)}" />
          <p class="text-xs text-slate-500">–ú–æ–∂–µ—à –¥–∞ –≤—ä–≤–µ–¥–µ—à –Ω—è–∫–æ–ª–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏ —Å <b>|</b>.</p>
        </div>
      `;
      return;
    }

    if(type==="boolean"){
      const v = (correct===true || correct==="true") ? "true" : (correct===false || correct==="false") ? "false" : "";
      body.innerHTML = `
        <div class="space-y-3">
          <div class="text-sm text-slate-400">–í—è—Ä–Ω–æ / –ù–µ–≤—è—Ä–Ω–æ</div>
          <select id="mqBool" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10">
            <option value="">‚Äî –∏–∑–±–µ—Ä–∏ ‚Äî</option>
            <option value="true" ${v==="true"?"selected":""}>–í—è—Ä–Ω–æ</option>
            <option value="false" ${v==="false"?"selected":""}>–ù–µ–≤—è—Ä–Ω–æ</option>
          </select>
        </div>
      `;
      return;
    }

    if(type==="numeric"){
      const num = (typeof correct==="number" || (typeof correct==="string" && correct.trim()!=="")) ? String(correct) : "";
      const min = q.min ?? 0;
      const max = q.max ?? 10;
      const step = q.step ?? 1;
      body.innerHTML = `
        <div class="space-y-3">
          <div class="text-sm text-slate-400">–ß–∏—Å–ª–æ–≤ –æ—Ç–≥–æ–≤–æ—Ä (–ø–ª—ä–∑–≥–∞—á)</div>
          <div class="grid grid-cols-3 gap-2">
            <div><label class="text-xs">Min</label><input id="mqNumMin" type="number" step="any" value="${min}" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10"></div>
            <div><label class="text-xs">Max</label><input id="mqNumMax" type="number" step="any" value="${max}" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10"></div>
            <div><label class="text-xs">–°—Ç—ä–ø–∫–∞</label><input id="mqNumStep" type="number" step="any" value="${step}" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10"></div>
          </div>
          <div><label class="text-xs">–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</label><input id="mqNum" type="number" step="any" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="–Ω–∞–ø—Ä. 3.14" value="${escV(num)}" /></div>
        </div>
      `;
      return;
    }

    body.innerHTML = `<p class="text-sm text-slate-400">–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ç–∏–ø –≤—ä–ø—Ä–æ—Å.</p>`;
  }
  window.renderModal = renderModal;

  window.openQModal = (q=null, idx=null) => {
    editingQIndex = (typeof idx==="number") ? idx : null;
    mqDraft = q ? JSON.parse(JSON.stringify(q)) : { t: Math.round(getTeacherVideoTime()*10)/10, type:"single", text:"", options:["","","",""], correct:0, points:1, accept:[], min:0, max:10, step:1 };

    $("mqText").value = mqDraft.text || "";
    $("mqTime").value  = (mqDraft.t ?? 0);
    $("mqType").value  = mqDraft.type || "single";
    $("mqPoints").value   = (mqDraft.points ?? 1);

    renderModal();
    showModal("qModal");
  };

  window.setModalNow = () => {
    $("mqTime").value = Math.round(getTeacherVideoTime()*10)/10;
  };

  window.playFromModal = () => {
    try{
      const t = Number($("mqTime")?.value || 0) || 0;
      if(window.edPlayer && typeof window.edPlayer.seekTo==="function"){
        window.edPlayer.seekTo(t, true);
        if(typeof window.edPlayer.playVideo==="function") window.edPlayer.playVideo();
      }
    }catch(e){}
  };

  window.closeQModal = () => {
    closeModal("qModal");
  };

  window.saveModalQ = () => {
    const qText = ($("mqText").value||"").trim();
    const qTime = Number($("mqTime").value||0) || 0;
    const qType = ($("mqType").value||"single");
    const qPts  = Math.max(0, Number($("mqPoints").value||1) || 1);

    if(!qText){
      toast("–í—ä–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞.", "error");
      return;
    }

    const q = { t: qTime, type: qType, text: qText, points: qPts, options:[], correct:null, accept:[] };

    if(qType==="single" || qType==="multiple"){
      const opts = [0,1,2,3].map(i=> ($("mqOpt"+i)?.value||"").trim());
      if(opts.filter(Boolean).length < 2){
        toast("–í—ä–≤–µ–¥–∏ –ø–æ–Ω–µ 2 –æ—Ç–≥–æ–≤–æ—Ä–∞.", "error");
        return;
      }
      q.options = opts;

      if(qType==="single"){
        const picked = document.querySelector('input[name="mqCorrect"]:checked');
        q.correct = picked ? Number(picked.value) : 0;
      }else{
        const corr=[];
        [0,1,2,3].forEach(i=>{ if($("mqCorr"+i)?.checked) corr.push(i); });
        if(!corr.length){
          toast("–ú–∞—Ä–∫–∏—Ä–∞–π –ø–æ–Ω–µ –µ–¥–∏–Ω –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä.", "error");
          return;
        }
        q.correct = corr;
      }
    }else if(qType==="open"){
      const acc = ($("mqAccept")?.value||"").trim();
      q.accept = acc ? acc.split("|").map(s=>s.trim()).filter(Boolean) : [];
      q.correct = null;
    }else if(qType==="boolean"){
      const v = $("mqBool")?.value || "";
      if(v!=="true" && v!=="false"){
        toast("–ò–∑–±–µ—Ä–∏ –í—è—Ä–Ω–æ –∏–ª–∏ –ù–µ–≤—è—Ä–Ω–æ.", "error");
        return;
      }
      q.correct = (v==="true");
    }else if(qType==="numeric"){
      const v = $("mqNum")?.value;
      if(v===null || v===undefined || String(v).trim()===""){
        toast("–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ–≤–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç.", "error");
        return;
      }
      q.correct = Number(v);
      if(Number.isNaN(q.correct)){
        toast("–ù–µ–≤–∞–ª–∏–¥–Ω–æ —á–∏—Å–ª–æ.", "error");
        return;
      }
      q.min = Number($("mqNumMin")?.value) || 0;
      q.max = Number($("mqNumMax")?.value) || 10;
      q.step = Number($("mqNumStep")?.value) || 1;
    }

    try{
      if(editingQIndex===null){
        edQs.push(q);
      }else{
        edQs[editingQIndex] = q;
      }
      edQs = edQs.map(norm).sort((a,b)=>(a.t||0)-(b.t||0));
      renderEdQs();
      toast("–ó–∞–ø–∏—Å–∞–Ω–æ.", "success");
      closeQModal();
    }catch(e){ console.error(e); }
  };

  window.playQ=(t)=>{ try{edPlayer.seekTo(t,true);edPlayer.playVideo()}catch(e){} };
  window.delQ=(i)=>{ if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) return; edQs.splice(i,1); renderEdQs(); };

  window.saveLesson=async ()=>{
    if(!edVideo) return toast("–ù—è–º–∞ –≤–∏–¥–µ–æ.","error");
    if(!edQs.length) return toast("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ 1 –≤—ä–ø—Ä–æ—Å.","error");
    const title=prompt("–ò–º–µ –Ω–∞ —É—Ä–æ–∫–∞:",edTitle); if(title===null) return;
    edTitle=(title||"").trim()||"–ë–µ–∑ –∏–º–µ";
    const payload={title:edTitle,v:edVideo,questions:edQs.map(norm),updatedAt:serverTimestamp()};
    if(edId){
      await updateDoc(doc(db,"artifacts",FINAL_APP_ID,"users",user.uid,"my_quizzes",edId),payload);
    }else{
      payload.createdAt=serverTimestamp();
      const ref=await addDoc(collection(db,"artifacts",FINAL_APP_ID,"users",user.uid,"my_quizzes"),payload); edId=ref.id;
    }
    toast("–ó–∞–ø–∞–∑–µ–Ω–æ!","success"); show("teacher");
  };
  window.editQ=(i)=>{ openQModal(edQs[i], i); };

  window.setQT=(i,val)=>{
    const t = Math.max(0, Number(val)||0);
    if(!edQs[i]) return;
    edQs[i].t = Math.round(t*10)/10;
    renderEdQs();
  };
  window.bumpQT=(i,delta)=>{
    if(!edQs[i]) return;
    edQs[i].t = Math.max(0, Math.round(((Number(edQs[i].t)||0)+delta)*10)/10);
    renderEdQs();
  };

  // ========== –°–û–õ–û –†–ï–ñ–ò–ú ==========
  let soloPlayer=null, soloQuiz=null, soloIdx=-1, soloScore=0, soloMax=0, soloSel=null, sop=false, disc=false, soloName="–ê–Ω–æ–Ω–∏–º–µ–Ω", soloDone=false;
  let soloAnswers = []; // <-- –¥–æ–±–∞–≤–µ–Ω–æ

  const maxPts=(qs)=>qs.reduce((a,q)=>a+(Number(q.points||1)||1),0);
  const correct=(q,ans)=>{
    if(!q) return false;
    if(q.type==='numeric') return Number(ans)===Number(q.correct?.[0]);
    if(q.type==='boolean') return Boolean(ans) === Boolean(q.correct?.[0]);
    if(q.type==='open'){
      const a = String(ans||"").trim().toLowerCase();
      const acc = Array.isArray(q.accept)? q.accept : [];
      if(!acc.length) return false; // –∑–∞–ø–∏—Å–≤–∞–º–µ –±–µ–∑ –æ—Ü–µ–Ω–∫–∞
      return acc.map(s=>String(s||"").trim().toLowerCase()).includes(a);
    }
    if(q.type==='multiple'){
      const A=(Array.isArray(ans)?ans:[]).slice().sort().join(',');
      const B=(Array.isArray(q.correct)?q.correct:[]).slice().sort().join(',');
      return A===B;
    }
    // single
    return Number(ans)===Number(q.correct?.[0]);
  };

  window.startSolo=async ()=>{
    const d=dec($("ind-code").value||""); if(!d||!d.v) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥.","error");
    sop=$("ind-sop").checked; disc=$("ind-disc").checked; soloName=($("ind-name").value||"").trim()||"–ê–Ω–æ–Ω–∏–º–µ–Ω";
    soloQuiz={title:d.title||"–£—Ä–æ–∫",v:d.v,q:(d.q||[]).map(norm).sort((a,b)=>a.t-b.t),ownerId:d.ownerId||null};
    soloIdx=-1; soloScore=0; soloSel=null; soloDone=false; soloAnswers = []; // –Ω—É–ª–∏—Ä–∞–Ω–µ
    soloMax=maxPts(soloQuiz.q);
    if(!auth.currentUser) await signInAnonymously(auth);
    show("solo");
    $("soloPlayer").innerHTML='<div id="soloYT" class="w-full h-full"></div>';
    soloPlayer=new YT.Player("soloYT",{videoId:soloQuiz.v,width:"100%",height:"100%",playerVars:{autoplay:1,controls:1,rel:0},
      events:{onStateChange:(e)=>{ if(e.data===1) pollSolo(); if(e.data===0) finishSolo(); }}});
  };

  let soloPoll=null;
  function pollSolo(){
    clearInterval(soloPoll);
    soloPoll=setInterval(()=>{
      try{
        const t=Math.floor(soloPlayer.getCurrentTime());
        const next=soloQuiz.q.findIndex((qq,i)=>i>soloIdx && t>=Math.floor(qq.t));
        if(next!==-1){ soloIdx=next; openSoloQ(soloQuiz.q[next]); }
        const dur=soloPlayer.getDuration?.()||0; if(dur>0 && t>=dur-1) finishSolo();
      }catch(e){}
    },500); // –Ω–∞–º–∞–ª–µ–Ω–∞ —á–µ—Å—Ç–æ—Ç–∞
  }

  function openSoloQ(q){
    try{soloPlayer.pauseVideo()}catch(e){}
    $("soloOverlay").classList.remove("hidden"); $("soloOverlay").classList.add("flex");
    $("soloQ").textContent=q.text;
    $("soloSpeak").classList.toggle("hidden",!sop);
    if(sop) speakSolo();
    soloSel=null; $("soloConfirm").classList.add("hidden");
    const o=$("soloOpts"); o.innerHTML="";
    $("soloOpen").classList.add("hidden"); // —Å–∫—Ä–∏–≤–∞–º–µ –ø–æ–ª–µ—Ç–æ –∑–∞ –æ—Ç–≤–æ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä, –∞–∫–æ –Ω–µ –µ –Ω—É–∂–Ω–æ

    if(q.type==="numeric"){
      const start = (q.min + q.max) / 2;
      o.innerHTML=`<div class="card p-6 bg-white/10 border border-white/20">
        <input id="soloRange" type="range" min="${q.min}" max="${q.max}" step="${q.step||1}" value="${start}" class="w-full"
          oninput="document.getElementById('soloRangeVal').textContent=this.value">
        <div id="soloRangeVal" class="text-white text-5xl font-black mt-6">${start}</div></div>`;
      $("soloConfirm").classList.remove("hidden"); return;
    }
    if(q.type==="multiple"){
      o.innerHTML=q.options.map((x,i)=>`<label class="flex items-center gap-3 p-4 rounded-2xl bg-white/10 border border-white/15 text-white font-black">
        <input type="checkbox" data-i="${i}" class="accent-indigo-600 w-5 h-5"> ${x}</label>`).join("");
      o.querySelectorAll("input").forEach(cb=>cb.addEventListener("change",()=>{
        soloSel=[...o.querySelectorAll("input:checked")].map(x=>Number(x.dataset.i));
        $("soloConfirm").classList.toggle("hidden", !soloSel.length);
      }));
      return;
    }
    if(q.type==="open"){
      $("soloOpen").classList.remove("hidden");
      $("soloOpen").value = "";
      $("soloOpen").oninput = (e) => { soloSel = e.target.value; };
      $("soloConfirm").classList.remove("hidden");
      return;
    }
    const list=(q.type==="boolean")?["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"]:q.options;
    o.innerHTML=list.map((x,i)=>`<button type="button" class="btn bg-white/10 border border-white/15 text-white text-left" onclick="pickSolo(${i})">${x}</button>`).join("");
  }

  window.pickSolo=(i)=>{ soloSel=i; $("soloConfirm").classList.remove("hidden"); };
  window.speakSolo=()=>{
    try{ if(!("speechSynthesis" in window)) return;
      speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance($("soloQ").textContent||""); u.lang="bg-BG"; u.rate=.9;
      speechSynthesis.speak(u);
    }catch(e){}
  };

  window.confirmSolo=async ()=>{
    const q=soloQuiz.q[soloIdx];
    let ans=soloSel;

    if(q.type==="numeric") ans=Number(document.getElementById("soloRange").value);
    if(q.type==="open") ans=String(document.getElementById("soloOpen").value||"").trim();

    const hasAuto = q.type==="open" ? (Array.isArray(q.accept) && q.accept.length>0) : true;
    const ok = correct(q,ans);

    if(q.type==="open" && !hasAuto){
      toast("–û—Ç–≥–æ–≤–æ—Ä—ä—Ç –µ –∑–∞–ø–∏—Å–∞–Ω (–±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ—Ü–µ–Ω–∫–∞).","info");
    } else if(ok){
      soloScore += (Number(q.points||1)||1);
      toast("–í—è—Ä–Ω–æ!","success");
    } else {
      toast("–ì—Ä–µ—à–Ω–æ‚Ä¶","error");
    }

    soloAnswers.push({t:q.t, type:q.type||"single", answer:ans, ok: ok===true });

    $("soloOverlay").classList.add("hidden"); $("soloOverlay").classList.remove("flex");
    try{speechSynthesis.cancel()}catch(e){}
    setTimeout(()=>{try{soloPlayer.playVideo()}catch(e){}},600);
  };

  async function finishSolo(){
    if(soloDone) return; soloDone=true;
    show("finish"); $("finishScore").textContent=`${soloScore}/${soloMax}`;
    if(disc) return;
    if(auth.currentUser && soloQuiz?.ownerId){
      try{
        await addDoc(collection(db,"artifacts",FINAL_APP_ID,"users",soloQuiz.ownerId,"solo_results"),{
          studentName:soloName,
          quizTitle:soloQuiz.title+(sop?" (–°–û–ü)":""),
          score:`${soloScore}/${soloMax}`,
          timestamp:serverTimestamp(),
          userId:auth.currentUser.uid
        });
      }catch(e){}
    }
  }

  // ========== –û–°–¢–ê–ù–ê–õ–ò–¢–ï –§–£–ù–ö–¶–ò–ò (host, client) —Å–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–∏ ==========
  // –ó–∞ –∫—Ä–∞—Ç–∫–æ—Å—Ç —Ç—É–∫ –Ω–µ –≥–∏ –ø—Ä–µ–ø–∏—Å–≤–∞–º –∏–∑—Ü—è–ª–æ, –Ω–æ —Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–∞—Ç —Å—ä—â–∏—Ç–µ –∫–∞—Ç–æ –≤—ä–≤ –≤–∞—à–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª,
  // –∫–∞—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–æ —Å–µ —É–≤–µ—Ä–∏—Ç–µ, —á–µ –≤ client —á–∞—Å—Ç—Ç–∞ –∑–∞ open –≤—ä–ø—Ä–æ—Å —Å—ä—â–æ –µ –¥–æ–±–∞–≤–µ–Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ª–æ–≥–∏–∫–∞.

  // ... (–æ—Å—Ç–∞–Ω–∞–ª–∏—è—Ç –∫–æ–¥ –æ—Ç –≤–∞—à–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª, –Ω–æ —Å –ø–æ–¥–æ–±–Ω–∏ –∫–æ—Ä–µ–∫—Ü–∏–∏) ...

  // –ù–∞–∫—Ä–∞—è ‚Äì –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ
  onAuthStateChanged(auth, async (u)=>{
    user=u||null;
    if(!user){ show("welcome"); icons(); return; }
    try{
      const prof=await getDoc(doc(db,"artifacts",FINAL_APP_ID,"users",user.uid,"settings","profile"));
      if(prof.exists() && prof.data()?.role==="teacher"){
        $("teacherEmail").textContent = prof.data()?.email || user.email || "";
        unsubQ?.(); unsubS?.();
        unsubQ=onSnapshot(collection(db,"artifacts",FINAL_APP_ID,"users",user.uid,"my_quizzes"),(snap)=>{ myQuizzes=snap.docs.map(d=>({id:d.id,...d.data()})); renderTeacher(); });
        unsubS=onSnapshot(collection(db,"artifacts",FINAL_APP_ID,"users",user.uid,"solo_results"),(snap)=>{ mySolo=snap.docs.map(d=>({id:d.id,...d.data()})); renderTeacher(); });
        show("teacher"); icons(); return;
      }
    }catch(e){}
    show("welcome"); icons();
  });

  window.addEventListener("load", icons);
</script>
</body>
</html>
