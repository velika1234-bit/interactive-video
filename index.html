<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>VideoQuiz</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;900&display=swap" rel="stylesheet">

  <script>
    try {
      tailwind.config = {
        theme: { extend: {
          fontFamily: { sans: ['Nunito','sans-serif'] },
          colors: { brand: { 600:'#4f46e5', 700:'#4338ca' } }
        } }
      }
    } catch(e){}
  </script>

  <style>
    html, body { height: 100%; }
    body { font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { height: 100%; }
    .scrollbar-hide::-webkit-scrollbar{ display:none; }
    .scrollbar-hide{ -ms-overflow-style:none; scrollbar-width:none; }
    @keyframes pop { from{ transform:scale(.98); opacity:0 } to{ transform:scale(1); opacity:1 } }
    .animate-pop { animation: pop .22s ease-out; }
    .sop-text { font-size: 1.5rem !important; line-height: 1.35 !important; }
    .sop-btn { font-size: 1.2rem !important; padding: 1.25rem !important; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 overflow-hidden">
  <!-- Toasts -->
  <div id="toasts" class="fixed top-4 right-4 z-[99999] flex flex-col gap-2 pointer-events-none"></div>

  <div id="app" class="relative w-full overflow-hidden">
    <!-- WELCOME -->
    <section id="screen-welcome" class="h-full w-full flex flex-col md:flex-row">
      <!-- STUDENT SIDE -->
      <div class="flex-1 bg-white p-6 md:p-10 overflow-y-auto">
        <div class="max-w-xl mx-auto space-y-6">
          <div class="space-y-1">
            <h1 class="text-4xl md:text-5xl font-black tracking-tight">VideoQuiz</h1>
            <p class="text-slate-500 font-bold">–í–∏–¥–µ–æ + –≤—ä–ø—Ä–æ—Å–∏ –ø–æ —Å–µ–∫—É–Ω–¥–∏ ‚Ä¢ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ ‚Ä¢ –í –∫–ª–∞—Å ‚Ä¢ –£—á–∏—Ç–µ–ª—Å–∫–∏ –ø–∞–Ω–µ–ª</p>
          </div>

          <!-- SOLO -->
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-5 space-y-4 shadow-sm">
            <div class="flex items-center gap-2 text-indigo-700">
              <i data-lucide="user" class="w-5 h-5"></i>
              <h2 class="font-black">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <input id="soloName" class="p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫‚Ä¶">
              <input id="soloCode" class="p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500" placeholder="–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫‚Ä¶">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <label class="flex items-center gap-2 bg-white border border-slate-200 rounded-xl p-3 font-bold text-sm">
                <input id="soloSOP" type="checkbox" class="accent-indigo-600">
                –°–û–ü (–µ–¥—ä—Ä —à—Ä–∏—Ñ—Ç + —á–µ—Ç–µ—Ü)
              </label>
              <label class="flex items-center gap-2 bg-white border border-slate-200 rounded-xl p-3 font-bold text-sm">
                <input id="soloDiscussion" type="checkbox" class="accent-amber-500">
                –û–±—Å—ä–∂–¥–∞–Ω–µ (–±–µ–∑ –∑–∞–ø–∏—Å)
              </label>
            </div>

            <button id="btnSoloStart" class="w-full py-3 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-black uppercase tracking-wider">
              –°—Ç–∞—Ä—Ç
            </button>
          </div>

          <!-- LIVE -->
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-5 space-y-4 shadow-sm">
            <div class="flex items-center gap-2 text-emerald-700">
              <i data-lucide="users" class="w-5 h-5"></i>
              <h2 class="font-black">–í –∫–ª–∞—Å (–Ω–∞ –∂–∏–≤–æ)</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <input id="liveName" class="p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-emerald-500" placeholder="–ò–º–µ‚Ä¶">
              <input id="livePin" class="p-3 rounded-xl border border-slate-200 font-black tracking-widest text-lg outline-none focus:border-emerald-500" placeholder="–ü–ò–ù">
            </div>

            <button id="btnLiveJoin" class="w-full py-3 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-black uppercase tracking-wider">
              –í–ª–µ–∑
            </button>

            <p class="text-xs text-slate-500 font-bold">
              * QR –µ –∏–∑–∫–ª—é—á–µ–Ω. –í–ª–∏–∑–∞—Ç–µ —Å –ü–ò–ù.
            </p>
          </div>

          <div class="text-center">
            <button id="btnHintTeacher" class="text-sm font-bold text-slate-500 hover:text-indigo-700 underline">
              –£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥ ‚Üí (–≤–¥—è—Å–Ω–æ)
            </button>
          </div>
        </div>
      </div>

      <!-- TEACHER SIDE -->
      <div class="w-full md:w-[420px] bg-slate-900 text-white p-8 flex flex-col justify-center">
        <div class="max-w-sm mx-auto w-full space-y-5">
          <div>
            <h2 id="authTitle" class="text-3xl font-black">–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥</h2>
            <p class="text-slate-400 text-sm font-bold">–ò–º–µ–π–ª + –ø–∞—Ä–æ–ª–∞</p>
          </div>

          <div class="space-y-3">
            <input id="authEmail" type="email" autocomplete="username"
              class="w-full p-3 rounded-xl bg-white/5 border border-white/10 outline-none font-bold"
              placeholder="name@school.bg">
            <input id="authPass" type="password" autocomplete="current-password"
              class="w-full p-3 rounded-xl bg-white/5 border border-white/10 outline-none font-bold"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

            <div id="teacherCodeBox" class="hidden">
              <input id="teacherRegCode" type="password"
                class="w-full p-3 rounded-xl bg-amber-500/10 border border-amber-500/30 outline-none font-bold text-center tracking-widest"
                placeholder="–ö–æ–¥ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–ø–æ –∏–∑–±–æ—Ä)">
              <p class="text-[11px] text-slate-400 font-bold mt-2">
                * –ê–∫–æ –Ω–µ –ø–æ–ª–∑–≤–∞—à –∫–æ–¥ ‚Äì –æ—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ.
              </p>
            </div>

            <button id="btnAuth"
              class="w-full py-3 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-black uppercase tracking-wider">
              –í–ª–µ–∑
            </button>

            <button id="btnToggleAuth" class="w-full py-2 text-slate-400 hover:text-white font-bold text-sm">
              –ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </button>
          </div>

          <div class="text-slate-500 text-xs font-bold">
            –ê–∫–æ –≤–∏–¥–µ–∞—Ç–∞ –Ω–µ —Ç—Ä—ä–≥–≤–∞—Ç: –ø—Ä–æ–±–≤–∞–π –±–µ–∑ AdBlock –∑–∞ —Ç–æ–∑–∏ —Å–∞–π—Ç.
          </div>
        </div>
      </div>
    </section>

    <!-- TEACHER DASHBOARD -->
    <section id="screen-teacher" class="hidden h-full w-full flex flex-col">
      <header class="bg-white border-b border-slate-200 px-5 py-3 flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-brand-600 text-white flex items-center justify-center">
          <i data-lucide="library" class="w-5 h-5"></i>
        </div>
        <div class="min-w-0">
          <div class="font-black">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
          <div id="teacherEmail" class="text-xs font-bold text-slate-400 truncate">‚Ä¶</div>
        </div>

        <div class="ml-auto flex gap-2">
          <button id="btnNewLesson" class="px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-black text-sm flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> –ù–æ–≤ —É—Ä–æ–∫
          </button>
          <button id="btnLogout" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-black text-sm">
            <span class="inline-flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> –ò–∑—Ö–æ–¥</span>
          </button>
        </div>
      </header>

      <main class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12">
        <!-- Library -->
        <aside class="lg:col-span-4 border-r border-slate-200 bg-white overflow-y-auto p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-black text-slate-800">–í–∞—à–∏—Ç–µ —É—Ä–æ—Ü–∏</h3>
            <button id="btnImportLesson" class="px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 font-black text-xs">
              –ò–º–ø–æ—Ä—Ç
            </button>
          </div>
          <div id="lessonList" class="mt-4 space-y-3"></div>
        </aside>

        <!-- Stats -->
        <section class="lg:col-span-8 overflow-y-auto p-4 space-y-4">
          <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-black text-slate-400 uppercase">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="font-black text-lg">–°–µ—Å–∏–∏</div>
              </div>
              <div class="flex gap-2">
                <button id="btnExportSoloExcel" class="px-3 py-2 rounded-xl bg-white border border-slate-200 font-black text-xs">
                  üìä Excel (–¥–æ–º–∞—à–Ω–∏)
                </button>
              </div>
            </div>

            <div class="mt-4">
              <div class="flex gap-2 bg-slate-50 border border-slate-200 p-1 rounded-xl w-fit">
                <button id="tabSolo" class="px-4 py-2 rounded-lg font-black text-xs bg-brand-600 text-white">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏</button>
                <button id="tabClass" class="px-4 py-2 rounded-lg font-black text-xs text-slate-600 hover:bg-white">–í –∫–ª–∞—Å</button>
              </div>
            </div>

            <div id="soloTableWrap" class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-xs uppercase tracking-wider text-slate-500">
                  <tr class="border-b border-slate-100">
                    <th class="p-3 text-left">–£—á–µ–Ω–∏–∫</th>
                    <th class="p-3 text-left">–£—Ä–æ–∫</th>
                    <th class="p-3 text-left">–î–∞—Ç–∞</th>
                    <th class="p-3 text-right">–†–µ–∑—É–ª—Ç–∞—Ç</th>
                    <th class="p-3 text-center">–ò–∑—Ç—Ä–∏–π</th>
                  </tr>
                </thead>
                <tbody id="soloRows" class="divide-y divide-slate-50"></tbody>
              </table>
            </div>

            <div id="classTableWrap" class="hidden mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-xs uppercase tracking-wider text-slate-500">
                  <tr class="border-b border-slate-100">
                    <th class="p-3 text-left">–î–∞—Ç–∞</th>
                    <th class="p-3 text-left">–£—Ä–æ–∫</th>
                    <th class="p-3 text-left">–ü–ò–ù</th>
                    <th class="p-3 text-center">–í–∏–∂</th>
                    <th class="p-3 text-center">–ò–∑—Ç—Ä–∏–π</th>
                  </tr>
                </thead>
                <tbody id="classRows" class="divide-y divide-slate-50"></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </section>

    <!-- EDITOR -->
    <section id="screen-editor" class="hidden h-full w-full flex flex-col bg-slate-100">
      <header class="bg-white border-b border-slate-200 px-5 py-3 flex items-center gap-3">
        <button id="btnBackToTeacher" class="p-2 rounded-lg hover:bg-slate-100 text-slate-500">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </button>
        <div class="min-w-0">
          <div class="font-black">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
          <div id="editorLessonTitle" class="text-xs font-bold text-slate-400 truncate">‚Ä¶</div>
        </div>

        <div class="ml-auto flex gap-2">
          <button id="btnSaveLesson" class="px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-black text-sm flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> –ó–∞–ø–∞–∑–∏
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12 gap-3 p-3">
        <div class="lg:col-span-8 bg-black rounded-2xl overflow-hidden relative border border-white/10">
          <div id="editorPlayer" class="w-full h-full"></div>

          <div id="editorOverlay" class="absolute inset-0 bg-slate-900/90 flex items-center justify-center p-6">
            <div class="bg-white rounded-2xl p-5 max-w-md w-full space-y-3 shadow-2xl">
              <div class="font-black text-lg">YouTube –≤–∏–¥–µ–æ</div>
              <input id="editorYtUrl" class="w-full p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500" placeholder="YouTube –ª–∏–Ω–∫ –∏–ª–∏ ID‚Ä¶">
              <input id="editorTitleInput" class="w-full p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500" placeholder="–ò–º–µ –Ω–∞ —É—Ä–æ–∫‚Ä¶">
              <button id="btnLoadVideo" class="w-full py-3 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-black">
                –ó–∞—Ä–µ–¥–∏
              </button>
              <div class="text-xs text-slate-500 font-bold">
                * –ü—É—Å–Ω–∏ –≤–∏–¥–µ–æ—Ç–æ, —Å–ø—Ä–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –∏ –¥–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å –Ω–∞ —Ç–µ–∫—É—â–∞—Ç–∞ —Å–µ–∫—É–Ω–¥–∞.
              </div>
            </div>
          </div>

          <div class="absolute top-3 left-3 bg-white/10 text-white px-3 py-2 rounded-xl font-mono text-sm font-bold">
            <span id="editorClock">0:00</span>
          </div>
        </div>

        <div class="lg:col-span-4 bg-white rounded-2xl border border-slate-200 overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
            <div>
              <div class="text-xs font-black text-slate-400 uppercase">–í—ä–ø—Ä–æ—Å–∏</div>
              <div class="font-black">–°–ø–∏—Å—ä–∫</div>
            </div>
            <button id="btnAddQuestion" class="w-10 h-10 rounded-full bg-brand-600 hover:bg-brand-700 text-white flex items-center justify-center">
              <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>

          <div id="qList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50 scrollbar-hide"></div>
        </div>
      </div>
    </section>

    <!-- LIVE HOST -->
    <section id="screen-live-host" class="hidden h-full w-full bg-slate-900 text-white flex flex-col">
      <header class="h-16 px-5 border-b border-white/10 flex items-center gap-3 bg-slate-900/80 backdrop-blur">
        <div class="bg-brand-600 px-4 py-2 rounded-xl">
          <div class="text-[10px] uppercase font-black text-indigo-200">–ü–ò–ù</div>
          <div id="hostPin" class="text-2xl font-black tracking-widest leading-none">‚Äî</div>
        </div>
        <div class="text-sm font-bold text-slate-300 flex items-center gap-2">
          <i data-lucide="users" class="w-4 h-4"></i> <span id="hostCount">0</span>
        </div>

        <div class="ml-auto flex gap-2">
          <button id="btnHostStart" class="px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 font-black text-sm">–°–¢–ê–†–¢</button>
          <button id="btnHostResume" class="hidden px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-black text-sm">–ü–†–û–î–™–õ–ñ–ò</button>
          <button id="btnHostEnd" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-black text-sm">–ö–†–ê–ô</button>
        </div>
      </header>

      <div class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12 gap-3 p-3">
        <div class="lg:col-span-8 bg-black rounded-2xl overflow-hidden relative border border-white/10">
          <div id="hostPlayer" class="w-full h-full"></div>

          <div id="hostOverlayWaiting" class="absolute inset-0 bg-black/70 flex flex-col items-center justify-center gap-4">
            <div class="text-3xl font-black">–ì–æ—Ç–æ–≤–æ!</div>
            <div class="text-slate-300 font-bold">–£—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–ª–∏–∑–∞—Ç —Å –ü–ò–ù. –ù–∞—Ç–∏—Å–Ω–∏ –°–¢–ê–†–¢.</div>
          </div>

          <div id="hostOverlayQuestion" class="hidden absolute inset-0 bg-black/70 flex flex-col items-center justify-center gap-4">
            <div class="text-2xl font-black">–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∞–∫—Ç–∏–≤–µ–Ω</div>
            <div class="text-slate-300 font-bold">–£—á–µ–Ω–∏—Ü–∏—Ç–µ –æ—Ç–≥–æ–≤–∞—Ä—è—Ç –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ç–∞ —Å–∏.</div>
          </div>
        </div>

        <div class="lg:col-span-4 bg-white text-slate-800 rounded-2xl border border-slate-200 overflow-hidden flex flex-col">
          <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
            <div class="font-black flex items-center gap-2">
              <i data-lucide="trophy" class="w-4 h-4 text-amber-500"></i> –ö–ª–∞—Å–∞—Ü–∏—è
            </div>
            <div class="flex gap-2">
              <button id="btnHostExportExcel" class="px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 font-black text-xs">Excel</button>
              <button id="btnHostExportPDF" class="px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-700 font-black text-xs">PDF</button>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-3 bg-slate-50 scrollbar-hide">
            <table class="w-full text-sm">
              <tbody id="hostRankRows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- LIVE CLIENT -->
    <section id="screen-live-client" class="hidden h-full w-full bg-slate-50 flex flex-col overflow-hidden">
      <div class="h-2 bg-brand-600"></div>

      <div id="clientWaiting" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-6">
        <div class="w-24 h-24 rounded-full bg-white border border-slate-200 shadow flex items-center justify-center text-5xl" id="clientEmoji">üëÄ</div>
        <div>
          <div class="text-2xl font-black" id="clientTitle">–ò–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å‚Ä¶</div>
          <div class="text-slate-500 font-bold" id="clientSubtitle">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è.</div>
        </div>
        <div class="bg-white border border-slate-200 rounded-2xl px-6 py-3 shadow-sm flex items-center gap-3">
          <div class="text-2xl" id="clientAvatar">üòé</div>
          <div class="text-lg font-black" id="clientName">‚Ä¶</div>
        </div>
      </div>

      <div id="clientQuestion" class="hidden flex-1 overflow-y-auto p-6 pb-28 space-y-4">
        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm text-center">
          <div id="clientQText" class="text-xl font-black leading-snug">‚Ä¶</div>
        </div>
        <div id="clientOptions" class="space-y-3 max-w-md mx-auto w-full"></div>
        <button id="btnClientConfirm" class="hidden fixed bottom-6 left-6 right-6 py-4 rounded-2xl bg-brand-600 hover:bg-brand-700 text-white font-black text-lg shadow-xl">
          –ü–û–¢–í–™–†–î–ò
        </button>
      </div>

      <div id="clientFinished" class="hidden flex-1 flex flex-col items-center justify-center bg-brand-600 text-white text-center p-8">
        <div class="text-5xl font-black">–ö–†–ê–ô!</div>
        <div class="mt-3 text-xl font-bold opacity-90">–¢–≤–æ—è—Ç —Ä–µ–∑—É–ª—Ç–∞—Ç:</div>
        <div id="clientFinalScore" class="mt-6 w-40 h-40 rounded-full bg-white text-brand-600 flex items-center justify-center text-6xl font-black shadow-2xl">0</div>
        <button id="btnClientExit" class="mt-8 px-8 py-3 rounded-2xl bg-indigo-900 hover:bg-black font-black">–ò–∑—Ö–æ–¥</button>
      </div>
    </section>

    <!-- SOLO PLAYER -->
    <section id="screen-solo-play" class="hidden h-full w-full bg-black relative">
      <div id="soloPlayer" class="absolute inset-0"></div>

      <div id="soloOverlay" class="hidden absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center p-6 overflow-y-auto">
        <div class="w-full max-w-2xl space-y-6 text-center relative">
          <button id="btnSpeak" class="hidden absolute -top-12 right-0 p-3 rounded-full bg-brand-600 hover:bg-brand-700 text-white shadow" title="–ü—Ä–æ—á–µ—Ç–∏ –≤—ä–ø—Ä–æ—Å–∞">
            <i data-lucide="volume-2" class="w-6 h-6"></i>
          </button>
          <div id="soloQText" class="text-white font-black text-3xl leading-tight">‚Ä¶</div>
          <div id="soloOptions" class="grid gap-3"></div>
          <button id="btnSoloConfirm" class="hidden w-full py-4 rounded-2xl bg-brand-600 hover:bg-brand-700 text-white font-black text-lg">
            –ü–û–¢–í–™–†–î–ò –û–¢–ì–û–í–û–†–ê
          </button>
        </div>
      </div>
    </section>

    <!-- SOLO FINISH -->
    <section id="screen-solo-finish" class="hidden h-full w-full flex items-center justify-center p-8 bg-slate-50">
      <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-2xl p-10 max-w-md w-full text-center space-y-6 animate-pop">
        <div class="w-20 h-20 rounded-full bg-indigo-100 text-indigo-600 mx-auto flex items-center justify-center text-5xl">üèÜ</div>
        <div class="text-2xl font-black">–†–µ–∑—É–ª—Ç–∞—Ç</div>
        <div id="soloScore" class="text-6xl font-black text-indigo-600">0 / 0</div>
        <button id="btnSoloHome" class="w-full py-4 rounded-2xl bg-slate-900 hover:bg-black text-white font-black uppercase tracking-wider">
          –ù–∞—á–∞–ª–æ
        </button>
      </div>
    </section>

    <!-- MODAL: QUESTION -->
    <div id="modalQ" class="hidden fixed inset-0 bg-black/60 z-[9998] p-4 items-center justify-center">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-pop">
        <div class="p-5 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
          <div>
            <div class="font-black text-lg">–í—ä–ø—Ä–æ—Å</div>
            <div class="text-xs font-bold text-slate-400">–°–µ–∫—É–Ω–¥–∞: <span id="mSec">0</span></div>
          </div>
          <button id="btnCloseModal" class="w-9 h-9 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="p-6 space-y-5 max-h-[70vh] overflow-y-auto">
          <div>
            <label class="text-xs font-black text-slate-400 uppercase">–¢–µ–∫—Å—Ç</label>
            <textarea id="mText" class="w-full mt-2 p-4 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500 h-28 resize-none"></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-black text-slate-400 uppercase">–¢–∏–ø</label>
              <select id="mType" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500"></select>
            </div>
            <div>
              <label class="text-xs font-black text-slate-400 uppercase">–¢–æ—á–∫–∏</label>
              <input id="mPoints" type="number" min="1" value="1" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
          </div>

          <div id="mDynamic"></div>
        </div>

        <div class="p-5 border-t border-slate-100 bg-slate-50">
          <button id="btnSaveQ" class="w-full py-4 rounded-2xl bg-brand-600 hover:bg-brand-700 text-white font-black uppercase tracking-wider">
            –ó–∞–ø–∞–∑–∏
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL: CLASS SESSION VIEW -->
    <div id="modalClass" class="hidden fixed inset-0 bg-black/60 z-[9998] p-4 items-center justify-center">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-pop">
        <div class="p-5 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
          <div>
            <div class="font-black text-lg">–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç —Å–µ—Å–∏—è</div>
            <div class="text-xs font-bold text-slate-400" id="classModalTitle">‚Ä¶</div>
          </div>
          <button id="btnCloseClassModal" class="w-9 h-9 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="p-0 max-h-[70vh] overflow-y-auto">
          <table class="w-full text-sm">
            <thead class="text-xs uppercase tracking-wider text-slate-500 bg-slate-50 sticky top-0">
              <tr>
                <th class="p-4 text-left">–£—á–µ–Ω–∏–∫</th>
                <th class="p-4 text-right">–¢–æ—á–∫–∏</th>
              </tr>
            </thead>
            <tbody id="classModalRows" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== LOGIC =================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc,
      addDoc, onSnapshot, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ‚úÖ –¢–≤–æ—è—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
      apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314",
      authDomain: "videoquiz-ultimate.firebaseapp.com",
      projectId: "videoquiz-ultimate",
      storageBucket: "videoquiz-ultimate.firebasestorage.app",
      messagingSenderId: "793138692820",
      appId: "1:793138692820:web:8ee2418d28d47fca6bf141"
    };

    const APP_ID = "videoquiz-ultimate-live";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* ---------- YouTube loader (–±–µ–∑ –∫–ª—é—á) ---------- */
    const YouTube = (() => {
      let p = null;
      function ensure() {
        if (p) return p;
        p = new Promise((resolve, reject) => {
          if (window.YT && typeof window.YT.Player === "function") return resolve(true);
          window.onYouTubeIframeAPIReady = () => resolve(true);

          const exists = document.querySelector('script[data-yt="1"]');
          if (!exists) {
            const s = document.createElement("script");
            s.src = "https://www.youtube.com/iframe_api";
            s.async = true;
            s.defer = true;
            s.dataset.yt = "1";
            s.onerror = () => reject(new Error("YT iframe_api blocked"));
            document.head.appendChild(s);
          }

          setTimeout(() => {
            if (window.YT && typeof window.YT.Player === "function") return resolve(true);
            reject(new Error("YT API not ready"));
          }, 9000);
        });
        return p;
      }
      return { ensure };
    })();

    /* ---------- DOM helpers ---------- */
    const $ = (id) => document.getElementById(id);
    const screens = {
      welcome: $("screen-welcome"),
      teacher: $("screen-teacher"),
      editor: $("screen-editor"),
      liveHost: $("screen-live-host"),
      liveClient: $("screen-live-client"),
      soloPlay: $("screen-solo-play"),
      soloFinish: $("screen-solo-finish"),
    };

    function safeIcons() {
      try { if (window.lucide) window.lucide.createIcons(); } catch {}
    }

    function showScreen(key) {
      Object.values(screens).forEach(s => s.classList.add("hidden"));
      screens[key].classList.remove("hidden");
      safeIcons();
      window.scrollTo(0, 0);
    }

    function toast(msg, type="info") {
      const wrap = $("toasts");
      const el = document.createElement("div");
      const base = "pointer-events-none px-4 py-3 rounded-2xl shadow-lg border font-bold text-sm animate-pop";
      const cls = type==="error"
        ? "bg-rose-600/15 border-rose-400/20 text-rose-700"
        : type==="warn"
        ? "bg-amber-500/15 border-amber-400/20 text-amber-800"
        : "bg-indigo-600/10 border-indigo-400/20 text-indigo-700";
      el.className = base + " " + cls;
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(() => el.remove(), 3200);
    }

    function fmtTime(sec) {
      sec = Math.max(0, Math.floor(sec||0));
      const m = Math.floor(sec/60);
      const s = String(sec%60).padStart(2,"0");
      return `${m}:${s}`;
    }

    function nowBg(ts) {
      const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : new Date());
      return d.toLocaleString("bg-BG");
    }

    function ytIdFromAny(input) {
      const s = (input||"").trim();
      if (!s) return "";
      if (/^[\w-]{11}$/.test(s)) return s;
      const m = s.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/);
      return m ? m[1] : "";
    }

    function encodeLessonCode(obj) {
      const json = JSON.stringify(obj);
      return btoa(unescape(encodeURIComponent(json)));
    }
    function decodeLessonCode(code) {
      try {
        const json = decodeURIComponent(escape(atob(code.trim().replace(/\s/g,""))));
        return JSON.parse(json);
      } catch { return null; }
    }

    function speakBG(text) {
      try {
        if (!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "bg-BG";
        u.rate = 0.95;
        window.speechSynthesis.speak(u);
      } catch {}
    }

    function destroyPlayer(p) {
      try { if (p && typeof p.destroy==="function") p.destroy(); } catch {}
    }

    const escapeHtml = (s) => String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const AVATARS = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ","ü¶â","üêô","üêù","ü¶Ñ"];

    /* ---------- Firestore paths ---------- */
    const lessonsCol = (uid) => collection(db, "artifacts", APP_ID, "users", uid, "my_quizzes");
    const soloResultsCol = (uid) => collection(db, "artifacts", APP_ID, "users", uid, "solo_results");
    const classHistoryCol = (uid) => collection(db, "artifacts", APP_ID, "users", uid, "class_history");

    const sessionDoc = (pin) => doc(db, "artifacts", APP_ID, "public", "data", "sessions", pin);
    const participantsCol = (pin) => collection(db, "artifacts", APP_ID, "public", "data", "sessions", pin, "participants");
    const participantDoc = (pin, uid) => doc(db, "artifacts", APP_ID, "public", "data", "sessions", pin, "participants", uid);

    /* ---------- Auth state ---------- */
    let authMode = "login";
    let me = null;
    let isTeacher = false;

    $("btnHintTeacher").onclick = () => toast("–£—á–∏—Ç–µ–ª—Å–∫–∏—è—Ç –≤—Ö–æ–¥ –µ –≤–¥—è—Å–Ω–æ üôÇ", "info");

    $("btnToggleAuth").onclick = () => {
      authMode = authMode === "login" ? "register" : "login";
      $("authTitle").textContent = authMode === "login" ? "–£—á–∏—Ç–µ–ª—Å–∫–∏ –≤—Ö–æ–¥" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
      $("btnAuth").textContent = authMode === "login" ? "–í–ª–µ–∑" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
      $("teacherCodeBox").classList.toggle("hidden", authMode !== "register");
    };

    $("btnAuth").onclick = async () => {
      const email = $("authEmail").value.trim();
      const pass = $("authPass").value;
      if (!email || !pass) return toast("–ü–æ–ø—ä–ª–Ω–∏ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞.", "warn");

      try {
        if (authMode === "register") {
          await createUserWithEmailAndPassword(auth, email, pass);
          await setDoc(doc(db, "artifacts", APP_ID, "users", auth.currentUser.uid, "settings", "profile"), {
            role: "teacher",
            email,
            emailNormalized: email.toLowerCase().trim(),
            createdAt: serverTimestamp()
          });
          toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞.", "info");
        } else {
          await signInWithEmailAndPassword(auth, email, pass);
          toast("–í–ª—è–∑–æ—Ö—Ç–µ.", "info");
        }
      } catch (e) {
        toast("–ì—Ä–µ—à–∫–∞: " + (e?.message || e), "error");
      }
    };

    $("btnLogout").onclick = async () => {
      try { await signOut(auth); } catch {}
      location.reload();
    };

    /* ---------- Teacher: library + stats ---------- */
    let unsubLessons = null, unsubSolo = null, unsubClass = null;
    let myLessons = [];
    let soloResults = [];
    let classHistory = [];
    let activeStatsTab = "solo";

    function setStatsTab(t) {
      activeStatsTab = t;
      $("soloTableWrap").classList.toggle("hidden", t !== "solo");
      $("classTableWrap").classList.toggle("hidden", t !== "class");
      $("tabSolo").className = t==="solo" ? "px-4 py-2 rounded-lg font-black text-xs bg-brand-600 text-white" : "px-4 py-2 rounded-lg font-black text-xs text-slate-600 hover:bg-white";
      $("tabClass").className = t==="class" ? "px-4 py-2 rounded-lg font-black text-xs bg-brand-600 text-white" : "px-4 py-2 rounded-lg font-black text-xs text-slate-600 hover:bg-white";
    }
    $("tabSolo").onclick = () => setStatsTab("solo");
    $("tabClass").onclick = () => setStatsTab("class");

    function startTeacherListeners(uid) {
      if (unsubLessons) unsubLessons();
      if (unsubSolo) unsubSolo();
      if (unsubClass) unsubClass();

      unsubLessons = onSnapshot(lessonsCol(uid), (snap) => {
        myLessons = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderLessonList();
      });

      unsubSolo = onSnapshot(soloResultsCol(uid), (snap) => {
        soloResults = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSoloRows();
      });

      unsubClass = onSnapshot(classHistoryCol(uid), (snap) => {
        classHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderClassRows();
      });
    }

    function renderLessonList() {
      const wrap = $("lessonList");
      wrap.innerHTML = "";

      if (!myLessons.length) {
        wrap.innerHTML = `
          <div class="text-slate-400 font-bold text-sm bg-slate-50 border border-slate-200 rounded-xl p-4">
            –ù—è–º–∞ —É—Ä–æ—Ü–∏. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ù–æ–≤ —É—Ä–æ–∫‚Äù.
          </div>`;
        safeIcons();
        return;
      }

      const sorted = [...myLessons].sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0));
      for (const l of sorted) {
        const qCount = (l.questions||[]).length;
        const card = document.createElement("div");
        card.className = "bg-white border border-slate-200 rounded-2xl p-4 shadow-sm hover:shadow-md transition-all";
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-700 flex items-center justify-center">
              <i data-lucide="video" class="w-5 h-5"></i>
            </div>
            <div class="min-w-0 flex-1">
              <div class="font-black text-slate-800 truncate">${escapeHtml(l.title||"–ë–µ–∑ –∏–º–µ")}</div>
              <div class="text-xs font-bold text-slate-400 mt-1">${qCount} –≤—ä–ø—Ä–æ—Å–∞</div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-4 gap-2">
            <button data-act="start" class="py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-black text-xs">–°—Ç–∞—Ä—Ç</button>
            <button data-act="code" class="py-2 rounded-xl bg-amber-50 hover:bg-amber-100 text-amber-700 font-black text-xs">–ö–æ–¥</button>
            <button data-act="edit" class="py-2 rounded-xl bg-slate-50 hover:bg-slate-100 text-slate-700 font-black text-xs">‚úèÔ∏è</button>
            <button data-act="del" class="py-2 rounded-xl bg-rose-50 hover:bg-rose-100 text-rose-700 font-black text-xs">üóëÔ∏è</button>
          </div>
        `;

        const btns = card.querySelectorAll("button");
        btns[0].onclick = () => openLiveHostFromLesson(l.id);
        btns[1].onclick = () => showShareCode(l.id);
        btns[2].onclick = () => openEditor(l.id);
        btns[3].onclick = () => deleteLesson(l.id);

        wrap.appendChild(card);
      }
      safeIcons();
    }

    function renderSoloRows() {
      const tb = $("soloRows");
      tb.innerHTML = "";
      const sorted = [...soloResults].sort((a,b)=> (b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
      for (const r of sorted) {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50";
        tr.innerHTML = `
          <td class="p-3 font-bold">${escapeHtml(r.studentName||"")}</td>
          <td class="p-3 text-slate-600">${escapeHtml(r.quizTitle||"")}</td>
          <td class="p-3 text-slate-500 font-mono text-xs">${nowBg(r.timestamp)}</td>
          <td class="p-3 text-right"><span class="px-2 py-1 rounded-lg bg-indigo-50 text-indigo-700 font-black">${escapeHtml(r.score||"")}</span></td>
          <td class="p-3 text-center">
            <button class="p-2 rounded-lg text-rose-600 hover:bg-rose-50" title="–ò–∑—Ç—Ä–∏–π">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </td>
        `;
        tr.querySelector("button").onclick = async () => {
          if (!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç?")) return;
          await deleteDoc(doc(db, "artifacts", APP_ID, "users", me.uid, "solo_results", r.id));
        };
        tb.appendChild(tr);
      }
      safeIcons();
    }

    function renderClassRows() {
      const tb = $("classRows");
      tb.innerHTML = "";
      const sorted = [...classHistory].sort((a,b)=> (b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
      for (const r of sorted) {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50";
        tr.innerHTML = `
          <td class="p-3 text-slate-500 font-mono text-xs">${nowBg(r.timestamp)}</td>
          <td class="p-3 font-bold">${escapeHtml(r.quizTitle||"")}</td>
          <td class="p-3 font-mono text-slate-600">${escapeHtml(r.pin||"")}</td>
          <td class="p-3 text-center">
            <button class="px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-700 font-black text-xs">–í–∏–∂</button>
          </td>
          <td class="p-3 text-center">
            <button class="p-2 rounded-lg text-rose-600 hover:bg-rose-50" title="–ò–∑—Ç—Ä–∏–π">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </td>
        `;
        tr.querySelectorAll("button")[0].onclick = () => openClassModal(r.sessionId, r.quizTitle, r.pin);
        tr.querySelectorAll("button")[1].onclick = () => deleteClassSession(r.id, r.sessionId);
        tb.appendChild(tr);
      }
      safeIcons();
    }

    $("btnExportSoloExcel").onclick = () => {
      const rows = [...soloResults].map(r => ({
        Student: r.studentName || "",
        Lesson: r.quizTitle || "",
        Date: nowBg(r.timestamp),
        Score: r.score || ""
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Solo");
      XLSX.writeFile(wb, "solo_results.xlsx");
    };

    async function openClassModal(sessionId, title, pin) {
      $("classModalTitle").textContent = `${title||"–°–µ—Å–∏—è"} ‚Ä¢ –ü–ò–ù ${pin||""}`;
      $("classModalRows").innerHTML = `<tr><td class="p-4 text-slate-400" colspan="2">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ‚Ä¶</td></tr>`;
      $("modalClass").classList.remove("hidden");
      $("modalClass").classList.add("flex");

      try {
        const snap = await getDocs(participantsCol(sessionId));
        const arr = snap.docs.map(d => d.data()).sort((a,b)=>(b.score||0)-(a.score||0));
        if (arr.length===0) {
          $("classModalRows").innerHTML = `<tr><td class="p-6 text-slate-400" colspan="2">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</td></tr>`;
          return;
        }
        $("classModalRows").innerHTML = arr.map(p => `
          <tr>
            <td class="p-4 font-bold">${escapeHtml(p.name||"")}</td>
            <td class="p-4 text-right font-black text-indigo-700">${p.score||0}</td>
          </tr>
        `).join("");
      } catch {
        $("classModalRows").innerHTML = `<tr><td class="p-6 text-rose-600" colspan="2">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</td></tr>`;
      }
    }

    $("btnCloseClassModal").onclick = () => {
      $("modalClass").classList.add("hidden");
      $("modalClass").classList.remove("flex");
    };

    async function deleteClassSession(historyId, sessionId) {
      if (!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Å–µ—Å–∏—è—Ç–∞ –∏ —É—á–∞—Å—Ç–Ω–∏—Ü–∏—Ç–µ?")) return;
      await deleteDoc(doc(db, "artifacts", APP_ID, "users", me.uid, "class_history", historyId));
      try {
        await deleteDoc(sessionDoc(sessionId));
        const snap = await getDocs(participantsCol(sessionId));
        for (const d of snap.docs) await deleteDoc(d.ref);
      } catch {}
      toast("–°–µ—Å–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.", "info");
    }

    async function deleteLesson(id) {
      if (!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫?")) return;
      await deleteDoc(doc(db, "artifacts", APP_ID, "users", me.uid, "my_quizzes", id));
      toast("–ò–∑—Ç—Ä–∏—Ç–æ.", "info");
    }

    function showShareCode(lessonId) {
      const l = myLessons.find(x=>x.id===lessonId);
      if (!l) return;
      const payload = { title: l.title, v: l.v, q: (l.questions||[]), ownerId: me.uid };
      const code = encodeLessonCode(payload);
      navigator.clipboard.writeText(code).then(
        () => toast("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω.", "info"),
        () => toast("–ö–æ–¥ (–∫–æ–ø–∏—Ä–∞–π —Ä—ä—á–Ω–æ): " + code, "info")
      );
    }

    $("btnImportLesson").onclick = async () => {
      const code = prompt("–ü–æ—Å—Ç–∞–≤–∏ –∫–æ–¥–∞ –∑–∞ –∏–º–ø–æ—Ä—Ç —Ç—É–∫:");
      if (!code) return;
      const dec = decodeLessonCode(code);
      if (!dec || !dec.v) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥.", "error");
      await addDoc(lessonsCol(me.uid), {
        title: dec.title || "–ò–º–ø–æ—Ä—Ç",
        v: dec.v,
        questions: dec.q || [],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      toast("–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ.", "info");
    };

    /* ---------- Editor ---------- */
    const Q_TYPES = [
      { v:"single", label:"–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω" },
      { v:"multiple", label:"–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω–∏" },
      { v:"boolean", label:"–í—è—Ä–Ω–æ/–ì—Ä–µ—à–Ω–æ" },
      { v:"ordering", label:"–ü–æ–¥—Ä–µ–∂–¥–∞–Ω–µ" },
      { v:"numeric_slider", label:"–ü–ª—ä–∑–≥–∞—á (—á–∏—Å–ª–æ)" },
      { v:"timeline_slider", label:"–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è (–ø–ª—ä–∑–≥–∞—á)" },
    ];
    const editorState = { title:"", v:"", questions:[] };
    let editingLessonId = null;
    let editorPlayer = null;
    let editorTick = null;

    $("mType").innerHTML = Q_TYPES.map(t=>`<option value="${t.v}">${t.label}</option>`).join("");

    function startEditorTick() {
      stopEditorTick();
      editorTick = setInterval(() => {
        if (!editorPlayer || typeof editorPlayer.getCurrentTime !== "function") return;
        $("editorClock").textContent = fmtTime(editorPlayer.getCurrentTime());
      }, 250);
    }
    function stopEditorTick() { if (editorTick) clearInterval(editorTick); editorTick = null; }

    function initEditorPlayer(videoId) {
      destroyPlayer(editorPlayer);
      $("editorPlayer").innerHTML = "";
      editorPlayer = new YT.Player("editorPlayer", {
        videoId,
        width: "100%", height: "100%",
        playerVars: { autoplay: 0, controls: 1, rel: 0, modestbranding: 1 },
        events: { onReady: () => startEditorTick() }
      });
    }

    function renderEditorQuestions() {
      const wrap = $("qList");
      wrap.innerHTML = "";
      const qs = editorState.questions || [];
      if (!qs.length) {
        wrap.innerHTML = `<div class="text-slate-400 font-bold text-sm">–ù—è–º–∞ –≤—ä–ø—Ä–æ—Å–∏.</div>`;
        return;
      }
      qs.forEach((q, i) => {
        const row = document.createElement("div");
        row.className = "bg-white border border-slate-200 rounded-xl p-3 shadow-sm flex items-center justify-between gap-3";
        row.innerHTML = `
          <div class="min-w-0">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-lg bg-indigo-50 text-indigo-700 font-mono font-black text-xs">${fmtTime(q.time)}</span>
              <span class="font-black text-slate-800 truncate">${escapeHtml(q.text)}</span>
            </div>
            <div class="text-xs font-bold text-slate-400 mt-1">${q.type} ‚Ä¢ ${q.points||1} —Ç.</div>
          </div>
          <div class="flex gap-2 shrink-0">
            <button class="p-2 rounded-lg bg-slate-50 hover:bg-slate-100 text-slate-600" title="–†–µ–¥–∞–∫—Ü–∏—è">‚úèÔ∏è</button>
            <button class="p-2 rounded-lg bg-rose-50 hover:bg-rose-100 text-rose-600" title="–ò–∑—Ç—Ä–∏–π">üóëÔ∏è</button>
          </div>
        `;
        row.querySelectorAll("button")[0].onclick = () => openQuestionModal(q.time, i);
        row.querySelectorAll("button")[1].onclick = () => {
          if (!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å?")) return;
          editorState.questions.splice(i,1);
          renderEditorQuestions();
        };
        wrap.appendChild(row);
      });
    }

    function openEditor(id) {
      const l = myLessons.find(x=>x.id===id);
      if (!l) return;
      editingLessonId = id;
      editorState.title = l.title || "–ë–µ–∑ –∏–º–µ";
      editorState.v = l.v || "";
      editorState.questions = JSON.parse(JSON.stringify(l.questions||[]));
      editorState.questions.sort((a,b)=>(a.time||0)-(b.time||0));
      $("editorLessonTitle").textContent = editorState.title;
      $("editorTitleInput").value = editorState.title;
      $("editorYtUrl").value = editorState.v ? ("https://youtu.be/" + editorState.v) : "";
      renderEditorQuestions();

      if (!editorState.v) {
        $("editorOverlay").classList.remove("hidden");
        destroyPlayer(editorPlayer); editorPlayer = null;
      } else {
        $("editorOverlay").classList.add("hidden");
        YouTube.ensure().then(()=>initEditorPlayer(editorState.v)).catch(()=>toast("YouTube API –±–ª–æ–∫–∏—Ä–∞–Ω–æ.", "error"));
      }
      showScreen("editor");
    }

    $("btnNewLesson").onclick = () => {
      editingLessonId = null;
      editorState.title = "–ù–æ–≤ —É—Ä–æ–∫";
      editorState.v = "";
      editorState.questions = [];
      $("editorLessonTitle").textContent = editorState.title;
      $("editorTitleInput").value = editorState.title;
      $("editorYtUrl").value = "";
      $("editorOverlay").classList.remove("hidden");
      destroyPlayer(editorPlayer); editorPlayer=null;
      renderEditorQuestions();
      showScreen("editor");
    };

    $("btnBackToTeacher").onclick = () => {
      stopEditorTick();
      destroyPlayer(editorPlayer); editorPlayer=null;
      showScreen("teacher");
    };

    $("btnLoadVideo").onclick = async () => {
      const id = ytIdFromAny($("editorYtUrl").value);
      if (!id) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω YouTube –ª–∏–Ω–∫/ID.", "error");
      editorState.title = ($("editorTitleInput").value.trim() || "–ë–µ–∑ –∏–º–µ");
      editorState.v = id;
      $("editorLessonTitle").textContent = editorState.title;

      try { await YouTube.ensure(); }
      catch { return toast("YouTube API –µ –±–ª–æ–∫–∏—Ä–∞–Ω–æ.", "error"); }

      $("editorOverlay").classList.add("hidden");
      initEditorPlayer(id);
      toast("–í–∏–¥–µ–æ –∑–∞—Ä–µ–¥–µ–Ω–æ.", "info");
    };

    $("btnAddQuestion").onclick = () => {
      if (!editorPlayer || typeof editorPlayer.getCurrentTime !== "function") return toast("–ü—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–∏ –≤–∏–¥–µ–æ.", "warn");
      openQuestionModal(Math.floor(editorPlayer.getCurrentTime()), null);
    };

    $("btnSaveLesson").onclick = async () => {
      if (!me || !isTeacher) return toast("–ù–µ —Å—Ç–µ –≤ —É—á–∏—Ç–µ–ª—Å–∫–∏ —Ä–µ–∂–∏–º.", "error");
      if (!editorState.v) return toast("–ü—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–∏ –≤–∏–¥–µ–æ.", "warn");
      if (!editorState.questions.length) return toast("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ –µ–¥–∏–Ω –≤—ä–ø—Ä–æ—Å.", "warn");

      const payload = {
        title: editorState.title || "–ë–µ–∑ –∏–º–µ",
        v: editorState.v,
        questions: editorState.questions,
        updatedAt: serverTimestamp()
      };

      if (editingLessonId) {
        await updateDoc(doc(db,"artifacts",APP_ID,"users",me.uid,"my_quizzes",editingLessonId), payload);
        toast("–£—Ä–æ–∫—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω.", "info");
      } else {
        payload.createdAt = serverTimestamp();
        await addDoc(lessonsCol(me.uid), payload);
        toast("–£—Ä–æ–∫—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω.", "info");
      }
      showScreen("teacher");
    };

    // Question modal
    const modalQ = $("modalQ");
    let editingQIndex = null;
    let modalSec = 0;

    function openQuestionModal(sec, idx) {
      modalSec = sec;
      editingQIndex = idx; // null => new
      $("mSec").textContent = String(sec);
      const q = (idx!=null) ? editorState.questions[idx] : null;

      $("mText").value = q?.text || "";
      $("mType").value = q?.type || "single";
      $("mPoints").value = q?.points || 1;
      renderModalDynamic(q);

      modalQ.classList.remove("hidden");
      modalQ.classList.add("flex");
      try { editorPlayer?.pauseVideo(); } catch {}
      safeIcons();
    }

    function closeQModal() {
      modalQ.classList.add("hidden");
      modalQ.classList.remove("flex");
    }
    $("btnCloseModal").onclick = closeQModal;
    $("mType").onchange = () => renderModalDynamic(null);
    modalQ.addEventListener("click",(e)=>{ if (e.target===modalQ) closeQModal(); });

    function renderModalDynamic(existing) {
      const type = $("mType").value;
      const box = $("mDynamic");
      box.innerHTML = "";

      const makeOptions4 = (opts=[]) => `
        <div class="grid grid-cols-1 gap-2">
          ${[0,1,2,3].map(i=>`
            <input data-opt="${i}" class="p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500"
              placeholder="–û—Ç–≥–æ–≤–æ—Ä ${i+1}" value="${(opts[i]||"").replaceAll('"',"&quot;")}">
          `).join("")}
        </div>`;

      if (type==="single") {
        box.innerHTML = `
          <div class="space-y-3">
            <div class="font-black text-sm">–û—Ç–≥–æ–≤–æ—Ä–∏</div>
            ${makeOptions4(existing?.options||[])}
            <div>
              <div class="text-xs font-black text-slate-400 uppercase">–í–µ—Ä–µ–Ω –∏–Ω–¥–µ–∫—Å (0-3)</div>
              <input id="mCorrectIdx" type="number" min="0" max="3" value="${existing?.correct ?? 0}"
                class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
          </div>`;
      } else if (type==="multiple") {
        box.innerHTML = `
          <div class="space-y-3">
            <div class="font-black text-sm">–û—Ç–≥–æ–≤–æ—Ä–∏</div>
            ${makeOptions4(existing?.options||[])}
            <div class="text-xs font-black text-slate-400 uppercase">–í–µ—Ä–Ω–∏ –∏–Ω–¥–µ–∫—Å–∏ (–ø—Ä–∏–º–µ—Ä: 0,2)</div>
            <input id="mCorrectMany" value="${(existing?.correct||[]).join(",")}"
              class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
          </div>`;
      } else if (type==="boolean") {
        const val = (existing?.correct === false) ? "false" : "true";
        box.innerHTML = `
          <div class="space-y-3">
            <div class="font-black text-sm">–í–µ—Ä–Ω–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä</div>
            <div class="flex gap-3">
              <label class="flex-1 p-3 rounded-xl border border-slate-200 font-black flex items-center justify-center gap-2 cursor-pointer">
                <input type="radio" name="mBool" value="true" ${val==="true"?"checked":""}> –í–Ø–†–ù–û
              </label>
              <label class="flex-1 p-3 rounded-xl border border-slate-200 font-black flex items-center justify-center gap-2 cursor-pointer">
                <input type="radio" name="mBool" value="false" ${val==="false"?"checked":""}> –ì–†–ï–®–ù–û
              </label>
            </div>
          </div>`;
      } else if (type==="ordering") {
        box.innerHTML = `
          <div class="space-y-3">
            <div class="font-black text-sm">–ï–ª–µ–º–µ–Ω—Ç–∏ –∑–∞ –ø–æ–¥—Ä–µ–∂–¥–∞–Ω–µ (–≤ –ø—Ä–∞–≤–∏–ª–µ–Ω —Ä–µ–¥)</div>
            ${makeOptions4(existing?.options||[])}
            <div class="text-xs text-slate-500 font-bold">* –í –∏–≥—Ä–∞—Ç–∞ —É—á–µ–Ω–∏–∫—ä—Ç –≥–∏ ‚Äú–Ω–∞—Ç–∏—Å–∫–∞‚Äù –≤ —Ä–µ–¥.</div>
          </div>`;
      } else if (type==="numeric_slider" || type==="timeline_slider") {
        box.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <div class="text-xs font-black text-slate-400 uppercase">–ú–∏–Ω–∏–º—É–º</div>
              <input id="mMin" type="number" value="${existing?.min ?? 0}" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
            <div>
              <div class="text-xs font-black text-slate-400 uppercase">–ú–∞–∫—Å–∏–º—É–º</div>
              <input id="mMax" type="number" value="${existing?.max ?? 100}" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
            <div>
              <div class="text-xs font-black text-slate-400 uppercase">–°—Ç—ä–ø–∫–∞</div>
              <input id="mStep" type="number" value="${existing?.step ?? 1}" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
            <div>
              <div class="text-xs font-black text-slate-400 uppercase">–¢–æ–ª–µ—Ä–∞–Ω—Å</div>
              <input id="mTol" type="number" value="${existing?.tolerance ?? 0}" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
            <div class="md:col-span-2">
              <div class="text-xs font-black text-slate-400 uppercase">–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</div>
              <input id="mCorrectNum" type="number" value="${existing?.correct ?? 0}" class="w-full mt-2 p-3 rounded-xl border border-slate-200 font-bold outline-none focus:border-indigo-500">
            </div>
          </div>`;
      }
    }

    $("btnSaveQ").onclick = () => {
      const text = $("mText").value.trim();
      const type = $("mType").value;
      const points = Math.max(1, Number($("mPoints").value||1));
      if (!text) return toast("–í—ä–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç.", "warn");

      const base = { time: modalSec, text, type, points };
      let q = null;

      if (type==="single") {
        const opts = [...modalQ.querySelectorAll("[data-opt]")].map(i=>i.value.trim());
        if (opts.some(o=>!o)) return toast("–ü–æ–ø—ä–ª–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ.", "warn");
        q = { ...base, options: opts, correct: Number($("mCorrectIdx").value||0) };
      } else if (type==="multiple") {
        const opts = [...modalQ.querySelectorAll("[data-opt]")].map(i=>i.value.trim());
        if (opts.some(o=>!o)) return toast("–ü–æ–ø—ä–ª–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ.", "warn");
        const arr = ($("mCorrectMany").value||"").split(",").map(x=>Number(x.trim())).filter(x=>Number.isFinite(x));
        q = { ...base, options: opts, correct: [...new Set(arr)] };
      } else if (type==="boolean") {
        const v = modalQ.querySelector('input[name="mBool"]:checked')?.value || "true";
        q = { ...base, correct: (v==="true") };
      } else if (type==="ordering") {
        const opts = [...modalQ.querySelectorAll("[data-opt]")].map(i=>i.value.trim()).filter(Boolean);
        if (opts.length < 2) return toast("–î–æ–±–∞–≤–∏ –ø–æ–Ω–µ 2 –µ–ª–µ–º–µ–Ω—Ç–∞.", "warn");
        q = { ...base, options: opts, correct: opts };
      } else if (type==="numeric_slider" || type==="timeline_slider") {
        q = {
          ...base,
          min: Number($("mMin").value||0),
          max: Number($("mMax").value||100),
          step: Number($("mStep").value||1),
          tolerance: Number($("mTol").value||0),
          correct: Number($("mCorrectNum").value||0),
        };
      }

      if (editingQIndex!=null) editorState.questions[editingQIndex] = q;
      else {
        const idx = editorState.questions.findIndex(x=>x.time===modalSec);
        if (idx>=0) editorState.questions[idx]=q;
        else editorState.questions.push(q);
      }

      editorState.questions.sort((a,b)=>(a.time||0)-(b.time||0));
      renderEditorQuestions();
      closeQModal();
      toast("–ó–∞–ø–∞–∑–µ–Ω–æ.", "info");
    };

    /* ---------- SOLO mode ---------- */
    let soloPlayer = null, soloTick = null;
    let soloLesson = null;
    let soloIndex = -1, soloScore = 0, soloMax = 0, soloSelected = null;
    let soloName = "", soloSop = false, soloDiscussion = false, soloFinished = false;

    $("btnSoloStart").onclick = async () => {
      const code = $("soloCode").value.trim();
      const name = $("soloName").value.trim() || "–ê–Ω–æ–Ω–∏–º–µ–Ω";
      if (!code) return toast("–í—ä–≤–µ–¥–∏ –∫–æ–¥.", "warn");

      const dec = decodeLessonCode(code);
      if (!dec || !dec.v || !Array.isArray(dec.q)) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥.", "error");

      if (!auth.currentUser) { try { await signInAnonymously(auth); } catch {} }

      soloLesson = dec;
      soloName = name;
      soloSop = $("soloSOP").checked;
      soloDiscussion = $("soloDiscussion").checked;
      soloIndex = -1;
      soloScore = 0;
      soloSelected = null;
      soloFinished = false;
      soloMax = (dec.q||[]).reduce((a,b)=>a + (b.points||1), 0);

      try { await YouTube.ensure(); }
      catch { return toast("YouTube API –µ –±–ª–æ–∫–∏—Ä–∞–Ω–æ (AdBlock?).", "error"); }

      destroyPlayer(soloPlayer);
      $("soloPlayer").innerHTML = "";
      soloPlayer = new YT.Player("soloPlayer", {
        videoId: dec.v,
        width: "100%", height: "100%",
        playerVars: { autoplay: 1, controls: 1, rel: 0, modestbranding: 1 },
        events: { onReady: () => startSoloTick() }
      });

      showScreen("soloPlay");
    };

    function startSoloTick() {
      stopSoloTick();
      soloTick = setInterval(() => {
        if (!soloPlayer || typeof soloPlayer.getCurrentTime !== "function" || !soloLesson) return;
        const t = Math.floor(soloPlayer.getCurrentTime() || 0);

        const next = soloLesson.q.findIndex((q, idx) => idx > soloIndex && t >= q.time);
        if (next !== -1) {
          soloIndex = next;
          triggerSoloQuestion(soloLesson.q[next], next);
        }

        try {
          const dur = soloPlayer.getDuration ? soloPlayer.getDuration() : 0;
          if (dur && t >= dur-1) finishSolo();
        } catch {}
      }, 250);
    }
    function stopSoloTick(){ if (soloTick) clearInterval(soloTick); soloTick=null; }

    function triggerSoloQuestion(q) {
      try { soloPlayer.pauseVideo(); } catch {}
      $("soloOverlay").classList.remove("hidden");
      $("soloOverlay").classList.add("flex");

      const qText = $("soloQText");
      qText.textContent = q.text || "";
      qText.classList.toggle("sop-text", !!soloSop);

      $("btnSpeak").classList.toggle("hidden", !soloSop);
      if (soloSop) speakBG(q.text || "");

      soloSelected = null;
      $("btnSoloConfirm").classList.add("hidden");
      const optWrap = $("soloOptions");
      optWrap.innerHTML = "";

      const optBtnClass = soloSop
        ? "sop-btn w-full bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl text-white font-bold text-left transition-all"
        : "w-full p-5 bg-white/10 hover:bg-white/20 border-2 border-white/20 rounded-2xl text-white font-bold text-xl text-left transition-all";

      if (q.type==="single" || q.type==="boolean") {
        const opts = q.type==="boolean" ? ["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"] : (q.options||[]);
        opts.forEach((o, i) => {
          const b = document.createElement("button");
          b.className = optBtnClass;
          b.textContent = o;
          b.onclick = () => {
            [...optWrap.querySelectorAll("button")].forEach(x=>x.classList.remove("border-indigo-400","bg-indigo-600/30"));
            b.classList.add("border-indigo-400","bg-indigo-600/30");
            soloSelected = (q.type==="boolean") ? (i===0) : i;
            $("btnSoloConfirm").classList.remove("hidden");
          };
          optWrap.appendChild(b);
        });
      } else if (q.type==="multiple") {
        const opts = q.options||[];
        const chosen = new Set();
        opts.forEach((o, i) => {
          const b = document.createElement("button");
          b.className = optBtnClass;
          b.textContent = o;
          b.onclick = () => {
            if (chosen.has(i)) { chosen.delete(i); b.classList.remove("border-indigo-400","bg-indigo-600/30"); }
            else { chosen.add(i); b.classList.add("border-indigo-400","bg-indigo-600/30"); }
            soloSelected = [...chosen];
            $("btnSoloConfirm").classList.remove("hidden");
          };
          optWrap.appendChild(b);
        });
      } else if (q.type==="ordering") {
        const opts = [...(q.options||[])];
        const picked = [];
        opts.forEach((o) => {
          const b = document.createElement("button");
          b.className = optBtnClass;
          b.textContent = o;
          b.onclick = () => {
            if (picked.includes(o)) return;
            picked.push(o);
            b.classList.add("border-indigo-400","bg-indigo-600/30");
            soloSelected = picked;
            $("btnSoloConfirm").classList.remove("hidden");
          };
          optWrap.appendChild(b);
        });
      } else if (q.type==="numeric_slider" || q.type==="timeline_slider") {
        const min = Number(q.min ?? 0);
        const max = Number(q.max ?? 100);
        const step = Number(q.step ?? 1);
        const start = Math.round((min+max)/2);

        optWrap.innerHTML = `
          <div class="w-full bg-white/10 border border-white/20 rounded-2xl p-6 text-white">
            <input id="soloRange" type="range" min="${min}" max="${max}" step="${step}" value="${start}" class="w-full">
            <div class="mt-4 text-5xl font-black" id="soloRangeVal">${start}</div>
          </div>
        `;
        const r = $("soloRange");
        r.oninput = () => $("soloRangeVal").textContent = r.value;
        $("btnSoloConfirm").classList.remove("hidden");
      } else {
        optWrap.innerHTML = `<div class="text-white font-bold">–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ç–∏–ø.</div>`;
      }

      $("btnSoloConfirm").onclick = () => confirmSoloAnswer(q);
    }

    $("btnSpeak").onclick = () => speakBG($("soloQText").textContent);

    function confirmSoloAnswer(q) {
      let ok = false;

      if (q.type==="single" || q.type==="boolean") ok = (soloSelected === q.correct);
      else if (q.type==="multiple") {
        const a = new Set((soloSelected||[]).map(Number));
        const b = new Set((q.correct||[]).map(Number));
        ok = (a.size===b.size) && [...a].every(x=>b.has(x));
      } else if (q.type==="ordering") {
        const a = (soloSelected||[]);
        const b = (q.correct||q.options||[]);
        ok = a.length===b.length && a.every((v,i)=>v===b[i]);
      } else if (q.type==="numeric_slider" || q.type==="timeline_slider") {
        const val = Number($("soloRange").value);
        ok = Math.abs(val - Number(q.correct||0)) <= Number(q.tolerance||0);
      }

      if (ok) { soloScore += (q.points||1); toast("–í–Ø–†–ù–û! üéâ", "info"); }
      else toast("–ì–†–ï–®–ù–û‚Ä¶", "warn");

      $("soloOverlay").classList.add("hidden");
      $("soloOverlay").classList.remove("flex");
      try { window.speechSynthesis?.cancel(); } catch {}

      setTimeout(() => { try { soloPlayer.playVideo(); } catch {} }, 600);
    }

    async function finishSolo() {
      if (soloFinished) return;
      soloFinished = true;
      stopSoloTick();
      destroyPlayer(soloPlayer);
      soloPlayer = null;

      $("soloScore").textContent = `${soloScore} / ${soloMax}`;
      showScreen("soloFinish");

      if (soloDiscussion) return;

      const teacherId = soloLesson?.ownerId;
      if (!teacherId || !auth.currentUser) return;

      try {
        await addDoc(soloResultsCol(teacherId), {
          studentName: soloName,
          quizTitle: (soloLesson.title||"") + (soloSop ? " (–°–û–ü)" : ""),
          score: `${soloScore}/${soloMax}`,
          timestamp: serverTimestamp(),
          uid: auth.currentUser.uid
        });
      } catch {}
    }

    $("btnSoloHome").onclick = () => {
      try { window.speechSynthesis?.cancel(); } catch {}
      showScreen("welcome");
    };

    /* ---------- LIVE ---------- */
    let hostPlayer=null, hostTick=null;
    let livePin="", liveSessionId="", liveLesson=null, liveActiveIdx=-1;
    let unsubParticipants=null, unsubSession=null;
    let liveParticipants=[];
    let liveClientScore=0, liveClientSelected=null, liveClientAnsweredIdx=-1, liveClientAvatar="üòé";

    async function openLiveHostFromLesson(lessonId) {
      const l = myLessons.find(x=>x.id===lessonId);
      if (!l) return;

      liveLesson = { title: l.title, v: l.v, q: (l.questions||[]).slice(), ownerId: me.uid };
      liveLesson.q.sort((a,b)=>(a.time||0)-(b.time||0));
      liveActiveIdx = -1;
      liveParticipants = [];

      livePin = String(Math.floor(1000 + Math.random()*9000));
      liveSessionId = livePin;

      $("hostPin").textContent = livePin;
      $("hostCount").textContent = "0";
      $("hostOverlayWaiting").classList.remove("hidden");
      $("hostOverlayQuestion").classList.add("hidden");
      $("btnHostResume").classList.add("hidden");

      await setDoc(sessionDoc(liveSessionId), {
        pin: livePin,
        hostId: me.uid,
        quizTitle: liveLesson.title,
        activeQ: -1,
        qData: null,
        status: "waiting",
        createdAt: serverTimestamp()
      });

      if (unsubParticipants) unsubParticipants();
      unsubParticipants = onSnapshot(participantsCol(liveSessionId), (snap) => {
        liveParticipants = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        $("hostCount").textContent = String(liveParticipants.length);
        renderHostRanking();
      });

      showScreen("liveHost");

      try { await YouTube.ensure(); }
      catch { return toast("YouTube API –±–ª–æ–∫–∏—Ä–∞–Ω–æ.", "error"); }

      destroyPlayer(hostPlayer);
      $("hostPlayer").innerHTML = "";
      hostPlayer = new YT.Player("hostPlayer", {
        videoId: liveLesson.v,
        width: "100%", height: "100%",
        playerVars: { autoplay: 0, controls: 1, rel: 0, modestbranding: 1 },
      });
    }

    $("btnHostStart").onclick = async () => {
      if (!hostPlayer || !liveLesson) return;
      $("hostOverlayWaiting").classList.add("hidden");
      try { hostPlayer.playVideo(); } catch {}
      await updateDoc(sessionDoc(liveSessionId), { status: "playing" });
      startHostTick();
    };

    $("btnHostResume").onclick = async () => {
      $("btnHostResume").classList.add("hidden");
      $("hostOverlayQuestion").classList.add("hidden");
      try { hostPlayer.playVideo(); } catch {}
      await updateDoc(sessionDoc(liveSessionId), { status: "playing" });
    };

    $("btnHostEnd").onclick = async () => {
      if (!confirm("–ö—Ä–∞–π –Ω–∞ —Å–µ—Å–∏—è—Ç–∞?")) return;
      await updateDoc(sessionDoc(liveSessionId), { status: "finished" });

      try {
        await addDoc(classHistoryCol(me.uid), {
          sessionId: liveSessionId,
          pin: livePin,
          quizTitle: liveLesson?.title || "",
          timestamp: serverTimestamp()
        });
      } catch {}

      stopHostTick();
      destroyPlayer(hostPlayer);
      hostPlayer=null;
      showScreen("teacher");
    };

    function startHostTick() {
      stopHostTick();
      hostTick = setInterval(async () => {
        if (!hostPlayer || !liveLesson) return;
        const t = Math.floor(hostPlayer.getCurrentTime() || 0);
        const idx = liveLesson.q.findIndex((q)=> Math.abs((q.time||0) - t) <= 1);
        if (idx !== -1 && idx !== liveActiveIdx) {
          liveActiveIdx = idx;
          try { hostPlayer.pauseVideo(); } catch {}
          $("hostOverlayQuestion").classList.remove("hidden");
          $("btnHostResume").classList.remove("hidden");

          await updateDoc(sessionDoc(liveSessionId), {
            activeQ: idx,
            qData: liveLesson.q[idx],
            status: "active"
          });
        }
      }, 800);
    }
    function stopHostTick(){ if (hostTick) clearInterval(hostTick); hostTick=null; }

    function renderHostRanking() {
      const tb = $("hostRankRows");
      const sorted = [...liveParticipants].sort((a,b)=>(b.score||0)-(a.score||0));
      tb.innerHTML = sorted.map((p,i)=>`
        <tr class="bg-white border border-slate-200 rounded-xl shadow-sm">
          <td class="p-3 font-black text-slate-400 w-12">#${i+1}</td>
          <td class="p-3 font-bold text-slate-800">
            <span class="text-xl mr-2">${escapeHtml(p.avatar||"üòé")}</span>${escapeHtml(p.name||"")}
          </td>
          <td class="p-3 text-right font-black text-indigo-700">${p.score||0}</td>
        </tr>
      `).join("");
    }

    $("btnHostExportExcel").onclick = () => {
      const rows = [...liveParticipants].map(p => ({ Name: p.name||"", Score: p.score||0 }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Class");
      XLSX.writeFile(wb, `class_${livePin}.xlsx`);
    };

    $("btnHostExportPDF").onclick = () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      pdf.text(`–†–µ–∑—É–ª—Ç–∞—Ç–∏ ‚Ä¢ –ü–ò–ù ${livePin}`, 10, 12);
      const rows = [...liveParticipants].sort((a,b)=>(b.score||0)-(a.score||0)).map(p => [p.name||"", String(p.score||0)]);
      pdf.autoTable({ head:[["–£—á–µ–Ω–∏–∫","–¢–æ—á–∫–∏"]], body: rows, startY: 18 });
      pdf.save(`class_${livePin}.pdf`);
    };

    /* ---------- Live client ---------- */
    $("btnLiveJoin").onclick = async () => {
      const pin = $("livePin").value.trim();
      const name = $("liveName").value.trim();
      if (!pin || !name) return toast("–ü–æ–ø—ä–ª–Ω–∏ –∏–º–µ –∏ –ü–ò–ù.", "warn");

      if (!auth.currentUser) { try { await signInAnonymously(auth); } catch {} }

      const snap = await getDoc(sessionDoc(pin));
      if (!snap.exists()) return toast("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ü–ò–ù.", "error");

      liveSessionId = pin;
      livePin = pin;
      liveClientAvatar = AVATARS[Math.floor(Math.random()*AVATARS.length)];
      liveClientScore = 0;
      liveClientSelected = null;
      liveClientAnsweredIdx = -1;

      $("clientName").textContent = name;
      $("clientAvatar").textContent = liveClientAvatar;

      await setDoc(participantDoc(pin, auth.currentUser.uid), {
        name, avatar: liveClientAvatar, score: 0, joinedAt: serverTimestamp()
      }, { merge: true });

      if (unsubSession) unsubSession();
      unsubSession = onSnapshot(sessionDoc(pin), (s) => {
        const d = s.data();
        if (!d) return;

        if (d.status === "finished") return showClientFinished();
        if (d.status === "active" && d.activeQ !== liveActiveIdx) {
          liveActiveIdx = d.activeQ;
          return showClientQuestion(d.qData);
        }
        return showClientWaiting();
      });

      showScreen("liveClient");
      showClientWaiting();
    };

    function showClientWaiting() {
      $("clientWaiting").classList.remove("hidden");
      $("clientQuestion").classList.add("hidden");
      $("clientFinished").classList.add("hidden");
      $("clientEmoji").textContent = "üëÄ";
      $("clientTitle").textContent = "–ò–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å‚Ä¶";
      $("clientSubtitle").textContent = "–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è.";
    }

    function showClientFinished() {
      $("clientWaiting").classList.add("hidden");
      $("clientQuestion").classList.add("hidden");
      $("clientFinished").classList.remove("hidden");
      $("clientFinalScore").textContent = String(liveClientScore);
    }

    $("btnClientExit").onclick = () => {
      if (unsubSession) unsubSession();
      unsubSession=null;
      showScreen("welcome");
    };

    function showClientQuestion(q) {
      if (!q) return;
      $("clientWaiting").classList.add("hidden");
      $("clientQuestion").classList.remove("hidden");
      $("clientFinished").classList.add("hidden");

      $("clientQText").textContent = q.text || "";
      const wrap = $("clientOptions");
      wrap.innerHTML = "";
      liveClientSelected = null;
      $("btnClientConfirm").classList.add("hidden");

      if (q.type==="single" || q.type==="boolean") {
        const opts = q.type==="boolean" ? ["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"] : (q.options||[]);
        opts.forEach((o, i) => {
          const b = document.createElement("button");
          b.className = "option-btn w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-black text-lg text-slate-700 shadow-sm text-left hover:border-indigo-500 hover:bg-indigo-50 transition-all";
          b.textContent = o;
          b.onclick = () => {
            [...wrap.querySelectorAll("button")].forEach(x=>x.classList.remove("border-indigo-600","bg-indigo-50"));
            b.classList.add("border-indigo-600","bg-indigo-50");
            liveClientSelected = (q.type==="boolean") ? (i===0) : i;
            $("btnClientConfirm").classList.remove("hidden");
          };
          wrap.appendChild(b);
        });
      } else if (q.type==="multiple") {
        const opts = q.options||[];
        const chosen = new Set();
        opts.forEach((o, i) => {
          const b = document.createElement("button");
          b.className = "option-btn w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-black text-lg text-slate-700 shadow-sm text-left hover:border-indigo-500 hover:bg-indigo-50 transition-all";
          b.textContent = o;
          b.onclick = () => {
            if (chosen.has(i)) { chosen.delete(i); b.classList.remove("border-indigo-600","bg-indigo-50"); }
            else { chosen.add(i); b.classList.add("border-indigo-600","bg-indigo-50"); }
            liveClientSelected = [...chosen];
            $("btnClientConfirm").classList.remove("hidden");
          };
          wrap.appendChild(b);
        });
      } else if (q.type==="numeric_slider" || q.type==="timeline_slider") {
        const min = Number(q.min ?? 0);
        const max = Number(q.max ?? 100);
        const step = Number(q.step ?? 1);
        const start = Math.round((min+max)/2);

        wrap.innerHTML = `
          <div class="w-full bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <input id="clientRange" type="range" min="${min}" max="${max}" step="${step}" value="${start}" class="w-full">
            <div id="clientRangeVal" class="text-indigo-600 text-6xl font-black mt-6 text-center">${start}</div>
          </div>
        `;
        const r = $("clientRange");
        r.oninput = () => $("clientRangeVal").textContent = r.value;
        $("btnClientConfirm").classList.remove("hidden");
      } else {
        wrap.innerHTML = `<div class="text-center text-slate-500 font-bold mt-8">–¢–æ–∑–∏ —Ç–∏–ø –≤—ä–ø—Ä–æ—Å –Ω–µ –µ –∞–∫—Ç–∏–≤–µ–Ω –∑–∞ live (–≤ —Ç–∞–∑–∏ –≤–µ—Ä—Å–∏—è).</div>`;
      }

      $("btnClientConfirm").onclick = () => confirmClientAnswer(q);
    }

    async function confirmClientAnswer(q) {
      if (liveClientAnsweredIdx === liveActiveIdx) return;
      liveClientAnsweredIdx = liveActiveIdx;

      let ok = false;
      if (q.type==="single" || q.type==="boolean") ok = (liveClientSelected === q.correct);
      else if (q.type==="multiple") {
        const a = new Set((liveClientSelected||[]).map(Number));
        const b = new Set((q.correct||[]).map(Number));
        ok = (a.size===b.size) && [...a].every(x=>b.has(x));
      } else if (q.type==="numeric_slider" || q.type==="timeline_slider") {
        const val = Number($("clientRange").value);
        ok = Math.abs(val - Number(q.correct||0)) <= Number(q.tolerance||0);
      }

      if (ok) liveClientScore += (q.points||1);

      $("clientQuestion").classList.add("hidden");
      $("clientWaiting").classList.remove("hidden");
      $("clientEmoji").textContent = ok ? "üéâ" : "üòì";
      $("clientTitle").textContent = ok ? "–í–Ø–†–ù–û!" : "–ì–†–ï–®–ù–û‚Ä¶";
      $("clientSubtitle").textContent = "–ò–∑—á–∞–∫–∞–π —Å–ª–µ–¥–≤–∞—â–∏—è –≤—ä–ø—Ä–æ—Å‚Ä¶";

      const up = { score: liveClientScore };
      up[`answers.${liveActiveIdx}`] = ok;

      try { await updateDoc(participantDoc(liveSessionId, auth.currentUser.uid), up); } catch {}

      setTimeout(() => {
        $("clientEmoji").textContent = "üëÄ";
        $("clientTitle").textContent = "–ò–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å‚Ä¶";
        $("clientSubtitle").textContent = "–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è.";
      }, 2000);
    }

    /* ---------- Init ---------- */
    onAuthStateChanged(auth, async (u) => {
      me = u || null;
      isTeacher = false;

      if (!me) {
        showScreen("welcome");
        return;
      }

      // teacher profile check
      try {
        const prof = await getDoc(doc(db,"artifacts",APP_ID,"users",me.uid,"settings","profile"));
        if (prof.exists() && prof.data()?.role === "teacher") {
          isTeacher = true;
          $("teacherEmail").textContent = prof.data().email || me.email || "";
          startTeacherListeners(me.uid);
          setStatsTab("solo");
          showScreen("teacher");
          return;
        }
      } catch {}

      // anonymous/student
      showScreen("welcome");
    });

    // Auto-fill ?pin=1234
    window.addEventListener("DOMContentLoaded", () => {
      const usp = new URLSearchParams(location.search);
      const pin = usp.get("pin");
      if (pin) {
        $("livePin").value = pin;
        toast("–ü–ò–ù –µ –∑–∞—Ä–µ–¥–µ–Ω.", "info");
      }
      safeIcons();
      showScreen("welcome");
    });
  </script>
</body>
</html>
